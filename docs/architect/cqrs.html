<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Command Query Responsibility Segregation (CQRS) | Nguyễn Khánk&#39;s Wiki</title>
    <meta name="description" content="Wikipedia của tui">
    <link rel="apple-touch-icon" sizes="180x180" href="../public/favicons/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../public/favicons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../public/favicons/favicon-16x16.png">
  <link rel="manifest" href="../public/favicons/manifest.json">
  <link rel="mask-icon" href="../public/favicons/safari-pinned-tab.svg" color="#3a0839">
  <link rel="shortcut icon" href="../public/favicons/favicon.ico">
  <meta name="msapplication-TileColor" content="#3a0839">
  <meta name="msapplication-config" content="../public/favicons/browserconfig.xml">
  <meta name="theme-color" content="#ffffff">
    
    <link rel="preload" href="/docs/assets/css/0.styles.34ec9276.css" as="style"><link rel="preload" href="/docs/assets/js/app.e1ced8c8.js" as="script"><link rel="preload" href="/docs/assets/js/2.798c4ec4.js" as="script"><link rel="preload" href="/docs/assets/js/6.5bc5d43b.js" as="script"><link rel="preload" href="/docs/assets/js/10.385cac93.js" as="script"><link rel="prefetch" href="/docs/assets/js/100.50f0a243.js"><link rel="prefetch" href="/docs/assets/js/101.3d4dc6c5.js"><link rel="prefetch" href="/docs/assets/js/102.c6aa1423.js"><link rel="prefetch" href="/docs/assets/js/103.2fb1d08a.js"><link rel="prefetch" href="/docs/assets/js/104.60a5488a.js"><link rel="prefetch" href="/docs/assets/js/105.9362cfd1.js"><link rel="prefetch" href="/docs/assets/js/106.309cea19.js"><link rel="prefetch" href="/docs/assets/js/107.c52ddfa7.js"><link rel="prefetch" href="/docs/assets/js/108.e2324dea.js"><link rel="prefetch" href="/docs/assets/js/11.811034c6.js"><link rel="prefetch" href="/docs/assets/js/12.b2119b97.js"><link rel="prefetch" href="/docs/assets/js/13.60f2ddad.js"><link rel="prefetch" href="/docs/assets/js/14.d7f3f7ea.js"><link rel="prefetch" href="/docs/assets/js/15.02c1a77b.js"><link rel="prefetch" href="/docs/assets/js/16.985cdb1d.js"><link rel="prefetch" href="/docs/assets/js/17.5ddb0155.js"><link rel="prefetch" href="/docs/assets/js/18.df7b8dbe.js"><link rel="prefetch" href="/docs/assets/js/19.95d592aa.js"><link rel="prefetch" href="/docs/assets/js/20.d6435cfc.js"><link rel="prefetch" href="/docs/assets/js/21.731458df.js"><link rel="prefetch" href="/docs/assets/js/22.d0463220.js"><link rel="prefetch" href="/docs/assets/js/23.97c34e01.js"><link rel="prefetch" href="/docs/assets/js/24.112c9117.js"><link rel="prefetch" href="/docs/assets/js/25.3bcb2fdd.js"><link rel="prefetch" href="/docs/assets/js/26.f551a572.js"><link rel="prefetch" href="/docs/assets/js/27.668e01fc.js"><link rel="prefetch" href="/docs/assets/js/28.729ae779.js"><link rel="prefetch" href="/docs/assets/js/29.ab239e83.js"><link rel="prefetch" href="/docs/assets/js/3.9aa01312.js"><link rel="prefetch" href="/docs/assets/js/30.5ac49f7f.js"><link rel="prefetch" href="/docs/assets/js/31.d1260aa1.js"><link rel="prefetch" href="/docs/assets/js/32.c47345c6.js"><link rel="prefetch" href="/docs/assets/js/33.0c36f540.js"><link rel="prefetch" href="/docs/assets/js/34.7ea1c6cf.js"><link rel="prefetch" href="/docs/assets/js/35.77e4475d.js"><link rel="prefetch" href="/docs/assets/js/36.46c570b5.js"><link rel="prefetch" href="/docs/assets/js/37.2d06f9ae.js"><link rel="prefetch" href="/docs/assets/js/38.285334f7.js"><link rel="prefetch" href="/docs/assets/js/39.6dad9387.js"><link rel="prefetch" href="/docs/assets/js/4.77e50073.js"><link rel="prefetch" href="/docs/assets/js/40.80d0e31a.js"><link rel="prefetch" href="/docs/assets/js/41.4d627928.js"><link rel="prefetch" href="/docs/assets/js/42.05e37f04.js"><link rel="prefetch" href="/docs/assets/js/43.17ab339a.js"><link rel="prefetch" href="/docs/assets/js/44.aea33a2d.js"><link rel="prefetch" href="/docs/assets/js/45.867d1b44.js"><link rel="prefetch" href="/docs/assets/js/46.38f11b47.js"><link rel="prefetch" href="/docs/assets/js/47.bc97934f.js"><link rel="prefetch" href="/docs/assets/js/48.63111a03.js"><link rel="prefetch" href="/docs/assets/js/49.329aa787.js"><link rel="prefetch" href="/docs/assets/js/5.9ca46a51.js"><link rel="prefetch" href="/docs/assets/js/50.706d79c0.js"><link rel="prefetch" href="/docs/assets/js/51.db121e3b.js"><link rel="prefetch" href="/docs/assets/js/52.653f436e.js"><link rel="prefetch" href="/docs/assets/js/53.0f4c11a2.js"><link rel="prefetch" href="/docs/assets/js/54.f9963858.js"><link rel="prefetch" href="/docs/assets/js/55.a5cacb33.js"><link rel="prefetch" href="/docs/assets/js/56.38c32a24.js"><link rel="prefetch" href="/docs/assets/js/57.5086e93c.js"><link rel="prefetch" href="/docs/assets/js/58.d0ca2a7e.js"><link rel="prefetch" href="/docs/assets/js/59.371d0ea3.js"><link rel="prefetch" href="/docs/assets/js/60.cf8cd1e9.js"><link rel="prefetch" href="/docs/assets/js/61.336abbce.js"><link rel="prefetch" href="/docs/assets/js/62.d2846405.js"><link rel="prefetch" href="/docs/assets/js/63.acf59ab8.js"><link rel="prefetch" href="/docs/assets/js/64.47e80684.js"><link rel="prefetch" href="/docs/assets/js/65.212823a4.js"><link rel="prefetch" href="/docs/assets/js/66.42224a71.js"><link rel="prefetch" href="/docs/assets/js/67.f07c0bd6.js"><link rel="prefetch" href="/docs/assets/js/68.6a2f3945.js"><link rel="prefetch" href="/docs/assets/js/69.c8d3f47a.js"><link rel="prefetch" href="/docs/assets/js/7.6ae6b32d.js"><link rel="prefetch" href="/docs/assets/js/70.9f70fcea.js"><link rel="prefetch" href="/docs/assets/js/71.99dbaa61.js"><link rel="prefetch" href="/docs/assets/js/72.b0605dd5.js"><link rel="prefetch" href="/docs/assets/js/73.caac4a0e.js"><link rel="prefetch" href="/docs/assets/js/74.143e62b4.js"><link rel="prefetch" href="/docs/assets/js/75.ad5650af.js"><link rel="prefetch" href="/docs/assets/js/76.23308e67.js"><link rel="prefetch" href="/docs/assets/js/77.46503870.js"><link rel="prefetch" href="/docs/assets/js/78.ddd1e662.js"><link rel="prefetch" href="/docs/assets/js/79.cf44988a.js"><link rel="prefetch" href="/docs/assets/js/8.3be39f91.js"><link rel="prefetch" href="/docs/assets/js/80.31f648fb.js"><link rel="prefetch" href="/docs/assets/js/81.6f49d7f8.js"><link rel="prefetch" href="/docs/assets/js/82.4fb1c5c1.js"><link rel="prefetch" href="/docs/assets/js/83.8a095e91.js"><link rel="prefetch" href="/docs/assets/js/84.5cf8aeb2.js"><link rel="prefetch" href="/docs/assets/js/85.38ada8a5.js"><link rel="prefetch" href="/docs/assets/js/86.94640592.js"><link rel="prefetch" href="/docs/assets/js/87.62c4c47d.js"><link rel="prefetch" href="/docs/assets/js/88.c871ae48.js"><link rel="prefetch" href="/docs/assets/js/89.611e6f12.js"><link rel="prefetch" href="/docs/assets/js/9.635938ed.js"><link rel="prefetch" href="/docs/assets/js/90.dfc4007a.js"><link rel="prefetch" href="/docs/assets/js/91.b676db19.js"><link rel="prefetch" href="/docs/assets/js/92.3b7864bf.js"><link rel="prefetch" href="/docs/assets/js/93.bc85c5e5.js"><link rel="prefetch" href="/docs/assets/js/94.d25bc581.js"><link rel="prefetch" href="/docs/assets/js/95.960b75d2.js"><link rel="prefetch" href="/docs/assets/js/96.b22fada7.js"><link rel="prefetch" href="/docs/assets/js/97.8854c625.js"><link rel="prefetch" href="/docs/assets/js/98.26960dfb.js"><link rel="prefetch" href="/docs/assets/js/99.5b568d9a.js">
    <link rel="stylesheet" href="/docs/assets/css/0.styles.34ec9276.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/docs/" class="home-link router-link-active"><!----> <span class="site-name">Nguyễn Khánk's Wiki</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/docs/architect/" class="nav-link router-link-active">Architecture</a></div><div class="nav-item"><a href="https://nguyenngockhank.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Home
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/docs/architect/" class="nav-link router-link-active">Architecture</a></div><div class="nav-item"><a href="https://nguyenngockhank.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Home
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/docs/architect/" class="sidebar-link">Tổng quan Architecture</a></li><li><a href="/docs/architect/ddd.html" class="sidebar-link">Domain-Driven Design</a></li><li><a href="/docs/architect/clean_A.html" class="sidebar-link">Clean Architecture</a></li><li><a href="/docs/architect/ebi.html" class="sidebar-link">EBI Architecture</a></li><li><a href="/docs/architect/onion_A.html" class="sidebar-link">Onion Architecture</a></li><li><a href="/docs/architect/soa.html" class="sidebar-link">Service Oriented Architecture (SOA)</a></li><li><a href="/docs/architect/cqrs.html" class="active sidebar-link">Command Query Responsibility Segregation (CQRS)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/architect/cqrs.html#command-query-separation" class="sidebar-link">Command Query Separation</a></li><li class="sidebar-sub-header"><a href="/docs/architect/cqrs.html#command-pattern" class="sidebar-link">Command Pattern</a></li><li class="sidebar-sub-header"><a href="/docs/architect/cqrs.html#command-bus" class="sidebar-link">Command Bus</a></li><li class="sidebar-sub-header"><a href="/docs/architect/cqrs.html#command-query-responsibility-segregation" class="sidebar-link">Command Query Responsibility Segregation</a></li><li class="sidebar-sub-header"><a href="/docs/architect/cqrs.html#code-sample" class="sidebar-link">Code sample</a></li><li class="sidebar-sub-header"><a href="/docs/architect/cqrs.html#ket-luan" class="sidebar-link">Kết luận</a></li><li class="sidebar-sub-header"><a href="/docs/architect/cqrs.html#nhung-quan-niem-sai-lam" class="sidebar-link">Những quan niệm sai lầm</a></li></ul></li><li><a href="/docs/architect/event_driven_A.html" class="sidebar-link">Event-driven architecture</a></li><li><a href="/docs/architect/hexagonal_A.html" class="sidebar-link">Hexagonal Architecture</a></li><li><a href="/docs/architect/spa.html" class="sidebar-link">Single Page Application</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Họ làm điều đó như nào?</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Khác</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="command-query-responsibility-segregation-cqrs"><a href="#command-query-responsibility-segregation-cqrs" aria-hidden="true" class="header-anchor">#</a> Command Query Responsibility Segregation (CQRS)</h1> <p>Với một ứng dụng kiểu <strong>data-centric application</strong> (ứng dụng tập trung vào dữ liệu) chỉ implement các thao tác CRUD căn bản xuống DB và để business process cho user xử lý (ví dụ như cần change data nào và khi nào change), nó có lợi điểm là user có thể thay đổi business process mà application không cần phải thay đổi. Nói cách khác, nó ngụ ý rằng tất cả user đều có hiểu biết rõ ràng về business process mà họ có thể làm, nhưng vấn đề là phần lớn user đều không thể nắm hết được business process mà họ cần phải thao tác.</p> <p>Trong data-centric application, application không có kiến thức về business process, vì vậy domain sẽ không có bất cứ 1 “động từ” (hành động) nào, và không thể làm gì khác ngoài việc đọc/ghi raw data. Nó trở thành một sự trừu tượng hóa của mô hình dữ liệu (a glorified abstraction of the data model). Process (quy trình) chỉ tồn tại trong đầu của người sử dụng application, hoặc thậm chí là trong các sticky note dán trên màn hình máy tính.</p> <p>Một ứng dụng thực sự hữu ích khi nó có thể loại bỏ gánh nặng “<strong>process</strong>” trên vai người dùng bằng cách nắm bắt ý định của họ, làm cho nó trở thành một ứng dụng có khả năng xử lý hành vi (process) chứ không chỉ đơn giản là lưu trữ dữ liệu.</p> <h2 id="command-query-separation"><a href="#command-query-separation" aria-hidden="true" class="header-anchor">#</a> Command Query Separation</h2> <p>Thông thường, chúng ta bắt đầu bằng một cái gì đó như sau:</p> <p><img src="/docs/assets/img/1_layered.c1856c2d.png" alt="1_layered"><br> <em>Diagram of classic N-Layer architecture.</em></p> <p>Đây là kiến trúc N-layer điển hình như tất cả chúng ta đều biết. Nếu chúng ta muốn thêm một số CQS ở đây, chúng ta có thể “đơn giản” tách business logic ra thành Commands và Queries</p> <p><img src="/docs/assets/img/cqrs-simple-architecture_2_cqs_1.cbc8fcd3.png" alt="CQRS-Simple-Architecture_2_CQS_1"></p> <p><em>Separated Commands and Queries with shared domain model</em></p> <p>Theo Martin Fowler, thuật ngữ ‘command query separation’ được đặt ra bởi Bertrand Meyer trong cuốn sách của ông “<a href="https://www.amazon.com/gp/product/0136291554?ie=UTF8&amp;tag=martinfowlerc-20&amp;linkCode=as2&amp;camp=1789&amp;creative=9325&amp;creativeASIN=0136291554" target="_blank" rel="noopener noreferrer">Object Oriented Software Construction<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>” (1988) – một cuốn sách được cho là một trong những cuốn sách OO có ảnh hưởng nhất, trong những ngày đầu của OO.</p> <p>Meyer nói rằng, chúng ta không nên có các method mà vừa thay đổi data và trả về data. Vì vậy, chúng ta có hai loại method:</p> <ul><li>Queries: Trả về data nhưng không thay đổi data, do đó không gây ra các side effects;</li> <li>Commands: Thay đổi data và không trả về data.</li></ul> <p>Nói cách khác, đặt một câu hỏi không nên thay đổi câu trả lời và làm cái gì đó không nên trả lại câu trả lời, tuân theo Nguyên tắc Single Responsibility Principle.</p> <p>Tuy vậy, cũng có 1 số pattern ngoại lệ với nguyên tắc này, ví dụ với implementation của Queue và Stack, thao tác “pop” vừa đồng thời thay đổi data và trả về data.</p> <h2 id="command-pattern"><a href="#command-pattern" aria-hidden="true" class="header-anchor">#</a> Command Pattern</h2> <p>Ý tưởng chính của Command Pattern là chuyển chúng ta từ data-centric application sang process-centric application (ứng dụng tập trung vào quy trình), application sẽ có cả kiến thức về domain và processes.</p> <p>Trong thực tế, điều này có nghĩa là thay vì có người dùng thực hiện hành động “CreateUser”, theo sau là một hành động “ActivateUser” và một hành động “SendUserCreatedEmail”, chúng ta sẽ yêu cầu người dùng thực hiện lệnh “RegisterUser” , application sẽ xử lý bao gồm cả ba hành động như một business process khép kín.</p> <p>Tuy nhiên, bạn nên nhớ rằng điều này không có nghĩa là không thể có command “CreateUser” đơn giản. Các trường hợp sử dụng CRUD có thể cùng tồn tại với các trường hợp sử dụng có ý đồ đại diện cho một business process phức tạp, nhưng điều quan trọng là không nhầm lẫn chúng.</p> <p>Giống như tên gọi của nó, trong pattern này chúng ta sẽ phân chia việc thực hiện các commands khác nhau. Hãy xem <strong>Wikipedia</strong> nói gì về pattern này</p> <blockquote><p><em>Command pattern là một behavioral design pattern trong đó một đối tượng được sử dụng để đại diện và đóng gói tất cả các thông tin cần thiết để gọi một method. Thông tin này bao gồm tên method, các đối tượng của method đó và các giá trị cho các tham số của method..</em></p></blockquote> <p>Ví dụ, tất cả các Command sẽ có cùng một phương thức execute() để tại một thời điểm nào đó, bất cứ Command nào cũng có thể được kích hoạt mà không cần biết nó là Command gì. Điều này sẽ cho phép các Command được xếp hàng đợi và được thực thi khi có thể, có thể đồng bộ (sync) hoặc bất đồng bộ (async).</p> <h2 id="command-bus"><a href="#command-bus" aria-hidden="true" class="header-anchor">#</a> Command Bus</h2> <p>Việc mô hình hoá các nghiệp vụ ghi dữ liệu dưới các command cho phép che đậy tốt các logic nghiệp vụ, giúp việc mở rộng dễ dàng hơn. Đồng thời các comand đó có thể dễ dàng chuyển đổi giữa xử lý đồng bộ và bất đồng bộ thông qua lớp abstract là command bus mà không thay đổi mô hình. Giúp cung cấp một mô hình nhất quán, xuyên suốt trong bộ kiến trúc. Phần ghi dữ liệu được thực hiện qua việc send các command tới các handler thông qua command bus. Comand hanlder đóng vai trò tương tự domain service sẽ tương tác với các model để thực hiện các nghiệp vụ thay đổi dữ liệu.</p> <p>Hơn nữa, chúng ta có thể implement theo dạng nhiều command không cần phải được xử lý ngay lập tức, chúng có thể được xếp queue và thực hiện bất đồng bộ. Điều này có một số lợi thế làm cho hệ thống mạnh mẽ hơn:</p> <ul><li>Phản hồi cho người dùng được gửi lại nhanh hơn bởi vì chúng ta không xử lý command ngay lập tức;</li> <li>Nếu vì lỗi hệ thống, giống như một lỗi hoặc DB đang offline, một command không thành công, người dùng thậm chí không nhận ra nó. Command này chỉ đơn giản có thể được execute khi vấn đề được giải quyết.</li></ul> <p>Ngoài ra, việc sử dụng command bus còn mang lại một số lợi điểm như chúng ta có thể áp dụng thêm <strong>Aspect-oriented programming</strong> (AOP) có thể wrap thêm các common logic trước và / hoặc sau khi xử lý được thực hiện. Ví dụ, chúng ta có thể validate dữ liệu command trước khi chuyển nó tới handler, wrap các handler trong transaction logic (commit, rollback) khi làm việc với DB transaction, hoặc chúng ta có thể làm cho command bus support việc truy vấn, phân luồng các logic phức tạp và thực thi bất đồng bộ.</p> <p>Cách thông thường mà command bus đạt được là sử dụng Decorator pattern wrap xung quanh command bus (một Decorator object có thể decorate cho một Decorator object khác), giống như trò matryoshka.</p> <p><img src="/docs/assets/img/commandbusmatryoshka.ad1a0ff2.jpg" alt="commandbusmatryoshka"></p> <p>Điều này cho phép chúng ta tạo ra các <strong>Decorators</strong> riêng của chúng ta và để cấu hình cho command bus (có thể bên thứ ba) được tạo ra bởi bất kỳ Decorator nào, bất kể thứ tự nào, thêm chức năng tuỳ chỉnh của chúng ta vào command bus. Nếu chúng ta cần quản lý command theo hàng đợi, chúng ta thêm một Decorator để quản lý hàng đợi (queue) của các command. Nếu không sử dụng các transaction DB thì chúng ta không cần transaction management Decorator làm gì, …</p> <h2 id="command-query-responsibility-segregation"><a href="#command-query-responsibility-segregation" aria-hidden="true" class="header-anchor">#</a> Command Query Responsibility Segregation</h2> <p>Bằng cách kết hợp các khái niệm về CQS, Command, Query và CommandBus, cuối cùng chúng ta đã đạt tới Command Query Responsibility Segregation (CQRS). Về cơ bản, chúng ta có thể nói rằng CQRS là một implementation của nguyên tắc Command Query Separation principle trong kiến trúc phần mềm. CQRS có thể được thực hiện theo những cách khác nhau và lên đến các cấp độ khác nhau, có thể chỉ có phía Command, hoặc có thể không sử dụng một Command Bus. Để hoàn thành, đây là một sơ đồ đại diện cho cách tôi nhìn thấy implementation của một CQRS đầy đủ:</p> <p><img src="/docs/assets/img/2006-1-cqrs.5ad4c9d7.png" alt="2006-1-cqrs"></p> <h3 id="query-side"><a href="#query-side" aria-hidden="true" class="header-anchor">#</a> Query side</h3> <p>Nếu làm theo CQS, phía truy vấn sẽ chỉ trả lại data và không thay đổi data. Vì không có ý định thực hiện business process trên data đó nên chúng ta không cần các business objects (ví dụ như các entities), vì vậy không cần một ORM trung gian. Chúng ta chỉ cần truy vấn dữ liệu thô để hiển thị cho người dùng và chính xác dữ liệu mà chúng ta cần để hiển thị đến người dùng!</p> <p>Phần đọc dữ liệu được thiết kế riêng không lệ thuộc vào các model của phần ghi dữ liệu. Do đó có thể linh hoạt trong việc truy xuất database, cũng như sử dụng các data source khác nhau để tối ưu về tốc độ truy xuất.</p> <p>Đây là lợi ích về hiệu suất ngay tại đây: Khi truy vấn dữ liệu, chúng ta không cần trải qua các business logic layers, chúng ta chỉ làm và nhận được chính xác những gì chúng ta cần.</p> <p>Do sự tách biệt này, một cách tối ưu khác có thể là để tách biệt hoàn toàn bộ nhớ dữ liệu thành hai kho dữ liệu tách biệt: WRITE DB được tối ưu hóa cho ghi data và READ DB để tối ưu hóa cho việc đọc data. Ví dụ, nếu chúng ta đang sử dụng một RDBMS:</p> <p>Việc đọc data không cần đến tính data integrity, chúng không cần các ràng buộc khoá ngoại bởi vì việc xác thực tính toàn vẹn dữ liệu được thực hiện khi ghi vào WRITE DB. Vì vậy, chúng ta có thể loại bỏ các ràng buộc toàn vẹn dữ liệu ở READ DB.</p> <p>Chúng ta cũng có thể sử dụng các DB View với chính xác dữ liệu mà chúng ta cần, làm cho việc truy vấn trở nên đơn giản và do đó nhanh hơn, và do đó, tại sao chúng ta cần một RDBMS cho việc đọc dữ liệu ?! Chúng ta có thể sử dụng Mongo DB hoặc Redis, nhanh hơn. Việc thay đổi này có ích nếu ứng dụng đang có vấn đề hiệu suất về việc đọc data.</p> <p>Việc truy vấn có thể được thực hiện bằng cách sử dụng một đối tượng truy vấn trả về một mảng dữ liệu mong muốn hoặc chúng ta có thể sử dụng một cái gì đó tinh vi hơn như Query Bus, ví dụ, nhận một query name, sử dụng một đối tượng truy vấn để truy vấn dữ liệu và trả về một thể hiện của ViewModel mà query cần.</p> <h3 id="command-side"><a href="#command-side" aria-hidden="true" class="header-anchor">#</a> Command side</h3> <p>Như đã giải thích trước đó, bằng việc sử dụng command, chúng ta dịch chuyển thiết kế của application từ data-centric design sang behaviour design sử dụng Domain Driven Design.</p> <p>Bằng việc loại bỏ các tác vụ READ ra khỏi code xử lý command và domain, có thể giải quyết các vấn đề sau:</p> <ul><li>Domain objects sẽ không cần phải lộ ra (expose) các trạng thái internal của nó</li> <li>Các Repositories sẽ chỉ còn rất ít (nếu có) các tác vụ truy vấn dữ liệu</li> <li>Tập trung vào behaviour tương tác giữa các Aggregate boundaries (hiểu nôm na là các đối tượng boundary trong EIB) hơn</li></ul> <p>Các phụ thuộc “one-to-many” và “many-to-many” giữa các entities có thể gây ra ảnh hưởng xấu về mặt performance trong ORM. Tin tốt là chúng ta hiếm khi cần các mối quan hệ đó khi xử lý các command, chúng chủ yếu được sử dụng để truy vấn và chúng ta vừa chuyển truy vấn ra khỏi để chúng ta có thể loại bỏ các mối quan hệ thực thể đó. Tôi không nói ở đây về mối quan hệ giữa các bảng trong một RDBMS, những ràng buộc khoái ngoại nên vẫn tồn tại trong DB, tôi đang nói về các kết nối giữa các thực thể được cấu hình ở cấp độ ORM. Ví dụ, liệu chúng ta có thực sự cần một danh sách đơn đặt hàng khi truy vấn một thực thể khách hàng? Xử lý nào chúng ta cần phải sử dụng danh sách đơn hàng đó?</p> <p>Giống như phía truy vấn, nếu Command không được sử dụng cho các truy vấn phức tạp, chúng ta có thể thay thế RDBMS với một cách lưu trữ như document hoặc key-value? Tất nhiên điều đó còn phụ thuộc vào nếu ứng dụng đang có vấn đề hiệu suất về ghi dữ liệu.</p> <h3 id="business-process-events"><a href="#business-process-events" aria-hidden="true" class="header-anchor">#</a> Business process events</h3> <p>Sau khi Command được xử lý, và nếu nó đã được xử lý thành công, trình xử lý sẽ kích hoạt một event thông báo cho phần còn lại của ứng dụng về những gì đã xảy ra. Các event nên được đặt tên như là Command kích hoạt nó, và một điều nữa như là quy luật với các event, nó phải là sử dụng thì quá khứ, ví dụ actionPerformed.</p> <h3 id="cqrs-event-sourcing"><a href="#cqrs-event-sourcing" aria-hidden="true" class="header-anchor">#</a> CQRS != EVENT SOURCING</h3> <p>Event Sourcing là một ý tưởng đã được trình bày cùng với CQRS, và thường được xác định là một phần của CQRS. Ý tưởng về Event Sourcing rất đơn giản: domain của chúng ta đang tạo ra các event record lại tất cả thay đổi được thực hiện trong hệ thống. Nếu chúng ta lấy mọi event từ đầu của hệ thống và phát lại chúng về trạng thái ban đầu, chúng ta sẽ nhận được trạng thái hiện tại của hệ thống. Nó hoạt động tương tự như các giao dịch trên tài khoản ngân hàng của chúng ta; chúng ta có thể bắt đầu với tài khoản rỗng, phát lại từng giao dịch và (hy vọng) có được sự cân bằng hiện tại. Vì vậy, nếu chúng ta lưu trữ tất cả các sự kiện, chúng ta luôn có thể nhận được trạng thái hiện tại của hệ thống.</p> <p><img src="/docs/assets/img/cqrs_6_cqrs_es.9b765315.png" alt="CQRS_6_CQRS_ES"></p> <p><em>Event Sourcing</em></p> <p>Trong khi Event Sourcing là một phương pháp tuyệt vời để lưu trữ trạng thái của hệ thống là không nhất thiết cần thiết trong CQRS. Đối với CQRS, điều quan trọng là Domain Model thực sự được lưu giữ như thế nào và đây chỉ là một trong những lựa chọn.</p> <h3 id="eventual-consistency"><a href="#eventual-consistency" aria-hidden="true" class="header-anchor">#</a> EVENTUAL CONSISTENCY</h3> <p>Nếu các mô hình của chúng ta được phân tách về mặt vật lý thì việc đồng bộ hoá sẽ mất một thời gian, tuy nhiên cách này cũng rất đáng sợ đối với những người làm kinh doanh. Trong các dự án của tôi, nếu mỗi phần hoạt động chính xác, thời gian khi Mô hình READ không đồng bộ thì thường không đáng kể. Tuy nhiên, chúng ta chắc chắn sẽ cần phải tính đến các mối nguy thời gian trong quá trình phát triển trong các hệ thống phức tạp hơn. Giao diện người dùng được thiết kế tốt cũng rất hữu ích trong việc xử lý sự nhất quán cuối cùng.</p> <p>Chúng ta phải giả định rằng ngay cả khi mô hình READ được cập nhật đồng bộ với mô hình WRITE, người dùng vẫn sẽ đưa ra quyết định dựa trên dữ liệu cũ. Thật không may, chúng ta không thể chắc chắn rằng khi dữ liệu được trình bày cho người sử dụng (ví dụ như trình bày trong trình duyệt web) nó vẫn còn tươi.</p> <h2 id="code-sample"><a href="#code-sample" aria-hidden="true" class="header-anchor">#</a> Code sample</h2> <p>Việc implement CQRS cũng rất đơn giản và không cần đến bất kỳ framwork hỗ trợ nào.</p> <p>Đầu tiên, chúng ta sẽ định nghĩa các class/interface cho phía Command, bao gồm <strong>ICommand</strong>, <strong>ICommandHandler</strong> và <strong>ICommandDispatcher</strong> interface.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ICommand</span>
<span class="token punctuation">{</span>
<span class="token punctuation">}</span>
 
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ICommandHandler</span>
    where <span class="token class-name">TCommand</span> <span class="token operator">:</span> <span class="token class-name">ICommand</span>
<span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token class-name">Execute</span><span class="token punctuation">(</span><span class="token class-name">TCommand</span> command<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ICommandDispatcher</span>
<span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token class-name">Execute</span><span class="token punctuation">(</span><span class="token class-name">TCommand</span> command<span class="token punctuation">)</span>
        where <span class="token class-name">TCommand</span> <span class="token operator">:</span> <span class="token class-name">ICommand</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Tiếp theo là phía Query side, chúng ta cũng có IQuery, IQueryHandler và IQueryDispatcher.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IQuery</span>
<span class="token punctuation">{</span>
<span class="token punctuation">}</span>
 
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IQueryHandler</span>
    where <span class="token class-name">TQuery</span> <span class="token operator">:</span> <span class="token class-name">IQuery</span>
<span class="token punctuation">{</span>
    <span class="token class-name">TResult</span> <span class="token class-name">Execute</span><span class="token punctuation">(</span><span class="token class-name">TQuery</span> query<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IQueryDispatcher</span>
<span class="token punctuation">{</span>
    <span class="token class-name">TResult</span> <span class="token class-name">Execute</span><span class="token punctuation">(</span><span class="token class-name">TQuery</span> query<span class="token punctuation">)</span>
        where <span class="token class-name">TQuery</span> <span class="token operator">:</span> <span class="token class-name">IQuery</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Tiếp theo là viết 1 lớp nhằm hiện thực <strong>ICommandDispatcher</strong> interface, ta gọi đó là <strong>CommandDispatcher</strong>. CommandDispatcher có một public method là <strong>Execute(TCommand command)</strong> để thực thi bất cứ Command nào thông qua CommandHandler. <strong>CommandHandler</strong> được khởi tạo bởi <strong>IDependencyResolver</strong> đã được truyền vào constructor của <strong>ICommandDispatcher</strong> với mục đích tìm ra CommandHandler tương ứng để execute 1 Command.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CommandDispatcher</span> <span class="token operator">:</span> <span class="token class-name">ICommandDispatcher</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> readonly <span class="token class-name">IDependencyResolver</span> _resolver<span class="token punctuation">;</span>
 
    <span class="token keyword">public</span> <span class="token class-name">CommandDispatcher</span><span class="token punctuation">(</span><span class="token class-name">IDependencyResolver</span> resolver<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _resolver <span class="token operator">=</span> resolver<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">Execute</span><span class="token punctuation">(</span><span class="token class-name">TCommand</span> command<span class="token punctuation">)</span>
        where <span class="token class-name">TCommand</span> <span class="token operator">:</span> <span class="token class-name">ICommand</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>command <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token string">&quot;command&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
 
        <span class="token keyword">var</span> handler <span class="token operator">=</span> _resolver<span class="token punctuation">.</span><span class="token class-name">Resolve</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CommandHandlerNotFoundException</span><span class="token punctuation">(</span><span class="token function">typeof</span><span class="token punctuation">(</span><span class="token class-name">TCommand</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
 
        handler<span class="token punctuation">.</span><span class="token class-name">Execute</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Nữa là việc định nghĩa ra các đối tượng Command và <strong>CommandHandler</strong> cụ thể cho từng action. Ở đây ta có <strong>SignOnCommand</strong> và <strong>SignOnCommandHandler</strong>. SignOnCommand là một đối tượng Command như đã đề cập ở trên, chỉ chứa data đơn giản cần thiết cho việc execute command đó. <strong>SignOnCommandHandler</strong> sẽ nhận vào <strong>SignOnCommand</strong> và execute action tương ứng với data nhận được.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SignOnCommand</span> <span class="token operator">:</span> <span class="token class-name">ICommand</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">AssignmentId</span> <span class="token class-name">Id</span> <span class="token punctuation">{</span> get<span class="token punctuation">;</span> <span class="token keyword">private</span> set<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">LocalDateTime</span> <span class="token class-name">EffectiveDate</span> <span class="token punctuation">{</span> get<span class="token punctuation">;</span> <span class="token keyword">private</span> set<span class="token punctuation">;</span> <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token class-name">SignOnCommand</span><span class="token punctuation">(</span><span class="token class-name">AssignmentId</span> assignmentId<span class="token punctuation">,</span> <span class="token class-name">LocalDateTime</span> effectiveDate<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">Id</span> <span class="token operator">=</span> assignmentId<span class="token punctuation">;</span>
        <span class="token class-name">EffectiveDate</span> <span class="token operator">=</span> effectiveDate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SignOnCommandHandler</span> <span class="token operator">:</span> <span class="token class-name">ICommandHandler</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> readonly <span class="token class-name">AssignmentRepository</span> _assignmentRepository<span class="token punctuation">;</span>
    <span class="token keyword">private</span> readonly <span class="token class-name">SignOnPolicyFactory</span> _factory<span class="token punctuation">;</span>
 
    <span class="token keyword">public</span> <span class="token class-name">SignOnCommandHandler</span><span class="token punctuation">(</span><span class="token class-name">AssignmentRepository</span> assignmentRepository<span class="token punctuation">,</span>
                                <span class="token class-name">SignOnPolicyFactory</span> factory<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _assignmentRepository <span class="token operator">=</span> assignmentRepository<span class="token punctuation">;</span>
        _factory <span class="token operator">=</span> factory<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">Execute</span><span class="token punctuation">(</span><span class="token class-name">SignOnCommand</span> command<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">var</span> assignment <span class="token operator">=</span> _assignmentRepository<span class="token punctuation">.</span><span class="token class-name">GetById</span><span class="token punctuation">(</span>command<span class="token punctuation">.</span><span class="token class-name">Id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token keyword">if</span> <span class="token punctuation">(</span>assignment <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">MeaningfulDomainException</span><span class="token punctuation">(</span><span class="token string">&quot;Assignment not found!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
 
        <span class="token keyword">var</span> policy <span class="token operator">=</span> _factory<span class="token punctuation">.</span><span class="token class-name">GetPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        assignment<span class="token punctuation">.</span><span class="token class-name">SignOn</span><span class="token punctuation">(</span>command<span class="token punctuation">.</span><span class="token class-name">EffectiveDate</span><span class="token punctuation">,</span> policy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Để execute SignOnCommand này, chúng ta chỉ cần pass nó vào dispatcher như sau:</p> <div class="language-java extra-class"><pre class="language-java"><code>_commandDispatcher<span class="token punctuation">.</span><span class="token class-name">Execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SignOnCommand</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AssignmentId</span><span class="token punctuation">(</span>rawId<span class="token punctuation">)</span><span class="token punctuation">,</span> effectiveDate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Việc implement cho phía Query cũng tương tự như vậy, ta có <strong>QueryDispatcher</strong>.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QueryDispatcher</span> <span class="token operator">:</span> <span class="token class-name">IQueryDispatcher</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> readonly <span class="token class-name">IDependencyResolver</span> _resolver<span class="token punctuation">;</span>
 
    <span class="token keyword">public</span> <span class="token class-name">QueryDispatcher</span><span class="token punctuation">(</span><span class="token class-name">IDependencyResolver</span> resolver<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _resolver <span class="token operator">=</span> resolver<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token class-name">TResult</span> <span class="token class-name">Execute</span><span class="token punctuation">(</span><span class="token class-name">TQuery</span> query<span class="token punctuation">)</span>
        where <span class="token class-name">TQuery</span> <span class="token operator">:</span> <span class="token class-name">IQuery</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>query <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token string">&quot;query&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
 
        <span class="token keyword">var</span> handler <span class="token operator">=</span> _resolver<span class="token punctuation">.</span><span class="token class-name">Resolve</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">QueryHandlerNotFoundException</span><span class="token punctuation">(</span><span class="token function">typeof</span><span class="token punctuation">(</span><span class="token class-name">TQuery</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
 
        <span class="token keyword">return</span> handler<span class="token punctuation">.</span><span class="token class-name">Execute</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Như tôi đã nói, việc triển khai này rất dễ dàng mở rộng. Ví dụ: chúng ta có thể handle các <strong>transactions</strong> cho command dispatcher mà không thay đổi việc thực hiện ban đầu bằng cách sử dụng các <strong>Decorator</strong>:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransactionalCommandDispatcher</span> <span class="token operator">:</span> <span class="token class-name">ICommandDispatcher</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> readonly <span class="token class-name">ICommandDispatcher</span> _next<span class="token punctuation">;</span>
    <span class="token keyword">private</span> readonly <span class="token class-name">ISessionFactory</span> _sessionFactory<span class="token punctuation">;</span>
 
    <span class="token keyword">public</span> <span class="token class-name">TransactionalCommandDispatcher</span><span class="token punctuation">(</span><span class="token class-name">ICommandDispatcher</span> next<span class="token punctuation">,</span>
            <span class="token class-name">ISessionFactory</span> sessionFactory<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _next <span class="token operator">=</span> next<span class="token punctuation">;</span>
        _sessionFactory <span class="token operator">=</span> sessionFactory<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">Execute</span><span class="token punctuation">(</span><span class="token class-name">TCommand</span> command<span class="token punctuation">)</span>
        where <span class="token class-name">TCommand</span> <span class="token operator">:</span> <span class="token class-name">ICommand</span>
    <span class="token punctuation">{</span>
        using <span class="token punctuation">(</span><span class="token keyword">var</span> session <span class="token operator">=</span> _sessionFactory<span class="token punctuation">.</span><span class="token class-name">GetSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            using <span class="token punctuation">(</span><span class="token keyword">var</span> tx <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token class-name">BeginTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">try</span>
                <span class="token punctuation">{</span>
                    _next<span class="token punctuation">.</span><span class="token class-name">Execute</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    tx<span class="token punctuation">.</span><span class="token class-name">Commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">catch</span>
                <span class="token punctuation">{</span>
                    tx<span class="token punctuation">.</span><span class="token class-name">Rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">throw</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="ket-luan"><a href="#ket-luan" aria-hidden="true" class="header-anchor">#</a> Kết luận</h2> <p>Bằng cách sử dụng CQRS, chúng ta có thể tách rời hoàn toàn mô hình <strong>READ</strong> và <strong>WRITE</strong>, cho phép tối ưu hóa các thao tác đọc và ghi. Điều này làm tăng hiệu suất, làm cho codebase rõ ràng, đơn giản, phản ánh được domain, tăng tính bảo trì.</p> <p>Một lần nữa, đó là tất cả về encapsulation, low coupling, high cohesion, và Single Responsibility Principle.</p> <p>Tuy nhiên, cần lưu ý rằng mặc dù CQRS cung cấp một kiểu dáng thiết kế và một số giải pháp kỹ thuật có thể làm cho một ứng dụng rất mạnh mẽ, điều đó không có nghĩa là tất cả các ứng dụng phải được xây dựng theo cách này: Chúng ta nên sử dụng những gì chúng ta cần, và khi nào cần.</p> <h2 id="nhung-quan-niem-sai-lam"><a href="#nhung-quan-niem-sai-lam" aria-hidden="true" class="header-anchor">#</a> Những quan niệm sai lầm</h2> <h3 id="cqrs-rat-kho"><a href="#cqrs-rat-kho" aria-hidden="true" class="header-anchor">#</a> CQRS rất khó</h3> <p>Xét về mức cơ bản thì CQRS chỉ là một pattern đơn giản triển khai nguyên tắc Single Responsibility Principle (SRP) ở lớp Domain Model.</p> <p>CQRS không phải là một framework hay là một hệ thống multiple database, nó là pattern được áp dụng vào bounded context, dùng để chia Domain Model thành 2 model: Write Model (Command side) và Read Model (Query side), chúng được xử lý riêng rẽ để đạt hiệu quả tốt hơn.</p> <h3 id="cqrs-la-eventually-consistent"><a href="#cqrs-la-eventually-consistent" aria-hidden="true" class="header-anchor">#</a> CQRS là Eventually Consistent</h3> <p>Eventually Consistency được áp dụng để Read Model được cập nhật bất đồng bộ (asynchronous) với Write Model</p> <p>Đây không phải là điều kiện tiên quyết của CQRS, nhưng nó thường được sử dụng để cho phép bên Read side có thể scale (mở rộng) dễ dàng.</p> <p>CQRS không yêu cầu bạn phải thực hiện Eventually Consistent. Bạn có thể sử dụng cùng một database và transaction để cập nhật Read Model hoặc sử dụng caching để có Strong Consistency.</p> <h3 id="model-phai-dung-event-sourcing"><a href="#model-phai-dung-event-sourcing" aria-hidden="true" class="header-anchor">#</a> Model phải dùng Event Sourcing</h3> <p>Event Sourcing là một cách rất hiệu quả để xây dựng cả Read Model và Write Model nhưng nó không bắt buộc phải có khi sử dụng CQRS.</p> <p>Event Sourcing là một giải pháp lưu trữ dữ liệu theo lịch sử một cách chính xác, nhưng nó cũng giúp xây dựng Read Model dễ dàng hơn bởi vì bạn có thể tạo ra bất kỳ projection mong muốn từ những dữ liệu sự kiện theo lịch sử.</p> <h3 id="command-nen-la-asynchronous"><a href="#command-nen-la-asynchronous" aria-hidden="true" class="header-anchor">#</a> Command nên là Asynchronous</h3> <p>CQRS không bắt buộc Command phải được gửi theo kiểu fire-and-forget (không quan tâm đến response).</p> <p>Với các trường hợp tương tác cao, nhiều user thực hiện thay đổi vào cùng dữ liệu thì Asynchronous Command sẽ hiệu quả. Nó sẽ giúp ứng dụng dễ scale và không bị quá tải.</p> <p>Tuy nhiên các Command mà không phản hồi lại thành công hay thất bại sẽ cần phải có những cách khác để cập nhật cho user kết quả của hành động. Nó có thể là qua email hoặc qua các thao tác phụ xử lý message lỗi.</p> <h3 id="cqrs-chi-hoat-dong-duoc-voi-he-thong-messaging"><a href="#cqrs-chi-hoat-dong-duoc-voi-he-thong-messaging" aria-hidden="true" class="header-anchor">#</a> CQRS chỉ hoạt động được với hệ thống Messaging</h3> <p>Nếu bạn đang tìm cách áp dụng một Read store theo cách eventually consistent hoặc xử lý Command theo kiểu bất đồng bộ thì dùng một messaging framework có thể là một ý tưởng tốt.</p> <p>Ngược lại, sử dụng một hệ thống messaging khi không cần thiết sẽ làm cho ứng dụng của bạn trở nên phức tạp và khó bảo trì hơn.</p> <h3 id="can-phai-su-dung-domain-event-voi-cqrs"><a href="#can-phai-su-dung-domain-event-voi-cqrs" aria-hidden="true" class="header-anchor">#</a> Cần phải sử dụng Domain Event với CQRS</h3> <p>Sử dụng Event để dựng Read Model là một phương pháp hiệu quả để giữ Read Model và Write Model được tách biệt.</p> <p>Tuy nhiên nó không phải là cách duy nhất, và bạn có thể sử dụng nhiều method khác để tạo Read store, ví dụ như dựng trực tiếp từ dữ liệu quan hệ của Write Model.</p> <p><strong>Bài viết được tham khảo từ:</strong></p> <p><a href="https://herbertograca.com/2017/10/19/from-cqs-to-cqrs/" target="_blank" rel="noopener noreferrer">From CQS to CQRS<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://www.future-processing.pl/blog/cqrs-simple-architecture/" target="_blank" rel="noopener noreferrer">https://www.future-processing.pl/blog/cqrs-simple-architecture/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/docs/architect/soa.html" class="prev">Service Oriented Architecture (SOA)</a></span> <span class="next"><a href="/docs/architect/event_driven_A.html">Event-driven architecture</a>→
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/docs/assets/js/app.e1ced8c8.js" defer></script><script src="/docs/assets/js/2.798c4ec4.js" defer></script><script src="/docs/assets/js/6.5bc5d43b.js" defer></script><script src="/docs/assets/js/10.385cac93.js" defer></script>
  </body>
</html>
