<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Pinterest đã thực hiện scaled MySQL của họ như thế nào | Nguyễn Khánk&#39;s Wiki</title>
    <meta name="description" content="Wikipedia của tui">
    <link rel="apple-touch-icon" sizes="180x180" href="../public/favicons/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../public/favicons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../public/favicons/favicon-16x16.png">
  <link rel="manifest" href="../public/favicons/webmanifest.json">
  <link rel="mask-icon" href="../public/favicons/safari-pinned-tab.svg" color="#3a0839">
  <link rel="shortcut icon" href="../public/favicons/favicon.ico">
  <meta name="msapplication-TileColor" content="#3a0839">
  <meta name="msapplication-config" content="../public/favicons/browserconfig.xml">
  <meta name="theme-color" content="#ffffff">
    
    <link rel="preload" href="/docs/assets/css/0.styles.88febddd.css" as="style"><link rel="preload" href="/docs/assets/js/app.3598f0b3.js" as="script"><link rel="preload" href="/docs/assets/js/2.42b1a8fc.js" as="script"><link rel="preload" href="/docs/assets/js/30.e885f37e.js" as="script"><link rel="preload" href="/docs/assets/js/3.37b3a70b.js" as="script"><link rel="prefetch" href="/docs/assets/js/10.514e3d77.js"><link rel="prefetch" href="/docs/assets/js/11.116d157c.js"><link rel="prefetch" href="/docs/assets/js/12.32c5de1d.js"><link rel="prefetch" href="/docs/assets/js/13.4d06b7fc.js"><link rel="prefetch" href="/docs/assets/js/14.9a05fb9c.js"><link rel="prefetch" href="/docs/assets/js/15.68291ccf.js"><link rel="prefetch" href="/docs/assets/js/16.3aed14e5.js"><link rel="prefetch" href="/docs/assets/js/17.28b83c5d.js"><link rel="prefetch" href="/docs/assets/js/18.dd070b52.js"><link rel="prefetch" href="/docs/assets/js/19.c573a1ba.js"><link rel="prefetch" href="/docs/assets/js/20.4509bbda.js"><link rel="prefetch" href="/docs/assets/js/21.1a4cd4dd.js"><link rel="prefetch" href="/docs/assets/js/22.560cb640.js"><link rel="prefetch" href="/docs/assets/js/23.29b38c72.js"><link rel="prefetch" href="/docs/assets/js/24.fec0de3b.js"><link rel="prefetch" href="/docs/assets/js/25.68b7add7.js"><link rel="prefetch" href="/docs/assets/js/26.588cd671.js"><link rel="prefetch" href="/docs/assets/js/27.169ac9b6.js"><link rel="prefetch" href="/docs/assets/js/28.bb3195c4.js"><link rel="prefetch" href="/docs/assets/js/29.0248e393.js"><link rel="prefetch" href="/docs/assets/js/31.e38de5c4.js"><link rel="prefetch" href="/docs/assets/js/32.d4ee8acd.js"><link rel="prefetch" href="/docs/assets/js/33.f09cba15.js"><link rel="prefetch" href="/docs/assets/js/34.ce0e7b58.js"><link rel="prefetch" href="/docs/assets/js/35.ab90c228.js"><link rel="prefetch" href="/docs/assets/js/36.86ccd486.js"><link rel="prefetch" href="/docs/assets/js/37.4cd902ea.js"><link rel="prefetch" href="/docs/assets/js/38.362e53e3.js"><link rel="prefetch" href="/docs/assets/js/39.537b84cd.js"><link rel="prefetch" href="/docs/assets/js/4.c678166f.js"><link rel="prefetch" href="/docs/assets/js/40.f5309bb2.js"><link rel="prefetch" href="/docs/assets/js/41.ea3a9f73.js"><link rel="prefetch" href="/docs/assets/js/42.ea3ce56b.js"><link rel="prefetch" href="/docs/assets/js/43.47b77d0f.js"><link rel="prefetch" href="/docs/assets/js/44.c5741979.js"><link rel="prefetch" href="/docs/assets/js/45.e9a71f9d.js"><link rel="prefetch" href="/docs/assets/js/46.be8473b3.js"><link rel="prefetch" href="/docs/assets/js/47.9ac607df.js"><link rel="prefetch" href="/docs/assets/js/48.acde57b4.js"><link rel="prefetch" href="/docs/assets/js/49.132543e4.js"><link rel="prefetch" href="/docs/assets/js/5.cc6c98ad.js"><link rel="prefetch" href="/docs/assets/js/50.42faa387.js"><link rel="prefetch" href="/docs/assets/js/51.9eea0010.js"><link rel="prefetch" href="/docs/assets/js/52.a6d4dac7.js"><link rel="prefetch" href="/docs/assets/js/53.03636380.js"><link rel="prefetch" href="/docs/assets/js/54.01016b2d.js"><link rel="prefetch" href="/docs/assets/js/55.65857c66.js"><link rel="prefetch" href="/docs/assets/js/56.a86af040.js"><link rel="prefetch" href="/docs/assets/js/57.2a9d9be0.js"><link rel="prefetch" href="/docs/assets/js/58.fdcbe2d8.js"><link rel="prefetch" href="/docs/assets/js/59.9d367ed0.js"><link rel="prefetch" href="/docs/assets/js/6.73f36474.js"><link rel="prefetch" href="/docs/assets/js/60.f5de8c9a.js"><link rel="prefetch" href="/docs/assets/js/61.111bec19.js"><link rel="prefetch" href="/docs/assets/js/62.f9dbbffc.js"><link rel="prefetch" href="/docs/assets/js/63.071b0c65.js"><link rel="prefetch" href="/docs/assets/js/64.2266e863.js"><link rel="prefetch" href="/docs/assets/js/65.42104547.js"><link rel="prefetch" href="/docs/assets/js/66.f7e4e5b0.js"><link rel="prefetch" href="/docs/assets/js/7.e953a8aa.js"><link rel="prefetch" href="/docs/assets/js/8.ed4a5e88.js"><link rel="prefetch" href="/docs/assets/js/9.d9c80fd5.js">
    <link rel="stylesheet" href="/docs/assets/css/0.styles.88febddd.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/docs/" class="home-link router-link-active"><!----> <span class="site-name">Nguyễn Khánk's Wiki</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Chuyện muôn thuở</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/common/optimize_web.html" class="sidebar-link">Performance website</a></li><li><a href="/docs/common/cross_domain.html" class="sidebar-link">Cross Domain</a></li><li><a href="/docs/common/authenication.html" class="sidebar-link">Authenication</a></li><li><a href="/docs/common/seo.html" class="sidebar-link">SEO</a></li><li><a href="/docs/common/realtime.html" class="sidebar-link">Real time</a></li><li><a href="/docs/common/crawl.html" class="sidebar-link">Crawl data</a></li><li><a href="/docs/common/refactor.html" class="sidebar-link">Code Refactoring</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Giải Toán</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Tools / Toys</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Thuật ngữ</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Javascript</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="pinterest-da-thuc-hien-scaled-mysql-cua-ho-nhu-the-nao"><a href="#pinterest-da-thuc-hien-scaled-mysql-cua-ho-nhu-the-nao" aria-hidden="true" class="header-anchor">#</a> Pinterest đã thực hiện scaled MySQL của họ như thế nào</h1> <p></p><div class="table-of-contents"><ul><li><a href="#nhan-dinh">Nhận định</a></li><li><a href="#luu-cau-hinh">Lưu cấu hình</a></li><li><a href="#tao-id-khi-sharding">Tạo ID khi sharding</a></li><li><a href="#database-schema">Database Schema</a><ul><li><a href="#cau-hoi-phat-sinh">Câu hỏi phát sinh:</a></li></ul></li><li><a href="#references">References</a></li></ul></div><p></p> <h2 id="nhan-dinh"><a href="#nhan-dinh" aria-hidden="true" class="header-anchor">#</a> Nhận định</h2> <ul><li>Một khi đã shard, họ sẽ ko thể sử dụng joins, foreign keys, hoặc index một cách global được.</li> <li>Load balancing vẫn là cần thiết sau khi shard. Không để trường hợp node này quá đầy, node kia lại ko có gì.</li> <li>Những nodes cần có tính ổn định cao.</li> <li>Một khi đã shard, thì ko sờ vào data ở slave nữa. Mọi action read/write đều tiến hành trên master hết.</li> <li>Cần 1 giải thuật đơn giản khi tạo UUID cho tất cả các records của họ.</li></ul> <h2 id="luu-cau-hinh"><a href="#luu-cau-hinh" aria-hidden="true" class="header-anchor">#</a> Lưu cấu hình</h2> <blockquote><p><code>shard nào</code>, có <code>ID là bao nhiêu</code>? con <code>server nào chứa</code></p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">[</span> 
    <span class="token punctuation">{</span>“range”<span class="token punctuation">:</span>     <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">511</span><span class="token punctuation">)</span><span class="token punctuation">,</span> “master”<span class="token punctuation">:</span> “MySQL001A”<span class="token punctuation">,</span> “slave”<span class="token punctuation">:</span> “MySQL001B”<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>“range”<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">1023</span><span class="token punctuation">)</span><span class="token punctuation">,</span> “master”<span class="token punctuation">:</span> “MySQL002A”<span class="token punctuation">,</span> “slave”<span class="token punctuation">:</span> “MySQL002B”<span class="token punctuation">}</span><span class="token punctuation">,</span>
     <span class="token comment">//  ...</span>
    <span class="token punctuation">{</span>“range”<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">3072</span><span class="token punctuation">,</span> <span class="token number">3583</span><span class="token punctuation">)</span><span class="token punctuation">,</span> “master”<span class="token punctuation">:</span> “MySQL007A”<span class="token punctuation">,</span> “slave”<span class="token punctuation">:</span> “MySQL007B”<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>“range”<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">3584</span><span class="token punctuation">,</span> <span class="token number">4095</span><span class="token punctuation">)</span><span class="token punctuation">,</span> “master”<span class="token punctuation">:</span> “MySQL008A”<span class="token punctuation">,</span> “slave”<span class="token punctuation">:</span> “MySQL008B”<span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre></div><h2 id="tao-id-khi-sharding"><a href="#tao-id-khi-sharding" aria-hidden="true" class="header-anchor">#</a> Tạo ID khi sharding</h2> <blockquote><p><code>UUID</code> = (<code>shard ID</code> &lt;&lt; 46) | (<code>type ID</code> &lt;&lt; 36) | (<code>local ID</code> &lt;&lt;0)</p></blockquote> <ul><li><strong><code>shard ID</code></strong>: là 1 số <strong>16 bit</strong>, có vai trò là ID của shard.</li> <li><strong><code>type ID</code></strong>: là 1 số <strong>10 bit</strong>, có vai trò chỉ ra type của object. Ví dụ nếu type ID = 1 có nghĩa object type là <code>Pin</code>, type ID = 2 ứng với object type là <code>Board</code> chẳng hạn.</li> <li><strong><code>local ID</code></strong>: là 1 số <strong>36 bit</strong>, có vai trò là ID của records bên trong shard, có giá trị auto increment.</li></ul> <p>Ví dụ: Tiến hành decompose cái UUID theo cách sau:</p> <div class="language- extra-class"><pre class="language-text"><code>https://www.pinterest.com/pin/241294492511762325/
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Shard ID</span><span class="token template-punctuation string">`</span></span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">241294492511762325</span> <span class="token operator">&gt;&gt;</span> <span class="token number">46</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFFFF</span> <span class="token operator">=</span> <span class="token number">3429</span>
</code></pre></div><p>Dịch phải 46 bit rồi &amp; với 0xFFFF</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Type ID</span><span class="token template-punctuation string">`</span></span>  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">241294492511762325</span> <span class="token operator">&gt;&gt;</span> <span class="token number">36</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x3FF</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token comment">// type Pin -&gt; query vào table pins</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Local ID</span><span class="token template-punctuation string">`</span></span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">241294492511762325</span> <span class="token operator">&gt;&gt;</span>  <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFFFFFFFFF</span> <span class="token operator">=</span> <span class="token number">7075733</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Shard ID = 3429 =&gt; ”MySQL007A” from config </span>
conn <span class="token operator">=</span> MySQLdb<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>host<span class="token operator">=</span>”MySQL007A”<span class="token punctuation">)</span>
conn<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>“<span class="token constant">SELECT</span> data <span class="token constant">FROM</span> db03429<span class="token punctuation">.</span>pins where local_id<span class="token operator">=</span><span class="token number">7075733</span>”<span class="token punctuation">)</span>
</code></pre></div><h2 id="database-schema"><a href="#database-schema" aria-hidden="true" class="header-anchor">#</a> Database Schema</h2> <p>Họ phân loại dữ liệu ra 2 loại: Object và Map. Nói nôm na là các table có tính chất là chứa thông tin, và các table có tính chất là tham chiếu.</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> pins <span class="token punctuation">(</span>
   local_id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
   <span class="token keyword">data</span> <span class="token keyword">TEXT</span><span class="token punctuation">,</span>
   ts <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span>  <span class="token operator">=</span> <span class="token keyword">InnoDB</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> board_has_pins <span class="token punctuation">(</span>
  board_id <span class="token keyword">INT</span><span class="token punctuation">,</span>
  pin_id <span class="token keyword">INT</span><span class="token punctuation">,</span>
  sequence <span class="token keyword">INT</span><span class="token punctuation">,</span>
  <span class="token keyword">INDEX</span><span class="token punctuation">(</span>board_id<span class="token punctuation">,</span> pin_id<span class="token punctuation">,</span> sequence<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span><span class="token punctuation">;</span>
</code></pre></div><p>Để ý thấy là table <code>Pin</code> có bao nhiêu thông tin như thế, vậy mà <code>sao lại có mỗi column data</code>? Cái hay là họ nhét tất cả các thông tin liên quan đến pin vào column data này, dưới dạng JSON:</p> <div class="language- extra-class"><pre class="language-text"><code>{“details”: “New Star Wars character”, “link”: “http://webpage.com/asdf”, “user_id”: 241294629943640797, “board_id”: 241294561224164665, …}
</code></pre></div><ul><li><p>nếu phải thêm 1 column mới cho 1 table theo cách tiếp cận cũ, thì việc alter table sẽ rất nặng (do phải alter cho tất cả các table tương ứng của các shard)</p></li> <li><p>chỉ cần khai báo ở tầng app giá trị default cho column mới mỗi khi muốn đọc ra thôi</p></li> <li><p>Khi insert 1 record mới, họ chỉ định ghi nó vào <code>shard ID</code> nào, <code>type ID</code> là gì. Sau khi record được insert rồi, nó sẽ trả về <code>local ID</code>, lúc này sẽ kết hợp với Shard ID và Type ID để cho ra UUID theo cách bên trên. Quá lợi hại.</p></li></ul> <p>Table <code>board_has_pins</code></p> <p><strong><code>board_id</code></strong> và <strong><code>pin_id</code></strong> là các UUID 64bit như trên, <code>sequence</code> có dạng timestamp, bảo đảm cho việc order theo created time rồi.</p> <h3 id="cau-hoi-phat-sinh"><a href="#cau-hoi-phat-sinh" aria-hidden="true" class="header-anchor">#</a> Câu hỏi phát sinh:</h3> <p><em>Vậy giả sử có query: lấy tất cả boards của user X, thì ko lẽ query trên tất cả các shards à?</em></p> <p>Dự là không. table users, trong column data có chứa luôn list board rồi. Vì là JSON mà, nó lưu gì chả được. Tiếp cận theo cách của NoSQL là hoàn toàn đúng đắn trong trường hợp này.</p> <hr> <h2 id="references"><a href="#references" aria-hidden="true" class="header-anchor">#</a> References</h2> <ul><li><a href="https://medium.com/pinterest-engineering/sharding-pinterest-how-we-scaled-our-mysql-fleet-3f341e96ca6f" target="_blank" rel="noopener noreferrer">Sharding Pinterest: How we scaled our MySQL fleet<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://kipalog.com/posts/Pinterest-da-thuc-hien-scaled-MySQL-cua-ho-nhu-the-nao" target="_blank" rel="noopener noreferrer">Pinterest đã thực hiện scaled MySQL của họ như thế nào<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://nghethuatcoding.com/2019/05/19/instagram-da-sinh-ra-id-trong-database-cua-ho-nhu-the-nao/" target="_blank" rel="noopener noreferrer">Instagram đã sinh ra ID trong database của họ như thế nào<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/docs/assets/js/app.3598f0b3.js" defer></script><script src="/docs/assets/js/2.42b1a8fc.js" defer></script><script src="/docs/assets/js/30.e885f37e.js" defer></script><script src="/docs/assets/js/3.37b3a70b.js" defer></script>
  </body>
</html>
