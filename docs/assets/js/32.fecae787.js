(window.webpackJsonp=window.webpackJsonp||[]).push([[32],{1108:function(e,t,s){e.exports=s.p+"assets/img/f1.729c8cdd.png"},1109:function(e,t,s){e.exports=s.p+"assets/img/48.5cc39f82.png"},1110:function(e,t,s){e.exports=s.p+"assets/img/f3.d67cc4d0.png"},1111:function(e,t,s){e.exports=s.p+"assets/img/50.b73ef75d.png"},1112:function(e,t,s){e.exports=s.p+"assets/img/f5.cbdb64d3.png"},1113:function(e,t,s){e.exports=s.p+"assets/img/f6.bdeb2afe.png"},1114:function(e,t,s){e.exports=s.p+"assets/img/53.61b98c8a.png"},1115:function(e,t,s){e.exports=s.p+"assets/img/55.1d5d4408.png"},1116:function(e,t,s){e.exports=s.p+"assets/img/56.96390a31.png"},1641:function(e,t,s){"use strict";s.r(t);var a=s(7),n=Object(a.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"design-tinder"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#design-tinder"}},[e._v("#")]),e._v(" Design Tinder")]),e._v(" "),a("h2",{attrs:{id:"introduction"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#introduction"}},[e._v("#")]),e._v(" Introduction")]),e._v(" "),a("p",[e._v("Note: This is a prototype on designing a location-based social search application that allows\nusers to use a swiping motion to like or dislike other users similar to Tinder. This has been\ncreated by design based on ourresearch going through Tinder engineering blog. These\narticles are quite informative and detailed. The detailed reference list of the tech talks and\nblogs has been provided in reference section.")]),e._v(" "),a("h3",{attrs:{id:"problem-statement"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#problem-statement"}},[e._v("#")]),e._v(" Problem Statement")]),e._v(" "),a("p",[e._v('Design a location-based social search application similar to Tinder which if often used as\na dating service. It allows users to use a swiping motion to like (swipe right) or dislike\n(swipe left) other users, and allows users to chat if both parties like each other (a "match").')]),e._v(" "),a("h3",{attrs:{id:"gathering-requirements"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#gathering-requirements"}},[e._v("#")]),e._v(" Gathering Requirements")]),e._v(" "),a("p",[a("strong",[e._v("In Scope")]),e._v(" The application should be able to support the following requirements.")]),e._v(" "),a("ul",[a("li",[e._v("User should be able to create their Tinder profile by adding their bio and uploading photos.")]),e._v(" "),a("li",[e._v("User should be able to view recommendations of other users in geographically nearby regions.")]),e._v(" "),a("li",[e._v("Users should be able to like (swipe right) or dislike (swipe left) other recommended users.")]),e._v(" "),a("li",[e._v("Users should get notifications when matched with other users.")]),e._v(" "),a("li",[e._v("Users should be able to move to a different location and still get recommendations of nearby users.")])]),e._v(" "),a("p",[a("strong",[e._v("Out of Scope")]),e._v(" Sending and receiving messages from other users. We have covered it in our article on designing WhatsApp (link here)")]),e._v(" "),a("p",[a("img",{attrs:{src:s(1108),alt:"alt"}}),a("br"),e._v(" "),a("em",[e._v("Figure 9.1: High level Design - Tinder")])]),e._v(" "),a("p",[e._v("There will be a fleet of micro-services behind the Gateway which will be serving the\nuser requests. The Profile Creator Service will be invoked when the user profile gets created. This service will store the user information in a database and add the user to the\ncorresponding geo-sharded index so that the user shows up in recommendations of nearby\nusers. This index gets queried by the Recommendation Service when it receives the request to generate recommendations for other users. Once the user starts swiping through\nthose recommendations, the Swipes Service receives those swipes and places them in a\ndata-streams (e.g. AWS Kinesis/ SQS). There are a fleet of workers which read data from\nthose streams for generating matches. The workers do this by querying the LikesCache\nto determine if it’s a match, in which case the match notification is sent to both the users\nusing technologies such as WebSockets.")]),e._v(" "),a("h2",{attrs:{id:"component-design"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#component-design"}},[e._v("#")]),e._v(" Component Design")]),e._v(" "),a("p",[a("img",{attrs:{src:s(1109),alt:"alt"}}),a("br"),e._v(" "),a("em",[e._v("Figure 9.2: Sequence Diagram for User Profile Creation")])]),e._v(" "),a("p",[e._v("The sequence diagram above shows the sequence of operations which gets executed\nwhen a user creates profile on Tinder. Within the synchronous process, the user media (e.g.\nphotos) is uploaded on a file server and the user information including user’s location is\npersisted in a key-value store like Amazon DynamoDB. Additionally, this user is added to\na queue for adding the user to a geo-sharded index.")]),e._v(" "),a("p",[e._v("The asynchronous process reads the user information from the queue and passes this\ninformation to the GeoShardingIndexer. The indexer uses geo libraries like Google’s S2\nlibrary to map user’s location to a geo-shard and add the user to the index associated with\nthat shard. This helps the user to show up in recommendations of other nearby users. For\ninstance, in the image below we have shown how a user from North America gets mapped\nto the corresponding index so that the user gets shown in recommendations of nearby users.")]),e._v(" "),a("p",[a("img",{attrs:{src:s(1110),alt:"alt"}}),a("br"),e._v(" "),a("em",[e._v("Figure 9.3: User from North America will be mapped to the corresponding shard (image:\ntinder engineering blog)")])]),e._v(" "),a("h3",{attrs:{id:"user-profile-information-sample-data-model"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#user-profile-information-sample-data-model"}},[e._v("#")]),e._v(" User Profile Information - Sample data Model")]),e._v(" "),a("p",[e._v("We have shown below a json blob for storing the user profile information. We can use a key-value store such as Amazon DynamoDB or Riak for maintaining this data.")]),e._v(" "),a("div",{staticClass:"language-json extra-class"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"userId"')]),e._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/* (PK) */")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"AWDGT567RTH"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[e._v('"name"')]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"Julie"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[e._v('"age"')]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("25")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[e._v('"gender"')]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"F"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[e._v('"location"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n        "),a("span",{pre:!0,attrs:{class:"token property"}},[e._v('"latitude"')]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("1111")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n        "),a("span",{pre:!0,attrs:{class:"token property"}},[e._v('"longitude"')]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("1111")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[e._v('"media"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n        "),a("span",{pre:!0,attrs:{class:"token property"}},[e._v('"images"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),e._v("\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"https://mybucket.s3.amazonaws.com/myfolder/img1.jpg"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"https://mybucket.s3.amazonaws.com/myfolder/img2.jpg"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"https://mybucket.s3.amazonaws.com/myfolder/img3.jpg"')]),e._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[e._v('"recommendationPreferences"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n        "),a("span",{pre:!0,attrs:{class:"token property"}},[e._v('"ageRange"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n            "),a("span",{pre:!0,attrs:{class:"token property"}},[e._v('"min"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("21")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n            "),a("span",{pre:!0,attrs:{class:"token property"}},[e._v('"max"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("31")]),e._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n        "),a("span",{pre:!0,attrs:{class:"token property"}},[e._v('"radius"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("50")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),a("h3",{attrs:{id:"fetch-user-recommendations"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#fetch-user-recommendations"}},[e._v("#")]),e._v(" Fetch User recommendations")]),e._v(" "),a("p",[e._v("In the previous section, shows how users get added into the geo-sharded index. Let’s see\nhow the user gets shown in the recommendation of other users. When a user request arrives\nat the Recommendation Engine it is forwarded to the request to the GeoShardedIndexer.\nThe indexer determines the geo-shards to be queried based on user location and radius using geo-libraries like Google’s S2. Followed by, the indexer queries all the geo-sharded indexes (more details in next section) are mapped to the shards returned by Google S2 to\nfetch the list of all the users in those indexes and returns that list to the RecommendationEngine. The engine applies filtering on the list based on user preferences and returns the\nfinal list of recommendations to the user")]),e._v(" "),a("p",[a("img",{attrs:{src:s(1111),alt:"alt"}}),a("br"),e._v(" "),a("em",[e._v("Figure 9.4: Fetch User recommendations")])]),e._v(" "),a("h3",{attrs:{id:"geo-sharded-index"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#geo-sharded-index"}},[e._v("#")]),e._v(" Geo-Sharded Index")]),e._v(" "),a("p",[e._v("A naïve approach of maintaining this index would be to have an Elasticsearch cluster with\none index and the default number of shards. However, this approach won’t hold up to the\nscaling expectations which an application like Tinder requires. We should leverage the\nfact that Tinder’s recommendations are location-based. For instance, when we are serving\na user from India, we don’t need to include the users from USA. This fact can be used\nby keeping an optimal index size for better performance. We can optimize the index size\nby sharding the active user records based on their geo-locations so that the active user\ncount will remain balanced across shards. We can represent the balance of a geo-sharding\nconfiguration with N shards by the standard deviation of active user counts across shards\nas mentioned below.")]),e._v(" "),a("p",[e._v("Balance(Shard1, Shard2,. . . , ShardN) = standard-deviation(Active User Count of Shard1,\nShard2,. . . , ShardN)")]),e._v(" "),a("p",[e._v("The geo-sharding configuration with the minimal standard deviation would be best balanced. Geo-libraries like Google’s S2 Library can be used which are based on hierarchical decomposition of sphere into “cells” using Quad-Trees. A visualization of generated geosharded map for our user-case is shown below. The inference from the given graph is, that\ngeo-shards are physically closer and larger for areas having lower number of active users. For instance, in the image below shards are larger on water bodies like seas and oceans as they only have users from some islands, however, shards are smaller on land. In the image below, it can seen that North America has three shards, however, entire England and\nGreenland along-with a large portion of Atlantic Ocean share a single shard due to lesser\ndensity of active users.")]),e._v(" "),a("p",[e._v("The S2 library provides two major functions:")]),e._v(" "),a("ol",[a("li",[e._v("given a location point (lat, long), return the S2 cell that contains it")]),e._v(" "),a("li",[e._v("given a circle (lat, long, radius), return the S2 cells that cover the circle. Each S2 cell can be represented by a geo-shard which will be mapped to an index in our system. When a profile gets created, the user is added to the search index for that corresponding S2 cell. To fetch recommendations for a user, we query the indexes of the nearby S2 cells depending on the circle radius as shown in the image below.")])]),e._v(" "),a("p",[a("img",{attrs:{src:s(1112),alt:"alt"}}),a("br"),e._v(" "),a("em",[e._v("Figure 9.5: Geo-sharded map generated by Google S2, each shard us a S2 cell (image: Tinder engineering blog )")])]),e._v(" "),a("p",[a("img",{attrs:{src:s(1113),alt:"alt"}}),a("br"),e._v(" "),a("em",[e._v("Figure 9.6: Fetching recommendations for a user from nearby shards(image: Tinder engineering blog)")])]),e._v(" "),a("h3",{attrs:{id:"swipes-and-matches"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#swipes-and-matches"}},[e._v("#")]),e._v(" Swipes and Matches")]),e._v(" "),a("p",[e._v("The above image shows the sequence of operations which gets executed when a user swipes\nleft/right. The swipes ingester processes the swipes and puts the left swipes into a stream")]),e._v(" "),a("p",[a("img",{attrs:{src:s(1114),alt:"alt"}}),a("br"),e._v(" "),a("em",[e._v("Figure 9.7: Sequence of operations for user swipes and matching")])]),e._v(" "),a("p",[e._v("which persist those swipes to a low-cost data storage (e.g. Amazon S3). These left swipes\ncan be used for data analysis for some user cases.")]),e._v(" "),a("p",[e._v("On the other hand, the right swipes are put in a separate stream and is ultimately read\nby matcher worker thread. The matcher worker threads reads the likes message from the\nstream and checks if the corresponding entry exist in the LikesCache. For instance, in the\nimage above Alice likes Bob and the match worker checks if an entry exists for Bob liking\nAlice in the cache. If both Alice and Bob likes each other then it’s called a match and a\nmatch notification is sent both the users using server push mechanism like Websockets. If\nBob hasn’t liked Alice yet, an entry is made in the LikesCache for Alice liking Bob.")]),e._v(" "),a("h3",{attrs:{id:"matches-data-model"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#matches-data-model"}},[e._v("#")]),e._v(" Matches Data Model")]),e._v(" "),a("p",[e._v("We can use a key-value store (e.g. Amazon DynamoDB) to persist the information about\nmatches (users liking each other). The hash key used for this data store can be a composite\nkey of the unique identifiers of the users who liked each other. The value in the data-store\nwill contain metadata information related to the match.")]),e._v(" "),a("table",[a("tr",[a("th",[e._v("Key")]),e._v(" "),a("th",[e._v("Value")])]),e._v(" "),a("tr",[a("td",[e._v("\n    userId1_userId2\n    "),a("br"),e._v("\n    (e.g AWDGT567RTH_ARTHT567WDG)\n    ")]),e._v(" "),a("td",[a("code",[a("pre",[e._v('{\n    "matchTimestamp": T2,\n    "likes": [\n        {\n            "likeId": "AWDGT567RTH",\n            "userLikeId": "ARTHT567WDG",\n            "timestamp": T1\n        },\n        {\n            "likeId": "ARTHT567WDG",\n            "userLikeId": "AWDGT567RTH",\n            "timestamp": T2\n        },\n    ]\n}\n        ')])])])])]),e._v(" "),a("p",[a("img",{attrs:{src:s(1115),alt:"alt"}}),a("br"),e._v(" "),a("em",[e._v("Figure 9.8: User switching locations")])]),e._v(" "),a("h3",{attrs:{id:"user-switching-locations"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#user-switching-locations"}},[e._v("#")]),e._v(" User Switching Locations")]),e._v(" "),a("p",[e._v("When a user changes locations it has to be ensured to provide recommendations to the user\nfrom the new location and vice-versa. The user location gets updated to the new location so\nthat the updated location is used for fetching recommendations for the user. Additionally,\nthe index mapped is also updated to user’s new location with user’s information so the user\nshows up in recommendations at the location. This process gets executed asynchronously.")]),e._v(" "),a("p",[e._v("The elastic search cluster (explained below) containing the geo-sharded indexes which\nreads the message from a queue to update user’s index. The elastic search is co-ordinating\nnodes moving the user’s information from the index mapped to user’s old location to the\nindex mapped to user’s new location. This ensures that the user shows up in recommendations of other users in the new location.")]),e._v(" "),a("h3",{attrs:{id:"elastic-search-cluster"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#elastic-search-cluster"}},[e._v("#")]),e._v(" Elastic Search Cluster")]),e._v(" "),a("p",[e._v("The cluster will comprise of multiple master nodes, each having two auto-scaling groups(ASG),\none containing only coordinating nodes (this is where all the requests are sent) and another\ncontaining all the data nodes. Each data node will contain certain number of indexes (combination of primaries and replicas) of randomly distributed shards. For each user query,\nthe responsibility of the co-ordinating node is to query the data-nodes of the target shards\nfor handling the user query. The increase in reliability and robustness of the elastic search\ncluster by sharding the user data using their geographical locations and creating replicas of\nthose shards.")]),e._v(" "),a("h2",{attrs:{id:"optimization"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#optimization"}},[e._v("#")]),e._v(" Optimization")]),e._v(" "),a("p",[a("img",{attrs:{src:s(1116),alt:"alt"}}),a("br"),e._v(" "),a("em",[e._v("Figure 9.9: Geo-sharded cluster architecture")])]),e._v(" "),a("p",[e._v("One of the most important aspects of an application like Tinder is the recommendations\n(of potential matches) it is provide to a user. In one the sections above, it shown how\nto generate recommendations for a user by querying indexes corresponding to the nearby\ngeo-shards of a user. The system can be optimized by applying machine learning to rank the recommendations. The machine learning model will optimize on the user’s potential\nto right swipe recommended potential matches. The features which may impact user’s\ndecision to swipe left or right are listed below:")]),e._v(" "),a("ul",[a("li",[a("strong",[e._v("User demographics data")]),e._v(": Age, Gender, Race, Location, Profession and so forth")]),e._v(" "),a("li",[a("strong",[e._v("User’s Tinder history data")]),e._v(": Swipe Left, Swipe Rights, Historical geo-locations, Daily usage time")]),e._v(" "),a("li",[a("strong",[e._v("Extracted Information from User’s Bio")]),e._v(": Likes, Dislikes, Preferences")]),e._v(" "),a("li",[a("strong",[e._v("Extracted Information from user’s pictures")]),e._v(": Facial features, Hair color, Body type")])]),e._v(" "),a("p",[e._v("A regression problem can be framed by using these features to find the probability that\nthe user will swipe right a recommendation. We can then leverage algorithms such as\nLogistic Regression to compute those probabilities, which will be used for ranking the\nrecommendations. In addition to this, we can also optimize the mechanism to send match\nnotifications to user by prefetching the information that a user has been swiped right by a\nrecommended user. Pre-fetching this information, we can notify the user about a match (if\nand when it occurs) right-away, hence preventing the network call. For instance, if Alice is\nshown in Bob’s recommendation and Alice has already swiped Bob right then Bob gets an\ninstantaneous match notification (without any network hop) in case Bob swipes Alice right\ntoo.")]),e._v(" "),a("h2",{attrs:{id:"fitness-check-up"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#fitness-check-up"}},[e._v("#")]),e._v(" Fitness check up")]),e._v(" "),a("ol",[a("li",[e._v("Why are we geo-sharded index for storing generating recommendations for user?\n"),a("ul",[a("li",[e._v("(a) Usage of geo-sharded index optimizes the query performance to fetch user recommendations")]),e._v(" "),a("li",[e._v("(b) It doesn’t provide a major advantage and we will be better off using a data store.")])])]),e._v(" "),a("li",[e._v("What is the main advantage of using a composite key of the userIds who liked each other in the MatchesDB?\n"),a("ul",[a("li",[e._v("(a) It helps prevent hot partition problems.")]),e._v(" "),a("li",[e._v("(b) It optimizes the query performance to fetch the matches of a given user.")])])])])])}),[],!1,null,null,null);t.default=n.exports}}]);