(window.webpackJsonp=window.webpackJsonp||[]).push([[17],{1633:function(e,a,t){"use strict";t.r(a);var s=t(7),i=Object(s.a)({},(function(){var e=this,a=e.$createElement,s=e._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("h1",{attrs:{id:"distributed-email-service"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#distributed-email-service"}},[e._v("#")]),e._v(" Distributed Email Service")]),e._v(" "),s("p",[e._v("In this chapter we design a large-scale email service, such as Gmail, Outlook, or Yahoo Mail. The growth of the Internet has led to an explosion in the volume of emails. In 2020, Gmail had over 1.8 billion active users andOutlook had over 400 million users worldwide.")]),e._v(" "),s("p",[s("img",{attrs:{src:t(811),alt:"Figure 1"}}),s("br"),e._v(" "),s("em",[e._v("Figure 1 Popular email providers")])]),e._v(" "),s("h2",{attrs:{id:"step-1-understand-the-problem-and-establish-design-scope"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#step-1-understand-the-problem-and-establish-design-scope"}},[e._v("#")]),e._v(" Step 1 - Understand the Problem and Establish Design Scope")]),e._v(" "),s("p",[e._v("Over the years, email services have changed significantly in complexity and scale. A modem email service  is a complex system with many features. There is no way we can design a real-world system in 45 minutes. So before jumping into the design, we definitely want to ask clarifying questions to narrow down the scope.")]),e._v(" "),s("p",[s("strong",[e._v("Candidate")]),e._v(": How many people use the product?"),s("br"),e._v(" "),s("strong",[e._v("Interviewer")]),e._v(": One billion users.")]),e._v(" "),s("p",[s("strong",[e._v("Candidate")]),e._v(": I think the following features are important:")]),e._v(" "),s("ul",[s("li",[e._v("Authentication.")]),e._v(" "),s("li",[e._v("Send and receive emails.")]),e._v(" "),s("li",[e._v("Fetch all emails.")]),e._v(" "),s("li",[e._v("Filter emails by read and unread status.")]),e._v(" "),s("li",[e._v("Search emails by subject, sender, and body.")]),e._v(" "),s("li",[e._v("Anti-spam and anti-virus.")])]),e._v(" "),s("p",[s("strong",[e._v("Interviewer")]),e._v(": That's a good list. We don’t need to worry about authentication. Let's focus on the other  features you mentioned.")]),e._v(" "),s("p",[s("strong",[e._v("Candidate")]),e._v(": How do users connect with mail servers?"),s("br"),e._v(" "),s("strong",[e._v("Interviewer")]),e._v(": Traditionally, users connect with mail servers through native clients that use SMTP, POP, IMAP, and vendor-specific protocols. Those protocols are legacy to some extent, yet still very popular. For this interview, let's assume HTTP is used for client and server communication.")]),e._v(" "),s("p",[s("strong",[e._v("Candidate")]),e._v(": Can emails have attachments?"),s("br"),e._v(" "),s("strong",[e._v("Interviewer")]),e._v(": Yes.")]),e._v(" "),s("h3",{attrs:{id:"non-functional-requirements"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#non-functional-requirements"}},[e._v("#")]),e._v(" Non-functional requirements")]),e._v(" "),s("p",[e._v("Next, let's go over the most important non-functional requirements.")]),e._v(" "),s("p",[s("strong",[e._v("Reliability")]),e._v(". We should not lose email data.")]),e._v(" "),s("p",[s("strong",[e._v("Availability")]),e._v(". Email and user data should be automatically replicated across multiple nodes to ensure availability. Besides, the system should continue to function despite partial system failures.")]),e._v(" "),s("p",[s("strong",[e._v("Scalability")]),e._v(". As the number of users grows, the system should be able to handle the increasing number of users and emails. The performance of the system should not degrade with more users or emails.")]),e._v(" "),s("p",[s("strong",[e._v("Flexibility and extensibility")]),e._v(". A flexible/extensible system allows us to add new features or improve performance easily by adding new components. Traditional email protocols such as POP and IMAP have very limited functionality (more on this in high-level design). Therefore, we may need custom protocols to satisfy the flexibility and extensibility requirements.")]),e._v(" "),s("h3",{attrs:{id:"back-of-the-envelope-estimation"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#back-of-the-envelope-estimation"}},[e._v("#")]),e._v(" Back-of-the-envelope estimation")]),e._v(" "),s("p",[e._v("Let's do a back-of-the-envelope calculation to determine the scale and to discover some challenges our solution will need to address. By design, emails are storage heavy applications.")]),e._v(" "),s("ul",[s("li",[e._v("1 billion users.")]),e._v(" "),s("li",[e._v("Assume the average number of emails a person sends per day is 10. QPS for sending emails = 10^9 * 10 / (10~5) = 100,000.")]),e._v(" "),s("li",[e._v("Assume the average number of emails a person receives in a day is 40 [3] and the average size of email metadata is 50KB. Metadata refers to everything related to an email, excluding attachment files. Assume metadata is stored in a database. Storage requirement for maintaining metadata in 1 year: 1 billion\nusers * 40 emails / day * 365 days * 50 KB = 730 PB.")]),e._v(" "),s("li",[e._v("Assume 20% of emails contain an attachment and the average attachment size is 500 KB.")]),e._v(" "),s("li",[e._v("Storage for attachments in 1 year is: 1 billion users * 40 emails / day * 365 days * 20% * 500 KB = 1,460 PB")])]),e._v(" "),s("p",[e._v("From this back-of-the-envelope calculation, it's clear we would deal with a lot of data. So, it's likely that we need a distributed database solution.")]),e._v(" "),s("h2",{attrs:{id:"step-2-propose-high-level-design-and-get-buy-in"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#step-2-propose-high-level-design-and-get-buy-in"}},[e._v("#")]),e._v(" Step 2 - Propose High-Level Design and Get Buy-In")]),e._v(" "),s("p",[e._v("In this section, we first discuss some basics about email servers and how email servers evolve over time. Then we look at the high-level design of distributed email servers. The content is structured as follows:")]),e._v(" "),s("ul",[s("li",[e._v("Email knowledge 101")]),e._v(" "),s("li",[e._v("Traditional mail servers")]),e._v(" "),s("li",[e._v("Distributed mail servers")])]),e._v(" "),s("h3",{attrs:{id:"email-knowledge-101"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#email-knowledge-101"}},[e._v("#")]),e._v(" Email knowledge 101")]),e._v(" "),s("p",[e._v("There are various email protocols that are used to send and receive emails. Historically, most mail servers use email protocols such as POP, IMAP, and SMTP.")]),e._v(" "),s("h4",{attrs:{id:"email-protocols"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#email-protocols"}},[e._v("#")]),e._v(" Email protocols")]),e._v(" "),s("p",[s("strong",[e._v("SMTP")]),e._v(": Simple Mail Transfer Protocol (SMTP) is the standard protocol for sending emails from one mail server to another.")]),e._v(" "),s("p",[e._v("The most popular protocals for "),s("strong",[e._v("retrieving")]),e._v(" emails are known as Post Office Protocal (POP) and the Internet Mail Access Protocol (IMAP),")]),e._v(" "),s("p",[s("strong",[e._v("POP")]),e._v(" is a standard mail protocol to receive and download emails from a remote mail server to a local email client. Once emails are downloaded to your computer or phone, they are deleted from the email server, which means you can only access emails on one computer or phone. The details of POP are covered in RFC 1939 [4]. POP requires mail clients to download the entire email. This can take long time if an email contains a large attachment.")]),e._v(" "),s("p",[s("strong",[e._v("IMAP")]),e._v(" is also a standard mail protocol for receiving emails for a local email client. When you read an email, you are connected to an external mail server, and data is transferred to your local device. IMAP only downloads a message when you click it, and emails are not deleted from mail servers, meaning that you can access emails from multiple devices. IMAP is the most widely used protocol for individual email accounts. It works well when the connection is slow because only the email header information is downloaded until opened")]),e._v(" "),s("p",[s("strong",[e._v("HTTPS")]),e._v(" is not technically a mail protocol, but it can be used to access your mailbox, particularly for web-based email. For example, it's common for Microsoft Outlook to talk to mobile devices over HTTPS, on a custom-made protocol called ActiveSync [5].")]),e._v(" "),s("h4",{attrs:{id:"domain-name-service-dns"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#domain-name-service-dns"}},[e._v("#")]),e._v(" Domain name service (DNS)")]),e._v(" "),s("p",[e._v("A DNS server is used to look up the mail exchanger record (MX record) for the recipient’s domain. If you run DNS lookup for gmail.com from the command line, you may get MX records as shown in Figure 2.")]),e._v(" "),s("p",[s("img",{attrs:{src:t(812),alt:"Figure 2"}}),s("br"),e._v(" "),s("em",[e._v("Figure 2 MX records")])]),e._v(" "),s("p",[e._v("The priority numbers indicate preferences, where the mail server with a lower priority number is more preferred. In\nFigure 2, gmail-smtp-in..google.com is used first (priority 5). A sending mail server will attempt to connect and\nsend messages to this mail server first. If the connection fails, the sending mail server will attempt to connect to the\nmail server with the next lowest priority, which is alt.gmail-smtp-in..google.com (priority 10).")]),e._v(" "),s("h4",{attrs:{id:"attachment"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#attachment"}},[e._v("#")]),e._v(" Attachment")]),e._v(" "),s("p",[e._v("An email attachment is sent along with an email message, commonly with Base64 encoding [6]. There is usually a\nsize limit for an email attachment. For example, Outlook and Gmail limit the size of attachments to 20MB and 25M8\nrespectively as of June 2021. This number is highly configurable and varies from individual to corporate accounts.\nMultipurpose Internet Mail Extension (MIME) [7] is a specification that allows the attachment to be sent over the\ninternet.")]),e._v(" "),s("h3",{attrs:{id:"traditional-mail-servers"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#traditional-mail-servers"}},[e._v("#")]),e._v(" Traditional mail servers")]),e._v(" "),s("p",[e._v("Before we dive into distributed mail servers, let's dig a little bit through the history and see how traditional mail\nservers work, as doing so provides good lessons about how to scale an email server system. You can consider a\ntraditional mail server as a system that works when there are limited email users, usually on single server.")]),e._v(" "),s("h4",{attrs:{id:"traditional-mail-server-architecture"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#traditional-mail-server-architecture"}},[e._v("#")]),e._v(" Traditional mail server architecture")]),e._v(" "),s("p",[e._v("Figure 3 describes what happens when Alice sends an email to Bob, using traditional email servers.")]),e._v(" "),s("p",[s("img",{attrs:{src:t(813),alt:"Figure 3"}}),s("br"),e._v(" "),s("em",[e._v("Figure 3 Tranditional mail servers")])]),e._v(" "),s("p",[e._v("The process consists of 4 steps:")]),e._v(" "),s("ol",[s("li",[e._v("Alice logs in to her Outlook client, composes an email, and presses the “send” button. The email is sent to the\nOutlook mail server. The communication protocol between the Outlook client and the mail server is SMTP.")]),e._v(" "),s("li",[e._v("Outlook mail server queries the DNS (not shown in the diagram) to find the address of the recipient's SMTP\nserver. In this case, it is Gmail's SMTP server. Next, it transfers the email to the Gmail mail server. The\ncommunication protocol between the mail servers is SMTP.")]),e._v(" "),s("li",[e._v("The Gmail server stores the email and makes it available to Bob, the recipient")]),e._v(" "),s("li",[e._v("Gmail client fetches new emails through the IMAP/POP server when Bob logs in to Gmail")])]),e._v(" "),s("h4",{attrs:{id:"storage"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#storage"}},[e._v("#")]),e._v(" Storage")]),e._v(" "),s("p",[e._v("In a traditional mail server, emails were stored in local file directories and each email was stored in a separate file\nwith a unique name. Each user maintained a user directory to store configuration data and mailboxes. Maildir was a\npopular way to store email messages on the mail server (Figure 4)")]),e._v(" "),s("p",[s("img",{attrs:{src:t(814),alt:"Figure 4"}}),s("br"),e._v(" "),s("em",[e._v("Figure 4 Maildir")])]),e._v(" "),s("p",[e._v("File directories worked well when the user base was small, but it was challenging to retrieve and backup billions of\nemails. As the email volume grew and the file structure became more complex, disk I/O became a bottleneck. The\nlocal directories also don't satisfy our high availability and reliability requirements. The disk can be damaged and\nservers can go down. We need a more reliable distributed storage layer.")]),e._v(" "),s("p",[e._v("Email functionality has come a long way since it was invented in the 1960s, from text-based format to rich features\nsuch as multimedia, threading [8], search, labels, and more. But email protocols (POP, IMAP, and SMTP) were\ninvented a long time ago and they were not designed to support these new features, nor were they scalable to\nsupport billions of users.")]),e._v(" "),s("h3",{attrs:{id:"distributed-mail-servers"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#distributed-mail-servers"}},[e._v("#")]),e._v(" Distributed mail servers")]),e._v(" "),s("p",[e._v("Distributed mail servers are designed to support modern use cases and solve the problems of scale and resiliency.\nThis section covers email APIs, distributed email server architecture, email sending, and email receiving flows.")]),e._v(" "),s("h4",{attrs:{id:"email-apis"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#email-apis"}},[e._v("#")]),e._v(" Email APIs")]),e._v(" "),s("p",[e._v("Email APIs can mean very different things for different mail clients, or at different stages of an email's life cycle. For example:")]),e._v(" "),s("ul",[s("li",[e._v("SMTP/POP/IMAP APIs for native mobile clients.")]),e._v(" "),s("li",[e._v("SMTP communications between sender and receiver mail servers.")]),e._v(" "),s("li",[e._v("RESTful API over HTTP for full-featured and interactive web-based email applications.")])]),e._v(" "),s("p",[e._v("Due to the length limitations of this book, we cover only some of the most important APIs for webmail. A common way for webmail to communicate is through the HTTP protocol.")]),e._v(" "),s("ol",[s("li",[s("p",[e._v("Endpoint: "),s("code",[e._v("POST /v1/messages")]),e._v("\nSends a message to the recipients in the To, Cc, and Bcc headers.")])]),e._v(" "),s("li",[s("p",[e._v("Endpoint: "),s("code",[e._v("GET /v1/folders")])])])]),e._v(" "),s("p",[e._v("Returns all folders of an email account.")]),e._v(" "),s("p",[s("strong",[e._v("Response")]),e._v(":")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("[{\n    id: string      Unique folder identifier.\n    name: string    Name of the folder.\n                    According to RFC6154 [9], the default folders can be one of\n                    the following: All, Archive, Drafts, Flagged, Junk, Sent,\n                    and Trash.\n    user_id: string Reference to the account owner\n}]\n")])])]),s("ol",{attrs:{start:"3"}},[s("li",[e._v("Endpoint: "),s("code",[e._v("GET /v1/folders/{:folder_id}/messages")])])]),e._v(" "),s("p",[e._v("Returns all messages under a folder. Keep in mind this is a highly simplified AP In reality, this needs to support pagination.\n"),s("strong",[e._v("Response")]),e._v(":\nList of message objects.")]),e._v(" "),s("ol",{attrs:{start:"4"}},[s("li",[e._v("Endpoint: "),s("code",[e._v("GET /v1/messages/{:message_id}")])])]),e._v(" "),s("p",[e._v("Gets all information about a specific message. Messages are core building blocks for an email application, containing information about the sender, recipients, message subject, body, attachments, etc.")]),e._v(" "),s("p",[s("strong",[e._v("Response")]),e._v(":")]),e._v(" "),s("p",[e._v("A message’s object.")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("{\n    user_id: string                     // Reference to the account ouner.\n    from: {name: string, email: string} // <name, email> pair of the sender.\n    to: [{name: string, email: string}] // A list of <name, email> paris\n    subject: string                     // subject of an email\n    body: string                        // Message body\n    is_read: boolean                    // Indicate if a message is read or not.\n}\n")])])]),s("h4",{attrs:{id:"distributed-mail-server-architecture"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#distributed-mail-server-architecture"}},[e._v("#")]),e._v(" Distributed mail server architecture")]),e._v(" "),s("p",[e._v("While it is easy to set up an email server that handles a small number of users, it is difficult to scale beyond one\nserver. This is mainly because traditional email servers were designed to work with a single server only.")]),e._v(" "),s("p",[e._v("Synchronizing data across servers can be difficult, and keeping emails from being misclassified as spam by\nrecipients’ mail servers is very challenging. In this section, we explore how to leverage cloud technologies to make it\neasier. The high-level design is shown in Figure 5.")]),e._v(" "),s("p",[s("img",{attrs:{src:t(815),alt:"Figure 5"}}),s("br"),e._v(" "),s("em",[e._v("Figure 5 High-level design")])]),e._v(" "),s("p",[e._v("Let us take a close look at each component.")]),e._v(" "),s("p",[s("strong",[e._v("Webmail")]),e._v(". Users use web browsers to receive and send emails.")]),e._v(" "),s("p",[s("strong",[e._v("Web servers")]),e._v(". Web servers are public-facing request/response services, used to manage features such as login,\nsignup, user profile, etc. In our design, all email AP requests, such as sending an email, loading mail folders, loading\nall mails in a folder, etc., go through web servers.")]),e._v(" "),s("p",[s("strong",[e._v("Real-time servers")]),e._v(". Real-time servers are responsible for pushing new email updates to clients in real-time. Real-\ntime servers are stateful servers because they need to maintain persistent connections. To support real-time\ncommunication we have a few options, such as long polling and WebSocket. WebSocket is a more elegant solution,\nbut one drawback of it is browser compatibility. A possible solution is to establish a WebSocket connection\nwhenever possible and to use long-polling as a fallback.")]),e._v(" "),s("p",[e._v("Here is an example of a real-world mail server (Apache James [10]) that implements the JSON Meta Application\nProtocol (IMAP) subprotocol over WebSocket [11],")]),e._v(" "),s("p",[s("strong",[e._v("Metadata database")]),e._v(". This database stores mail metadata including mail subject, body, from user, to users, etc. We\ndiscuss the database choice in the deep dive section")]),e._v(" "),s("p",[s("strong",[e._v("Attachment store")]),e._v(". We choose object stores such as Amazon Simple Storage Service (S3) as the attachment store.\nS3 is a scalable storage infrastructure that's suitable for storing large files such as images, videos, files, etc.\nAttachments can take up to 25MB in size. NoSQL column-family databases like Cassandra might not be a good fit\nfor the following two reasons:")]),e._v(" "),s("ul",[s("li",[e._v("Even though Cassandra supports blob data type and its maximum theoretical size for a blob is 2GB, the practical limit is less than 1MB [12].")]),e._v(" "),s("li",[e._v("Another problem with putting attachments in Cassandra is that we can't use a row cache as attachments take too much memory space.")])]),e._v(" "),s("p",[s("strong",[e._v("Distributed cache.")]),e._v(" Since the most recent emails are repeatedly loaded by a client, caching recent emails in\nmemory significantly improves the load time. We can use Redis here because it offers rich features such as lists and\nit is easy to scale.")]),e._v(" "),s("p",[s("strong",[e._v("Search store.")]),e._v(" The search store is a distributed document store. It uses a data structure called inverted index [13]\nthat supports very fast full-text searches. We will discuss this in more detail in the deep dive section")]),e._v(" "),s("p",[e._v("Now that we have discussed some of the most important components to build distributed mail servers, let's assemble together two main workflows.")]),e._v(" "),s("ul",[s("li",[e._v("Email sending flow.")]),e._v(" "),s("li",[e._v("Email receiving flow,")])]),e._v(" "),s("h4",{attrs:{id:"email-sending-flow"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#email-sending-flow"}},[e._v("#")]),e._v(" Email sending flow")]),e._v(" "),s("p",[e._v("The email sending flow is shown in Figure 6.")]),e._v(" "),s("p",[s("img",{attrs:{src:t(816),alt:"Figure 6"}}),s("br"),e._v(" "),s("em",[e._v("Figure 6 Email sending flow")])]),e._v(" "),s("ol",[s("li",[e._v("A user writes an email on webmail and presses the “send” button. The request is sent to the load balancer.")]),e._v(" "),s("li",[e._v("The load balancer makes sure it doesn't exceed the rate limit and routes traffic to web servers.")]),e._v(" "),s("li",[e._v("Web servers are responsible for:\n"),s("ul",[s("li",[e._v("3a. Basic email validation. Each incoming email is checked against pre-defined rules such as email size limit.")]),e._v(" "),s("li",[e._v("3b. Checking if the domain of the recipient's email address is the same as the sender. If it is the same, the web server ensures the email data is spam and virus free. If so, email data is inserted into the sender’s “Sent Folder” and recipient’s “Inbox Folder”. The recipient can fetch the email directly via the RESTiul API. There is no need to go to step 4")])])]),e._v(" "),s("li",[e._v("Message queues\n"),s("ul",[s("li",[e._v("4a. If basic email validation succeeds, the email data is passed to the outgoing queue. If the attachment is too large to fit in the queue, we could store the attachment in the object store and save the object reference in the queued message")]),e._v(" "),s("li",[e._v("4p.If basic email validation fails, the email is put in the error queue.")])])]),e._v(" "),s("li",[e._v("SMTP outgoing workers pull messages from the outgoing queue and make sure emails are spam and virus free.")]),e._v(" "),s("li",[e._v("The outgoing email is stored in the “Sent Folder” of the storage layer.")]),e._v(" "),s("li",[e._v("SMTP outgoing workers send the email to the recipient mail server.")])]),e._v(" "),s("p",[e._v("Each message in the outgoing queue contains all the metadata required to create an email. A distributed message queue is a critical component that allows asynchronous mail processing. By decoupling SMTP outgoing workers from the web servers, we can scale SMTP outgoing workers independently.")]),e._v(" "),s("p",[e._v("We monitor the size of the outgoing queue very closely. If there are many emails stuck in the queue, we need to analyze the cause of the issue. Here are some possibilities:")]),e._v(" "),s("ul",[s("li",[e._v("The recipient's mail server is unavailable. In this case, we need to retry sending the email at a later time. Exponential backoff [14] might be a good retry strategy.")]),e._v(" "),s("li",[e._v("Not enough consumers to send emails. In this case, we may need more consumers to reduce the processing time.")])]),e._v(" "),s("h4",{attrs:{id:"email-receiving-flow"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#email-receiving-flow"}},[e._v("#")]),e._v(" Email receiving flow")]),e._v(" "),s("p",[e._v("The following diagram demonstrates the email receiving flow.")]),e._v(" "),s("p",[s("img",{attrs:{src:t(817),alt:"Figure 7"}}),s("br"),e._v(" "),s("em",[e._v("Figure 7 Email receiving flow")])]),e._v(" "),s("ol",[s("li",[e._v("Incoming emails arrive at the SMTP load balancer.")]),e._v(" "),s("li",[e._v("The load balancer distributes traffic among SMTP servers. Email acceptance policy can be configured and applied at the SMTP-connection level. For example, invalid emails are bounced to avoid unnecessary email processing.")]),e._v(" "),s("li",[e._v("If the attachment of an email is too large to put into the queue, we can put it into the attachment store (s3).")]),e._v(" "),s("li",[e._v("Emails are put in the incoming email queue. The queue decouples mail processing workers from SMTP servers so they can be scaled independently. Moreover, the queue serves as a buffer in case the email volume surges.")]),e._v(" "),s("li",[e._v("Mail processing workers are responsible for a lot of tasks, including filtering out spam mails, stopping viruses,\netc. The following steps assume an email passed the validation.")]),e._v(" "),s("li",[e._v("The email is stored in the mail storage, cache, and object data store,")]),e._v(" "),s("li",[e._v("If the receiver is currently online, the email is pushed to real-time servers.")]),e._v(" "),s("li",[e._v("Real-time servers are WebSocket servers that allow clients to receive new emails in real-time.")]),e._v(" "),s("li",[e._v("For offline users, emails are stored in the storage layer. When a user comes back online, the webmail client\nconnects to web servers via RESTful API.")]),e._v(" "),s("li",[e._v("Web servers pull new emails from the storage layer and return them to the client.")])]),e._v(" "),s("h2",{attrs:{id:"step-3-design-deep-dive"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#step-3-design-deep-dive"}},[e._v("#")]),e._v(" Step 3 - Design Deep Dive")]),e._v(" "),s("p",[e._v("Now that we have talked about all the parts of the email server, let's go deeper into some key components and  examine how to scale the system.")]),e._v(" "),s("h3",{attrs:{id:"metadata-database"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#metadata-database"}},[e._v("#")]),e._v(" Metadata database")]),e._v(" "),s("ul",[s("li",[e._v("Search")]),e._v(" "),s("li",[e._v("Deliverability")]),e._v(" "),s("li",[e._v("Scalability")])]),e._v(" "),s("h4",{attrs:{id:"metadata-database-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#metadata-database-2"}},[e._v("#")]),e._v(" Metadata database")]),e._v(" "),s("p",[e._v("In this section, we discuss the characteristics of email metadata, choosing the right database, data model, and conversation threads (bonus point).")]),e._v(" "),s("p",[s("strong",[e._v("Characteristics of email metadata")])]),e._v(" "),s("ul",[s("li",[e._v("Email headers are usually small and frequently accessed.")]),e._v(" "),s("li",[e._v("Email body sizes can range from small to big but are infrequently accessed. You normally only read an email once.")]),e._v(" "),s("li",[e._v("Most of the mail operations, such as fetching mails, marking an email as read, and searching are isolated to an individual user. In other words, mails owned by a user are only accessible by that user and all the mail operations are performed by the same user.")]),e._v(" "),s("li",[e._v("Data recency impacts data usage. Users usually only read the most recent emails. 82% of read queries are for data younger than 16 days [15].")]),e._v(" "),s("li",[e._v("Data has high-reliability requirements. Data loss is not acceptable.")])]),e._v(" "),s("p",[s("strong",[e._v("Choosing the right database")])]),e._v(" "),s("p",[e._v("At Gmail or Outlook scale, the database system is usually custom-made to reduce input/output operations per second (IOPS) [16], s this can easily become a major constraint in the system. Choosing the right database is not easy. It is helpful to consider all the options we have on the table before deciding the most suitable one.")]),e._v(" "),s("ul",[s("li",[e._v("Relational database. The main motivation behind this is to search through emails efficiently. We can build\nindexes for email header and body. With indexes, simple search queries are fast. However, relational databases\nare typically optimized for small chunks of data entries and are not ideal for large ones. A typical email is\nusually larger than a few KB and can easily be over 100KB when HTML is involved. You might argue that the\nBLOB data type is designed to support large data entries. However, search queries over unstructured BLOB data\ntype are not efficient. So relational databases such as MySQL or PostgreSQL are not good fits.")]),e._v(" "),s("li",[e._v("Distributed object storage. Another potential solution is to store raw emails in cloud storage such as Amazon S3, which can be a good option for backup storage, but it's hard to efficiently support features such as marking\nemails as read, searching emails based on keywords, threading emails, etc.")]),e._v(" "),s("li",[e._v("NoSQL databases. Google Bigtable is used by Gmail, so it's definitely a viable solution. However, Bigtable is not\nopen sourced and how email search is implemented remains a mystery. Cassandra might be a good option as\nwell, but we haven't seen any large email providers use it yet.")])]),e._v(" "),s("p",[e._v("Based on the above analysis, very few existing solutions seem to fit our needs perfectly. Large email service\nproviders tend to build their own highly customized databases. However, in an interview setting, we won't have\ntime to design a new distributed database, but it's important to explain the following characteristics that the\ndatabase should have.")]),e._v(" "),s("ul",[s("li",[e._v("A single column can be a single-digit of MB.")]),e._v(" "),s("li",[e._v("Strong data consistency.")]),e._v(" "),s("li",[e._v("Designed to reduce disk I/O")]),e._v(" "),s("li",[e._v("It should be highly available and fault-tolerant.")]),e._v(" "),s("li",[e._v("It should be easy to create incremental backups.")])]),e._v(" "),s("h4",{attrs:{id:"data-model"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#data-model"}},[e._v("#")]),e._v(" Data model")]),e._v(" "),s("p",[e._v("One way to store the data is to use user_id as a partition key so data for one user is stored on single shard. One\nlimitation of this data model is that messages are not shared among multiple users. Since this is not a requirement\nfor us in this interview, it's not something we need to worry about")]),e._v(" "),s("p",[e._v("Now let us define the tables. The primary key contains two companents, the partition key, and the clustering key.")]),e._v(" "),s("ul",[s("li",[e._v("Partition key: responsible for distributing data across nodes. As a general rule, we want to spread the data evenly.")]),e._v(" "),s("li",[e._v("Clustering key: responsible for sorting data within a partition.")])]),e._v(" "),s("p",[e._v("At a high level, an email service needs to support the following queries at the data layer:")]),e._v(" "),s("ul",[s("li",[e._v("The first query is to get all folders for a user.")]),e._v(" "),s("li",[e._v("The second query is to display all emails for a specific folder.")]),e._v(" "),s("li",[e._v("The third query is to create/delete/get a specific email.")]),e._v(" "),s("li",[e._v("The fourth query is to fetch all read or unread emails")]),e._v(" "),s("li",[e._v("Bonus point: get conversation threads.")])]),e._v(" "),s("p",[e._v("Let's take a look at them ane by one.")]),e._v(" "),s("p",[s("strong",[e._v("Query 1: get all folders for a user.")])]),e._v(" "),s("p",[e._v("As shown in Table 1, user_id is the partition key, so folders owned by the same user are located in one partition.")]),e._v(" "),s("p",[s("img",{attrs:{src:t(818),alt:"img"}}),s("br"),e._v(" "),s("em",[e._v("Table 1 Folders by user")])]),e._v(" "),s("p",[s("strong",[e._v("Query 2: display all emails for a specific folder.")])]),e._v(" "),s("p",[e._v("When a user loads their inbox, emails are usually sorted by timestamp, showing the most recent at the top. In order to store all emails for the same folder in one partition, composite partition key "),s("code",[e._v("<user.id, folder_id>")]),e._v("is used. Another column to note is email_id. Its data type is TIMEUUID [17], and it is the clustering key used to sort emails in chronological order.")]),e._v(" "),s("p",[s("img",{attrs:{src:t(819),alt:"img"}}),s("br"),e._v(" "),s("em",[e._v("Table 2 Emails by folder")])]),e._v(" "),s("p",[s("strong",[e._v("Query 3: create/delete/get an email")])]),e._v(" "),s("p",[e._v("Due to space limitations, we only explain how to get detailed information about an email. The two tables in Table 3 are designed to support this query. The simple query looks like this:")]),e._v(" "),s("div",{staticClass:"language-sql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("SELECT")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("FROM")]),e._v(" emails_by_user "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("WHERE")]),e._v(" email id "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("123")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),s("p",[e._v("An email can have multiple attachments, and these can be retrieved by the combination of emaiL_id and filename fields.")]),e._v(" "),s("p",[s("img",{attrs:{src:t(820),alt:"img"}}),s("br"),e._v(" "),s("em",[e._v("Table 3 Emails by user")])]),e._v(" "),s("p",[s("strong",[e._v("Query 4: fetch all read or unread emails")])]),e._v(" "),s("p",[e._v("If our domain model was for a relational database, the query to fetch all read emails would ook like this:")]),e._v(" "),s("div",{staticClass:"language-sql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("SELECT")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("FROM")]),e._v(" emails_by_folder\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("WHERE")]),e._v(" user_id "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("user_id"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("and")]),e._v(" folder_id "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("folder_id"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("and")]),e._v(" is_read "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[e._v("true")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("ORDER")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("BY")]),e._v(" email_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),s("p",[e._v("The query to fetch all unread emails would ook very similar. We just need to change ‘is_read = true to is_read =\nfalse’ in the above query.")]),e._v(" "),s("p",[e._v("Our data model, however, is designed for NoSQL. A NoSQL database normally only supports queries on partition\nand cluster keys. Since is_read in the emails_by_folder table is neither of those, most NoSQL databases will reject\nthis query.")]),e._v(" "),s("p",[e._v("One way to get around this limitation is to fetch the entire folder for a user and perform the filtering in the\napplication. This could work for a small email service, but at our design scale this does not work well.")]),e._v(" "),s("p",[e._v("This problem is commonly solved with denormalization in NoSQL. To support the read/unread queries, we denormalize the "),s("em",[e._v("emails_by_folder")]),e._v(" data into two tables as shown in Table 4.")]),e._v(" "),s("ul",[s("li",[e._v("read_emails: it stores all emails that are in read status.")]),e._v(" "),s("li",[e._v("unread_emails: it stores all emails that are in unread status")])]),e._v(" "),s("p",[e._v("To mark an UNREAD email as READ, the email is deleted from "),s("em",[e._v("unread_emails")]),e._v(" and then inserted to "),s("em",[e._v("read_emails")]),e._v(".")]),e._v(" "),s("p",[e._v("To fetch all unread emails for a specific folder, we can run a query like this:")]),e._v(" "),s("div",{staticClass:"language-sql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("SELECT")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("FROM")]),e._v(" unread_emails\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("WHERE")]),e._v(" user_id "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("user_id"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("and")]),e._v(" folder_id "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("folder_id"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("ORDER")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("BY")]),e._v(" email_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),s("p",[s("img",{attrs:{src:t(821),alt:"img"}}),s("br"),e._v(" "),s("em",[e._v("Table 3 Read and unread emails")])]),e._v(" "),s("p",[e._v("Denormalization as shown above is a common practice. It makes the application code more complicated and\nharder to maintain, but it improves the read performance of these queries at scale.")]),e._v(" "),s("p",[s("strong",[e._v("Bonus point: conversation threads")])]),e._v(" "),s("p",[e._v("Threads are a feature supported by many email clients. It groups email replies with their original message [8]. This allows users to retrieve all emails associated with one conversation. Traditionally, a thread is implemented using algorithms such as JWZ algorithm [18]. We will not go into detail about the algorithm, but just explain the core idea behind it. An email header generally contains the following three fields:")]),e._v(" "),s("div",{staticClass:"language-json extra-class"},[s("pre",{pre:!0,attrs:{class:"language-json"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"headers"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n        "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"Message-Id"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"<7BA@4B2A-430C-4D12-8B57-862103C34501@gmail.com>"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n        "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"In-Reply-To"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"<CAEWTXuPFN=LzECiDItgYoVue3kgFvInJUSHTt6TW@gmail.com>"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n        "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"References"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"<7BA@4B2A-430C-4D12-8857-862103C34501@gmail.com>"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),s("table",[s("thead",[s("tr",[s("th",[e._v("Message-Id")]),e._v(" "),s("th",[e._v("The value of a message ID. It is generated by a client while sending a message.")])])]),e._v(" "),s("tbody",[s("tr",[s("td",[e._v("In-Reply-To")]),e._v(" "),s("td",[e._v("The parent Message-Id to which the message replies.")])]),e._v(" "),s("tr",[s("td",[e._v("References")]),e._v(" "),s("td",[e._v("A list of message IDs related to a thread.")])])])]),e._v(" "),s("p",[s("em",[e._v("Table 5 Email header")])]),e._v(" "),s("p",[e._v("With these fields, an email client can reconstruct mail conversations from messages, if all messages in the reply\nchain are preloaded.")]),e._v(" "),s("h4",{attrs:{id:"consistency-trade-off"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#consistency-trade-off"}},[e._v("#")]),e._v(" Consistency trade-off")]),e._v(" "),s("p",[e._v("Distributed databases that rely on replication for high availability must make a fundamental trade-off between\nconsistency and availability. Correctness is very important for email systems, so by design we want to have a single\nprimary for any given mailbox. In the event of a failover, the mailbox isn't accessible by clients, so their sync/update\noperation is paused until failover ends. It trades availability in favor of consistency.")]),e._v(" "),s("h3",{attrs:{id:"email-deliverability"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#email-deliverability"}},[e._v("#")]),e._v(" Email deliverability")]),e._v(" "),s("p",[e._v("It s easy to set up a mail server and start sending emails. The hard part is to get emails actually delivered to a user's\ninbox. If an email ends up in the spam folder, it means there is a very high chance a recipient won't read it. Email\nspam is a huge issue. According to research done by Statista [19], more than 50% of all emails sent are spam. If we\nset up a new mail server, most likely our emails will end up in the spam folder because a new email server has no\nreputation. There are a couple of factors to consider to improve email deliverability.")]),e._v(" "),s("p",[s("strong",[e._v("Dedicated IPs")]),e._v(". It is recommended to have dedicated IP addresses for sending emails. Email providers are less likely\nto accept emails from new IP addresses that have no history.")]),e._v(" "),s("p",[s("strong",[e._v("Classify emails")]),e._v(". Send different categories of emails from different IP addresses. For example, you may want to\navoid sending marketing and important emails from the same servers because it might make ISPs mark all emails as\npromotional.")]),e._v(" "),s("p",[s("strong",[e._v("Email sender reputation")]),e._v(". Warm up new email server IP addresses slowly to build a good reputation, so big\nproviders such as Office365, Gmail, Yahoo Mail, etc. are less likely to put our emails in the spam folder. According to\nAmazon Simple Email Service [20], it takes about 2 to 6 weeks to warm up a new IP address\nBan spammers quickly. Spammers should be banned quickly before they have a significant impact on the server's\nreputation.")]),e._v(" "),s("p",[s("strong",[e._v("Feedback processing")]),e._v(". It's very important to set up feedback loops with ISPs so we can keep the complaint rate low\nand ban spam accounts quickly. If an email fails to deliver or a user complains, one of the following outcomes\noceurs:")]),e._v(" "),s("ul",[s("li",[e._v("Hard bounce. This means an email is rejected by an ISP because the recipient's email address is invalid.")]),e._v(" "),s("li",[e._v("Soft bounce. A soft bounce indicates an email failed to deliver due to temporary conditions, such as ISPs being to busy.")]),e._v(" "),s("li",[e._v('Complaint. This means a recipient clicks the "report spam” button.')])]),e._v(" "),s("p",[e._v("Figure 8 shows the process of collecting and processing bounces/complaints. We use separate queues for soft bounces, hard bounces, and complaints so they can be managed separately.")]),e._v(" "),s("p",[s("img",{attrs:{src:t(822),alt:"Figure 8"}}),s("br"),e._v(" "),s("em",[e._v("Figure 8 Handle feedback loop")])]),e._v(" "),s("p",[s("strong",[e._v("Email authentication.")]),e._v(" According to the 2018 data breach investigation report provided by Verizon, phishing and\npretexting represent 93% of breaches [21]. Some of the common techniques to combat phishing are: Sender Policy\nFramework (SPF) [22], DomainKeys Identified Mail (DKIM) [23], and Domain-based Message Authentication,\nReporting and Conformance (DMARC) [24].")]),e._v(" "),s("p",[e._v("Figure 9 shows an example header of a Gmail message. As you can see, the sender @infoé.citi.com is authenticated\nby SPF, DKIM, and DMARC.")]),e._v(" "),s("p",[s("img",{attrs:{src:t(823),alt:"Figure 9"}}),s("br"),e._v(" "),s("em",[e._v("Figure 9 An example of a Gmail header")])]),e._v(" "),s("p",[e._v("You don't need to remember all those terms. The important thing to keep in mind is that getting emails to work as\nintended is hard. It requires not only domain knowledge, but good relationships with ISPs.")]),e._v(" "),s("h3",{attrs:{id:"search"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#search"}},[e._v("#")]),e._v(" Search")]),e._v(" "),s("p",[e._v('Basic mail search refers to searching for emails that contain any of the entered keywords in the subject or body.\nMore advanced features include filtering by “From”, “Subject”, “Unread", or other attributes. On one hand, whenever\nan email is sent, received, or deleted, we need to perform reindexing. On the other hand, a search query is only run\nwhen a user presses the “search” button. This means the search feature in email systems has a lot more writes than\nreads. By comparison with Google search, email search has quite different characteristics, as shown in Table 6.')]),e._v(" "),s("table",[s("thead",[s("tr",[s("th",[e._v(".")]),e._v(" "),s("th",[e._v("Scope")]),e._v(" "),s("th",[e._v("Sorting")]),e._v(" "),s("th",[e._v("Accuracy")])])]),e._v(" "),s("tbody",[s("tr",[s("td",[e._v("Google search")]),e._v(" "),s("td",[e._v("The whole internet")]),e._v(" "),s("td",[e._v("Sort by relevance")]),e._v(" "),s("td",[e._v("Indexing generally takes time, so some items may not show in the  search result immediately.")])]),e._v(" "),s("tr",[s("td",[e._v("Email search")]),e._v(" "),s("td",[e._v("User's own email box")]),e._v(" "),s("td",[e._v("Sort by attributes such as time, has attachment, date within, is unread, etc.")]),e._v(" "),s("td",[e._v("Indexing should be near real-time, and the result has to be accurate.")])])])]),e._v(" "),s("p",[s("em",[e._v("Table 6 Google search vs email search")])]),e._v(" "),s("p",[e._v("To support search functionality, we compare two approaches: Elasticsearch and native search embedded in the datastore.")]),e._v(" "),s("p",[s("strong",[e._v("Option 1: Elasticsearch")])]),e._v(" "),s("p",[e._v("The high-level design for email search using Elasticsearch is shown in Figure 10. Because queries are mostly performed on the user's own email server, we can group underlying documents to the same node using "),s("em",[e._v("user_id")]),e._v(" as the partition key.")]),e._v(" "),s("p",[s("img",{attrs:{src:t(824),alt:"Figure 10"}}),s("br"),e._v(" "),s("em",[e._v("Figure 10 Elasticsearch")])]),e._v(" "),s("p",[e._v('When a user clicks the "search” button, the user waits until the search response is received. A search request is\nsynchronous. When events such as “send email’, “receive email” or “delete email” are triggered, nothing related to\nsearch needs to be retumed to the client. Reindexing is needed and it can be done with offline jobs. Kafka is used in\nthe design to decouple services that trigger reindexing, from services that actually perform reindexing.\nElasticsearch is the most popular search-engine database as of June 2021 [25] and it supports full-text search of\nemails very well. One challenge of adding Elasticsearch s to keep our primary email store in sync with it. One of the\nlargest email providers in China, Tencent QQ Email, uses Elasticsearch [26].')]),e._v(" "),s("p",[s("strong",[e._v("Option 2: Custom search solution")])]),e._v(" "),s("p",[e._v("Large-scale email providers usually develop their own custom search engines to meet their specific requirements.\nDesigning an email search engine is a very complicated task and is out of the scope of this chapter. Here we only\nbriefly touch on the disk I/O bottleneck, a primary challenge we will face for a custom search engine.")]),e._v(" "),s("p",[e._v("As shown in the back-of-the-envelope calculation, the size of the metadata and attachments added daily is at the\npetabyte (PB) level. Meanwhile, an email account can easily have over half a million emails. The main bottleneck of\nthe index server is usually disk I/O.")]),e._v(" "),s("p",[e._v("Since the process of building the index is write-heavy, 2 good strategy might be to use Log-Structured Merge-Tree\n(LSM) [27] to structure the index data on disk (Figure 11). The write path is optimized by only performing sequential\nwrites. LSM trees are the core data structure behind databases such as BigTable, Cassandra, and RocksDB. When a new email arrives, it is first added to level 0 in-memory cache, and when data size in memory reaches the predefined threshold, data is merged to the next level. Another reason to use LSM is to separate data that change frequently from those that don't. For example, email data usually doesn't change, but folder information tends to change more often due to different filter rules. In this case, we can separate them into two different sections, so thatif a request is related to a folder change, we change only the folder and leave the email data alone")]),e._v(" "),s("p",[e._v("If you are interested in reading more about email search, it s highly recommended you take a look at how search\nworks in Microsoft Exchange servers [28].")]),e._v(" "),s("p",[s("img",{attrs:{src:t(825),alt:"Figure 11"}}),s("br"),e._v(" "),s("em",[e._v("Figure 11 LSM tree")])]),e._v(" "),s("p",[e._v("Each approach has pros and cons:")]),e._v(" "),s("table",[s("thead",[s("tr",[s("th",[e._v("Feature")]),e._v(" "),s("th",[e._v("Elasticsearch")]),e._v(" "),s("th",[e._v("Custom search engine")])])]),e._v(" "),s("tbody",[s("tr",[s("td",[e._v("Scalability")]),e._v(" "),s("td",[e._v("Scalable to some extent.")]),e._v(" "),s("td",[e._v("Easier to scale as we can optimize the  system for the email use case.")])]),e._v(" "),s("tr",[s("td",[e._v("System complexity")]),e._v(" "),s("td",[e._v("Need to maintain 2 different systems: datastore & elasticsearch")]),e._v(" "),s("td",[e._v("One system")])]),e._v(" "),s("tr",[s("td",[e._v("Data consistency")]),e._v(" "),s("td",[e._v("2 copies of data. 1 in the metadata datastore & the other in Elasticsearch. Data consistency is hard to maintain")]),e._v(" "),s("td",[e._v("A single copy of data in the metadata datastore")])]),e._v(" "),s("tr",[s("td",[e._v("Data loss possible")]),e._v(" "),s("td",[e._v("No. Can rebuild the Elasticsearch index from the primary storage, in case of failure")]),e._v(" "),s("td",[e._v("No")])]),e._v(" "),s("tr",[s("td",[e._v("Developement effort")]),e._v(" "),s("td",[e._v("Easy to integrate. To support a large scale email search, a dedicated Elasticsearch team might be needed")]),e._v(" "),s("td",[e._v("Significant engineering effort is needed to develop a custom email search engine")])])])]),e._v(" "),s("p",[s("em",[e._v("Table 7 Elastic search vs custom search engine")])]),e._v(" "),s("p",[e._v("A general rule of thumb is that for a smaller scale email system, Elasticsearch is a good option as it's easy to\nintegrate and doesn't require significant engineering effort. For a larger scale, Elasticsearch might work, but we may\nneed a dedicated team to develop and maintain the email search infrastructure. To support an email system at\nGmail or Outlook scale, it might be a good idea to have a native search embedded in the database as opposed to\nthe separate indexing approach.")]),e._v(" "),s("h3",{attrs:{id:"scalability-and-availability"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#scalability-and-availability"}},[e._v("#")]),e._v(" Scalability and availability")]),e._v(" "),s("p",[e._v("Since data access patterns of individual users are independent of one another, we expect most components in the\nsystem are horizontally scalable.")]),e._v(" "),s("p",[e._v("For better availability, data is replicated across multiple data centers. Users communicate with a mail server that is\nphysically closer to them in the network topology. During a network partition, users can access messages from\nother data centers (Figure 12).")]),e._v(" "),s("p",[s("img",{attrs:{src:t(826),alt:"Figure 12"}}),s("br"),e._v(" "),s("em",[e._v("Figure 12 Multi-data center setup")])]),e._v(" "),s("h2",{attrs:{id:"step-4-wrap-up"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#step-4-wrap-up"}},[e._v("#")]),e._v(" Step 4 - Wrap Up")]),e._v(" "),s("p",[e._v("In this chapter, we have presented a design for building large-scale email servers. We started by gathering requirements and doing some back-of-the-envelope calculations to get a good idea of the scale. In the high-level design, we discussed how traditional email servers were designed and why they cannot satisfy modern use cases. We also discussed email APIs and high-level designs for sending and receiving flows. Finally, we dived deep into metadata database design, email deliverability, search, and scalability.")]),e._v(" "),s("p",[e._v("If there is extra time at the end of the interview, here are a few additional talking points:")]),e._v(" "),s("ul",[s("li",[e._v("Fault tolerance. Many parts of the system can fail, and you can talk about how to handle node failures, network issues, event delays, etc.")]),e._v(" "),s("li",[e._v("Compliance. Email service works all around the world and there are legal regulations to comply with. For instance, we need to handle and store personally identifiable information (Pll) from Europe in a way that complies with General Data Protection Regulation (GDPR) [29]. Legal intercept is another typical feature in this area [30].")]),e._v(" "),s("li",[e._v("Security. Email security is important because emails contain sensitive information. Gmail provides safety features such as phishing protections, safe browsing, proactive alerts, account safety, confidential mode, and email encryption [31].")]),e._v(" "),s("li",[e._v("Optimizations. Sometimes, the same email is sent to multiple recipients, and the same email attachment is stored several times in the object store (S3) in the group emails. One optimization we could do is to check the existence of the attachment in storage, before performing the expensive save operation.")])])])}),[],!1,null,null,null);a.default=i.exports},811:function(e,a,t){e.exports=t.p+"assets/img/f1.dc5bad37.png"},812:function(e,a,t){e.exports=t.p+"assets/img/f2.d4a61756.png"},813:function(e,a,t){e.exports=t.p+"assets/img/f3.8477b69e.png"},814:function(e,a,t){e.exports=t.p+"assets/img/f4.8c2453c3.png"},815:function(e,a,t){e.exports=t.p+"assets/img/f5.f339055c.png"},816:function(e,a,t){e.exports=t.p+"assets/img/f6.17ba4864.png"},817:function(e,a,t){e.exports=t.p+"assets/img/f7.6220355b.png"},818:function(e,a,t){e.exports=t.p+"assets/img/t1.74662d68.png"},819:function(e,a,t){e.exports=t.p+"assets/img/t2.611f6b9d.png"},820:function(e,a,t){e.exports=t.p+"assets/img/t3.73d4442b.png"},821:function(e,a,t){e.exports=t.p+"assets/img/t4.e017299c.png"},822:function(e,a,t){e.exports=t.p+"assets/img/f8.83f082a8.png"},823:function(e,a,t){e.exports=t.p+"assets/img/f9.1054dd21.png"},824:function(e,a,t){e.exports=t.p+"assets/img/f10.844f605a.png"},825:function(e,a,t){e.exports=t.p+"assets/img/f11.ecf683df.png"},826:function(e,a,t){e.exports=t.p+"assets/img/f12.4b6a1196.png"}}]);