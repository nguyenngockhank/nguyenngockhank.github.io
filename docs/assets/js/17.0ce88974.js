(window.webpackJsonp=window.webpackJsonp||[]).push([[17],{581:function(e,t,a){e.exports=a.p+"assets/img/image--009.292a0ee1.jpg"},582:function(e,t,a){e.exports=a.p+"assets/img/image--010.9bd8cb7b.jpg"},583:function(e,t,a){e.exports=a.p+"assets/img/image--011.b868fd28.jpg"},584:function(e,t,a){e.exports=a.p+"assets/img/image--012.606e5ae5.jpg"},585:function(e,t,a){e.exports=a.p+"assets/img/image--013.b663b501.jpg"},960:function(e,t,a){"use strict";a.r(t);var s=a(7),n=Object(s.a)({},(function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("h1",{attrs:{id:"chapter-3-more-details-on-data-models"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#chapter-3-more-details-on-data-models"}},[e._v("#")]),e._v(" Chapter 3. More Details on Data Models")]),e._v(" "),s("p",[e._v("So far we’ve covered the key feature in most NoSQL databases: their use of aggregates and how\naggregate-oriented databases model aggregates in different ways. While aggregates are a central part\nof the NoSQL story, there is more to the data modeling side than that, and we’ll explore these further\nconcepts in this chapter.")]),e._v(" "),s("h2",{attrs:{id:"_3-1-relationships"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-relationships"}},[e._v("#")]),e._v(" 3.1. Relationships")]),e._v(" "),s("p",[e._v("Aggregates are useful in that they put together data that is commonly accessed together. But there are\nstill lots of cases where data that’s related is accessed differently. Consider the relationship between\na customer and all of his orders. Some applications will want to access the order history whenever\nthey access the customer; this fits in well with combining the customer with his order history into a\nsingle aggregate. Other applications, however, want to process orders individually and thus model\norders as independent aggregates.")]),e._v(" "),s("p",[e._v("In this case, you’ll want separate order and customer aggregates but with some kind of relationship\nbetween them so that any work on an order can look up customer data. The simplest way to provide\nsuch a link is to embed the ID of the customer within the order’s aggregate data. That way, if you need\ndata from the customer record, you read the order, ferret out the customer ID, and make another call to\nthe database to read the customer data. This will work, and will be just fine in many scenarios—but\nthe database will be ignorant of the relationship in the data. This can be important because there are\ntimes when it’s useful for the database to know about these links.")]),e._v(" "),s("p",[e._v("As a result, many databases—even key-value stores—provide ways to make these relationships\nvisible to the database. Document stores make the content of the aggregate available to the database to\nform indexes and queries. Riak, a key-value store, allows you to put link information in metadata,\nsupporting partial retrieval and link-walking capability.")]),e._v(" "),s("p",[e._v("An important aspect of relationships between aggregates is how they handle updates. Aggregate-\noriented databases treat the aggregate as the unit of data-retrieval. Consequently, atomicity is only\nsupported within the contents of a single aggregate. If you update multiple aggregates at once, you\nhave to deal yourself with a failure partway through. Relational databases help you with this by\nallowing you to modify multiple records in a single transaction, providing ACID guarantees while\naltering many rows.")]),e._v(" "),s("p",[e._v("All of this means that aggregate-oriented databases become more awkward as you need to operate\nacross multiple aggregates. There are various ways to deal with this, which we’ll explore later in this\nchapter, but the fundamental awkwardness remains.")]),e._v(" "),s("p",[e._v("This may imply that if you have data based on lots of relationships, you should prefer a relational\ndatabase over a NoSQL store. While that’s true for aggregate-oriented databases, it’s worth\nremembering that relational databases aren’t all that stellar with complex relationships either. While\nyou can express queries involving joins in SQL, things quickly get very hairy—both with SQL writing\nand with the resulting performance—as the number of joins mounts up.")]),e._v(" "),s("p",[e._v("This makes it a good moment to introduce another category of databases that’s often lumped into\nthe NoSQL pile.")]),e._v(" "),s("h2",{attrs:{id:"_3-2-graph-databases"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-graph-databases"}},[e._v("#")]),e._v(" 3.2. Graph Databases")]),e._v(" "),s("p",[e._v("Graph databases are an odd fish in the NoSQL pond. Most NoSQL databases were inspired by the\nneed to run on clusters, which led to aggregate-oriented data models of large records with simple\nconnections. Graph databases are motivated by a different frustration with relational databases and\nthus have an opposite model—small records with complex interconnections, something like Figure\n3.1.")]),e._v(" "),s("p",[s("img",{attrs:{src:a(581),alt:"img"}})]),e._v(" "),s("p",[s("strong",[e._v("Figure 3.1. An example graph structure")])]),e._v(" "),s("p",[e._v("In this context, a graph isn’t a bar chart or histogram; instead, we refer to a graph data structure of\nnodes connected by edges.")]),e._v(" "),s("p",[e._v("In Figure 3.1 we have a web of information whose nodes are very small (nothing more than a name) but there is a rich structure of interconnections between them. With this structure, we can ask questions such as “"),s("em",[e._v("find the books in the Databases category that are written by someone whom a friend of mine likes.")]),e._v("”")]),e._v(" "),s("p",[e._v("Graph databases specialize in capturing this sort of information—but on a much larger scale than a\nreadable diagram could capture. This is ideal for capturing any data consisting of complex\nrelationships such as social networks, product preferences, or eligibility rules.")]),e._v(" "),s("p",[e._v("The fundamental data model of a graph database is very simple: nodes connected by edges (also\ncalled arcs). Beyond this essential characteristic there is a lot of variation in data models—in\nparticular, what mechanisms you have to store data in your nodes and edges. A quick sample of some\ncurrent capabilities illustrates this variety of possibilities: FlockDB is simply nodes and edges with\nno mechanism for additional attributes; Neo4J allows you to attach Java objects as properties to")]),e._v(" "),s("p",[e._v("nodes and edges in a schemaless fashion (“Features,” p. 113 ); Infinite Graph stores your Java objects,\nwhich are subclasses of its built-in types, as nodes and edges.")]),e._v(" "),s("p",[e._v("Once you have built up a graph of nodes and edges, a graph database allows you to query that\nnetwork with query operations designed with this kind of graph in mind. This is where the important\ndifferences between graph and relational databases come in. Although relational databases can\nimplement relationships using foreign keys, the joins required to navigate around can get quite\nexpensive—which means performance is often poor for highly connected data models. Graph\ndatabases make traversal along the relationships very cheap. A large part of this is because graph\ndatabases shift most of the work of navigating relationships from query time to insert time. This\nnaturally pays off for situations where querying performance is more important than insert speed.")]),e._v(" "),s("p",[e._v("Most of the time you find data by navigating through the network of edges, with queries such as\n“tell me all the things that both Anna and Barbara like.” You do need a starting place, however, so\nusually some nodes can be indexed by an attribute such as ID. So you might start with an ID lookup\n(i.e., look up the people named “Anna” and “Barbara”) and then start using the edges. Still, graph\ndatabases expect most of your query work to be navigating relationships.")]),e._v(" "),s("p",[e._v("The emphasis on relationships makes graph databases very different from aggregate-oriented\ndatabases. This data model difference has consequences in other aspects, too; you’ll find such\ndatabases are more likely to run on a single server rather than distributed across clusters. ACID\ntransactions need to cover multiple nodes and edges to maintain consistency. The only thing they have\nin common with aggregate-oriented databases is their rejection of the relational model and an upsurge\nin attention they received around the same time as the rest of the NoSQL field.")]),e._v(" "),s("h2",{attrs:{id:"_3-3-schemaless-databases"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-schemaless-databases"}},[e._v("#")]),e._v(" 3.3. Schemaless Databases")]),e._v(" "),s("p",[e._v("A common theme across all the forms of NoSQL databases is that they are schemaless. When you\nwant to store data in a relational database, you first have to define a schema—a defined structure for\nthe database which says what tables exist, which columns exist, and what data types each column can\nhold. Before you store some data, you have to have the schema defined for it.")]),e._v(" "),s("p",[e._v("With NoSQL databases, storing data is much more casual. A key-value store allows you to store\nany data you like under a key. A document database effectively does the same thing, since it makes no\nrestrictions on the structure of the documents you store. Column-family databases allow you to store\nany data under any column you like. Graph databases allow you to freely add new edges and freely\nadd properties to nodes and edges as you wish.")]),e._v(" "),s("p",[e._v("Advocates of schemalessness rejoice in this freedom and flexibility. With a schema, you have to\nfigure out in advance what you need to store, but that can be hard to do. Without a schema binding\nyou, you can easily store whatever you need. This allows you to easily change your data storage as\nyou learn more about your project. You can easily add new things as you discover them. Furthermore,\nif you find you don’t need some things anymore, you can just stop storing them, without worrying\nabout losing old data as you would if you delete columns in a relational schema.")]),e._v(" "),s("p",[e._v("As well as handling changes, a schemaless store also makes it easier to deal with "),s("strong",[e._v("nonuniform\ndata")]),e._v(" : data where each record has a different set of fields. A schema puts all rows of a table into a\nstraightjacket, which becomes awkward if you have different kinds of data in different rows. You\neither end up with lots of columns that are usually null (a sparse table), or you end up with\nmeaningless columns like custom column 4. Schemalessness avoids this, allowing each record to")]),e._v(" "),s("p",[e._v("contain just what it needs—no more, no less.")]),e._v(" "),s("p",[e._v("Schemalessness is appealing, and it certainly avoids many problems that exist with fixed-schema\ndatabases, but it brings some problems of its own. If all you are doing is storing some data and\ndisplaying it in a report as a simple list of fieldName: value lines then a schema is only going to\nget in the way. But usually we do with our data more than this, and we do it with programs that need\nto know that the billing address is called billingAddress and not addressForBilling and that the\nquantify field is going to be an integer 5 and not five.")]),e._v(" "),s("p",[e._v("The vital, if sometimes inconvenient, fact is that whenever we write a program that accesses data,\nthat program almost always relies on some form of implicit schema. Unless it just says something like")]),e._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("//pseudo code")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("foreach")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[e._v("Record r "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("in")]),e._v(" records")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("foreach")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[e._v("Field f "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("in")]),e._v(" r"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("fields")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("print")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("f"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" f"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("value"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),s("p",[e._v("it will assume that certain field names are present and carry data with a certain meaning, and assume\nsomething about the type of data stored within that field. Programs are not humans; they cannot read\n“qty” and infer that that must be the same as “quantity”—at least not unless we specifically program\nthem to do so. So, however schemaless our database is, there is usually an implicit schema present.\nThis "),s("strong",[e._v("implicit schema")]),e._v(" is a set of assumptions about the data’s structure in the code that manipulates the\ndata.")]),e._v(" "),s("p",[e._v("Having the implicit schema in the application code results in some problems. It means that in order\nto understand what data is present you have to dig into the application code. If that code is well\nstructured you should be able to find a clear place from which to deduce the schema. But there are no\nguarantees; it all depends on how clear the application code is. Furthermore, the database remains\nignorant of the schema—it can’t use the schema to help it decide how to store and retrieve data\nefficiently. It can’t apply its own validations upon that data to ensure that different applications don’t\nmanipulate data in an inconsistent way.")]),e._v(" "),s("p",[e._v("These are the reasons why relational databases have a fixed schema, and indeed the reasons why\nmost databases have had fixed schemas in the past. Schemas have value, and the rejection of schemas\nby NoSQL databases is indeed quite startling.")]),e._v(" "),s("p",[e._v("Essentially, a schemaless database shifts the schema into the application code that accesses it. This\nbecomes problematic if multiple applications, developed by different people, access the same\ndatabase. These problems can be reduced with a couple of approaches. One is to encapsulate all\ndatabase interaction within a single application and integrate it with other applications using web\nservices. This fits in well with many people’s current preference for using web services for\nintegration. Another approach is to clearly delineate different areas of an aggregate for access by\ndifferent applications. These could be different sections in a document database or different column\nfamilies an a column-family database.")]),e._v(" "),s("p",[e._v("Although NoSQL fans often criticize relational schemas for having to be defined up front and being\ninflexible, that’s not really true. Relational schemas can be changed at any time with standard SQL\ncommands. If necessary, you can create new columns in an ad-hoc way to store nonuniform data. We\nhave only rarely seen this done, but it worked reasonably well where we have. Most of the time,")]),e._v(" "),s("p",[e._v("however, nonuniformity in your data is a good reason to favor a schemaless database.")]),e._v(" "),s("p",[e._v("Schemalessness does have a big impact on changes of a database’s structure over time, particularly\nfor more uniform data. Although it’s not practiced as widely as it ought to be, changing a relational\ndatabase’s schema can be done in a controlled way. Similarly, you have to exercise control when\nchanging how you store data in a schemaless database so that you can easily access both old and new\ndata. Furthermore, the flexibility that schemalessness gives you only applies within an aggregate—if\nyou need to change your aggregate boundaries, the migration is every bit as complex as it is in the\nrelational case. We’ll talk more about database migration later (“Schema Migrations,” p. 123 ).")]),e._v(" "),s("h2",{attrs:{id:"_3-4-materialized-views"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-materialized-views"}},[e._v("#")]),e._v(" 3.4. Materialized Views")]),e._v(" "),s("p",[e._v("When we talked about aggregate-oriented data models, we stressed their advantages. If you want to\naccess orders, it’s useful to have all the data for an order contained in a single aggregate that can be\nstored and accessed as a unit. But aggregate-orientation has a corresponding disadvantage: What\nhappens if a product manager wants to know how much a particular item has sold over the last couple\nof weeks? Now the aggregate-orientation works against you, forcing you to potentially read every\norder in the database to answer the question. You can reduce this burden by building an index on the\nproduct, but you’re still working against the aggregate structure.")]),e._v(" "),s("p",[e._v("Relational databases have an advantage here because their lack of aggregate structure allows them\nto support accessing data in different ways. Furthermore, they provide a convenient mechanism that\nallows you to look at data differently from the way it’s stored—views. A view is like a relational\ntable (it is a relation) but it’s defined by computation over the base tables. When you access a view,\nthe database computes the data in the view—a handy form of encapsulation.")]),e._v(" "),s("p",[e._v("Views provide a mechanism to hide from the client whether data is derived data or base data—but\ncan’t avoid the fact that some views are expensive to compute. To cope with this, "),s("strong",[e._v("materialized views")]),e._v("\nwere invented, which are views that are computed in advance and cached on disk. Materialized\nviews are effective for data that is read heavily but can stand being somewhat stale.")]),e._v(" "),s("p",[e._v("Although NoSQL databases don’t have views, they may have precomputed and cached queries, and\nthey reuse the term “materialized view” to describe them. It’s also much more of a central aspect for\naggregate-oriented databases than it is for relational systems, since most applications will have to\ndeal with some queries that don’t fit well with the aggregate structure. (Often, NoSQL databases\ncreate materialized views using a map-reduce computation, which we’ll talk about in Chapter 7.)")]),e._v(" "),s("p",[e._v("There are two rough strategies to building a materialized view. The first is the eager approach\nwhere you update the materialized view at the same time you update the base data for it. In this case,\nadding an order would also update the purchase history aggregates for each product. This approach is\ngood when you have more frequent reads of the materialized view than you have writes and you want\nthe materialized views to be as fresh as possible. The application database (p. 7 ) approach is\nvaluable here as it makes it easier to ensure that any updates to base data also update materialized\nviews.")]),e._v(" "),s("p",[e._v("If you don’t want to pay that overhead on each update, you can run batch jobs to update the\nmaterialized views at regular intervals. You’ll need to understand your business requirements to\nassess how stale your materialized views can be.")]),e._v(" "),s("p",[e._v("You can build materialized views outside of the database by reading the data, computing the view,\nand saving it back to the database. More often databases will support building materialized views")]),e._v(" "),s("p",[e._v("themselves. In this case, you provide the computation that needs to be done, and the database executes\nthe computation when needed according to some parameters that you configure. This is particularly\nhandy for eager updates of views with incremental map-reduce (“Incremental Map-Reduce,” p. 76 ).")]),e._v(" "),s("p",[e._v("Materialized views can be used within the same aggregate. An order document might include an\norder summary element that provides summary information about the order so that a query for an\norder summary does not have to transfer the entire order document. Using different column families\nfor materialized views is a common feature of column-family databases. An advantage of doing this is\nthat it allows you to update the materialized view within the same atomic operation.")]),e._v(" "),s("h2",{attrs:{id:"_3-5-modeling-for-data-access"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-5-modeling-for-data-access"}},[e._v("#")]),e._v(" 3.5. Modeling for Data Access")]),e._v(" "),s("p",[e._v("As mentioned earlier, when modeling data aggregates we need to consider how the data is going to be\nread as well as what are the side effects on data related to those aggregates.")]),e._v(" "),s("p",[e._v("Let’s start with the model where all the data for the customer is embedded using a key-value store\n(see Figure 3.2).")]),e._v(" "),s("p",[s("img",{attrs:{src:a(582),alt:"img"}})]),e._v(" "),s("p",[s("strong",[e._v("Figure 3.2. Embed all the objects for customer and their orders.")])]),e._v(" "),s("p",[e._v("In this scenario, the application can read the customer’s information and all the related data by\nusing the key. If the requirements are to read the orders or the products sold in each order, the whole\nobject has to be read and then parsed on the client side to build the results. When references are\nneeded, we could switch to document stores and then query inside the documents, or even change the\ndata for the key-value store to split the value object into Customer and Order objects and then\nmaintain these objects’ references to each other.")]),e._v(" "),s("p",[e._v("With the references (see Figure 3.3), we can now find the orders independently from the\nCustomer, and with the orderId reference in the Customer we can find all Orders for the\nCustomer. Using aggregates this way allows for read optimization, but we have to push the orderId reference into Customer every time with a new Order.")]),e._v(" "),s("div",{staticClass:"language-json extra-class"},[s("pre",{pre:!0,attrs:{class:"language-json"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// Customer object")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"customerId"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"customer"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n        "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"name"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"Martin"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n        "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"billingAddress"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"city"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"Chicago"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n        "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"payment"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"type"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"debit"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"ccinfo"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"1000-1000-1000-1000"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n        "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"orders"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"orderId"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("99")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// Order object")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"customerId"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"orderId"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("99")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"order"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n        "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"orderDate"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"Nov-20-2011"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n        "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"orderItems"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"productId"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("27")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"price"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("32.45")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n        "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"orderPayment"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"ccinfo"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"1000-1000-1000-1000"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n        "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"txnId"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"abelif879rft"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n        "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"shippingAddress"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"city"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"Chicago"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),s("p",[s("img",{attrs:{src:a(583),alt:"img"}})]),e._v(" "),s("p",[s("strong",[e._v("Figure 3.3. Customer is stored separately from Order.")])]),e._v(" "),s("p",[e._v("Aggregates can also be used to obtain analytics; for example, an aggregate update may fill in\ninformation on which Orders have a given Product in them. This denormalization of the data allows\nfor fast access to the data we are interested in and is the basis for "),s("strong",[e._v("Real Time BI")]),e._v(" or "),s("strong",[e._v("Real Time")])]),e._v(" "),s("p",[s("strong",[e._v("Analytics")]),e._v(" where enterprises don’t have to rely on end-of-the-day batch runs to populate data\nwarehouse tables and generate analytics; now they can fill in this type of data, for multiple types of\nrequirements, when the order is placed by the customer.")]),e._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"itemid"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("27")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"orders"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("99")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("545")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("897")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("678")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"itemid"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("29")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"orders"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("199")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("545")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("704")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("819")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),s("p",[e._v("In document stores, since we can query inside documents, removing references to Orders from the\nCustomer object is possible. This change allows us to not update the Customer object when new\norders are placed by the Customer.")]),e._v(" "),s("p",[s("strong",[e._v("Click here to view code image")])]),e._v(" "),s("div",{staticClass:"language-json extra-class"},[s("pre",{pre:!0,attrs:{class:"language-json"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// Customer object")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"customerId"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"name"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"Martin"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"billingAddress"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"city"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"Chicago"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"payment"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),e._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"type"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"debit"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"ccinfo"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"1000-1000-1000-1000"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// Order object")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"orderId"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("99")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"customerId"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"orderDate"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"Nov-20-2011"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"orderItems"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"productId"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("27")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"price"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("32.45")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"orderPayment"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"ccinfo"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"1000-1000-1000-1000"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"txnId"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"abelif879rft"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"shippingAddress"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),s("span",{pre:!0,attrs:{class:"token property"}},[e._v('"city"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"Chicago"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),s("p",[e._v("Since document data stores allow you to query by attributes inside the document, searches such as\n“find all orders that include the "),s("em",[e._v("Refactoring Databases")]),e._v(" product” are possible, but the decision to\ncreate an aggregate of items and orders they belong to is not based on the database’s query capability\nbut on the read optimization desired by the application.")]),e._v(" "),s("p",[e._v("When modeling for column-family stores, we have the benefit of the columns being ordered,\nallowing us to name columns that are frequently used so that they are fetched first. When using the\ncolumn families to model the data, it is important to remember to do it per your query requirements\nand not for the purpose of writing; the general rule is to make it easy to query and denormalize the\ndata during write.")]),e._v(" "),s("p",[e._v("As you can imagine, there are multiple ways to model the data; one way is to store the Customer\nand Order in different "),s("em",[e._v("column-family")]),e._v(" families (see Figure 3.4). Here, it is important to note the\nreference to all the orders placed by the customer are in the Customer column family. Similar other\ndenormalizations are generally done so that query (read) performance is improved.")]),e._v(" "),s("p",[s("img",{attrs:{src:a(584),alt:"img"}})]),e._v(" "),s("p",[s("strong",[e._v("Figure 3.4. Conceptual view into a column data store")])]),e._v(" "),s("p",[e._v("When using graph databases to model the same data, we model all objects as nodes and relations\nwithin them as relationships; these relationships have types and directional significance.")]),e._v(" "),s("p",[e._v("Each node has independent relationships with other nodes. These relationships have names like\n"),s("em",[e._v("PURCHASED")]),e._v(" , "),s("em",[e._v("PAID_WITH")]),e._v(" , or "),s("em",[e._v("BELONGS_TO")]),e._v(" (see Figure 3.5); these relationship names let you\ntraverse the graph. Let’s say you want to find all the Customers who "),s("em",[e._v("PURCHASED")]),e._v(" a product with the\nname "),s("em",[e._v("Refactoring Database")]),e._v(". All we need to do is query for the product node Refactoring\nDatabases and look for all the Customers with the incoming "),s("em",[e._v("PURCHASED")]),e._v(" relationship.")]),e._v(" "),s("p",[s("img",{attrs:{src:a(585),alt:"img"}})]),e._v(" "),s("p",[s("strong",[e._v("Figure 3.5. Graph model of e-commerce data")])]),e._v(" "),s("p",[e._v("This type of relationship traversal is very easy with graph databases. It is especially convenient\nwhen you need to use the data to recommend products to users or to find patterns in actions taken by\nusers.")]),e._v(" "),s("h2",{attrs:{id:"_3-6-key-points"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-6-key-points"}},[e._v("#")]),e._v(" 3.6. Key Points")]),e._v(" "),s("ul",[s("li",[e._v("Aggregate-oriented databases make inter-aggregate relationships more difficult to handle than     intra-aggregate relationships.")]),e._v(" "),s("li",[e._v("Graph databases organize data into node and edge graphs; they work best for data that has complex relationship structures.")]),e._v(" "),s("li",[e._v("Schemaless databases allow you to freely add fields to records, but there is usually an implicit schema expected by users of the data.")]),e._v(" "),s("li",[e._v("Aggregate-oriented databases often compute materialized views to provide data organized differently from their primary aggregates. This is often done with map-reduce computations.")])])])}),[],!1,null,null,null);t.default=n.exports}}]);