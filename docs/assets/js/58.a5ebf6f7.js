(window.webpackJsonp=window.webpackJsonp||[]).push([[58],{563:function(e,a,t){"use strict";t.r(a);var n=t(7),s=Object(n.a)({},(function(){var e=this,a=e.$createElement,t=e._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("h2",{attrs:{id:"chapter-10-column-family-stores"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#chapter-10-column-family-stores"}},[e._v("#")]),e._v(" Chapter 10. Column-Family Stores")]),e._v(" "),t("p",[e._v("Column-family stores, such as Cassandra [Cassandra], HBase [Hbase], Hypertable [Hypertable], and\nAmazon SimpleDB [Amazon SimpleDB], allow you to store data with keys mapped to values and the\nvalues grouped into multiple column families, each column family being a map of data.")]),e._v(" "),t("h3",{attrs:{id:"_10-1-what-is-a-column-family-data-store"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_10-1-what-is-a-column-family-data-store"}},[e._v("#")]),e._v(" 10.1. What Is a Column-Family Data Store?")]),e._v(" "),t("p",[e._v("There are many column-family databases. In this chapter, we will talk about Cassandra but also\nreference other column-family databases to discuss features that may be of interest in particular\nscenarios.")]),e._v(" "),t("p",[e._v("Column-family databases store data in column families as rows that have many columns associated\nwith a row key (Figure 10.1). Column families are groups of related data that is often accessed\ntogether. For a Customer, we would often access their Profile information at the same time, but not\ntheir Orders.")]),e._v(" "),t("p",[t("strong",[e._v("Figure 10.1. Cassandra’s data model with column families")]),e._v("\nCassandra is one of the popular column-family databases; there are others, such as HBase,\nHypertable, and Amazon DynamoDB [Amazon DynamoDB]. Cassandra can be described as fast and\neasily scalable with write operations spread across the cluster. The cluster does not have a master\nnode, so any read and write can be handled by any node in the cluster.")]),e._v(" "),t("h3",{attrs:{id:"_10-2-features"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_10-2-features"}},[e._v("#")]),e._v(" 10.2. Features")]),e._v(" "),t("p",[e._v("Let’s start by looking at how data is structured in Cassandra. The basic unit of storage in Cassandra is\na column. A Cassandra column consists of a name-value pair where the name also behaves as the key.\nEach of these key-value pairs is a single column and is always stored with a timestamp value. The\ntimestamp is used to expire data, resolve write conflicts, deal with stale data, and do other things.\nOnce the column data is no longer used, the space can be reclaimed later during a compaction phase.")]),e._v(" "),t("p",[t("strong",[e._v("Click here to view code image")])]),e._v(" "),t("p",[e._v('{\nname: "fullName",\nvalue: "Martin Fowler",\ntimestamp: 12345667890\n}')]),e._v(" "),t("p",[e._v("The column has a key of firstName and the value of Martin and has a timestamp attached to it. A\nrow is a collection of columns attached or linked to a key; a collection of similar rows makes a\ncolumn family. When the columns in a column family are simple columns, the column family is known\nas "),t("strong",[e._v("standard column family")]),e._v(".")]),e._v(" "),t("p",[t("strong",[e._v("Click here to view code image")])]),e._v(" "),t("p",[e._v('//column family\n{\n//row\n"pramod-sadalage" : {\nfirstName: "Pramod",\nlastName: "Sadalage",\nlastVisit: "2012/12/12"\n}\n//row\n"martin-fowler" : {\nfirstName: "Martin",\nlastName: "Fowler",\nlocation: "Boston"\n}\n}')]),e._v(" "),t("p",[e._v("Each column family can be compared to a container of rows in an RDBMS table where the key\nidentifies the row and the row consists on multiple columns. The difference is that various rows do\nnot have to have the same columns, and columns can be added to any row at any time without having\nto add it to other rows. We have the pramod-sadalage row and the martin-fowler row with\ndifferent columns; both rows are part of the column family.")]),e._v(" "),t("p",[e._v("When a column consists of a map of columns, then we have a "),t("strong",[e._v("super column")]),e._v(". A super column\nconsists of a name and a value which is a map of columns. Think of a super column as a container of\ncolumns.")]),e._v(" "),t("p",[t("strong",[e._v("Click here to view code image")])]),e._v(" "),t("p",[e._v('{\nname: "book:978-0767905923",\nvalue: {\nauthor: "Mitch Albon",\ntitle: "Tuesdays with Morrie",\nisbn: "978-0767905923"\n}')]),e._v(" "),t("p",[e._v("}")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("When we use super columns to create a column family, we get a super column family.\n")])])]),t("p",[t("strong",[e._v("Click here to view code image")])]),e._v(" "),t("p",[e._v('//super column family\n{\n//row\nname: "billing:martin-fowler",\nvalue: {\naddress: {\nname: "address:default",\nvalue: {\nfullName: "Martin Fowler",\nstreet:"100 N. Main Street",\nzip: "20145"\n}\n},\nbilling: {\nname: "billing:default",\nvalue: {\ncreditcard: "8888-8888-8888-8888",\nexpDate: "12/2016"\n}\n}\n}\n//row\nname: "billing:pramod-sadalage",\nvalue: {\naddress: {\nname: "address:default",\nvalue: {\nfullName: "Pramod Sadalage",\nstreet:"100 E. State Parkway",\nzip: "54130"\n}\n},\nbilling: {\nname: "billing:default",\nvalue: {\ncreditcard: "9999-8888-7777-4444",\nexpDate: "01/2016"\n}\n}\n}\n}')]),e._v(" "),t("p",[e._v("Super column families are good to keep related data together, but when some of the columns are\nnot needed most of the time, the columns are still fetched and deserialized by Cassandra, which may\nnot be optimal.")]),e._v(" "),t("p",[e._v("Cassandra puts the standard and super column families into "),t("strong",[e._v("keyspaces")]),e._v(". A keyspace is similar to a\ndatabase in RDBMS where all column families related to the application are stored. Keyspaces have\nto be created so that column families can be assigned to them:")]),e._v(" "),t("p",[e._v("create keyspace ecommerce")]),e._v(" "),t("p",[t("strong",[e._v("10.2.1. Consistency")])]),e._v(" "),t("p",[e._v("When a write is received by Cassandra, the data is first recorded in a commit log, then written to an")]),e._v(" "),t("p",[e._v("in-memory structure known as "),t("strong",[e._v("memtable")]),e._v(". A write operation is considered successful once it’s\nwritten to the commit log and the memtable. Writes are batched in memory and periodically written\nout to structures known as "),t("strong",[e._v("SSTable")]),e._v(". SSTables are not written to again after they are flushed; if there\nare changes to the data, a new SSTable is written. Unused SSTables are reclaimed by "),t("strong",[e._v("compactation")]),e._v(".")]),e._v(" "),t("p",[e._v("Let’s look at the read operation to see how consistency settings affect it. If we have a consistency\nsetting of ONE as the default for all read operations, then when a read request is made, Cassandra\nreturns the data from the first replica, even if the data is stale. If the data is stale, subsequent reads\nwill get the latest (newest) data; this process is known as "),t("strong",[e._v("read repair")]),e._v(". The low consistency level is\ngood to use when you do not care if you get stale data and/or if you have high read performance\nrequirements.")]),e._v(" "),t("p",[e._v("Similarly, if you are doing writes, Cassandra would write to one node’s commit log and return a\nresponse to the client. The consistency of ONE is good if you have very high write performance\nrequirements and also do not mind if some writes are lost, which may happen if the node goes down\nbefore the write is replicated to other nodes.")]),e._v(" "),t("p",[t("strong",[e._v("Click here to view code image")])]),e._v(" "),t("p",[e._v("quorum = new ConfigurableConsistencyLevel();\nquorum.setDefaultReadConsistencyLevel(HConsistencyLevel.QUORUM);\nquorum.setDefaultWriteConsistencyLevel(HConsistencyLevel.QUORUM);")]),e._v(" "),t("p",[e._v("Using the QUORUM consistency setting for both read and write operations ensures that majority of the\nnodes respond to the read and the column with the newest timestamp is returned back to the client,\nwhile the replicas that do not have the newest data are repaired via the read repair operations. During\nwrite operations, the QUORUM consistency setting means that the write has to propagate to the majority\nof the nodes before it is considered successful and the client is notified.")]),e._v(" "),t("p",[e._v("Using ALL as consistency level means that all nodes will have to respond to reads or writes, which\nwill make the cluster not tolerant to faults—even when one node is down, the write or read is\nblocked and reported as a failure. It’s therefore upon the system designers to tune the consistency\nlevels as the application requirements change. Within the same application, there may be different\nrequirements of consistency; they can also change based on each operation, for example showing\nreview comments for a product has different consistency requirements compared to reading the status\nof the last order placed by the customer.")]),e._v(" "),t("p",[e._v("During "),t("strong",[e._v("keyspace")]),e._v(" creation, we can configure how many replicas of the data we need to store. This\nnumber determines the replication factor of the data. If you have a replication factor of 3, the data\ncopied on to three nodes. When writing and reading data with Cassandra, if you specify the\nconsistency values of 2, you get that R + W is greater than the replication factor (2 + 2 > 3) which\ngives you better consistency during writes and reads.")]),e._v(" "),t("p",[e._v("We can run the node repair command for the keyspace and force Cassandra to compare every key\nit’s responsible for with the rest of the replicas. As this operation is expensive, we can also just\nrepair a specific column family or a list of column families:")]),e._v(" "),t("p",[e._v("repair ecommerce")]),e._v(" "),t("p",[e._v("repair ecommerce customerInfo")]),e._v(" "),t("p",[e._v("While a node is down, the data that was supposed to be stored by that node is handed off to other\nnodes. As the node comes back online, the changes made to the data are handed back to the node. This")]),e._v(" "),t("p",[e._v("technique is known as "),t("strong",[e._v("hinted handoff")]),e._v(". Hinted handoff allows for faster restore of failed nodes.")]),e._v(" "),t("p",[t("strong",[e._v("10.2.2. Transactions")])]),e._v(" "),t("p",[e._v("Cassandra does not have transactions in the traditional sense—where we could start multiple writes\nand then decide if we want to commit the changes or not. In Cassandra, a write is atomic at the row\nlevel, which means inserting or updating columns for a given row key will be treated as a single\nwrite and will either succeed or fail. Writes are first written to commit logs and memtables, and are\nonly considered good when the write to commit log and memtable was successful. If a node goes\ndown, the commit log is used to apply changes to the node, just like the "),t("strong",[e._v("redo log")]),e._v(" in Oracle.")]),e._v(" "),t("p",[e._v("You can use external transaction libraries, such as ZooKeeper [ZooKeeper], to synchronize your\nwrites and reads. There are also libraries such as Cages [Cages] that allow you to wrap your\ntransactions over ZooKeeper.")]),e._v(" "),t("p",[t("strong",[e._v("10.2.3. Availability")])]),e._v(" "),t("p",[e._v("Cassandra is by design highly available, since there is no master in the cluster and every node is a\npeer in the cluster. The availability of a cluster can be increased by reducing the consistency level of\nthe requests. Availability is governed by the (R + W) > N formula (“Quorums,” p. 57 ) where W is the\nminimum number of nodes where the write must be successfully written, R is the minimum number of\nnodes that must respond successfully to a read, and N is the number of nodes participating in the\nreplication of data. You can tune the availability by changing the R and W values for a fixed value of N.")]),e._v(" "),t("p",[e._v("In a 10-node Cassandra cluster with a replication factor for the keyspace set to 3 (N = 3), if we set\nR = 2 and W = 2, then we have (2 + 2) > 3. In this scenario, when one node goes down,\navailability is not affected much, as the data can be retrieved from the other two nodes. If W = 2 and\nR = 1, when two nodes are down the cluster is not available for write but we can still read.\nSimilarly, if R = 2 and W = 1, we can write but the cluster is not available for read. With the R + W")]),e._v(" "),t("blockquote",[t("p",[e._v("N equation, you are making conscious decisions about consistency tradeoffs.")])]),e._v(" "),t("p",[e._v("You should set up your keyspaces and read/write operations based on your needs—higher\navailability for write or higher availability for read.")]),e._v(" "),t("p",[t("strong",[e._v("10.2.4. Query Features")])]),e._v(" "),t("p",[e._v("When designing the data model in Cassandra, it is advised to make the columns and column families\noptimized for reading the data, as it does not have a rich query language; as data is inserted in the\ncolumn families, data in each row is sorted by column names. If we have a column that is retrieved\nmuch more often than other columns, it’s better performance-wise to use that value for the row key\ninstead.")]),e._v(" "),t("p",[t("strong",[e._v("10.2.4.1. Basic Queries")])]),e._v(" "),t("p",[e._v("Basic queries that can be run using a Cassandra client include the GET, SET, and DEL. Before starting\nto query for data, we have to issue the keyspace command use ecommerce;. This ensures that all of\nour queries are run against the keyspace that we put our data into. Before starting to use the column\nfamily in the keyspace, we have to define the column family.")]),e._v(" "),t("p",[t("strong",[e._v("Click here to view code image")])]),e._v(" "),t("p",[e._v("CREATE COLUMN FAMILY Customer\nWITH comparator = UTF8Type\nAND key_validation_class=UTF8Type")]),e._v(" "),t("p",[e._v("AND column_metadata = [\n{column_name: city, validation_class: UTF8Type}\n{column_name: name, validation_class: UTF8Type}\n{column_name: web, validation_class: UTF8Type}\n];")]),e._v(" "),t("p",[e._v("We have a column family named Customer with name, city, and web columns, and we are\ninserting data in the column family with a Cassandra client.")]),e._v(" "),t("p",[t("strong",[e._v("Click here to view code image")])]),e._v(" "),t("p",[e._v("SET Customer['mfowler']['city']='Boston';\nSET Customer['mfowler']['name']='Martin Fowler';\nSET Customer['mfowler']['web']='www.martinfowler.com';")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("Using the Hector [Hector] Java client, we can insert the same data in the column family.\n")])])]),t("p",[t("strong",[e._v("Click here to view code image")])]),e._v(" "),t("div",{staticClass:"language-java extra-class"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("ColumnFamilyTemplate")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("String")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("String")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(">")])]),e._v(" template "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" cassandra"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("getColumnFamilyTemplate")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),t("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("ColumnFamilyUpdater")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("String")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("String")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(">")])]),e._v(" updater "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" template"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("createUpdater")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("key"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("for")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("String")]),e._v(" name "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" values"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("keySet")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    updater"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("setString")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" values"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("get")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(" \n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("try")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    template"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("update")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("updater"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("catch")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("HectorException")]),e._v(" e"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("handleException")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("e"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),t("p",[e._v("We can read the data back using the GET command. There are multiple ways to get the data; we can\nget the whole column family.")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("GET Customer['mfowler'];\n")])])]),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("We can even get just the column we are interested in from the column family.\n")])])]),t("p",[e._v("GET Customer['mfowler']['web'];")]),e._v(" "),t("p",[e._v("Getting the specific column we need is more efficient, as only the data we care about is returned—\nwhich saves lots of data movement, especially when the column family has a large number of\ncolumns. Updating the data is the same as using the SET command for the column that needs to be set\nto the new value. Using DEL command, we can delete either a column or the entire column family.")]),e._v(" "),t("p",[t("strong",[e._v("Click here to view code image")])]),e._v(" "),t("p",[e._v("DEL Customer['mfowler']['city'];")]),e._v(" "),t("p",[e._v("DEL Customer['mfowler'];")]),e._v(" "),t("p",[t("strong",[e._v("10.2.4.2. Advanced Queries and Indexing")])]),e._v(" "),t("p",[e._v("Cassandra allows you to index columns other than the keys for the column family. We can define an\nindex on the city column.")]),e._v(" "),t("p",[t("strong",[e._v("Click here to view code image")])]),e._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("UPDATE")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("COLUMN")]),e._v(" FAMILY Customer\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("WITH")]),e._v(" comparator "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" UTF8Type \n"),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("AND")]),e._v(" column_metadata "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),e._v("{column_name: city"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" validation_class: UTF8Type"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" index_type: "),t("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("KEYS")]),e._v("}"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),t("p",[e._v("We can now query directly against the indexed column.")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("GET Customer WHERE city = 'Boston';\n")])])]),t("p",[e._v("These indexes are implemented as "),t("em",[e._v("bit-mapped")]),e._v(" indexes and perform well for low-cardinality\ncolumn values.")]),e._v(" "),t("p",[t("strong",[e._v("10.2.4.3. Cassandra Query Language (CQL)")])]),e._v(" "),t("p",[e._v("Cassandra has a query language that supports SQL-like commands, known as Cassandra Query\nLanguage (CQL). We can use the CQL commands to create a column family.")]),e._v(" "),t("p",[t("strong",[e._v("Click here to view code image")])]),e._v(" "),t("p",[e._v("CREATE COLUMNFAMILY Customer (\nKEY varchar PRIMARY KEY,\nname varchar,\ncity varchar,\nweb varchar);")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("We insert the same data using CQL.\n")])])]),t("p",[t("strong",[e._v("Click here to view code image")])]),e._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("INSERT")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("INTO")]),e._v(" Customer "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("KEY")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" city"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" web"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("VALUES")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[e._v("'mfowler'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[e._v("'Martin Fowler'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[e._v("'Boston'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[e._v("'www.martinfowler.com'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),t("p",[e._v("We can read data using the SELECT command. Here we read all the columns:")]),e._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("SELECT")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("FROM")]),e._v(" Customer\n")])])]),t("p",[e._v("Or, we could just "),t("code",[e._v("SELECT")]),e._v(" the columns we need.")]),e._v(" "),t("div",{staticClass:"language-sql extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("SELECT")]),e._v(" name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("web "),t("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("FROM")]),e._v(" Customer\n")])])]),t("p",[e._v("Indexing columns are created using the CREATE INDEX command, and then can be used to query the\ndata.")]),e._v(" "),t("p",[t("strong",[e._v("Click here to view code image")])]),e._v(" "),t("p",[e._v("SELECT name,web FROM Customer WHERE city='Boston'")]),e._v(" "),t("p",[e._v("CQL has many more features for querying data, but it does not have all the features that SQL has.\nCQL does not allow joins or subqueries, and its where clauses are typically simple.")]),e._v(" "),t("p",[t("strong",[e._v("10.2.5. Scaling")])]),e._v(" "),t("p",[e._v("Scaling an existing Cassandra cluster is a matter of adding more nodes. As no single node is a master,\nwhen we add nodes to the cluster we are improving the capacity of the cluster to support more writes\nand reads. This type of horizontal scaling allows you to have maximum uptime, as the cluster keeps\nserving requests from the clients while new nodes are being added to the cluster.")]),e._v(" "),t("h3",{attrs:{id:"_10-3-suitable-use-cases"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_10-3-suitable-use-cases"}},[e._v("#")]),e._v(" 10.3. Suitable Use Cases")]),e._v(" "),t("p",[e._v("Let’s discuss some of the problems where column-family databases are a good fit.")]),e._v(" "),t("p",[t("strong",[e._v("10.3.1. Event Logging")])]),e._v(" "),t("p",[e._v("Column-family databases with their ability to store any data structures are a great choice to store\nevent information, such as application state or errors encountered by the application. Within the\nenterprise, all applications can write their events to Cassandra with their own columns and the\nrowkey of the form appname:timestamp. Since we can scale writes, Cassandra would work ideally\nfor an event logging system (Figure 10.2).")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("Figure 10.2. Event logging with Cassandra\n")])])]),t("p",[t("strong",[e._v("10.3.2. Content Management Systems, Blogging Platforms")])]),e._v(" "),t("p",[e._v("Using column families, you can store blog entries with tags, categories, links, and trackbacks in\ndifferent columns. Comments can be either stored in the same row or moved to a different keyspace;\nsimilarly, blog users and the actual blogs can be put into different column families.")]),e._v(" "),t("p",[t("strong",[e._v("10.3.3. Counters")])]),e._v(" "),t("p",[e._v("Often, in web applications you need to count and categorize visitors of a page to calculate analytics.\nYou can use the CounterColumnType during creation of a column family.")]),e._v(" "),t("p",[t("strong",[e._v("Click here to view code image")])]),e._v(" "),t("p",[e._v("CREATE COLUMN FAMILY visit_counter\nWITH default_validation_class=CounterColumnType\nAND key_validation_class=UTF8Type AND comparator=UTF8Type;")]),e._v(" "),t("p",[e._v("Once a column family is created, you can have arbitrary columns for each page visited within the\nweb application for every user.")]),e._v(" "),t("p",[t("strong",[e._v("Click here to view code image")])]),e._v(" "),t("p",[e._v("INCR visit_counter['mfowler'][home] BY 1;\nINCR visit_counter['mfowler'][products] BY 1;\nINCR visit_counter['mfowler'][contactus] BY 1;")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("Incrementing counters using CQL:\n")])])]),t("p",[t("strong",[e._v("Click here to view code image")])]),e._v(" "),t("p",[e._v("UPDATE visit_counter SET home = home + 1 WHERE KEY='mfowler'")]),e._v(" "),t("p",[t("strong",[e._v("10.3.4. Expiring Usage")])]),e._v(" "),t("p",[e._v("You may provide demo access to users, or may want to show ad banners on a website for a specific\ntime. You can do this by using "),t("strong",[e._v("expiring columns")]),e._v(" : Cassandra allows you to have columns which, after\na given time, are deleted automatically. This time is known as TTL (Time To Live) and is defined in\nseconds. The column is deleted after the TTL has elapsed; when the column does not exist, the access\ncan be revoked or the banner can be removed.")]),e._v(" "),t("p",[t("strong",[e._v("Click here to view code image")])]),e._v(" "),t("p",[e._v("SET Customer['mfowler']['demo_access'] = 'allowed' WITH ttl=2592000;")]),e._v(" "),t("h3",{attrs:{id:"_10-4-when-not-to-use"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_10-4-when-not-to-use"}},[e._v("#")]),e._v(" 10.4. When Not to Use")]),e._v(" "),t("p",[e._v("There are problems for which column-family databases are not the best solutions, such as systems that\nrequire ACID transactions for writes and reads. If you need the database to aggregate the data using\nqueries (such as SUM or AVG), you have to do this on the client side using data retrieved by the client\nfrom all the rows.")]),e._v(" "),t("p",[e._v("Cassandra is not great for early prototypes or initial tech spikes: During the early stages, we are\nnot sure how the query patterns may change, and as the query patterns change, we have to change the\ncolumn family design. This causes friction for the product innovation team and slows down developer\nproductivity. RDBMS impose high cost on schema change, which is traded off for a low cost of query\nchange; in Cassandra, the cost may be higher for query change as compared to schema change.")])])}),[],!1,null,null,null);a.default=s.exports}}]);