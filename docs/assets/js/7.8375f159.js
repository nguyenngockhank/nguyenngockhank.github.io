(window.webpackJsonp=window.webpackJsonp||[]).push([[7],{1087:function(e,t,a){e.exports=a.p+"assets/img/f1.31b15c23.png"},1088:function(e,t,a){e.exports=a.p+"assets/img/f2.98edf017.png"},1089:function(e,t,a){e.exports=a.p+"assets/img/f3.d8bb7564.png"},1090:function(e,t,a){e.exports=a.p+"assets/img/f4.a2dde50b.png"},1091:function(e,t,a){e.exports=a.p+"assets/img/f5.5424ad3e.png"},1092:function(e,t,a){e.exports=a.p+"assets/img/f6.e225ff33.png"},1093:function(e,t,a){e.exports=a.p+"assets/img/f7.9ebe1c3a.png"},1094:function(e,t,a){e.exports=a.p+"assets/img/f8.5da880af.png"},1095:function(e,t,a){e.exports=a.p+"assets/img/f9.f8d4dcad.png"},1096:function(e,t,a){e.exports=a.p+"assets/img/f10.50f989c3.png"},1097:function(e,t,a){e.exports=a.p+"assets/img/f11.fc23c8d6.png"},1098:function(e,t,a){e.exports=a.p+"assets/img/f12.ddd0a15e.png"},1099:function(e,t,a){e.exports=a.p+"assets/img/f13.c6da8996.png"},1100:function(e,t,a){e.exports=a.p+"assets/img/f14.b6222064.png"},1101:function(e,t,a){e.exports=a.p+"assets/img/f15.d9251880.png"},1102:function(e,t,a){e.exports=a.p+"assets/img/f16.6cd52464.png"},1103:function(e,t,a){e.exports=a.p+"assets/img/f17.159e095f.png"},1104:function(e,t,a){e.exports=a.p+"assets/img/f18.14f44b7b.png"},1105:function(e,t,a){e.exports=a.p+"assets/img/f19.a2d8a786.png"},1106:function(e,t,a){e.exports=a.p+"assets/img/f20.4931f85c.png"},1107:function(e,t,a){e.exports=a.p+"assets/img/f21.da25c8e6.png"},1108:function(e,t,a){e.exports=a.p+"assets/img/f22.69dee0fa.png"},1109:function(e,t,a){e.exports=a.p+"assets/img/f23.235219e1.png"},1110:function(e,t,a){e.exports=a.p+"assets/img/f24.191ebb3e.png"},1600:function(e,t,a){"use strict";a.r(t);var n=a(7),s=Object(n.a)({},(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[n("h1",{attrs:{id:"stock-exchange"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#stock-exchange"}},[e._v("#")]),e._v(" Stock Exchange")]),e._v(" "),n("p",[e._v("In this chapter, we design an electronic stock exchange system")]),e._v(" "),n("p",[e._v("The basic function of an exchange is to facilitate the matching of buyers and sellers efficiently. This fundamental\nfunction has not changed over time. Before the rise of computing, people exchanged tangible goods by bartering\nand shouting at each other to get matched. Today, orders are processed silently by supercomputers, and people\ntrade not only for the exchange of products, but also for speculation and arbitrage. Technology has greatly\nchanged the landscape of trading and exponentially boosted electronic market trading volume.")]),e._v(" "),n("p",[e._v("When it comes to stock exchanges, most people think about major market players like The New York Stock\nExchange (NYSE) or Nasdag, which have existed for over fifty years. In fact, there are many other types of exchange.\nSome focus on vertical segmentation of the financial industry and place special focus on technology [1], while\nothers have an emphasis on fairness [2]. Before diving into the design, it is important to check with the "),n("strong",[e._v("Interviewer")]),e._v("\nabout the scale and the important characteristics of the exchange in question.")]),e._v(" "),n("p",[e._v("Just to get a taste of the kind of problem we are dealing with; NYSE is trading billions of matches per day [3], and\nHKEX about 200 billion shares per day [4]. Figure 1 shows the big exchanges in the “trillion-dollar club” by market\ncapitalization.")]),e._v(" "),n("p",[n("img",{attrs:{src:a(1087),alt:"Figure 1"}}),n("br"),e._v(" "),n("em",[e._v("Figure 1 Largest stock exchanges")])]),e._v(" "),n("h2",{attrs:{id:"step-1-understand-the-problem-and-establish-design-scope"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#step-1-understand-the-problem-and-establish-design-scope"}},[e._v("#")]),e._v(" Step 1 - Understand the Problem and Establish Design scope")]),e._v(" "),n("p",[e._v("A modem exchange is a complicated system with stringent requirements on latency, throughput, and robustness.\nBefore we start, let's ask the "),n("strong",[e._v("Interviewer")]),e._v(" a few questions to clarify the requirements.")]),e._v(" "),n("p",[n("strong",[e._v("Candidate")]),e._v(": Which securities are we going to trade? Stocks, options, or futures?"),n("br"),e._v(" "),n("strong",[e._v("Interviewer")]),e._v(": For simplicity, only stocks.")]),e._v(" "),n("p",[n("strong",[e._v("Candidate")]),e._v(": Which types of order operations are supported: placing a new order, canceling an order, or replacing an\norder? Do we need to support limit order, market order, or conditional order?"),n("br"),e._v(" "),n("strong",[e._v("Interviewer")]),e._v(": We need to support the following: placing a new order and canceling an order. For the order type, we\nonly need to consider the limit order.")]),e._v(" "),n("p",[n("strong",[e._v("Candidate")]),e._v(": Does the system need to support after-hours trading?"),n("br"),e._v(" "),n("strong",[e._v("Interviewer")]),e._v(": No, we just need to support the normal trading hours.")]),e._v(" "),n("p",[n("strong",[e._v("Candidate")]),e._v(": Could you describe the basic functions of the exchange? And the scale of the exchange, such as how\nmany users, how many symbols, and how many orders?"),n("br"),e._v(" "),n("strong",[e._v("Interviewer")]),e._v(": A client can place new limit orders or cancel them, and receive matched trades in real-time. A client\ncan view the real-time order book (the list of buy and sell orders). The exchange needs to support at least tens of\nthousands of users trading at the same time, and it needs to support at least 100 symbols. For the trading volume,\nwe should support billions of orders per day. Also, the exchange is a regulated facility, so we need to make sure it\nruns risk checks.")]),e._v(" "),n("p",[n("strong",[e._v("Candidate")]),e._v(": Could you please elaborate on risk checks?"),n("br"),e._v(" "),n("strong",[e._v("Interviewer")]),e._v(": Let's just do simple risk checks. For example, a user can only trade a maximum of 1 million shares of\nApple stock in one day.")]),e._v(" "),n("p",[n("strong",[e._v("Candidate")]),e._v(": I noticed you didn’t mention user wallet management. s it something we also need to consider?"),n("br"),e._v(" "),n("strong",[e._v("Interviewer")]),e._v(": Good catch! We need to make sure users have sufficient funds when they place orders. If an order is\nwaiting in the order book to be filled, the funds required for the order need to be withheld to prevent\noverspending.")]),e._v(" "),n("h3",{attrs:{id:"non-functional-requirements"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#non-functional-requirements"}},[e._v("#")]),e._v(" Non-functional requirements")]),e._v(" "),n("p",[e._v("After checking with the interviewer for the functional requirements, we should determine the non-functional\nrequirements. In fact, requirements like “at least 100 symbols” and “tens of thousands of users” tell us that the\ninterviewer wants us to design a small-to-medium scale exchange. On top of this, we should make sure the design\ncan be extended to support more symbols and users. Many interviewers focus on extensibility as an area for follow-\nup questions.")]),e._v(" "),n("p",[e._v("Here is a list of non-functional requirements:")]),e._v(" "),n("ul",[n("li",[n("strong",[e._v("Availability")]),e._v(". At least 99.99%. Availability is crucial for exchanges. Downtime, even seconds, can harm\nreputation.")]),e._v(" "),n("li",[n("strong",[e._v("Fault tolerance")]),e._v(". Fault tolerance and a fast recovery mechanism are needed to limit the impact of a production\nincident.")]),e._v(" "),n("li",[n("strong",[e._v("Latency")]),e._v(". The round-trip latency should be at the millisecond level, with a particular focus on the 99th\npercentile latency. The round trip latency is measured from the moment a market order enters the exchange to\nthe point where the market order returns as a filled execution. A persistently high 99th percentile latency\ncauses a terrible user experience for a small number of users.")]),e._v(" "),n("li",[n("strong",[e._v("Security")]),e._v(". The exchange should have an account management system. For legal compliance, the exchange\nperforms a KYC (Know Your Client) check to verify a user's identity before a new account is opened. For public\nresources, such as web pages containing market data, we should prevent distributed denial-of-service (DDoS)\n[6] attacks.")])]),e._v(" "),n("h3",{attrs:{id:"back-of-the-envelope-estimation"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#back-of-the-envelope-estimation"}},[e._v("#")]),e._v(" Back-of-the-envelope estimation")]),e._v(" "),n("p",[e._v("Let's do some simple back-of-the-envelope calculations to understand the scale of the system:")]),e._v(" "),n("ul",[n("li",[e._v("100 symbols")]),e._v(" "),n("li",[e._v("1 billion orders per day")]),e._v(" "),n("li",[e._v("NYSE Stock Exchange is open Monday through Friday from 9:30 am to 4:00 pm Eastern Time. That's 6.5 hours in total.")]),e._v(" "),n("li",[e._v("QPS: 1 billion / 6.5 / 3600 = ~43,000")]),e._v(" "),n("li",[e._v("Peak QPS: 5 * QPS = 215,000. The trading volume is significantly higher when the market first opens in the\nmorning and before it closes in the afternon.,")])]),e._v(" "),n("h2",{attrs:{id:"step-2-propose-high-level-design-and-get-buy-in"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#step-2-propose-high-level-design-and-get-buy-in"}},[e._v("#")]),e._v(" Step 2 - Propose High-Level Design and Get Buy-In")]),e._v(" "),n("p",[e._v("Before we dive into the high-level design, let's briefly discuss some basic concepts and terminology that are helpful\nfor designing an exchange.")]),e._v(" "),n("h3",{attrs:{id:"business-knowledge-101"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#business-knowledge-101"}},[e._v("#")]),e._v(" Business Knowledge 101")]),e._v(" "),n("h4",{attrs:{id:"broker"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#broker"}},[e._v("#")]),e._v(" Broker")]),e._v(" "),n("p",[e._v("Most retail clients trade with an exchange via a broker. Some brokers whom you might be familiar with include\nCharles Schwab, Robinhood, Etrade, Fidelity, etc. These brokers provide a friendly user interface for retail users to\nplace trades and view market data.")]),e._v(" "),n("h4",{attrs:{id:"institutional-client"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#institutional-client"}},[e._v("#")]),e._v(" Institutional client")]),e._v(" "),n("p",[e._v("Institutional clients trade in large volumes using specialized trading software. Different institutional clients operate\nwith different requirements. For example, pension funds aim for a stable income. They trade infrequently, but when\nthey do trade, the volume is large. They need features like order splitting to minimize the market impact [7] of their\nsizable orders. Some hedge funds specialize in market making and earn income via commission rebates. They need\nlow latency trading abilities, so obviously they cannot simply view market data on a web page or a mobile app, as\nretail clients do.")]),e._v(" "),n("h4",{attrs:{id:"limit-order"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#limit-order"}},[e._v("#")]),e._v(" Limit order")]),e._v(" "),n("p",[e._v("A limit order is a buy or sell order with a fixed price. It might not find a match immediately, or it might just be\npartially matched.")]),e._v(" "),n("h4",{attrs:{id:"market-order"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#market-order"}},[e._v("#")]),e._v(" Market order")]),e._v(" "),n("p",[e._v("A market order doesn't specify a price. It is executed at the prevailing market price immediately. A market order\nsacrifices cost in order to guarantee execution. It is useful in certain fast-moving market conditions.")]),e._v(" "),n("h4",{attrs:{id:"market-data-levels"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#market-data-levels"}},[e._v("#")]),e._v(" Market data levels")]),e._v(" "),n("p",[e._v("The US stock market has three tiers of price quotes: L1 (level 1), L2, and L3. L1 market data contains the best bid\nprice, ask price, and quantities (Figure 2). Bid price refers to the highest price a buyer is willing to pay for a stock.\nAsk price refers to the lowest price a seller is willing to sell the stock.")]),e._v(" "),n("p",[n("img",{attrs:{src:a(1088),alt:"Figure 2"}}),n("br"),e._v(" "),n("em",[e._v("Figure 2 Level 1 data")])]),e._v(" "),n("p",[e._v("L2 includes more price levels than L1 (Figure 3).")]),e._v(" "),n("p",[n("img",{attrs:{src:a(1089),alt:"Figure 3"}}),n("br"),e._v(" "),n("em",[e._v("Figure 3 Level 2 data")])]),e._v(" "),n("p",[e._v("L3 shows price levels and the queued quantity at each price level (Figure 4),")]),e._v(" "),n("p",[n("img",{attrs:{src:a(1090),alt:"Figure 4"}}),n("br"),e._v(" "),n("em",[e._v("Fiture 4 Level 3 data")])]),e._v(" "),n("h4",{attrs:{id:"candlestick-chart"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#candlestick-chart"}},[e._v("#")]),e._v(" Candlestick chart")]),e._v(" "),n("p",[e._v("A candlestick chart represents the stock price for a certain period of time. A typical candlestick looks like this (Figure 5). A candlestick shows the market's open, close, high, and low price for a time interval. The common time intervals are one-minute, five-minute, one-hour, one-day, one-week, and one-month.")]),e._v(" "),n("p",[n("img",{attrs:{src:a(1091),alt:"Figure 5"}}),n("br"),e._v(" "),n("em",[e._v("Figure 5 A single candlestick chart")])]),e._v(" "),n("h4",{attrs:{id:"fix"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#fix"}},[e._v("#")]),e._v(" FIX")]),e._v(" "),n("p",[e._v("FIX protocol [8], which stands for Financial Information eXchange protocol, was created in 1991. It is a vendor-neutral communications protocol for exchanging securities transaction information. See below for an example of a securities transaction encoded in FIX.")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("8=FIX4.2 | 9=176 | 35=8 | 49=PHLX | 56=PERS | 52=20071123-05:30:00.000 | 11=ATOMNOCCC9990900 | 20=3 |\n150=E | 39=E | 55=MSFT | 167=CS | 54=1 38=15 | 40=2 | 44=15 | 58=PHLX EQUITY TESTING | 59=0 | 47=C | 32=0 |\n31=0 | 151=15 | 14=0 | 6=0 | 10=128 |\n")])])]),n("p",[e._v("Sample FIX [8]")]),e._v(" "),n("h3",{attrs:{id:"high-level-design"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#high-level-design"}},[e._v("#")]),e._v(" High-level design")]),e._v(" "),n("p",[e._v("Now that we have some basic understanding of the key concepts, let's take a look at the high-level design, as\nshown in Figure 6.")]),e._v(" "),n("p",[n("img",{attrs:{src:a(1092),alt:"Figure 6"}}),n("br"),e._v(" "),n("em",[e._v("Figure 6 High-level design")])]),e._v(" "),n("p",[e._v("Let's trace the life of an order through various components in the diagram to see how the pieces fit together.\nFirst, we follow the order through the "),n("strong",[e._v("trading flow")]),e._v(". This is the critical path with strict latency requirements.\nEverything has to happen fast in the flow:")]),e._v(" "),n("p",[e._v("Step 1: A client places an order via the broker's web or mobile app.")]),e._v(" "),n("p",[e._v("Step 2: The broker sends the order to the exchange.")]),e._v(" "),n("p",[e._v("Step 3: The order enters the exchange through the client gateway. The client gateway performs basic gatekeeping\nfunctions such as input validation, rate limiting, authentication, normalization, etc. The client gateway then forwards\nthe order to the order manager.")]),e._v(" "),n("p",[e._v("Step 4 - 5: The order manager performs risk checks based on rules set by the risk manager.")]),e._v(" "),n("p",[e._v("Step 6: After passing risk checks, the order manager verifies there are sufficient funds in the wallet for the order.")]),e._v(" "),n("p",[e._v("Step 7 - 9: The order is sent to the matching engine. When a match is found, the matching engine emits two\nexecutions (also called fills), with one each for the buy and sell sides. To guarantee that matching results are\ndeterministic when replayed, both orders and executions are sequenced in the sequencer (more on the sequencer\nlater).")]),e._v(" "),n("p",[e._v("Step 10 - 14: The executions are returned to the client.")]),e._v(" "),n("p",[e._v("Next, we follow the "),n("strong",[e._v("market data flow")]),e._v(" and trace the order executions from the matching engine to the broker via\nthe data service.")]),e._v(" "),n("p",[e._v("Step M1: The matching engine generates a stream of executions (fills) as matches are made. The stream is sent to\nthe market data publisher.")]),e._v(" "),n("p",[e._v("Step M2: The market data publisher constructs the candlestick charts and the order books as market data from the\nstream of executions and orders. It then sends market data to the data service.")]),e._v(" "),n("p",[e._v("Step M3: The market data is saved to specialized storage for real-time analytics. The brokers connect to the data\nservice to obtain timely market data. Brokers relay market data to their clients.")]),e._v(" "),n("p",[e._v("Lastly, we examine the reporter flow.")]),e._v(" "),n("p",[e._v("Step R1 - R2 (reporting flow): The reporter collects all the necessary reporting fields (eg. dlient_id, price, quantity,\norder_type, filled_quantity, remaining_quantity) from orders and executions, and writes the consolidated records to\nthe database")]),e._v(" "),n("p",[e._v("Note that the trading flow (steps 1 to 14) is on the critical path, while the market data flow and reporting flow are\nnot. They have different latency requirements.")]),e._v(" "),n("p",[e._v("Now let's examine each of the three flows in more detail.")]),e._v(" "),n("h4",{attrs:{id:"trading-flow"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#trading-flow"}},[e._v("#")]),e._v(" Trading flow")]),e._v(" "),n("p",[e._v("The trading flow is on the critical path of the exchange. Everything must happen fast. The heart of the trading flow\nis the matching engine. Let's go over that first.\nMatching engine\nThe matching engine is also called the cross engine. Here are the primary responsibilities of the matching engine:")]),e._v(" "),n("ol",[n("li",[e._v("Maintain the order book for each symbol. An order book is a list of buy and sell orders for a symbol. We explain\nthe construction of an order book in the Data models section later.")]),e._v(" "),n("li",[e._v("Match buy and sell orders. A match results in two executions (fill), with one each for the buy and sell sides. The\nmatching function must be fast and accurate.")]),e._v(" "),n("li",[e._v("Distribute the execution stream as market data.")])]),e._v(" "),n("p",[e._v("A highly available matching engine implementation must be able to produce matches in a deterministic order. That\nis, given a known sequence of orders as an input, the matching engine must produce the same sequence of\nexecutions (fills) as an output when the sequence is replayed. This determinism is a foundation of high availability\nwhich we will discuss at length in the deep dive section.")]),e._v(" "),n("p",[n("strong",[e._v("Sequencer")])]),e._v(" "),n("p",[e._v("The sequencer is the key component that makes the matching engine deterministic. It stamps every incoming order\nwith a sequence ID before it is processed by the matching engine. It also stamps every pair of executions (flls)\ncompleted by the matching engine with sequence IDs. In other words, the sequencer has an inbound and an\noutbound instance, with each maintaining its own sequences. The sequence generated by each sequencer must be\nsequential numbers, so that any missing numbers can be easily detected. See Figure 7 for details.")]),e._v(" "),n("p",[n("img",{attrs:{src:a(1093),alt:"Figure 7"}}),n("br"),e._v(" "),n("em",[e._v("Inbound and outbound sequencers")])]),e._v(" "),n("p",[e._v("The incoming orders and outgoing executions are stamped with sequence IDs for these reasons:")]),e._v(" "),n("ol",[n("li",[e._v("Timeliness and faimess")]),e._v(" "),n("li",[e._v("Fast recovery / replay")]),e._v(" "),n("li",[e._v("Exactly-once guarantee")])]),e._v(" "),n("p",[e._v("The sequencer does not only generate sequence IDs. It also functions as a message queue. There is one to send\nmessages (incoming orders) to the matching engine, and another one to send messages (executions) back to the\norder manager. It s also an event store for the orders and executions. It is similer to having two Kafka event\nstreams connected to the matching engine, one for incoming orders and the other for outgoing executions. In fact,\nwe could have used Kafka if its latency was lower and more predictable. We discuss how the sequencer is\nimplemented in a low-latency exchange environment in the deep dive section,")]),e._v(" "),n("p",[n("strong",[e._v("Order manager")])]),e._v(" "),n("p",[e._v("The order manager receives orders on one end and receives executions on the other. It manages the orders’ states.\nLet's look at it closely.")]),e._v(" "),n("p",[e._v("The order manager receives inbound orders from the client gateway and performs the following:")]),e._v(" "),n("ul",[n("li",[e._v("It sends the order for risk checks. Our requirements for risk checking are simple. For example, we verify that a\nuser's trade volume is below $1M a day.")]),e._v(" "),n("li",[e._v("It checks the order against the user's wallet and verifies that there are sufficient funds to cover the trade. The\nwallet was discussed at length in the “Digital Wallet” chapter. Refer to that chapter for an implementation that\nwould work in the exchange.")]),e._v(" "),n("li",[e._v("It sends the order to the sequencer where the order is stamped with a sequence ID. The sequenced order is\nthen processed by the matching engine. There are many attributes in a new order, but there is no need to send\nall the attributes to the matching engine. To reduce the size of the message in data transmission, the order\nmanager only sends the necessary attributes.")])]),e._v(" "),n("p",[e._v("On the other end, the order manager receives executions from the matching engine via the sequencer. The order\nmanager retumns the executions for the filled orders to the brokers via the client gateway.")]),e._v(" "),n("p",[e._v("The order manager should be fast, efficient, and accurate. It maintains the current states for the orders. In fact, the\nchallenge of managing the various state transitions is the major source of complexity for the order manager. There\ncan be tens of thousands of cases involved in a real exchange system. Event sourcing [9] is perfect for the design of\nan order manager. We discuss an event sourcing design in the deep dive section.")]),e._v(" "),n("p",[n("strong",[e._v("Client gateway")])]),e._v(" "),n("p",[e._v("The client gateway is the gatekeeper for the exchange. It receives orders placed by clients and routes them to the\norder manager. The gateway provides the following functions as shown in Figure 8.")]),e._v(" "),n("p",[n("img",{attrs:{src:a(1094),alt:"Figure 8"}}),n("br"),e._v(" "),n("em",[e._v("Figure 8 Client gateway components.")])]),e._v(" "),n("p",[e._v("The client gateway s on the critical path and is latency-sensitive. It should stay lightweight. It passes orders to the\ncorrect destinations as quickly as possible. The functions above, while critical, must be completed as quickly as\npossible. It s a design trade-off to decide what functionality to put in the client gateway, and what to leave out. As\na general guideline, we should leave complicated functions to the matching engine and risk check.")]),e._v(" "),n("p",[e._v("There are different types of client gateways for retail and institutional clients. The main considerations are latency,\ntransaction volume, and security requirements. For instance, institutions like the market makers provide a large\nportion of liquidity for the exchange. They require very low latency. Figure 9 shows different client gateway\nconnections to an exchange. An extreme example is the colocation (colo) engine. It is the trading engine software\nrunning on some servers rented by the broker in the exchange's data center. The latency s literally the time it takes\nfor light to travel from the colocated server to the exchange server [10].")]),e._v(" "),n("p",[n("img",{attrs:{src:a(1095),alt:"Figure 9"}}),n("br"),e._v(" "),n("em",[e._v("Figure 9 Client gateway")])]),e._v(" "),n("h4",{attrs:{id:"market-data-flow"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#market-data-flow"}},[e._v("#")]),e._v(" Market data flow")]),e._v(" "),n("p",[e._v("The market data publisher (MDP) receives executions (fills) from the matching engine and builds the order books\nand candlestick charts from the stream of executions. The order books and candlestick charts, which we discuss in\nthe Data Models section later, are collectively called market data. The market data is sent to the data service where\nthey are made available to subscribers. Figure 10 shows an implementation of MDP and how it fits with the other\ncomponents in the market data flow.")]),e._v(" "),n("p",[n("img",{attrs:{src:a(1096),alt:"Figure 10"}}),n("br"),e._v(" "),n("em",[e._v("Figure 10 Market Data Publisher")])]),e._v(" "),n("h4",{attrs:{id:"reporting-flow"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#reporting-flow"}},[e._v("#")]),e._v(" Reporting flow")]),e._v(" "),n("p",[e._v("One essential part of the exchange is reporting. The reporter is not on the trading critical path, but it is a critical\npart of the system. It provides trading history, tax reporting, compliance reporting, settlements, etc. Efficiency and\nIatency are critical for the trading flow, but the reporter is less sensitive to latency. Accuracy and compliance are key\nfactors for the reporter.")]),e._v(" "),n("p",[e._v("It is common practice to piece attributes together from both incoming orders and outgoing executions. An\nincoming new order only contains order details, and outgoing execution usually only contains order ID, price,\nquantity, and execution status. The reporter merges the attributes from both sources for the reports. Figure 11\nshows how the components in the report flow fit together.")]),e._v(" "),n("p",[n("img",{attrs:{src:a(1097),alt:"Figure 11"}}),n("br"),e._v(" "),n("em",[e._v("Figure 11 Reporter")])]),e._v(" "),n("p",[e._v('A sharp reader might notice that the section order of “Step 2 - Propose High-Level Design and Get Buy-In" looks a\nlittle different than other chapters. In this chapter, the APl design and data models sections come after the high-\nlevel design. The sections are arranged this way because these other sections require some concepts that were\nintroduced in the high-level design.')]),e._v(" "),n("h3",{attrs:{id:"api-design"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#api-design"}},[e._v("#")]),e._v(" API Design")]),e._v(" "),n("p",[e._v("Now that we understand the high-level design, let's take a look at the API design.")]),e._v(" "),n("p",[e._v("Clients interact with the stock exchange via the brokers to place orders, view executions, view market data,\ndownload historical data for analysis, etc. We use the RESTful conventions for the API below to specify the interface\nbetween the brokers and the client gateway. Refer to the “Data models” section for the resources mentioned below.")]),e._v(" "),n("p",[e._v("Note that the REST API might not satisfy the latency requirements of institutional clients like hedge funds. The\nspecialized software built for these institutions likely uses a different protocol, but no matter what it is, the basic\nfunctionality mentioned below needs to be supported.")]),e._v(" "),n("h4",{attrs:{id:"order"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#order"}},[e._v("#")]),e._v(" "),n("strong",[e._v("Order")])]),e._v(" "),n("p",[n("code",[e._v("POST /vi/order")])]),e._v(" "),n("p",[e._v("This endpoint places an order. It requires authentication.")]),e._v(" "),n("p",[e._v("Parameters")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("symbol: the stock symbol. String\nside: buy or sell. String\nprice: the price of the limit order. Long\norderType: limit or market (note we only support limit orders in our design). String\nquantity: the quantity of the order. Long\n")])])]),n("p",[e._v("Response")]),e._v(" "),n("p",[e._v("Body:")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("id: the ID of the order. Long\ncreationTime: the system creation time of the order. Long\nfilledQuantity: the quantity that has been successfully executed. Long\nremainingQuantity: the quantity still to be executed. Long\nstatus: new/canceled/filled. String\nrest of the attributes are the same as the input parameters\n")])])]),n("p",[e._v("Code:")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("200: successful\n40x: parameter error/access denied/unauthorized\n560: server error\n")])])]),n("h4",{attrs:{id:"execution"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#execution"}},[e._v("#")]),e._v(" "),n("strong",[e._v("Execution")])]),e._v(" "),n("p",[n("code",[e._v("GET /execution?symbol={:symbol}&orderId={:orderId}&startTine={:startTine}&endTine={:endTine}")])]),e._v(" "),n("p",[e._v("This endpoint queries execution info. It requires authentication.")]),e._v(" "),n("p",[e._v("Parameters")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("symbol: the stock symbol. String\norderId: the ID of the order. Optional. String\nstartTime: query start time in epoch . Long\nendTime: query end time in epoch. Long\n")])])]),n("p",[e._v("Response")]),e._v(" "),n("p",[e._v("Body:")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("executions: array with each execution in scope (see attributes below). Array\nid: the ID of the execution. Long\norderId: the ID of the order. Long\nsymbol: the stock symbol. String\nside: buy or sell. String\nprice: the price of the execution. Long\norderType: limit or market. String\nquantity: the filled quantity. Long\n")])])]),n("p",[e._v("Code:")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("200: successful\n40x: parameter error/not found/access denied/unauthorized\n560: server error\n")])])]),n("h4",{attrs:{id:"order-book"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#order-book"}},[e._v("#")]),e._v(" "),n("strong",[e._v("Order book")])]),e._v(" "),n("p",[n("code",[e._v("GET /marketdata/orderBook/L22symbol={:synbol}&depth={:depth}")])]),e._v(" "),n("p",[e._v("This endpoint queries L2 order book information for a symbol with designated depth.")]),e._v(" "),n("p",[e._v("Parameters")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("symbol: the stock symbol. String\ndepth: order book depth per side. Int\n")])])]),n("p",[e._v("Response")]),e._v(" "),n("p",[e._v("Body:")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("bids: array with price and size. Array\nasks: array with price and size. Array\n")])])]),n("p",[e._v("Code:")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("200: successful\n4xx: parameter error/not found/access denied/unauthorized\n500: server error\n")])])]),n("h4",{attrs:{id:"historical-prices-candlestick-charts"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#historical-prices-candlestick-charts"}},[e._v("#")]),e._v(" "),n("strong",[e._v("Historical prices (candlestick charts)")])]),e._v(" "),n("p",[n("code",[e._v("GET /marketdata/candles?symbol={:synbol}&resolution={:resolution}&startTine={:startTine}&endTine={:endTime}")])]),e._v(" "),n("p",[e._v("This endpoint queries candlestick chart data (see candlestick chart in data models section) for a symbol given a time range and resolution.")]),e._v(" "),n("p",[e._v("Parameters")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("symbol: the stock symbol. String\nresolution: window length of the candlestick chart in seconds. Long\nstartTime: start time of the window in epoch. Long\nendTime: end time of the window in epoch. Long\n")])])]),n("p",[e._v("Response")]),e._v(" "),n("p",[e._v("Body:")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("candles: array with each candlestick data (attributes listed below). Array\nopen: open price of each candlestick. Double\nclose: close price of each candlestick. Double\nhigh: high price of each candlestick. Double\nlow: low price of each candlestick. Double\n")])])]),n("p",[e._v("Code:")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("200: successful\n4ex: parameter error/not found/access denied/unauthorized\n500: server error\n")])])]),n("h3",{attrs:{id:"data-models"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#data-models"}},[e._v("#")]),e._v(" Data models")]),e._v(" "),n("p",[e._v("There are three main types of data in the stock exchange. Let's explore them one by one.")]),e._v(" "),n("ul",[n("li",[e._v("Product, order, and execution")]),e._v(" "),n("li",[e._v("Order book")]),e._v(" "),n("li",[e._v("Candlestick chart")])]),e._v(" "),n("h4",{attrs:{id:"product-order-execution"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#product-order-execution"}},[e._v("#")]),e._v(" Product, order, execution")]),e._v(" "),n("p",[e._v("A product describes the attributes of a traded symbol, like product type, trading symbol, Ul display symbol,\nsettlement currency, lot size, tick size, etc. This data doesn't change frequently. It is primarily used for Ul display.\nThe data can be stored in any database and is highly cacheable.")]),e._v(" "),n("p",[e._v("An order represents the inbound instruction for a buy or sell order. An execution represents the outbound matched\nresult. An execution is also called a fill. Not every order has an execution. The output of the matching engine\ncontains two executions, representing the buy and sell sides of a matched order.")]),e._v(" "),n("p",[e._v("See Figure 12 for the logical model diagram that shows the relationships between the three entities. Note it is not a\ndatabase schema.")]),e._v(" "),n("p",[n("img",{attrs:{src:a(1098),alt:"Figure 12"}}),n("br"),e._v(" "),n("em",[e._v("Figure 12 Product, order, execution")])]),e._v(" "),n("p",[e._v("Orders and executions are the most important data in the exchange. We encounter them in all three flows\nmentioned in the high-level design, in slightly different forms.")]),e._v(" "),n("ul",[n("li",[e._v("In the critical trading path, orders and executions are not stored in a database. To achieve high performance,\nthis path executes trades in memory and leverages hard disk or shared memory to persist and share orders and\nexecutions. Specifically, orders and executions are stored in the sequencer for fast recovery, and data is\narchived after the market closes. We discuss an efficient implementation of the sequencer in the deep dive\nsection")]),e._v(" "),n("li",[e._v("The reporter writes orders and executions to the database for reporting use cases like reconciliation and tax\nreporting.")]),e._v(" "),n("li",[e._v("Executions are forwarded to the market data processor to reconstruct the order book and candlestick chart\ndata. We discuss these data types next.")])]),e._v(" "),n("h4",{attrs:{id:"order-book-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#order-book-2"}},[e._v("#")]),e._v(" Order book")]),e._v(" "),n("p",[e._v("An order book is a list of buy and sell orders for a specific security or financial instrument, organized by price level\n[12] [13]. It is a key data structure in the matching engine for fast order matching. An efficient data structure for an\norder book must satisfy these requirements:")]),e._v(" "),n("ul",[n("li",[e._v("Constant lookup time. Operation includes: getting volume at a price level or between price levels.")]),e._v(" "),n("li",[e._v("Fast add/cancel/execute operations, preferably O(1) time complexity. Operations include: placing a new order, canceling an order, and matching an order.")]),e._v(" "),n("li",[e._v("Fast update. Operation: replacing an order.")]),e._v(" "),n("li",[e._v("Query best bid/ask.")]),e._v(" "),n("li",[e._v("Iterate through price levels.")])]),e._v(" "),n("p",[e._v("Let's walk through an example order execution against an order book, as illustrated in Figure 13.")]),e._v(" "),n("p",[n("img",{attrs:{src:a(1099),alt:"Figure 13"}}),n("br"),e._v(" "),n("em",[e._v("Figure 13 Limit order book illustrated")])]),e._v(" "),n("p",[e._v("In the example above, there is a large market buy order for 2700 shares of Apple. The buy order matches all the sell\norders in the best ask queue and the first sell order in the 100.11 price queue. After fulfilling this large order, the\nbid/ask spread widens, and the price increases by one level (best ask is 10011 now).")]),e._v(" "),n("p",[e._v("The following code snippet shows an implementation of the order book.")]),e._v(" "),n("div",{staticClass:"language-java extra-class"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("class")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("PriceLevel")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("private")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Price")]),e._v(" limitPrice"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("private")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("long")]),e._v(" totalVolume"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("private")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("List")]),n("span",{pre:!0,attrs:{class:"token generics"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("<")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Order")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(">")])]),e._v(" orders"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("class")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Book")]),n("span",{pre:!0,attrs:{class:"token generics"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("<")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Side")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(">")])]),e._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("private")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Side")]),e._v(" side"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("private")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Map")]),n("span",{pre:!0,attrs:{class:"token generics"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("<")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Price")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Pricelevel")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(">")])]),e._v(" limitMap"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("class")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("OrderBook")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("private")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Book")]),n("span",{pre:!0,attrs:{class:"token generics"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("<")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Buy")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(">")])]),e._v(" buyBook"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("private")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Book")]),n("span",{pre:!0,attrs:{class:"token generics"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("<")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Sell")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(">")])]),e._v(" sellBook"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("private")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Pricelevel")]),e._v(" bestBid"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("private")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Pricelevel")]),e._v(" bestOffer"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("private")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Map")]),n("span",{pre:!0,attrs:{class:"token generics"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("<")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("OrderID")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Order")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(">")])]),e._v(" orderMap"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),n("p",[e._v("Does the code meet all the design requirements stated above? For example, when adding/canceling limit order, is the time complexity O(1)? The answer is no since we are using a plain list here ("),n("code",[e._v("private List<Order> orders")]),e._v("). To have a more efficient order book, change the data structure of “orders” to a doubly-linked list so that the deletion type of operation (cancel and match) is also O(1). Let's review how we achieve O(1) time complexity for these\noperations:")]),e._v(" "),n("ol",[n("li",[e._v("Placing a new order means adding a new Order to the tail of the PriceLevel, This is O(1) time complexity for a doubly-linked list.")]),e._v(" "),n("li",[e._v("Matching an order means deleting an Order from the head of the PriceLevel. This is O(1) time complexity for a doubly-linked list.")]),e._v(" "),n("li",[e._v("Canceling an order means deleting an Order from the OrderBook. We leverage the helper data structure "),n("code",[e._v("Map<OrderiD, Order> orderMap")]),e._v(" in the OrderBook to find the Order to cancel in O(1) time. Once the order is found, if the “orders” list was a singly-linked list, the code would have to traverse the entire list to locate the previous pointer in order to delete the order. That would have taken O(n) time. Since the st is now doubly-\nlinked, the order itself has a pointer to the previous order, which allows the code to delete the order without traversing the entire order list.")])]),e._v(" "),n("p",[e._v("Figure 14 explains how these three operations work.")]),e._v(" "),n("p",[n("img",{attrs:{src:a(1100),alt:"Figure 14"}}),n("br"),e._v(" "),n("em",[e._v("Figure 14 Place, match, and cancel an order in O(1)")])]),e._v(" "),n("p",[e._v("See the reference material for more details [14]")]),e._v(" "),n("p",[e._v("It s worth noting that the order book data structure is also heavily used in the market data processor to reconstruct\nthe L1, 12, and L3 data from the streams of executions generated by the matching engine.")]),e._v(" "),n("h4",{attrs:{id:"candlestick-chart-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#candlestick-chart-2"}},[e._v("#")]),e._v(" Candlestick chart")]),e._v(" "),n("p",[e._v("Candlestick chart is another key data structure (alongside order book) in the market data processor to produce\nmarket data.")]),e._v(" "),n("p",[e._v("We model this with a Candlestick class and a CandlestickChart class. When the interval for the candlestick has\nelapsed, a new Candlestick class is instantiated for the next interval and added to the linked list in the CandleStickChart instance.")]),e._v(" "),n("div",{staticClass:"language-java extra-class"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("class")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Candlestick")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("private")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("long")]),e._v(" openPrice"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("private")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("long")]),e._v(" closePrice"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("private")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("long")]),e._v(" highPrice"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("private")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("long")]),e._v(" lowprice"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("private")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("long")]),e._v(" volume"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("private")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("long")]),e._v(" timestamp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("private")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("int")]),e._v(" interval"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("class")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Candlestickchart")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("private")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("LinkedList")]),n("span",{pre:!0,attrs:{class:"token generics"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("<")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Candlestick")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(">")])]),e._v(" sticks"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),n("p",[e._v("Tracking price history in candlestick charts for many symbols at many time intervals consumes a lot of memory.\nHow can we optimize it? Here are two ways:")]),e._v(" "),n("ol",[n("li",[e._v("Use pre-allocated ring buffers to hold sticks to reduce the number of new object allocations")]),e._v(" "),n("li",[e._v("Limit the number of sticks in the memory and persist the rest to disk.")])]),e._v(" "),n("p",[e._v("We will examine the optimizations in the “Market data publisher” section in deep dive.\nThe market data is usually persisted in an in-memory columnar database (for example, KDB [15]) for real-time\nanalytics. After the market is closed, data is persisted in a historical database.")]),e._v(" "),n("h2",{attrs:{id:"step-3-design-deep-dive"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#step-3-design-deep-dive"}},[e._v("#")]),e._v(" Step 3 - Design Deep Dive")]),e._v(" "),n("p",[e._v("Now that we understand how an exchange works at a high level, let's investigate how a modern exchange has\nevolved to become what it is today. What does a modern exchange look like? The answer might surprise a lot of\nreaders. Some large exchanges run almost everything on a single gigantic server. While it might sound extreme, we\ncan learn many good lessons from it.\nLet's dive in.")]),e._v(" "),n("h3",{attrs:{id:"performance"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#performance"}},[e._v("#")]),e._v(" Performance")]),e._v(" "),n("p",[e._v("As discussed in the non-functional requirements, latency is very important for an exchange. Not only does the\naverage latency need to be low, but the overall latency must also be stable. A good measure for the level of stability\nis the 99th percentile latency.")]),e._v(" "),n("p",[e._v("Latency can be broken down into its components as shown in the formula below:")]),e._v(" "),n("p",[n("code",[e._v("Latency - ∑executionTimeAlongCriticalPath")]),e._v("\nThere are two ways to reduce latency:")]),e._v(" "),n("ol",[n("li",[e._v("Decrease the number of tasks on the critical path.")]),e._v(" "),n("li",[e._v("Shorten the time spent on each task:\n"),n("ol",[n("li",[e._v("By reducing or eliminating network and disk usage")]),e._v(" "),n("li",[e._v("By reducing execution time for each task")])])])]),e._v(" "),n("p",[e._v("Let's review the first point. As shown in the high-level design, the critical trading path includes the following:")]),e._v(" "),n("p",[n("code",[e._v("gateway -> order manager -> sequencer -> matching engine")])]),e._v(" "),n("p",[e._v("The critical path only contains the necessary components, even logging is removed from the critical path to achieve\nlow latency.")]),e._v(" "),n("p",[e._v("Now let's look at the second point. In the high-level design, the components on the critical path run on individual servers connected over the network. The round trip network latency is about 500 microseconds. When there are\nmultiple components all communicating over the network on the critical path, the total network latency adds up to\nsingle-digit milliseconds. In addition, the sequencer is an event store that persists events to disk. Even assuming an\nefficient design that leverages the performance advantage of sequential writes, the latency of disk access still\nmeasures in tens of milliseconds. To leam more about network and disk access latency, see \"Latency Numbers Every\nProgrammer Should Know [16].")]),e._v(" "),n("p",[e._v("Accounting for both network and disk access latency, the total end-to-end latency adds up to tens of milliseconds.\nWhile this number was respectable in the early days of the exchange, it is no longer sufficient as exchanges\ncompete for ultra-low latency.")]),e._v(" "),n("p",[e._v("To stay ahead of the competition, exchanges over time evolve their design to reduce the end-to-end latency on the\nritical path to tens of microseconds, primarily by exploring options to reduce or eliminate network and disk access\nlatency. A time-tested design eliminates the network hops by putting everything on the same server. When all\ncomponents are on the same server, they can communicate via mmap [17] as an event store (more on this later).\nFigure 15 shows a low-latency design with all the components on a single server:")]),e._v(" "),n("p",[n("img",{attrs:{src:a(1101),alt:"Figure 15"}}),n("br"),e._v(" "),n("em",[e._v("Figure 15 A low latency single server exchange design")])]),e._v(" "),n("p",[e._v("There are a few interesting design decisions that are worth a closer look at.")]),e._v(" "),n("p",[e._v("Let's first focus on the application loops in the diagram above. An application loop s an interesting concept. It\nkeeps polling for tasks to execute in a while loop and is the primary task execution mechanism. To meet the strict\nlatency budget, only the most mission-critical tasks should be processed by the application loop. Its goal is to\nreduce the execution time for each component and to guarantee a highly predictable execution time (i, a low\n99th percentile latency). Each box in the diagram represents a component. A component is a process on the server.\nTo maximize CPU efficiency, each application loop (think of it as the main processing loop) is single-threaded, and\nthe thread is pinned to a fixed CPU core. Using the order manager as an example, it looks like the following\ndiagram (Figure 16).")]),e._v(" "),n("p",[n("img",{attrs:{src:a(1102),alt:"Figure 16"}}),n("br"),e._v(" "),n("em",[e._v("Figure 16 Application loop thread in Order Manager")])]),e._v(" "),n("p",[e._v("In this diagram, the application loop for the order manager is pinned to CPU 1. The benefits of pinning the\napplication loop to the CPU are substantial:")]),e._v(" "),n("ol",[n("li",[e._v("No context switch [18]. CPU 1 is fully allocated to the order manager's application loop.")]),e._v(" "),n("li",[e._v("No locks and therefore no lock contention, since there is only one thread that updates states.")])]),e._v(" "),n("p",[e._v("Both of these contribute to a low 99th percentile latency.")]),e._v(" "),n("p",[e._v("The tradeoff of CPU pinning is that it makes coding more complicated. Engineers need to carefully analyze the time\neach task takes to keep it from occupying the application loop thread for too long, as it can potentially block\nsubsequent tasks.")]),e._v(" "),n("p",[e._v('Next, let\'s focus our attention on the long rectangle labeled “mmap” at the center of Figure 15. “mmap” refers to a\nPOSIX-compliant UNIX system call named “mmap(2) that maps a file into the memory of a process.\n“mmap(2)" provides a mechanism for high-performance sharing of memory between processes. The performance\nadvantage is compounded when the backing file is in */dev/shm". /dev/shm’ is a memory-backed file system. When\n"mmap(2) is done over a file in */dev/shm’, the access to the shared memory does not result in any disk access at\nall.')]),e._v(" "),n("p",[e._v("Modern exchanges take advantage of this to eliminate as much disk access from the critical path as possible.\n“mmap(2) is used in the server to implement a message bus over which the components on the critical path\ncommunicate. The communication pathway has no network or disk access, and sending a message on this mmap\nmessage bus takes sub-microsecond. By leveraging mmap to build an event store, coupled with the event sourcing\ndesign paradigm which we will discuss next, modern exchanges can build low-latency microservices inside a server.")]),e._v(" "),n("h3",{attrs:{id:"event-sourcing"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#event-sourcing"}},[e._v("#")]),e._v(" Event sourcing")]),e._v(" "),n("p",[e._v("We discussed event sourcing in the “Digital Wallet” chapter. Refer to that chapter for an in-depth review of event\nsourcing.")]),e._v(" "),n("p",[e._v("The concept of event sourcing is not hard to understand. In a traditional application, states are persisted in a\ndatabase. When something goes wrong, it is hard to trace the source of the issue. The database only keeps the\ncurrent states, and there are no records of the events that have led to the current states.")]),e._v(" "),n("p",[e._v("In event sourcing, instead of storing the current states, it keeps an immutable log of all state-changing events.\nThese events are the golden source of truth. See Figure 17 for a comparison.")]),e._v(" "),n("p",[n("img",{attrs:{src:a(1103),alt:"Figure 17"}}),n("br"),e._v(" "),n("em",[e._v("Figure 17 Non-event sourcing vs event sourcing")])]),e._v(" "),n("p",[e._v("On the left is a classic database schema. It keeps track of the order status for an order, but it does not contain any\ninformation about how an order arrives at the current state. On the right is the event sourcing counterpart. It tracks\nall the events that change the order status, and it can recover order states by replaying all the events in sequence.\nFigure 18 shows an event sourcing design using the mmap event store as a message bus. This looks very much like\nthe Pub-Sub model in Kafka. In fact, if there is no strict latency requirement, Kafka could be used.")]),e._v(" "),n("p",[n("img",{attrs:{src:a(1104),alt:"Figure 18"}}),n("br"),e._v(" "),n("em",[e._v("Figure 18 An event sourcing design")])]),e._v(" "),n("p",[e._v("In the diagram, the external domain communicates with the trading domain using FIX that we introduced in the\nBusiness Knowledge 101 section.")]),e._v(" "),n("ul",[n("li",[e._v("The gateway transforms FIX to “FIX over Simple Binary Encoding” (SBE) for fast and compact encoding and\nsends each order as a NewOrderEvent via the Event Store Client in a pre-defined format (see event store entry\nin the diagram).")]),e._v(" "),n("li",[e._v("The order manager (embedded in the matching engine) receives the NewOrderEvent from the event store,\nvalidates it, and adds it to its intemal order states. The order is then sent to the matching core.")]),e._v(" "),n("li",[e._v("If the order gets matched, an OrderFilledEvent is generated and sent to the event store.")]),e._v(" "),n("li",[e._v("Other components such as the market data processor and the reporter subscribe to the event store and\nprocess those events accordingly.")])]),e._v(" "),n("p",[e._v("This design follows the high-level design closely, but there are some adjustments to make it work more efficiently\nin the event sourcing paradigm.")]),e._v(" "),n("p",[e._v("The first difference is the order manager. The order manager becomes a reusable library that is embedded in\ndifferent components. It makes sense for this design because the states of the orders are important for multiple\ncomponents. Having a centralized order manager for other components to update or query the order states would\nhurt latency, especially if those components are not on the critical trading path, as is the case for the reporter in the\ndiagram. Although each component maintains the order states by itself, with event sourcing the states are\nguaranteed to be identical and replayable.")]),e._v(" "),n("p",[e._v("Another key difference is that the sequencer is nowhere to be seen. What happened to it?")]),e._v(" "),n("p",[e._v('With the event sourcing design, we have one single event store for all messages. Note that the event store entry\ncontains a "sequence” field. This field is injected by the sequencer.')]),e._v(" "),n("p",[e._v("There is only one sequencer for each event store. It is a bad practice to have multiple sequencers, as they will fight\nfor the right to write to the event store. In a busy system like an exchange, a lot of time would be wasted on lock\ncontention. Therefore, the sequencer is a single writer which sequences the events before sending them to the\nevent store. Unlike the sequencer in the high-level design which also functions as a message store, the sequencer\nhere only does one simple thing and is super fast. Figure 19 shows a design for the sequencer in a memory-map\n(MMap) environment.")]),e._v(" "),n("p",[e._v("The sequencer pulls events from the ring buffer that is local to each component. For each event, it stamps a\nsequence ID on the event and sends it to the event store. We can have backup sequencers for high availability in\ncase the primary sequencer goes down.")]),e._v(" "),n("p",[n("img",{attrs:{src:a(1105),alt:"Figure 19"}}),n("br"),e._v(" "),n("em",[e._v("Figure 19 Sample design of Sequencer")])]),e._v(" "),n("h3",{attrs:{id:"high-availability"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#high-availability"}},[e._v("#")]),e._v(" High availability")]),e._v(" "),n("p",[e._v("For high availability, our design aims for 4 nines (99.99%). This means the exchange can only have 8.64 seconds of\ndowntime per day. It requires almost immediate recovery if a service goes down.\nTo achieve high availability, consider the following:")]),e._v(" "),n("ul",[n("li",[e._v("First, identify single-point-of-failures in the exchange architecture. For example, the failure of the matching\nengine could be a disaster for the exchange. Therefore, we set up redundant instances alongside the primary\ninstance.")]),e._v(" "),n("li",[e._v("Second, detection of failure and the decision to failover to the backup instance should be fast")])]),e._v(" "),n("p",[e._v("For stateless services such as the client gateway, they could easily be horizontally scaled by adding more servers.\nFor stateful components, such as the order manager and matching engine, we need to be able to copy state data\nacross replicas.")]),e._v(" "),n("p",[e._v("Figure 20 shows an example of how to copy data. The hot matching engine works as the primary instance, and the\nwarm engine receives and processes the exact same events but does not send any event out onto the event store.\nWhen the primary goes down, the warm instance can immediately take over as the primary and send out events.\nWhen the warm secondary instance goes down, upon restart, it can always recover all the states from the event\nstore. Event sourcing is a great fit for the exchange architecture. The inherent determinism makes state recovery\neasy and accurate.")]),e._v(" "),n("p",[n("img",{attrs:{src:a(1106),alt:"Figure 20"}}),n("br"),e._v(" "),n("em",[e._v("Figure 20 Hot-warm matching engine")])]),e._v(" "),n("p",[e._v("We need to design a mechanism to detect potential problems in the primary. Besides normal monitoring of\nhardware and processes, we can also send heartbeats from the matching engine. If a heartbeat is not received in\ntime, the matching engine might be experiencing problems.")]),e._v(" "),n("p",[e._v("The problem with this hot-warm design is that it only works within the boundary of a single server. To achieve high\navailability, we have to extend this concept across multiple machines or even across data centers. In this setting, an\nentire server is either hot or warm, and the entire event store is replicated from the hot server to all warm replicas.\nReplicating the entire event store across machines takes time. We could use reliable UDP [19] to efficiently\nbroadcast the event messages to all warm servers. Refer to the design of Aeron [20] for an example.")]),e._v(" "),n("p",[e._v("In the next section, we discuss an improvement to the hot-warm design to achieve high availability.")]),e._v(" "),n("h3",{attrs:{id:"fault-tolerance"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#fault-tolerance"}},[e._v("#")]),e._v(" Fault tolerance")]),e._v(" "),n("p",[e._v("The hot-warm design above is relatively simple. It works reasonably well, but what happens if the warm instances\ngo down as well? This is a low probability but catastrophic event, so we should prepare for it.")]),e._v(" "),n("p",[e._v("This is a problem large tech companies face. They tackle it by replicating core data to data centers in multiple cities.\nIt mitigates the risk of a natural disaster such as an earthquake or a large-scale power outage. To make the system\nfault-tolerant, we have to answer many questions:")]),e._v(" "),n("ol",[n("li",[e._v("If the primary instance goes down, how and when do we decide to failover to the backup instance?")]),e._v(" "),n("li",[e._v("How do we choose the leader among backup instances?")]),e._v(" "),n("li",[e._v("What i the recovery time needed (RTO - Recovery Time Objective)?")]),e._v(" "),n("li",[e._v("What functionalities need to be recovered (RPO - Recovery Point Objective)? Can our system operate under\ndegraded conditions?")])]),e._v(" "),n("p",[e._v("Let's answer these questions one by one.")]),e._v(" "),n("p",[e._v("First, we have to understand what “down” really means. This is not as straightforward as it seems. Consider these\nsituations.")]),e._v(" "),n("ol",[n("li",[e._v("The system might send out false alarms, which cause unnecessary failovers.")]),e._v(" "),n("li",[e._v("Bugs in the code might cause the primary instance to go down. The same bug could bring down the backup instance after the failover. When all backup instances are knocked out by the bug, the system is no longer available.")])]),e._v(" "),n("p",[e._v("These are tough problems to solve. Here are some suggestions. When we first release a new system, we might need\nto perform failovers manually. Only when we gather enough signals and operational experience and gain more\nconfidence in the system do we automate the failure detection process. Chaos engineering [21] is a good practice\nto surface edge cases and gain operational experience faster.")]),e._v(" "),n("p",[e._v("Once the decision to failover is correctly made, how do we decide which server takes over? Fortunately, this is a\nwell-understood problem. There are many battle-tested leader-election algorithms. We use Raft [22] as an example.\nFigure 21 shows a Raft cluster with five servers with their own event stores. The current leader sends data to all the\nother instances (followers). The minimum number of votes required to perform an operation in Raft is (N/2 + 1),\nwhere N is the number of members in the cluster. In this example, the minimum is 3")]),e._v(" "),n("p",[e._v("The following diagram (Figure 21) shows the followers receiving new events from the leader over RPC. The events\nare saved to the follower's own mmap event store.")]),e._v(" "),n("p",[n("img",{attrs:{src:a(1107),alt:"Figure 21"}}),n("br"),e._v(" "),n("em",[e._v("Figure 21 Event replication in Raft cluster")])]),e._v(" "),n("p",[e._v("Let's briefly examine the leader election process. The leader sends heartbeat messages (AppendEnties with no\ncontent as shown in Figure 21) to its followers. If a follower has not received heartbeat messages for a period of\ntime, it triggers an election timeout that initiates a new election. The first follower that reaches election timeout\nbecomes a candidate, and it asks the rest of the followers to vote (RequestVote). If the first follower receives a\nmajority of votes, it becomes the new leader. If the first follower has a lower term value than the new node, it\ncannot be the leader. If multiple followers become candidates at the same time, it is called a “split vote”. In this\ncase, the election times out, and a new election is initiated. See Figure 22 for the explanation of “term.” Time is\ndivided into arbitrary intervals in Raft to represent normal operation and election.")]),e._v(" "),n("p",[n("img",{attrs:{src:a(1108),alt:"Figure 22"}}),n("br"),e._v(" "),n("em",[e._v("Figure 22 Raft terms")])]),e._v(" "),n("p",[e._v("Next, let's take a look at recovery time. Recovery Time Objective (RTO) refers to the amount of time an application\ncan be down without causing significant damage to the business. For a stock exchange, we need to achieve a\nsecond-level RTO, which definitely requires automatic failover of services. To do this, we categorize services based\non priority and define a degradation strategy to maintain a minimum service level.")]),e._v(" "),n("p",[e._v("Finally, we need to figure out the tolerance for data loss. Recovery Point Objective (RPO) refers to the amount of\ndata that can be lost before significant harm is done to the business, i.e. the loss tolerance. In practice, this means\nbacking up data frequently. For a stock exchange, data loss is not acceptable, so RPO is near zero. With Raft, we\nhave many copies of the data. it guarantees that state consensus is achieved among cluster nodes. If the current\nleader crashes, the new leader should be able to function immediately.")]),e._v(" "),n("h3",{attrs:{id:"matching-algorithms"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#matching-algorithms"}},[e._v("#")]),e._v(" Matching algorithms")]),e._v(" "),n("p",[e._v("Let's take a slight detour and dive into the matching algorithms. The pseudo-code below explains how matching\nworks at a high level.")]),e._v(" "),n("div",{staticClass:"language-java extra-class"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Context")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("handleOrder")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("OrderBook")]),e._v(" orderBook"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("OrderEvent")]),e._v(" orderEvent"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("if")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("orderEvent"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("getSequenceld")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("!=")]),e._v(" nextSequence"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("return")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Error")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("OUT_OF_ORDER"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" nextSequence"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("if")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("!")]),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("validateorder")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("symbol"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" price"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" quantity"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("return")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("ERROR")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("INVALID_ORDER"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" orderEvent"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Order")]),e._v(" order "),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("createOrderFromEvent")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("orderEvent"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    suitch "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("msgType"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("case")]),e._v(" NEW"),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v("\n            "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("return")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("handleNew")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("orderBook"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" order"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("case")]),e._v(" CANCEL"),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v("\n            "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("return")]),e._v(" handleCancel "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("orderBook"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" order"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("default")]),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v("\n            "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("return")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("ERROR")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("INVALID_MSG_TYPE"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" msgType"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n\n"),n("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Context")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("handleNew")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("OrderBook")]),e._v(" orderBook"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Order")]),e._v(" order"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("if")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("BUY"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("equals")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("order"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("side"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("return")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("match")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("orderBook"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("sellBook"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" order"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("else")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("return")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("match")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("orderBook"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("buyBook"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" order"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n\n"),n("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Context")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("handleCancel")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v("rderBook orderBook"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Order")]),e._v(" order"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("if")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("!")]),e._v("orderBook"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("ordertap"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("contains")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("order"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("orderTd"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("return")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("ERROR")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("CANNOT_CANCEL_ALREADY_MATCHED"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" order"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n    removeOrder "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("order"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("setOrderstatus")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("order"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" CANCELED"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("return")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("SUCCESS")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("CANCEL_SUCCESS"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" order"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n\n"),n("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Context")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("match")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("OrderBook")]),e._v(" book"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Order")]),e._v(" order"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Quantity")]),e._v(" leavesQuantity "),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" order"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("quantity "),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),e._v(" order"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("matchedQuantity"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Iterator")]),n("span",{pre:!0,attrs:{class:"token generics"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("<")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Order")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(">")])]),e._v(" limitIter "),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" book"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("limitMap"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("get")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("order"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("price"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("orders"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    uhile "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("limitTter"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("hashext")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("&")]),e._v(" leavesQuantity "),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[e._v("8")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n        "),n("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Quantity")]),e._v(" matched "),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("min")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("limitIter"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("next"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("quantity"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" order"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("quantity"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n        order"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("matchedQuantity "),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("+=")]),e._v(" matched"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n        leavesQuantity "),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" order"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("quantity "),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),e._v(" order"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("matchedQuantity"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n        "),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("remove")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),e._v("imitIter"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("next"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n        "),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("generateMatchedFill")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("return")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("SUCCESS")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("MATCH_SUCCESS"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" order"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),n("p",[e._v("The pseudocode uses the FIFO (First In First Out) matching algorithm. The order that comes in first at a certain price\nlevel gets matched first, and the last one gets matched last.")]),e._v(" "),n("p",[e._v("There are many matching algorithms. These algorithms are commonly used in futures trading. For example, a FIFO\nwith LMM (Lead Market Maker) algorithm allocates a certain quantity to the LMM based on a predefined ratio\nahead of the FIFO queue, which the LMM firm negotiates with the exchange for the privilege. See more matching\nalgorithms on the CME website [24]. The matching algorithms are used in many other scenarios. A typical one is a\ndark pool [25].")]),e._v(" "),n("h3",{attrs:{id:"determinism"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#determinism"}},[e._v("#")]),e._v(" Determinism")]),e._v(" "),n("p",[e._v("There is both functional determinism and latency determinism. We have covered functional determinism in previous\nsections. The design choices we make, such as sequencer and event sourcing, guarantee that if the events are\nreplayed in the same order, the results will be the same.")]),e._v(" "),n("p",[e._v("With functional determinism, the actual time when the event happens does not matter most of the time. What\nmatters is the order of the events. In Figure 23, event timestamps from discrete uneven dots in the time dimension\nare converted to continuous dots, and the time spent on replay/recovery can be greatly reduced.")]),e._v(" "),n("p",[n("img",{attrs:{src:a(1109),alt:"Figure 23"}}),n("br"),e._v(" "),n("em",[e._v("Figure 23 Time in event sourcing")])]),e._v(" "),n("p",[e._v("Latency determinism means having almost the same latency through the system for each trade. This is key to the\nbusiness. There is a mathematical way to measure this: the 99th percentile latency, or even more strictly, the 99.99th\npercentile latency. We can leverage HdrHistogram [26] to calculate latency. If the 99th percentile latency is low, the\nexchange offers stable performance across almost all the trades.")]),e._v(" "),n("p",[e._v("It is important to investigate large latency fluctuations. For example, in Java, safe points are often the cause. The\nHotSpot JVM [27] Stop-the-World garbage collection is a well-known example.\nThis concludes our deep dive on the critical trading path. In the remainder of this chapter, we take a closer look at\nsome of the more interesting aspects of other parts of the exchange.")]),e._v(" "),n("h3",{attrs:{id:"market-data-publisher-optimizations"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#market-data-publisher-optimizations"}},[e._v("#")]),e._v(" Market data publisher optimizations")]),e._v(" "),n("p",[e._v("As we can see from the matching algorithm, the L3 order book data gives us a better view of the market. We can\nget free one-day candlestick data from Google Finance, but it is expensive to get the more detailed L2/L3 order\nbook data. Many hedge funds record the data themselves via the exchange real-time APl to build their own\ncandlestick charts and other charts for technical analysis.")]),e._v(" "),n("p",[e._v("The market data publisher (MDP) receives matched results from the matching engine and rebuilds the order book\nand candlestick charts based on that. It then publishes the data to the subscribers.")]),e._v(" "),n("p",[e._v("The order book rebuild is similar to the pseudocode mentioned in the matching algorithms section above. MDP is a\nservice with many levels. For example, a retail client can only view 5 levels of L2 data by default and needs to pay\nextra to get 10 levels. MDP's memory cannot expand forever, so we need to have an upper limit on the candlesticks.\nRefer to the data models section for a review of the candlestick charts. The design of the MDP is in Figure 24.")]),e._v(" "),n("p",[n("img",{attrs:{src:a(1110),alt:"Figure 24"}}),n("br"),e._v(" "),n("em",[e._v("Figure 24 Market Data Publisher")])]),e._v(" "),n("p",[e._v("This design utilizes ring buffers. A ring buffer, also called a circular buffer, is a fixed-size queue with the head\nconnected to the tail. A producer continuously produces data and one or more consumers pull data off it. The\nspace in a ring buffer is pre-allocated. There is no object creation or deallocation necessary. The data structure is\nalso lock-free. There are other techniques to make the data structure even more efficient. For example, padding\nensures that the ring buffer’s sequence number is never in a cache line with anything else. Refer to [28] for more\ndetail.")]),e._v(" "),n("h3",{attrs:{id:"distribution-fairness-of-market-data"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#distribution-fairness-of-market-data"}},[e._v("#")]),e._v(" Distribution fairness of market data")]),e._v(" "),n("p",[e._v("In stock trading, having lower latency than others is like having an oracle that can see the future. For a regulated\nexchange, it is important to guarantee that all the receivers of market data get that data at the same time. Why is\nthis important? For example, the MDP holds a list of data subscribers, and the order of the subscribers is decided by\nthe order in which they connect to the publisher, with the first one always receiving data first. Guess what happens,\nthen? Smart clients will fight to be the first on the list when the market opens.")]),e._v(" "),n("p",[e._v("There are some ways to mitigate this. Multicast using reliable UDP is a good solution to broadcast updates to many\nparticipants at once. The MDP could also assign a random order when the subscriber connects to it. We look at\nmulticast in more detail.")]),e._v(" "),n("h3",{attrs:{id:"multicast"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#multicast"}},[e._v("#")]),e._v(" Multicast")]),e._v(" "),n("p",[e._v("Data can be transported over the intemet by three different types of protocols. Let's take a quick look.")]),e._v(" "),n("ol",[n("li",[e._v("Unicast: from one source to one destination.")]),e._v(" "),n("li",[e._v("Broadcast: from one source to an entire subnetwork.")]),e._v(" "),n("li",[e._v("Multicast: from one source to a set of hosts that can be on different subnetworks.")])]),e._v(" "),n("p",[e._v("Multicast is a commonly-used protocol in exchange design. By configuring several receivers in the same multicast\ngroup, they will in theory receive data at the same time. However, UDP is an unreliable protocol and the datagram\nmight not reach all the receivers. There are solutions to handle retransmission [29].")]),e._v(" "),n("h3",{attrs:{id:"colocation"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#colocation"}},[e._v("#")]),e._v(" Colocation")]),e._v(" "),n("p",[e._v("While we are on the subject of fairness, it is a fact that a lot of exchanges offer colocation services, which put hedge\nfunds or brokers’ servers in the same data center as the exchange. The latency in placing an order to the matching\nengine is essentially proportional to the length of the cable. Colocation does not break the notion of faimess. It can\nbe considered as a paid-for VIP service.")]),e._v(" "),n("h3",{attrs:{id:"network-security"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#network-security"}},[e._v("#")]),e._v(" Network security")]),e._v(" "),n("p",[e._v("An exchange usually provides some public interfaces and a DDoS attack is a real challenge. Here are a few\ntechniques to combat DDoS:")]),e._v(" "),n("ol",[n("li",[e._v("Isolate public services and data from private services, so DDoS attacks don't impact the most important clients. In case the same data is served, we can have multiple read-only copies to isolate problems.")]),e._v(" "),n("li",[e._v("Use a caching layer to store data that is infrequently updated. With good caching, most queries won't hit databases.")]),e._v(" "),n("li",[e._v("Harden URLs against DDoS attacks. For example, with an URL like "),n("code",[e._v("https://my.website.com/data?from=123&to=456")]),e._v(", an attacker can easily generate many different requests by changing the query string. Instead, URLS like this work better: "),n("code",[e._v("https://my.website.com/data/recent")]),e._v(". It can also be cached at the CDN\nlayer.")]),e._v(" "),n("li",[e._v("An effective safelist/blocklist mechanism is needed. Many network gateway products provide this type of functionality.")]),e._v(" "),n("li",[e._v("Rate limiting is frequently used to defend against DDoS attacks.")])]),e._v(" "),n("h2",{attrs:{id:"wrap-up"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#wrap-up"}},[e._v("#")]),e._v(" Wrap Up")]),e._v(" "),n("p",[e._v("After reading this chapter, you may come to the conclusion that an ideal deployment model for a big exchange is\nto put everything on a single gigantic server or even one single process. Indeed, this is exactly how some exchanges\nare designed!")]),e._v(" "),n("p",[e._v("With the recent development of the cryptocurrency industry, many crypto exchanges use cloud infrastructure to\ndeploy their services [30]. Some decentralized finance projects are based on the notion of AMM (Automatic Market\nMaking) and don't even need an order book.")]),e._v(" "),n("p",[e._v("The convenience provided by the cloud ecosystem changes some of the designs and lowers the threshold for\nentering the industry. This will surely inject innovative energy into the financial world")])])}),[],!1,null,null,null);t.default=s.exports}}]);