<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>20. Designing for Performance | Nguyễn Khánk&#39;s Wiki</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="apple-touch-icon" sizes="180x180" href="../public/favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../public/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../public/favicons/favicon-16x16.png">
    <link rel="manifest" href="../public/favicons/manifest.json">
    <link rel="mask-icon" href="../public/favicons/safari-pinned-tab.svg" color="#3a0839">
    <link rel="shortcut icon" href="../public/favicons/favicon.ico">
    <meta name="description" content="Wikipedia của tui">
    <meta name="msapplication-TileColor" content="#3a0839">
    <meta name="msapplication-config" content="../public/favicons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    
    <link rel="preload" href="/docs/assets/css/0.styles.0558eedd.css" as="style"><link rel="preload" href="/docs/assets/js/app.ed218ff4.js" as="script"><link rel="preload" href="/docs/assets/js/2.de1d5c77.js" as="script"><link rel="preload" href="/docs/assets/js/28.109d4d82.js" as="script"><link rel="preload" href="/docs/assets/js/33.5733d073.js" as="script"><link rel="prefetch" href="/docs/assets/js/10.5023c493.js"><link rel="prefetch" href="/docs/assets/js/100.284a981f.js"><link rel="prefetch" href="/docs/assets/js/101.bd8bcb48.js"><link rel="prefetch" href="/docs/assets/js/102.482ff64f.js"><link rel="prefetch" href="/docs/assets/js/103.13336080.js"><link rel="prefetch" href="/docs/assets/js/104.78c8ba0b.js"><link rel="prefetch" href="/docs/assets/js/105.106fff09.js"><link rel="prefetch" href="/docs/assets/js/106.f9f0a8b7.js"><link rel="prefetch" href="/docs/assets/js/107.835564b8.js"><link rel="prefetch" href="/docs/assets/js/108.2eff01a1.js"><link rel="prefetch" href="/docs/assets/js/109.4966e4a5.js"><link rel="prefetch" href="/docs/assets/js/11.f47a5c98.js"><link rel="prefetch" href="/docs/assets/js/110.73d2c6e6.js"><link rel="prefetch" href="/docs/assets/js/111.92fffb03.js"><link rel="prefetch" href="/docs/assets/js/112.fd20c3c6.js"><link rel="prefetch" href="/docs/assets/js/113.c8655eb5.js"><link rel="prefetch" href="/docs/assets/js/114.14138359.js"><link rel="prefetch" href="/docs/assets/js/115.c736f983.js"><link rel="prefetch" href="/docs/assets/js/116.1f006b3a.js"><link rel="prefetch" href="/docs/assets/js/117.e3a9d496.js"><link rel="prefetch" href="/docs/assets/js/118.81a595ef.js"><link rel="prefetch" href="/docs/assets/js/119.7e381904.js"><link rel="prefetch" href="/docs/assets/js/12.f307c195.js"><link rel="prefetch" href="/docs/assets/js/120.22879100.js"><link rel="prefetch" href="/docs/assets/js/121.57012466.js"><link rel="prefetch" href="/docs/assets/js/122.c6c4cdb1.js"><link rel="prefetch" href="/docs/assets/js/123.f2131bbb.js"><link rel="prefetch" href="/docs/assets/js/124.39b9af6f.js"><link rel="prefetch" href="/docs/assets/js/125.efb5921e.js"><link rel="prefetch" href="/docs/assets/js/126.ef25b1f2.js"><link rel="prefetch" href="/docs/assets/js/127.65ef0044.js"><link rel="prefetch" href="/docs/assets/js/128.381c574c.js"><link rel="prefetch" href="/docs/assets/js/129.0bc9eb99.js"><link rel="prefetch" href="/docs/assets/js/13.dd6ab06d.js"><link rel="prefetch" href="/docs/assets/js/130.e13a98e6.js"><link rel="prefetch" href="/docs/assets/js/131.3ee7c5b9.js"><link rel="prefetch" href="/docs/assets/js/132.55caabc9.js"><link rel="prefetch" href="/docs/assets/js/133.714e6d14.js"><link rel="prefetch" href="/docs/assets/js/134.333503ce.js"><link rel="prefetch" href="/docs/assets/js/135.438ec9e1.js"><link rel="prefetch" href="/docs/assets/js/136.22d22116.js"><link rel="prefetch" href="/docs/assets/js/137.1ea3c2bf.js"><link rel="prefetch" href="/docs/assets/js/138.cf10f8f2.js"><link rel="prefetch" href="/docs/assets/js/139.bfa498ce.js"><link rel="prefetch" href="/docs/assets/js/14.934dd6a1.js"><link rel="prefetch" href="/docs/assets/js/140.1330e75a.js"><link rel="prefetch" href="/docs/assets/js/141.cd638896.js"><link rel="prefetch" href="/docs/assets/js/142.a5dd51d2.js"><link rel="prefetch" href="/docs/assets/js/143.e2aca1b6.js"><link rel="prefetch" href="/docs/assets/js/144.28aecb0c.js"><link rel="prefetch" href="/docs/assets/js/145.5d9cfb0f.js"><link rel="prefetch" href="/docs/assets/js/146.31b921ad.js"><link rel="prefetch" href="/docs/assets/js/147.929ca0f1.js"><link rel="prefetch" href="/docs/assets/js/148.eb2238e6.js"><link rel="prefetch" href="/docs/assets/js/149.e2a2ef57.js"><link rel="prefetch" href="/docs/assets/js/15.ba146d8d.js"><link rel="prefetch" href="/docs/assets/js/150.69701526.js"><link rel="prefetch" href="/docs/assets/js/151.8c8bf959.js"><link rel="prefetch" href="/docs/assets/js/152.faabc959.js"><link rel="prefetch" href="/docs/assets/js/153.7f9bb591.js"><link rel="prefetch" href="/docs/assets/js/154.0b2385bb.js"><link rel="prefetch" href="/docs/assets/js/155.1a770cd3.js"><link rel="prefetch" href="/docs/assets/js/156.ba81b7ee.js"><link rel="prefetch" href="/docs/assets/js/157.33f72c1f.js"><link rel="prefetch" href="/docs/assets/js/158.189a0e14.js"><link rel="prefetch" href="/docs/assets/js/159.d2393949.js"><link rel="prefetch" href="/docs/assets/js/16.fbc0e33c.js"><link rel="prefetch" href="/docs/assets/js/160.f16a8efd.js"><link rel="prefetch" href="/docs/assets/js/161.8351bc9e.js"><link rel="prefetch" href="/docs/assets/js/162.c8f8d515.js"><link rel="prefetch" href="/docs/assets/js/163.05f11963.js"><link rel="prefetch" href="/docs/assets/js/164.30dd077a.js"><link rel="prefetch" href="/docs/assets/js/165.a84ae891.js"><link rel="prefetch" href="/docs/assets/js/166.296952ef.js"><link rel="prefetch" href="/docs/assets/js/167.c5978c49.js"><link rel="prefetch" href="/docs/assets/js/168.e02ee7ff.js"><link rel="prefetch" href="/docs/assets/js/169.5bf5cd48.js"><link rel="prefetch" href="/docs/assets/js/17.ac45b0d9.js"><link rel="prefetch" href="/docs/assets/js/170.b8908ae9.js"><link rel="prefetch" href="/docs/assets/js/171.bf6e66a1.js"><link rel="prefetch" href="/docs/assets/js/172.f1ccdde6.js"><link rel="prefetch" href="/docs/assets/js/173.7b7ab2e8.js"><link rel="prefetch" href="/docs/assets/js/174.cb532ca5.js"><link rel="prefetch" href="/docs/assets/js/175.ac29e746.js"><link rel="prefetch" href="/docs/assets/js/176.650233f1.js"><link rel="prefetch" href="/docs/assets/js/177.a771ee5b.js"><link rel="prefetch" href="/docs/assets/js/178.5010c3a0.js"><link rel="prefetch" href="/docs/assets/js/179.ece519fc.js"><link rel="prefetch" href="/docs/assets/js/18.0f9655d5.js"><link rel="prefetch" href="/docs/assets/js/180.abef5f22.js"><link rel="prefetch" href="/docs/assets/js/181.64a28d38.js"><link rel="prefetch" href="/docs/assets/js/182.63909734.js"><link rel="prefetch" href="/docs/assets/js/183.9310dd5d.js"><link rel="prefetch" href="/docs/assets/js/184.44b63ca0.js"><link rel="prefetch" href="/docs/assets/js/185.a1645c38.js"><link rel="prefetch" href="/docs/assets/js/186.9e70827f.js"><link rel="prefetch" href="/docs/assets/js/187.3b40d84e.js"><link rel="prefetch" href="/docs/assets/js/188.afa48289.js"><link rel="prefetch" href="/docs/assets/js/189.e891e567.js"><link rel="prefetch" href="/docs/assets/js/19.8a639b7d.js"><link rel="prefetch" href="/docs/assets/js/190.83e8bba7.js"><link rel="prefetch" href="/docs/assets/js/191.90f7bb80.js"><link rel="prefetch" href="/docs/assets/js/192.222e5cdd.js"><link rel="prefetch" href="/docs/assets/js/193.a6d159ea.js"><link rel="prefetch" href="/docs/assets/js/194.563cfecb.js"><link rel="prefetch" href="/docs/assets/js/195.d2897b3b.js"><link rel="prefetch" href="/docs/assets/js/196.5ddfdec2.js"><link rel="prefetch" href="/docs/assets/js/197.e4bc2354.js"><link rel="prefetch" href="/docs/assets/js/198.260a922a.js"><link rel="prefetch" href="/docs/assets/js/199.8ff33dbe.js"><link rel="prefetch" href="/docs/assets/js/20.34b7e349.js"><link rel="prefetch" href="/docs/assets/js/200.fe8cf14f.js"><link rel="prefetch" href="/docs/assets/js/201.a1972b93.js"><link rel="prefetch" href="/docs/assets/js/202.3e8a4959.js"><link rel="prefetch" href="/docs/assets/js/203.1aa267b3.js"><link rel="prefetch" href="/docs/assets/js/204.6d03fc54.js"><link rel="prefetch" href="/docs/assets/js/205.c94c0957.js"><link rel="prefetch" href="/docs/assets/js/206.4aaea647.js"><link rel="prefetch" href="/docs/assets/js/207.53432dde.js"><link rel="prefetch" href="/docs/assets/js/208.2e2685d4.js"><link rel="prefetch" href="/docs/assets/js/209.e44362a3.js"><link rel="prefetch" href="/docs/assets/js/21.c59e0e98.js"><link rel="prefetch" href="/docs/assets/js/210.11dc1c0f.js"><link rel="prefetch" href="/docs/assets/js/211.38928593.js"><link rel="prefetch" href="/docs/assets/js/212.19c32eeb.js"><link rel="prefetch" href="/docs/assets/js/213.6bb90207.js"><link rel="prefetch" href="/docs/assets/js/214.ef46c11c.js"><link rel="prefetch" href="/docs/assets/js/215.87ebbaa1.js"><link rel="prefetch" href="/docs/assets/js/216.3e0b9647.js"><link rel="prefetch" href="/docs/assets/js/217.bd724dcc.js"><link rel="prefetch" href="/docs/assets/js/218.7dd31ae5.js"><link rel="prefetch" href="/docs/assets/js/219.fd005e52.js"><link rel="prefetch" href="/docs/assets/js/22.f9821b9b.js"><link rel="prefetch" href="/docs/assets/js/220.666e4005.js"><link rel="prefetch" href="/docs/assets/js/221.a8dd5ae3.js"><link rel="prefetch" href="/docs/assets/js/222.874715bc.js"><link rel="prefetch" href="/docs/assets/js/223.8ba1487c.js"><link rel="prefetch" href="/docs/assets/js/224.6a86e41d.js"><link rel="prefetch" href="/docs/assets/js/225.92d34f6c.js"><link rel="prefetch" href="/docs/assets/js/226.4003aa80.js"><link rel="prefetch" href="/docs/assets/js/227.4a90fe5e.js"><link rel="prefetch" href="/docs/assets/js/228.f96aa744.js"><link rel="prefetch" href="/docs/assets/js/229.0bb9d718.js"><link rel="prefetch" href="/docs/assets/js/23.7f8c26e7.js"><link rel="prefetch" href="/docs/assets/js/230.3abadf74.js"><link rel="prefetch" href="/docs/assets/js/231.f481c052.js"><link rel="prefetch" href="/docs/assets/js/232.1ab6c50c.js"><link rel="prefetch" href="/docs/assets/js/233.79bd4f9d.js"><link rel="prefetch" href="/docs/assets/js/234.0920aa15.js"><link rel="prefetch" href="/docs/assets/js/235.cc7c94cf.js"><link rel="prefetch" href="/docs/assets/js/236.e96ebfd6.js"><link rel="prefetch" href="/docs/assets/js/237.8072e640.js"><link rel="prefetch" href="/docs/assets/js/238.3da34ec8.js"><link rel="prefetch" href="/docs/assets/js/239.f95e07b0.js"><link rel="prefetch" href="/docs/assets/js/24.3338bd23.js"><link rel="prefetch" href="/docs/assets/js/240.3b721888.js"><link rel="prefetch" href="/docs/assets/js/241.14ad8beb.js"><link rel="prefetch" href="/docs/assets/js/242.53903205.js"><link rel="prefetch" href="/docs/assets/js/243.39960f42.js"><link rel="prefetch" href="/docs/assets/js/244.4d638c11.js"><link rel="prefetch" href="/docs/assets/js/245.04dd8a3c.js"><link rel="prefetch" href="/docs/assets/js/246.a37c142d.js"><link rel="prefetch" href="/docs/assets/js/247.9e8fb79c.js"><link rel="prefetch" href="/docs/assets/js/248.dba561a4.js"><link rel="prefetch" href="/docs/assets/js/249.f211299b.js"><link rel="prefetch" href="/docs/assets/js/25.468a3b2e.js"><link rel="prefetch" href="/docs/assets/js/250.b3c6759c.js"><link rel="prefetch" href="/docs/assets/js/251.0db82277.js"><link rel="prefetch" href="/docs/assets/js/252.8679430e.js"><link rel="prefetch" href="/docs/assets/js/253.faefbc64.js"><link rel="prefetch" href="/docs/assets/js/254.aed93289.js"><link rel="prefetch" href="/docs/assets/js/255.5ecb3a43.js"><link rel="prefetch" href="/docs/assets/js/256.cc3e9853.js"><link rel="prefetch" href="/docs/assets/js/257.b7846464.js"><link rel="prefetch" href="/docs/assets/js/258.ca0e33b0.js"><link rel="prefetch" href="/docs/assets/js/259.b7bf4388.js"><link rel="prefetch" href="/docs/assets/js/26.e421c065.js"><link rel="prefetch" href="/docs/assets/js/260.5231851d.js"><link rel="prefetch" href="/docs/assets/js/261.933a4915.js"><link rel="prefetch" href="/docs/assets/js/262.382bdc60.js"><link rel="prefetch" href="/docs/assets/js/263.e3c2ccdc.js"><link rel="prefetch" href="/docs/assets/js/264.26400404.js"><link rel="prefetch" href="/docs/assets/js/265.91af8d06.js"><link rel="prefetch" href="/docs/assets/js/266.797f8075.js"><link rel="prefetch" href="/docs/assets/js/267.7263c1c9.js"><link rel="prefetch" href="/docs/assets/js/268.9557f12f.js"><link rel="prefetch" href="/docs/assets/js/269.829ddaae.js"><link rel="prefetch" href="/docs/assets/js/27.70b852e1.js"><link rel="prefetch" href="/docs/assets/js/270.4e213479.js"><link rel="prefetch" href="/docs/assets/js/271.16b02057.js"><link rel="prefetch" href="/docs/assets/js/272.9e60b1c3.js"><link rel="prefetch" href="/docs/assets/js/273.4a6e548a.js"><link rel="prefetch" href="/docs/assets/js/274.8888e585.js"><link rel="prefetch" href="/docs/assets/js/275.ee0e6094.js"><link rel="prefetch" href="/docs/assets/js/276.aa39f70f.js"><link rel="prefetch" href="/docs/assets/js/277.53a44a06.js"><link rel="prefetch" href="/docs/assets/js/278.eeed994d.js"><link rel="prefetch" href="/docs/assets/js/279.75063327.js"><link rel="prefetch" href="/docs/assets/js/280.0e47e49a.js"><link rel="prefetch" href="/docs/assets/js/281.d011de44.js"><link rel="prefetch" href="/docs/assets/js/282.84bd9472.js"><link rel="prefetch" href="/docs/assets/js/283.93328ae1.js"><link rel="prefetch" href="/docs/assets/js/284.7ebedfbc.js"><link rel="prefetch" href="/docs/assets/js/285.4cc7cf0b.js"><link rel="prefetch" href="/docs/assets/js/286.fa87b3dc.js"><link rel="prefetch" href="/docs/assets/js/287.f518fced.js"><link rel="prefetch" href="/docs/assets/js/288.db51c51c.js"><link rel="prefetch" href="/docs/assets/js/289.d2dbad36.js"><link rel="prefetch" href="/docs/assets/js/29.a56dcea8.js"><link rel="prefetch" href="/docs/assets/js/290.776ae1cf.js"><link rel="prefetch" href="/docs/assets/js/291.ca47e99a.js"><link rel="prefetch" href="/docs/assets/js/292.a7c4eb50.js"><link rel="prefetch" href="/docs/assets/js/293.4ceab510.js"><link rel="prefetch" href="/docs/assets/js/294.300353f6.js"><link rel="prefetch" href="/docs/assets/js/295.90280d20.js"><link rel="prefetch" href="/docs/assets/js/296.6f7ee40b.js"><link rel="prefetch" href="/docs/assets/js/297.eefa3f58.js"><link rel="prefetch" href="/docs/assets/js/298.fe7172c7.js"><link rel="prefetch" href="/docs/assets/js/299.fd101421.js"><link rel="prefetch" href="/docs/assets/js/3.dd80ddf0.js"><link rel="prefetch" href="/docs/assets/js/30.f2adb12a.js"><link rel="prefetch" href="/docs/assets/js/300.eda2553b.js"><link rel="prefetch" href="/docs/assets/js/301.9e5b43f6.js"><link rel="prefetch" href="/docs/assets/js/302.adb69546.js"><link rel="prefetch" href="/docs/assets/js/303.281c1793.js"><link rel="prefetch" href="/docs/assets/js/304.d7bb4674.js"><link rel="prefetch" href="/docs/assets/js/305.bd7289f2.js"><link rel="prefetch" href="/docs/assets/js/306.4fef0539.js"><link rel="prefetch" href="/docs/assets/js/307.94e50767.js"><link rel="prefetch" href="/docs/assets/js/308.43377094.js"><link rel="prefetch" href="/docs/assets/js/309.7415a250.js"><link rel="prefetch" href="/docs/assets/js/31.b7e926b6.js"><link rel="prefetch" href="/docs/assets/js/310.87aa2a29.js"><link rel="prefetch" href="/docs/assets/js/311.da3b491e.js"><link rel="prefetch" href="/docs/assets/js/312.54e77b21.js"><link rel="prefetch" href="/docs/assets/js/313.3c58a0c3.js"><link rel="prefetch" href="/docs/assets/js/314.e2061a51.js"><link rel="prefetch" href="/docs/assets/js/315.93cfea1c.js"><link rel="prefetch" href="/docs/assets/js/316.842421f9.js"><link rel="prefetch" href="/docs/assets/js/317.0ba13b07.js"><link rel="prefetch" href="/docs/assets/js/318.0c4306e0.js"><link rel="prefetch" href="/docs/assets/js/319.5fcc15ec.js"><link rel="prefetch" href="/docs/assets/js/32.9bbab342.js"><link rel="prefetch" href="/docs/assets/js/320.3597bdec.js"><link rel="prefetch" href="/docs/assets/js/321.4778ca3c.js"><link rel="prefetch" href="/docs/assets/js/322.f54fa539.js"><link rel="prefetch" href="/docs/assets/js/323.026494b0.js"><link rel="prefetch" href="/docs/assets/js/324.e9266218.js"><link rel="prefetch" href="/docs/assets/js/325.99e3174d.js"><link rel="prefetch" href="/docs/assets/js/326.65730777.js"><link rel="prefetch" href="/docs/assets/js/327.1e37ca3a.js"><link rel="prefetch" href="/docs/assets/js/328.992b3dba.js"><link rel="prefetch" href="/docs/assets/js/329.864ecdf8.js"><link rel="prefetch" href="/docs/assets/js/330.ed4734fc.js"><link rel="prefetch" href="/docs/assets/js/331.28e39d8a.js"><link rel="prefetch" href="/docs/assets/js/332.cf2ca297.js"><link rel="prefetch" href="/docs/assets/js/333.163bffad.js"><link rel="prefetch" href="/docs/assets/js/334.a181370f.js"><link rel="prefetch" href="/docs/assets/js/335.c38d01fe.js"><link rel="prefetch" href="/docs/assets/js/336.402dea5a.js"><link rel="prefetch" href="/docs/assets/js/337.3b1a8f77.js"><link rel="prefetch" href="/docs/assets/js/338.26b3cd16.js"><link rel="prefetch" href="/docs/assets/js/339.923469ca.js"><link rel="prefetch" href="/docs/assets/js/34.d9e94fda.js"><link rel="prefetch" href="/docs/assets/js/340.a9e98b7c.js"><link rel="prefetch" href="/docs/assets/js/341.be674afa.js"><link rel="prefetch" href="/docs/assets/js/342.012129a7.js"><link rel="prefetch" href="/docs/assets/js/343.6d193363.js"><link rel="prefetch" href="/docs/assets/js/344.8394b181.js"><link rel="prefetch" href="/docs/assets/js/345.029df7c9.js"><link rel="prefetch" href="/docs/assets/js/346.5c57ea75.js"><link rel="prefetch" href="/docs/assets/js/347.a9b67716.js"><link rel="prefetch" href="/docs/assets/js/348.6d25b058.js"><link rel="prefetch" href="/docs/assets/js/349.9861a215.js"><link rel="prefetch" href="/docs/assets/js/35.00e09993.js"><link rel="prefetch" href="/docs/assets/js/350.184590e0.js"><link rel="prefetch" href="/docs/assets/js/351.f1beda9e.js"><link rel="prefetch" href="/docs/assets/js/352.06ae7593.js"><link rel="prefetch" href="/docs/assets/js/353.bff6cbd6.js"><link rel="prefetch" href="/docs/assets/js/354.d58f5973.js"><link rel="prefetch" href="/docs/assets/js/355.07628851.js"><link rel="prefetch" href="/docs/assets/js/356.a9ede5bf.js"><link rel="prefetch" href="/docs/assets/js/357.42a466e9.js"><link rel="prefetch" href="/docs/assets/js/358.0639a64f.js"><link rel="prefetch" href="/docs/assets/js/359.f47609df.js"><link rel="prefetch" href="/docs/assets/js/36.663b3246.js"><link rel="prefetch" href="/docs/assets/js/360.ac97596e.js"><link rel="prefetch" href="/docs/assets/js/361.c212bd2d.js"><link rel="prefetch" href="/docs/assets/js/362.58e219dd.js"><link rel="prefetch" href="/docs/assets/js/363.618c5d85.js"><link rel="prefetch" href="/docs/assets/js/364.57836c00.js"><link rel="prefetch" href="/docs/assets/js/365.57dc1639.js"><link rel="prefetch" href="/docs/assets/js/366.f4ab7b0a.js"><link rel="prefetch" href="/docs/assets/js/367.b00210f0.js"><link rel="prefetch" href="/docs/assets/js/368.799ffaa3.js"><link rel="prefetch" href="/docs/assets/js/369.6bf5a56e.js"><link rel="prefetch" href="/docs/assets/js/37.d8307e1b.js"><link rel="prefetch" href="/docs/assets/js/370.9bcdc35d.js"><link rel="prefetch" href="/docs/assets/js/371.78dc5c93.js"><link rel="prefetch" href="/docs/assets/js/372.1c8743dd.js"><link rel="prefetch" href="/docs/assets/js/373.cb1020cb.js"><link rel="prefetch" href="/docs/assets/js/374.60be3ad6.js"><link rel="prefetch" href="/docs/assets/js/375.f340ecfc.js"><link rel="prefetch" href="/docs/assets/js/376.b461221a.js"><link rel="prefetch" href="/docs/assets/js/377.b2a297c5.js"><link rel="prefetch" href="/docs/assets/js/378.b7cfc6a0.js"><link rel="prefetch" href="/docs/assets/js/379.78eda6c2.js"><link rel="prefetch" href="/docs/assets/js/38.a500a09e.js"><link rel="prefetch" href="/docs/assets/js/380.0d83ba2d.js"><link rel="prefetch" href="/docs/assets/js/381.5dc998b9.js"><link rel="prefetch" href="/docs/assets/js/382.54d228e5.js"><link rel="prefetch" href="/docs/assets/js/383.6bb87bf8.js"><link rel="prefetch" href="/docs/assets/js/384.44c44007.js"><link rel="prefetch" href="/docs/assets/js/385.21be5d2b.js"><link rel="prefetch" href="/docs/assets/js/386.8b806102.js"><link rel="prefetch" href="/docs/assets/js/387.6e7fe6e4.js"><link rel="prefetch" href="/docs/assets/js/388.8507f77d.js"><link rel="prefetch" href="/docs/assets/js/389.43d08259.js"><link rel="prefetch" href="/docs/assets/js/39.eb4517d8.js"><link rel="prefetch" href="/docs/assets/js/390.9f2c5338.js"><link rel="prefetch" href="/docs/assets/js/391.702f5acd.js"><link rel="prefetch" href="/docs/assets/js/392.ecbd8f80.js"><link rel="prefetch" href="/docs/assets/js/393.c03f11ee.js"><link rel="prefetch" href="/docs/assets/js/394.c24eadd7.js"><link rel="prefetch" href="/docs/assets/js/395.81e0a915.js"><link rel="prefetch" href="/docs/assets/js/396.f8b12342.js"><link rel="prefetch" href="/docs/assets/js/397.f82ddde5.js"><link rel="prefetch" href="/docs/assets/js/398.6534415a.js"><link rel="prefetch" href="/docs/assets/js/399.97654893.js"><link rel="prefetch" href="/docs/assets/js/4.fb88f924.js"><link rel="prefetch" href="/docs/assets/js/40.2928b57e.js"><link rel="prefetch" href="/docs/assets/js/400.a91a16d7.js"><link rel="prefetch" href="/docs/assets/js/401.9cdb26bc.js"><link rel="prefetch" href="/docs/assets/js/402.64abba29.js"><link rel="prefetch" href="/docs/assets/js/403.15bbaf7a.js"><link rel="prefetch" href="/docs/assets/js/404.f1f3a339.js"><link rel="prefetch" href="/docs/assets/js/405.c395b66b.js"><link rel="prefetch" href="/docs/assets/js/406.542537fa.js"><link rel="prefetch" href="/docs/assets/js/407.3b823a63.js"><link rel="prefetch" href="/docs/assets/js/408.fd5547b8.js"><link rel="prefetch" href="/docs/assets/js/41.5ec0c493.js"><link rel="prefetch" href="/docs/assets/js/42.79acb748.js"><link rel="prefetch" href="/docs/assets/js/43.7c93d37b.js"><link rel="prefetch" href="/docs/assets/js/44.b0ccd5af.js"><link rel="prefetch" href="/docs/assets/js/45.8db38bc2.js"><link rel="prefetch" href="/docs/assets/js/46.77abd87f.js"><link rel="prefetch" href="/docs/assets/js/47.76142be2.js"><link rel="prefetch" href="/docs/assets/js/48.fb05cc09.js"><link rel="prefetch" href="/docs/assets/js/49.fcddae31.js"><link rel="prefetch" href="/docs/assets/js/5.f7cfc7c2.js"><link rel="prefetch" href="/docs/assets/js/50.b611f75c.js"><link rel="prefetch" href="/docs/assets/js/51.4b96725b.js"><link rel="prefetch" href="/docs/assets/js/52.fcbf2b11.js"><link rel="prefetch" href="/docs/assets/js/53.349e18a0.js"><link rel="prefetch" href="/docs/assets/js/54.c44149cc.js"><link rel="prefetch" href="/docs/assets/js/55.95dfdcdd.js"><link rel="prefetch" href="/docs/assets/js/56.c86aaa7b.js"><link rel="prefetch" href="/docs/assets/js/57.e7741ec4.js"><link rel="prefetch" href="/docs/assets/js/58.2a8944bf.js"><link rel="prefetch" href="/docs/assets/js/59.f139962c.js"><link rel="prefetch" href="/docs/assets/js/6.64f902c9.js"><link rel="prefetch" href="/docs/assets/js/60.64268da2.js"><link rel="prefetch" href="/docs/assets/js/61.2d7472e1.js"><link rel="prefetch" href="/docs/assets/js/62.7c40b969.js"><link rel="prefetch" href="/docs/assets/js/63.c8f49f0a.js"><link rel="prefetch" href="/docs/assets/js/64.0c5a4304.js"><link rel="prefetch" href="/docs/assets/js/65.02fe6f12.js"><link rel="prefetch" href="/docs/assets/js/66.b38c6c7c.js"><link rel="prefetch" href="/docs/assets/js/67.53619ab1.js"><link rel="prefetch" href="/docs/assets/js/68.dbde5dd2.js"><link rel="prefetch" href="/docs/assets/js/69.f1ceea03.js"><link rel="prefetch" href="/docs/assets/js/7.c45dc450.js"><link rel="prefetch" href="/docs/assets/js/70.e8101f4b.js"><link rel="prefetch" href="/docs/assets/js/71.66ec1fb5.js"><link rel="prefetch" href="/docs/assets/js/72.3fcd17e2.js"><link rel="prefetch" href="/docs/assets/js/73.f6f3d102.js"><link rel="prefetch" href="/docs/assets/js/74.8e81a6ce.js"><link rel="prefetch" href="/docs/assets/js/75.f730cc7e.js"><link rel="prefetch" href="/docs/assets/js/76.4412982e.js"><link rel="prefetch" href="/docs/assets/js/77.b05e96f3.js"><link rel="prefetch" href="/docs/assets/js/78.d0ae109a.js"><link rel="prefetch" href="/docs/assets/js/79.60ef8a47.js"><link rel="prefetch" href="/docs/assets/js/8.d903e613.js"><link rel="prefetch" href="/docs/assets/js/80.1d34311b.js"><link rel="prefetch" href="/docs/assets/js/81.194f91af.js"><link rel="prefetch" href="/docs/assets/js/82.7b60cb7d.js"><link rel="prefetch" href="/docs/assets/js/83.cc7c0ea6.js"><link rel="prefetch" href="/docs/assets/js/84.798fff8e.js"><link rel="prefetch" href="/docs/assets/js/85.5fbd88f7.js"><link rel="prefetch" href="/docs/assets/js/86.959d409b.js"><link rel="prefetch" href="/docs/assets/js/87.8d9c23ed.js"><link rel="prefetch" href="/docs/assets/js/88.f99e1fda.js"><link rel="prefetch" href="/docs/assets/js/89.6d9fbb83.js"><link rel="prefetch" href="/docs/assets/js/9.28675f80.js"><link rel="prefetch" href="/docs/assets/js/90.a9f09836.js"><link rel="prefetch" href="/docs/assets/js/91.3d6ce3ab.js"><link rel="prefetch" href="/docs/assets/js/92.1e80cb6b.js"><link rel="prefetch" href="/docs/assets/js/93.17f0e365.js"><link rel="prefetch" href="/docs/assets/js/94.16b6e22c.js"><link rel="prefetch" href="/docs/assets/js/95.69e7df35.js"><link rel="prefetch" href="/docs/assets/js/96.0f73f75d.js"><link rel="prefetch" href="/docs/assets/js/97.30980d48.js"><link rel="prefetch" href="/docs/assets/js/98.d98fab0e.js"><link rel="prefetch" href="/docs/assets/js/99.531097f3.js">
    <link rel="stylesheet" href="/docs/assets/css/0.styles.0558eedd.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/docs/" class="home-link router-link-active"><!----> <span class="site-name">Nguyễn Khánk's Wiki</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/docs/architect/" class="nav-link">
  Architecture
</a></div><div class="nav-item"><a href="/docs/kungfu/letsgo.html" class="nav-link">
  Kungfu
</a></div><div class="nav-item"><a href="https://nguyenngockhank.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Home
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/docs/architect/" class="nav-link">
  Architecture
</a></div><div class="nav-item"><a href="/docs/kungfu/letsgo.html" class="nav-link">
  Kungfu
</a></div><div class="nav-item"><a href="https://nguyenngockhank.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Home
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>The Art of Readable Code</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>A Philosophy of Software Design</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/kungfu/philosophy/c1.html" class="sidebar-link">1. Introduction</a></li><li><a href="/docs/kungfu/philosophy/c2.html" class="sidebar-link">2. The Nature of Complexity</a></li><li><a href="/docs/kungfu/philosophy/c3.html" class="sidebar-link">3. Working Code Isn’t Enough</a></li><li><a href="/docs/kungfu/philosophy/c4.html" class="sidebar-link">4. Modules Should Be Deep</a></li><li><a href="/docs/kungfu/philosophy/c5.html" class="sidebar-link">5.  Information Hiding (and Leakage)</a></li><li><a href="/docs/kungfu/philosophy/c6.html" class="sidebar-link">6.  General-Purpose Modules are Deeper</a></li><li><a href="/docs/kungfu/philosophy/c7.html" class="sidebar-link">7.  Dierent Layer, Dierent Abstraction</a></li><li><a href="/docs/kungfu/philosophy/c8.html" class="sidebar-link">8.  Pull Complexity Downwards</a></li><li><a href="/docs/kungfu/philosophy/c9.html" class="sidebar-link">9.  Better Together Or Better Apart?</a></li><li><a href="/docs/kungfu/philosophy/c10.html" class="sidebar-link">10.  Dene Errors Out Of Existence</a></li><li><a href="/docs/kungfu/philosophy/c11.html" class="sidebar-link">11.  Design it Twice</a></li><li><a href="/docs/kungfu/philosophy/c12.html" class="sidebar-link">12. Why Write Comments? The Four Excuses</a></li><li><a href="/docs/kungfu/philosophy/c13.html" class="sidebar-link">13. Comments Should Describe Things that aren’t Obvious from the Code</a></li><li><a href="/docs/kungfu/philosophy/c14.html" class="sidebar-link">14. Choosing Names</a></li><li><a href="/docs/kungfu/philosophy/c15.html" class="sidebar-link">15.  Write The Comments First</a></li><li><a href="/docs/kungfu/philosophy/c16.html" class="sidebar-link">16. Modifying Existing Code</a></li><li><a href="/docs/kungfu/philosophy/c17.html" class="sidebar-link">17. Consistency</a></li><li><a href="/docs/kungfu/philosophy/c18.html" class="sidebar-link">18. Code Should be Obvious</a></li><li><a href="/docs/kungfu/philosophy/c19.html" class="sidebar-link">19. Software Trends</a></li><li><a href="/docs/kungfu/philosophy/c20.html" aria-current="page" class="active sidebar-link">20. Designing for Performance</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/kungfu/philosophy/c20.html#_20-1-how-to-think-about-performance" class="sidebar-link">20.1  How to think about performance</a></li><li class="sidebar-sub-header"><a href="/docs/kungfu/philosophy/c20.html#_20-2-measure-before-modifying" class="sidebar-link">20.2  Measure before modifying</a></li><li class="sidebar-sub-header"><a href="/docs/kungfu/philosophy/c20.html#_20-3-design-around-the-critical-path" class="sidebar-link">20.3  Design around the critical path</a></li><li class="sidebar-sub-header"><a href="/docs/kungfu/philosophy/c20.html#_20-4-an-example-ramcloud-buers" class="sidebar-link">20.4  An example: RAMCloud Buers</a></li><li class="sidebar-sub-header"><a href="/docs/kungfu/philosophy/c20.html#_20-5-conclusion" class="sidebar-link">20.5  Conclusion</a></li></ul></li><li><a href="/docs/kungfu/philosophy/c21.html" class="sidebar-link">21. Conclusion</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Building Microservices</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>97 Things Every Programmer Should Know</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>NoSql Distilled</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Go</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Others</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_20-designing-for-performance"><a href="#_20-designing-for-performance" class="header-anchor">#</a> 20. Designing for Performance</h1> <p>Up until this point, the discussion of software design has focused on complexity; the goal has been to make software as simple and understandable as possible. But what if you are working on a system that needs to be fast? How should performance considerations affect the design process? This chapter discusses how to achieve high performance without sacrificing clean design. The most important idea is still simplicity: not only does simplicity improve a system’s design, but it usually makes systems faster.</p> <h2 id="_20-1-how-to-think-about-performance"><a href="#_20-1-how-to-think-about-performance" class="header-anchor">#</a> 20.1  How to think about performance</h2> <p>The first question to address is “how much should you worry about performance during the normal development process?” If you try to optimize every statement for maximum speed, it will slow down
development and create a lot of unnecessary complexity. Furthermore, many of the “optimizations” won’t actually help performance. On the other hand, if you completely ignore performance issues, it’s easy to end up with a large number of significant inefficiencies spread throughout the code; the resulting system can easily be 5–10x slower than it needs to be.</p> <p>In this “death by a thousand cuts” scenario it’s hard to come back later and
improve the performance, because there is no single improvement that will
have much impact.</p> <p>The best approach is something between these extremes, where you
use basic knowledge of performance to choose design alternatives that are
“naturally efficient” yet also clean and simple. The key is to develop an
awareness of which operations are fundamentally expensive. Here are a
few examples of operations that are relatively expensive today:</p> <p>Network communication: even within a datacenter, a round-trip
message exchange can take 10–50 μs, which is tens of thousands of
instruction times. Wide-area round-trips can take 10–100 ms.
I/O to secondary storage: disk I/O operations typically take 5–10 ms,
which is millions of instruction times. Flash storage takes 10–100 μs.
New emerging nonvolatile memories may be as fast as 1 μs, but this
is still around 2000 instruction times.
Dynamic memory allocation (malloc in C, new in C++ or Java)
typically involves significant overhead for allocation, freeing, and
garbage collection.
Cache misses: fetching data from DRAM into an on-chip processor
cache takes a few hundred instruction times; in many programs,
overall performance is determined as much by cache misses as by
computational costs.
The best way to learn which things are expensive is to run micro-
benchmarks (small programs that measure the cost of a single operation in
isolation). In the RAMCloud project, we created a simple program that
provides a framework for microbenchmarks. It took a few days to create
the framework, but the framework makes it possible to add new micro-
benchmarks in five or ten minutes. This has allowed us to accumulate
dozens of micro-benchmarks. We use these both to understand the
performance of existing libraries used in RAMCloud, and also to measure
the performance of new classes written for RAMCloud.</p> <p>Once you have a general sense for what is expensive and what is cheap,
you can use that information to choose cheap operations whenever
possible. In many cases, a more efficient approach will be just as simple
as a slower approach. For example, when storing a large collection of
objects that will be looked up using a key value, you could use either a
hash table or an ordered map. Both are commonly available in library
packages, and both are simple and clean to use. However, hash tables can
easily be 5–10x faster. Thus, you should always use a hash table unless you
need the ordering properties provided by the map.</p> <p>As another example, consider allocating an array of structures in a
language such as C or C++. There are two ways you can do this. One way is
for the array to hold pointers to structures, in which case you must first</p> <p>allocate space for the array, then allocate space for each individual
structure. It is much more efficient to store the structures in the array
itself, so you only allocate one large block for everything.</p> <p>If the only way to improve efficiency is by adding complexity, then the
choice is more difficult. If the more efficient design adds only a small
amount of complexity, and if the complexity is hidden, so it doesn’t affect
any interfaces, then it may be worthwhile (but beware: complexity is
incremental). If the faster design adds a lot of implementation complexity,
or if it results in more complicated interfaces, then it may be better to start
off with the simpler approach and optimize later if performance turns out
to be a problem. However, if you have clear evidence that performance will
be important in a particular situation, then you might as well implement
the faster approach immediately.</p> <p>In the RAMCloud project one of our overall goals was to provide the
lowest possible latency for client machines accessing the storage system
over a datacenter network. As a result, we decided to use special hardware
for networking, which allowed RAMCloud to bypass the kernel and
communicate directly with the network interface controller to send and
receive packets. We made this decision even though it added complexity,
because we knew from prior measurements that kernel-based networking
would be too slow to meet our needs. In most of the rest of the RAMCloud
system we were able to design for simplicity; getting this one big issue
“right” made many other things easier.</p> <p>In general, simpler code tends to run faster than complex code. If you
have defined away special cases and exceptions, then no code is needed to
check for those cases and the system runs faster. Deep classes are more
efficient than shallow ones, because they get more work done for each
method call. Shallow classes result in more layer crossings, and each layer
crossing adds overhead.</p> <h2 id="_20-2-measure-before-modifying"><a href="#_20-2-measure-before-modifying" class="header-anchor">#</a> 20.2  Measure before modifying</h2> <p>But suppose that your system is still too slow, even though you have
designed it as described above. It’s tempting to rush off and start making
performance tweaks, based on your intuitions about what is slow. Don’t do</p> <p>this! Programmers’ intuitions about performance are unreliable. This is
true even for experienced developers. If you start making changes based on
intuition, you’ll waste time on things that don’t actually improve
performance, and you’ll probably make the system more complicated in
the process.</p> <p>Before making any changes, measure the system’s existing behavior.
This serves two purposes. First, the measurements will identify the places
where performance tuning will have the biggest impact. It isn’t sufficient
just to measure the top-level system performance. This may tell you that
the system is too slow, but it won’t tell you why. You’ll need to measure
deeper to identify in detail the factors that contribute to overall
performance; the goal is to identify a small number of very specific places
where the system is currently spending a lot of time, and where you have
ideas for improvement. The second purpose of the measurements is to
provide a baseline, so that you can re-measure performance after making
your changes to ensure that performance actually improved. If the changes
didn’t make a measurable difference in performance, then back them out
(unless they made the system simpler). There’s no point in retaining
complexity unless it provides a significant speedup.</p> <h2 id="_20-3-design-around-the-critical-path"><a href="#_20-3-design-around-the-critical-path" class="header-anchor">#</a> 20.3  Design around the critical path</h2> <p>At this point, let’s assume that you have carefully analyzed performance
and have identified a piece of code that is slow enough to affect the overall
system performance. The best way to improve its performance is with a
“fundamental” change, such as introducing a cache, or using a different
algorithmic approach (balanced tree vs. list, for instance). Our decision to
bypass the kernel for network communication in RAMCloud is an example
of a fundamental fix. If you can identify a fundamental fix, then you can
implement it using the design techniques discussed in previous chapters.</p> <p>Unfortunately, situations will sometimes arise where there isn’t a
fundamental fix. This brings us to the core issue for this chapter, which is
how to redesign an existing piece of code so that it runs faster. This should
be your last resort, and it shouldn’t happen often, but there are cases where
it can make a big difference. The key idea is to design the code around the
critical path.</p> <p>Start off by asking yourself what is the smallest amount of code that
must be executed to carry out the desired task in the common case.
Disregard any existing code structure. Imagine instead that you are writing
a new method that implements just the critical path, which is the
minimum amount of code that must be executed in the the most common
case. The current code is probably cluttered with special cases; ignore
them in this exercise. The current code might pass through several method
calls on the critical path; imagine instead that you could put all the
relevant code in a single method. The current code may also use a variety
of variables and data structures; consider only the data needed for the
critical path, and assume whatever data structure is most convenient for
the critical path. For example, it may make sense to combine multiple
variables into a single value. Assume that you could completely redesign
the system in order to minimize the code that must be executed for the
critical path. Let’s call this code “the ideal.”</p> <p>The ideal code probably clashes with your existing class structure, and
it may not be practical, but it provides a good target: this represents the
simplest and fastest that the code can ever be. The next step is to look for a
new design that comes as close as possible to the ideal while still having a
clean structure. You can apply all of the design ideas from previous
chapters of this book, but with the additional constraint of keeping the
ideal code (mostly) intact. You may have to add a bit of extra code to the
ideal in order to allow clean abstractions; for example, if the code involves
a hash table lookup, it’s OK to introduce an extra method call to a general-
purpose hash table class. In my experience it’s almost always possible to
find a design that is clean and simple, yet comes very close to the ideal.</p> <p>One of the most important things that happens in this process is to
remove special cases from the critical path. When code is slow, it’s often
because it must handle a variety of situations, and the code gets structured
to simplify the handling of all the different cases. Each special case adds a
little bit of code to the critical path, in the form of extra conditional
statements and/or method calls. Each of these additions makes the code a
bit slower. When redesigning for performance, try to minimize the number
of special cases you must check. Ideally, there will be a single if</p> <p>statement at the beginning, which detects all special cases with one test. In</p> <p>the normal case, only this one test will need to be made, after which the
the critical path can be executed with no additional tests for special cases.
If the initial test fails (which means a special case has occurred) the code
can branch to a separate place off the critical path to handle it.
Performance isn’t as important for special cases, so you can structure the
special-case code for simplicity rather than performance.</p> <h2 id="_20-4-an-example-ramcloud-buers"><a href="#_20-4-an-example-ramcloud-buers" class="header-anchor">#</a> 20.4  An example: RAMCloud Buers</h2> <p>Let’s consider an example, in which the Buffer class of the RAMCloud
storage system was optimized to achieve a speedup of about 2x for the
most common operations.</p> <p>RAMCloud uses Buffer objects to manage variable-length arrays of
memory, such as request and response messages for remote procedure
calls. Buffers are designed to reduce overheads from memory copying and
dynamic storage allocation. A Buffer stores what appears to be a linear
array of bytes, but for efficiency it allows the underlying storage to be
divided into multiple discontiguous chunks of memory, as shown in Figure
20.1. A Buffer is created by appending chunks of data. Each chunk is either
external or internal. If a chunk is external, its storage is owned by the
caller; the Buffer keeps a reference to this storage. External chunks are
typically used for large chunks in order to avoid memory copies. If a
chunk is internal, the Buffer owns the storage for the chunk; data supplied
by the caller is copied into the Buffer’s internal storage. Each Buffer
contains a small built-in allocation, which is a block of memory available
for storing internal chunks. If this space is exhausted, then the Buffer
creates additional allocations, which must be freed when the Buffer is
destroyed. Internal chunks are convenient for small chunks where the
memory copying costs are negligible. Figure 20.1 shows a Buffer with 5
chunks: the first chunk is internal, the next two are external, and the final
two chunks are internal.</p> <p><img src="/docs/assets/img/image--041.29e4a17a.jpg" alt="Image"></p> <p><strong>Figure 20.1</strong>: <em>A Buffer object uses a collection of memory chunks to store what appears to be a linear array of bytes. Internal chunks are owned by the Buffer and freed when the Buffer is destroyed; external chunks are not owned by the Buffer.</em></p> <p>The Buffer class itself represents a “fundamental fix,” in that it
eliminates expensive memory copies that would have been required
without it. For example, when assembling a response message containing a
short header and the contents of a large object in the RAMCloud storage
system, RAMCloud uses a Buffer with two chunks. The first chunk is an
internal one that contains the header; the second chunk is an external one
that refers to the object contents in the RAMCloud storage system. The
response can be collected in the Buffer without copying the large object.</p> <p>Aside from the fundamental approach of allowing discontiguous
chunks, we did not attempt to optimize the code of the Buffer class in the
original implementation. Over time, however, we noticed Buffers being
used in more and more situations; for example, at least four Buffers are
created during the execution of each remote procedure call. Eventually, it
became clear that speeding up the implementation of Buffer could have a
noticeable impact on overall system performance. We decided to see if we
could improve the performance of the Buffer class.</p> <p>The most common operation for Buffer is to allocate space for a small
amount of new data using an internal chunk. This happens, for example,
when creating headers for request and response messages. We decided to
use this operation as the critical path for optimization. In the simplest
possible case, the space can be allocated by enlarging the last existing
chunk in the Buffer. However, this is only possible if the last existing
chunk is internal, and if there is enough space in its allocation to
accommodate the new data. The ideal code would perform a single check</p> <p>to confirm that the simple approach is possible, then it would adjust the
size of the existing chunk.</p> <p>Figure 20.2 shows the original code for the critical path, which starts
with the method <code>Buffer::alloc</code>. In the fastest possible case, <code>Buffer::alloc</code> calls <code>Buffer:: allocateAppend</code>, which calls <code>Buffer::Allocation::allocateAppend</code>. From a performance standpoint, this code has two problems. The first problem is that numerous special cases are checked individually:</p> <ul><li>Buffer::allocateAppend checks to see if the Buffer currently has any
allocations.</li> <li>The code checks twice to see if the current allocation has enough room for the new data: once in <code>Buffer::Allocation::allocateAppend</code>, and again when its return value is tested by <code>Buffer::allocateAppend</code>.</li> <li><code>Buffer::alloc</code> tests the return value from <code>Buffer::allocAppend</code> to confirm yet again that the allocation succeeded.</li></ul> <p>Furthermore, rather than trying to expand the last chunk directly, the code allocates new space without any consideration of the last chunk. Then <code>Buffer::alloc</code> checks to see if that space happens to be adjacent to the last chunk, in which case it merges the new space with the existing chunk. This results in additional checks. Overall, this code tests 6 distinct conditions in the critical path.</p> <p>The second problem with the original code is that it has too many
layers, all of which are shallow. This is both a performance problem and a
design problem. The critical path makes two additional method calls in
addition to the original invocation of Buffer::alloc. Each method call</p> <p>takes additional time, and the result of each call must be checked by its
caller, which results in more special cases to consider. Chapter 7 discussed
how abstractions should normally change as you pass from one layer to
another, but all three of the methods in Figure 20.2 have identical
signatures and they provide essentially the same abstraction; this is a red
flag. Buffer::allocateAppend is nearly a pass-though method; its only
contribution is to create a new allocation if needed. The extra layers make
the code both slower and more complicated.</p> <p>To fix these problems, we refactored the Buffer class so that its design
is centered around the most performance-critical paths. We considered not
just the allocation code above but several other commonly executed paths,
such as retrieving the total number of bytes of data currently stored in a
Buffer. For each of these critical paths, we tried to identify the smallest
amount of code that must be executed in the common case. Then we
designed the rest of the class around these critical paths. We also applied
the design principles from this book to simplify the class in general. For
example, we eliminated shallow layers and created deeper internal
abstractions. The refactored class is 20% smaller than the original version
(1476 lines of code, versus 1886 lines in the original).</p> <p><img src="/docs/assets/img/image--042.9fdac72d.png" alt="Image"></p> <p><strong>Figure 20.2</strong>: <em>The original code for allocating new space at the end of a Buffer, using an internal chunk.</em></p> <p><img src="/docs/assets/img/image--043.01457d8c.png" alt="Image"></p> <p><strong>Figure 20.3</strong>: <em>The new code for allocating new space in an internal chunk of a Buffer.</em></p> <p>Figure 20.3 shows the new critical path for allocating internal space in
a Buffer. The new code is not only faster, but it is also easier to read, since
it avoids shallow abstractions. The entire path is handled in a single
method, and it uses a single test to rule out all of the special cases. The
new code introduces a new instance variable, extraAppendBytes, in order to</p> <p>simplify the critical path. This variable keeps track of how much unused
space is available immediately after the last chunk in the Buffer. If there is
no space available, or if the last chunk in the Buffer isn’t an internal
chunk, or if the Buffer contains no chunks at all, then extraAppendBytes is
zero. The code in Figure 20.3 represents the least possible amount of code
to handle this common case.</p> <p>Note: the update to totalLength could have been eliminated by
recomputing the total Buffer length from the individual chunks whenever
it is needed. However, this approach would be expensive for a large Buffer
with many chunks, and fetching the total Buffer length is another common
operation. Thus, we chose to add a small amount of extra overhead to
alloc in order to ensure that the Buffer length is always immediately
available.</p> <p>The new code is about twice as fast as the old code: the total time to
append a 1-byte string to a Buffer using internal storage dropped from 8.8
ns to 4.75 ns. Many other Buffer operations also speeded up because of the
revisions. For example, the time to construct a new Buffer, append a small
chunk in internal storage, and destroy the Buffer dropped from 24 ns to 12
ns.</p> <h2 id="_20-5-conclusion"><a href="#_20-5-conclusion" class="header-anchor">#</a> 20.5  Conclusion</h2> <p>The most important overall lesson from this chapter is that clean design
and high performance are compatible. The Buffer class rewrite improved
its performance by a factor of 2 while simplifying its design and reducing
code size by 20%. Complicated code tends to be slow because it does
extraneous or redundant work. On the other hand, if you write clean,
simple code, your system will probably be fast enough that you don’t have
to worry much about performance in the first place. In the few cases where
you do need to optimize performance, the key is simplicity again: find the
critical paths that are most important for performance and make them as
simple as possible.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/docs/kungfu/philosophy/c19.html" class="prev">
        19. Software Trends
      </a></span> <span class="next"><a href="/docs/kungfu/philosophy/c21.html">
        21. Conclusion
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----><!----></div></div>
    <script src="/docs/assets/js/app.ed218ff4.js" defer></script><script src="/docs/assets/js/2.de1d5c77.js" defer></script><script src="/docs/assets/js/28.109d4d82.js" defer></script><script src="/docs/assets/js/33.5733d073.js" defer></script>
  </body>
</html>
