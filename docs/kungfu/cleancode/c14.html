<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>14. Successive Refinement | Nguyễn Khánk&#39;s Wiki</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="apple-touch-icon" sizes="180x180" href="../public/favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../public/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../public/favicons/favicon-16x16.png">
    <link rel="manifest" href="../public/favicons/manifest.json">
    <link rel="mask-icon" href="../public/favicons/safari-pinned-tab.svg" color="#3a0839">
    <link rel="shortcut icon" href="../public/favicons/favicon.ico">
    <meta name="description" content="Wikipedia của tui">
    <meta name="msapplication-TileColor" content="#3a0839">
    <meta name="msapplication-config" content="../public/favicons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    
    <link rel="preload" href="/docs/assets/css/0.styles.416feb4e.css" as="style"><link rel="preload" href="/docs/assets/js/app.13f2dfe1.js" as="script"><link rel="preload" href="/docs/assets/js/2.ca319816.js" as="script"><link rel="preload" href="/docs/assets/js/425.6fba2505.js" as="script"><link rel="preload" href="/docs/assets/js/89.be9ab726.js" as="script"><link rel="prefetch" href="/docs/assets/js/10.da62c5cf.js"><link rel="prefetch" href="/docs/assets/js/100.4c5c35ff.js"><link rel="prefetch" href="/docs/assets/js/101.3f97cfd9.js"><link rel="prefetch" href="/docs/assets/js/102.6837b723.js"><link rel="prefetch" href="/docs/assets/js/103.b7a6e41a.js"><link rel="prefetch" href="/docs/assets/js/104.53b63a60.js"><link rel="prefetch" href="/docs/assets/js/105.8b829538.js"><link rel="prefetch" href="/docs/assets/js/106.cef37bff.js"><link rel="prefetch" href="/docs/assets/js/107.bb617e02.js"><link rel="prefetch" href="/docs/assets/js/108.f07bb530.js"><link rel="prefetch" href="/docs/assets/js/109.7cda15f1.js"><link rel="prefetch" href="/docs/assets/js/11.01721c88.js"><link rel="prefetch" href="/docs/assets/js/110.0cd2ecd4.js"><link rel="prefetch" href="/docs/assets/js/111.69c9edd1.js"><link rel="prefetch" href="/docs/assets/js/112.5fe1920c.js"><link rel="prefetch" href="/docs/assets/js/113.03345652.js"><link rel="prefetch" href="/docs/assets/js/114.12145fe5.js"><link rel="prefetch" href="/docs/assets/js/115.fe596d1c.js"><link rel="prefetch" href="/docs/assets/js/116.1e626d59.js"><link rel="prefetch" href="/docs/assets/js/117.7acd6c7c.js"><link rel="prefetch" href="/docs/assets/js/118.92831b67.js"><link rel="prefetch" href="/docs/assets/js/119.8852c12a.js"><link rel="prefetch" href="/docs/assets/js/12.c700ce70.js"><link rel="prefetch" href="/docs/assets/js/120.8f0a77ca.js"><link rel="prefetch" href="/docs/assets/js/121.dbc9ab56.js"><link rel="prefetch" href="/docs/assets/js/122.d2cd5813.js"><link rel="prefetch" href="/docs/assets/js/123.138081b9.js"><link rel="prefetch" href="/docs/assets/js/124.2cd60e29.js"><link rel="prefetch" href="/docs/assets/js/125.4d820515.js"><link rel="prefetch" href="/docs/assets/js/126.d1264bc9.js"><link rel="prefetch" href="/docs/assets/js/127.8b911b0d.js"><link rel="prefetch" href="/docs/assets/js/128.d9cfbfb2.js"><link rel="prefetch" href="/docs/assets/js/129.640604a8.js"><link rel="prefetch" href="/docs/assets/js/13.957c760f.js"><link rel="prefetch" href="/docs/assets/js/130.4d34bc1d.js"><link rel="prefetch" href="/docs/assets/js/131.308b5020.js"><link rel="prefetch" href="/docs/assets/js/132.ebcd3740.js"><link rel="prefetch" href="/docs/assets/js/133.75b5c040.js"><link rel="prefetch" href="/docs/assets/js/134.ca74a4a5.js"><link rel="prefetch" href="/docs/assets/js/135.f5af0694.js"><link rel="prefetch" href="/docs/assets/js/136.48915dfa.js"><link rel="prefetch" href="/docs/assets/js/137.47791955.js"><link rel="prefetch" href="/docs/assets/js/138.7b4a987e.js"><link rel="prefetch" href="/docs/assets/js/139.607ae181.js"><link rel="prefetch" href="/docs/assets/js/14.659fb6ff.js"><link rel="prefetch" href="/docs/assets/js/140.139f5049.js"><link rel="prefetch" href="/docs/assets/js/141.6e66f084.js"><link rel="prefetch" href="/docs/assets/js/142.6ae663c8.js"><link rel="prefetch" href="/docs/assets/js/143.fb1fb6bd.js"><link rel="prefetch" href="/docs/assets/js/144.b86edb27.js"><link rel="prefetch" href="/docs/assets/js/145.ce5696c0.js"><link rel="prefetch" href="/docs/assets/js/146.afb0c1da.js"><link rel="prefetch" href="/docs/assets/js/147.adefe3d5.js"><link rel="prefetch" href="/docs/assets/js/148.ba532a10.js"><link rel="prefetch" href="/docs/assets/js/149.31d97c3f.js"><link rel="prefetch" href="/docs/assets/js/15.4c43b368.js"><link rel="prefetch" href="/docs/assets/js/150.2b49d7ed.js"><link rel="prefetch" href="/docs/assets/js/151.40194d20.js"><link rel="prefetch" href="/docs/assets/js/152.0e2dfd48.js"><link rel="prefetch" href="/docs/assets/js/153.55615b3e.js"><link rel="prefetch" href="/docs/assets/js/154.860576ee.js"><link rel="prefetch" href="/docs/assets/js/155.bd117d94.js"><link rel="prefetch" href="/docs/assets/js/156.e2ca6015.js"><link rel="prefetch" href="/docs/assets/js/157.0f70ea58.js"><link rel="prefetch" href="/docs/assets/js/158.e3785e26.js"><link rel="prefetch" href="/docs/assets/js/159.185d9dd9.js"><link rel="prefetch" href="/docs/assets/js/16.c5fa733d.js"><link rel="prefetch" href="/docs/assets/js/160.0e4d60f4.js"><link rel="prefetch" href="/docs/assets/js/161.42848a97.js"><link rel="prefetch" href="/docs/assets/js/162.19cb84dc.js"><link rel="prefetch" href="/docs/assets/js/163.e7664fe1.js"><link rel="prefetch" href="/docs/assets/js/164.36e23e46.js"><link rel="prefetch" href="/docs/assets/js/165.9c741fa2.js"><link rel="prefetch" href="/docs/assets/js/166.bf8e3a93.js"><link rel="prefetch" href="/docs/assets/js/167.1df6e039.js"><link rel="prefetch" href="/docs/assets/js/168.33bc3bc0.js"><link rel="prefetch" href="/docs/assets/js/169.5317ee1d.js"><link rel="prefetch" href="/docs/assets/js/17.389b8ced.js"><link rel="prefetch" href="/docs/assets/js/170.61d1065d.js"><link rel="prefetch" href="/docs/assets/js/171.f5f5fece.js"><link rel="prefetch" href="/docs/assets/js/172.867be94e.js"><link rel="prefetch" href="/docs/assets/js/173.bd2c108d.js"><link rel="prefetch" href="/docs/assets/js/174.5863a06b.js"><link rel="prefetch" href="/docs/assets/js/175.73dafd76.js"><link rel="prefetch" href="/docs/assets/js/176.c0694e2e.js"><link rel="prefetch" href="/docs/assets/js/177.8034b473.js"><link rel="prefetch" href="/docs/assets/js/178.292d9a59.js"><link rel="prefetch" href="/docs/assets/js/179.4001d172.js"><link rel="prefetch" href="/docs/assets/js/18.37f94dae.js"><link rel="prefetch" href="/docs/assets/js/180.9e357ca1.js"><link rel="prefetch" href="/docs/assets/js/181.53d39f62.js"><link rel="prefetch" href="/docs/assets/js/182.cecf0a46.js"><link rel="prefetch" href="/docs/assets/js/183.c76ed452.js"><link rel="prefetch" href="/docs/assets/js/184.bf035ac3.js"><link rel="prefetch" href="/docs/assets/js/185.20ed2ff3.js"><link rel="prefetch" href="/docs/assets/js/186.239ede39.js"><link rel="prefetch" href="/docs/assets/js/187.312e69f8.js"><link rel="prefetch" href="/docs/assets/js/188.b70e3067.js"><link rel="prefetch" href="/docs/assets/js/189.bbfecc90.js"><link rel="prefetch" href="/docs/assets/js/19.cae14379.js"><link rel="prefetch" href="/docs/assets/js/190.30cbba38.js"><link rel="prefetch" href="/docs/assets/js/191.da60241c.js"><link rel="prefetch" href="/docs/assets/js/192.7c623ba2.js"><link rel="prefetch" href="/docs/assets/js/193.7d8f3450.js"><link rel="prefetch" href="/docs/assets/js/194.aa264b53.js"><link rel="prefetch" href="/docs/assets/js/195.734bfef3.js"><link rel="prefetch" href="/docs/assets/js/196.19a9d157.js"><link rel="prefetch" href="/docs/assets/js/197.5d809998.js"><link rel="prefetch" href="/docs/assets/js/198.06f66b88.js"><link rel="prefetch" href="/docs/assets/js/199.0f8c23d3.js"><link rel="prefetch" href="/docs/assets/js/20.69dc5b3a.js"><link rel="prefetch" href="/docs/assets/js/200.9cb3640f.js"><link rel="prefetch" href="/docs/assets/js/201.857a4765.js"><link rel="prefetch" href="/docs/assets/js/202.0c240b56.js"><link rel="prefetch" href="/docs/assets/js/203.6ebd4a56.js"><link rel="prefetch" href="/docs/assets/js/204.bcfab98e.js"><link rel="prefetch" href="/docs/assets/js/205.bff82ad0.js"><link rel="prefetch" href="/docs/assets/js/206.34987847.js"><link rel="prefetch" href="/docs/assets/js/207.bb466d58.js"><link rel="prefetch" href="/docs/assets/js/208.552f1ccf.js"><link rel="prefetch" href="/docs/assets/js/209.5d1213ee.js"><link rel="prefetch" href="/docs/assets/js/21.5a780055.js"><link rel="prefetch" href="/docs/assets/js/210.f4f6157a.js"><link rel="prefetch" href="/docs/assets/js/211.6058c502.js"><link rel="prefetch" href="/docs/assets/js/212.e3c6618f.js"><link rel="prefetch" href="/docs/assets/js/213.a9c2f781.js"><link rel="prefetch" href="/docs/assets/js/214.0065b08b.js"><link rel="prefetch" href="/docs/assets/js/215.ecc862e4.js"><link rel="prefetch" href="/docs/assets/js/216.36e41bdd.js"><link rel="prefetch" href="/docs/assets/js/217.1d8804f1.js"><link rel="prefetch" href="/docs/assets/js/218.cca06836.js"><link rel="prefetch" href="/docs/assets/js/219.26061a50.js"><link rel="prefetch" href="/docs/assets/js/22.f75cdb2f.js"><link rel="prefetch" href="/docs/assets/js/220.0129a4ce.js"><link rel="prefetch" href="/docs/assets/js/221.990d43e7.js"><link rel="prefetch" href="/docs/assets/js/222.3fb6bb40.js"><link rel="prefetch" href="/docs/assets/js/223.a1a48395.js"><link rel="prefetch" href="/docs/assets/js/224.3c6dade6.js"><link rel="prefetch" href="/docs/assets/js/225.c787164b.js"><link rel="prefetch" href="/docs/assets/js/226.73668f20.js"><link rel="prefetch" href="/docs/assets/js/227.7508587e.js"><link rel="prefetch" href="/docs/assets/js/228.954bb782.js"><link rel="prefetch" href="/docs/assets/js/229.05deb115.js"><link rel="prefetch" href="/docs/assets/js/23.c1278ee2.js"><link rel="prefetch" href="/docs/assets/js/230.c9ded572.js"><link rel="prefetch" href="/docs/assets/js/231.73e0fe13.js"><link rel="prefetch" href="/docs/assets/js/232.ca3149c7.js"><link rel="prefetch" href="/docs/assets/js/233.05d05c59.js"><link rel="prefetch" href="/docs/assets/js/234.141631e6.js"><link rel="prefetch" href="/docs/assets/js/235.960d42e2.js"><link rel="prefetch" href="/docs/assets/js/236.1bd8e273.js"><link rel="prefetch" href="/docs/assets/js/237.8da7f7e7.js"><link rel="prefetch" href="/docs/assets/js/238.760d9b2f.js"><link rel="prefetch" href="/docs/assets/js/239.15b9c518.js"><link rel="prefetch" href="/docs/assets/js/24.8952309d.js"><link rel="prefetch" href="/docs/assets/js/240.7f58ae5a.js"><link rel="prefetch" href="/docs/assets/js/241.a1f0eb8e.js"><link rel="prefetch" href="/docs/assets/js/242.e7d9adb3.js"><link rel="prefetch" href="/docs/assets/js/243.b8e38286.js"><link rel="prefetch" href="/docs/assets/js/244.d8ad2a8a.js"><link rel="prefetch" href="/docs/assets/js/245.6ad9b399.js"><link rel="prefetch" href="/docs/assets/js/246.a6d9759a.js"><link rel="prefetch" href="/docs/assets/js/247.f2483234.js"><link rel="prefetch" href="/docs/assets/js/248.080ebe02.js"><link rel="prefetch" href="/docs/assets/js/249.adaf3082.js"><link rel="prefetch" href="/docs/assets/js/25.3e20554e.js"><link rel="prefetch" href="/docs/assets/js/250.9909962b.js"><link rel="prefetch" href="/docs/assets/js/251.b6d2211c.js"><link rel="prefetch" href="/docs/assets/js/252.f3f6d382.js"><link rel="prefetch" href="/docs/assets/js/253.832e7eb3.js"><link rel="prefetch" href="/docs/assets/js/254.6ab891e9.js"><link rel="prefetch" href="/docs/assets/js/255.0eff5699.js"><link rel="prefetch" href="/docs/assets/js/256.be82c7a6.js"><link rel="prefetch" href="/docs/assets/js/257.3571d3a8.js"><link rel="prefetch" href="/docs/assets/js/258.599c3a78.js"><link rel="prefetch" href="/docs/assets/js/259.b8d1bfeb.js"><link rel="prefetch" href="/docs/assets/js/26.d427f924.js"><link rel="prefetch" href="/docs/assets/js/260.987913b7.js"><link rel="prefetch" href="/docs/assets/js/261.f0f02d83.js"><link rel="prefetch" href="/docs/assets/js/262.f9df9d86.js"><link rel="prefetch" href="/docs/assets/js/263.c65df275.js"><link rel="prefetch" href="/docs/assets/js/264.c70152c3.js"><link rel="prefetch" href="/docs/assets/js/265.a511a34c.js"><link rel="prefetch" href="/docs/assets/js/266.32b18935.js"><link rel="prefetch" href="/docs/assets/js/267.35561793.js"><link rel="prefetch" href="/docs/assets/js/268.19043633.js"><link rel="prefetch" href="/docs/assets/js/269.7339e1f0.js"><link rel="prefetch" href="/docs/assets/js/27.3bbc7757.js"><link rel="prefetch" href="/docs/assets/js/270.14af696e.js"><link rel="prefetch" href="/docs/assets/js/271.c71a9778.js"><link rel="prefetch" href="/docs/assets/js/272.ddf3010f.js"><link rel="prefetch" href="/docs/assets/js/273.d83d0185.js"><link rel="prefetch" href="/docs/assets/js/274.792d1bb5.js"><link rel="prefetch" href="/docs/assets/js/275.a38a1773.js"><link rel="prefetch" href="/docs/assets/js/276.3de0f79e.js"><link rel="prefetch" href="/docs/assets/js/277.4cdaeb4b.js"><link rel="prefetch" href="/docs/assets/js/278.de14bdfb.js"><link rel="prefetch" href="/docs/assets/js/279.126c5997.js"><link rel="prefetch" href="/docs/assets/js/28.489183b5.js"><link rel="prefetch" href="/docs/assets/js/280.aeacf2fe.js"><link rel="prefetch" href="/docs/assets/js/281.17449cb6.js"><link rel="prefetch" href="/docs/assets/js/282.d8fc7b16.js"><link rel="prefetch" href="/docs/assets/js/283.7bb581bd.js"><link rel="prefetch" href="/docs/assets/js/284.23e2113f.js"><link rel="prefetch" href="/docs/assets/js/285.19c8f473.js"><link rel="prefetch" href="/docs/assets/js/286.341706bb.js"><link rel="prefetch" href="/docs/assets/js/287.361f0473.js"><link rel="prefetch" href="/docs/assets/js/288.d4529dea.js"><link rel="prefetch" href="/docs/assets/js/289.c0f41e46.js"><link rel="prefetch" href="/docs/assets/js/29.8f6b39b6.js"><link rel="prefetch" href="/docs/assets/js/290.1fdb28c6.js"><link rel="prefetch" href="/docs/assets/js/291.b92ba39e.js"><link rel="prefetch" href="/docs/assets/js/292.cb043e51.js"><link rel="prefetch" href="/docs/assets/js/293.aaf7609d.js"><link rel="prefetch" href="/docs/assets/js/294.c9e1ad00.js"><link rel="prefetch" href="/docs/assets/js/295.d8073d2b.js"><link rel="prefetch" href="/docs/assets/js/296.fb621c07.js"><link rel="prefetch" href="/docs/assets/js/297.a38b7371.js"><link rel="prefetch" href="/docs/assets/js/298.793fd8b4.js"><link rel="prefetch" href="/docs/assets/js/299.01b31e10.js"><link rel="prefetch" href="/docs/assets/js/3.545a8231.js"><link rel="prefetch" href="/docs/assets/js/30.e7a9d693.js"><link rel="prefetch" href="/docs/assets/js/300.d1c1d6d8.js"><link rel="prefetch" href="/docs/assets/js/301.343bc869.js"><link rel="prefetch" href="/docs/assets/js/302.f7958a16.js"><link rel="prefetch" href="/docs/assets/js/303.b33d582a.js"><link rel="prefetch" href="/docs/assets/js/304.63c91e1e.js"><link rel="prefetch" href="/docs/assets/js/305.3017fa8f.js"><link rel="prefetch" href="/docs/assets/js/306.8d5c9872.js"><link rel="prefetch" href="/docs/assets/js/307.ed23c942.js"><link rel="prefetch" href="/docs/assets/js/308.ee90e908.js"><link rel="prefetch" href="/docs/assets/js/309.afb3249f.js"><link rel="prefetch" href="/docs/assets/js/31.0910271f.js"><link rel="prefetch" href="/docs/assets/js/310.da5eb876.js"><link rel="prefetch" href="/docs/assets/js/311.9e7b132f.js"><link rel="prefetch" href="/docs/assets/js/312.b4701c19.js"><link rel="prefetch" href="/docs/assets/js/313.291b95c7.js"><link rel="prefetch" href="/docs/assets/js/314.2fa02434.js"><link rel="prefetch" href="/docs/assets/js/315.5a37b259.js"><link rel="prefetch" href="/docs/assets/js/316.9d03e2a0.js"><link rel="prefetch" href="/docs/assets/js/317.8d73b698.js"><link rel="prefetch" href="/docs/assets/js/318.9309b379.js"><link rel="prefetch" href="/docs/assets/js/319.bb4b2c07.js"><link rel="prefetch" href="/docs/assets/js/32.36d02cc0.js"><link rel="prefetch" href="/docs/assets/js/320.89f9e28e.js"><link rel="prefetch" href="/docs/assets/js/321.51504c8d.js"><link rel="prefetch" href="/docs/assets/js/322.260bad3c.js"><link rel="prefetch" href="/docs/assets/js/323.882f748a.js"><link rel="prefetch" href="/docs/assets/js/324.62fb47e9.js"><link rel="prefetch" href="/docs/assets/js/325.ebc880f7.js"><link rel="prefetch" href="/docs/assets/js/326.ef629bee.js"><link rel="prefetch" href="/docs/assets/js/327.2dd239dd.js"><link rel="prefetch" href="/docs/assets/js/328.8288d42c.js"><link rel="prefetch" href="/docs/assets/js/329.b01889fb.js"><link rel="prefetch" href="/docs/assets/js/33.811afde4.js"><link rel="prefetch" href="/docs/assets/js/330.2ea08d8f.js"><link rel="prefetch" href="/docs/assets/js/331.1e015637.js"><link rel="prefetch" href="/docs/assets/js/332.0f6f2222.js"><link rel="prefetch" href="/docs/assets/js/333.9bd127d8.js"><link rel="prefetch" href="/docs/assets/js/334.2d87b718.js"><link rel="prefetch" href="/docs/assets/js/335.5db8a93d.js"><link rel="prefetch" href="/docs/assets/js/336.0c4f8281.js"><link rel="prefetch" href="/docs/assets/js/337.6f2e5866.js"><link rel="prefetch" href="/docs/assets/js/338.b5200f4c.js"><link rel="prefetch" href="/docs/assets/js/339.f4c9fd7c.js"><link rel="prefetch" href="/docs/assets/js/34.e03918c4.js"><link rel="prefetch" href="/docs/assets/js/340.d9058ce6.js"><link rel="prefetch" href="/docs/assets/js/341.7a7b4f56.js"><link rel="prefetch" href="/docs/assets/js/342.67d97a0a.js"><link rel="prefetch" href="/docs/assets/js/343.e8b4755d.js"><link rel="prefetch" href="/docs/assets/js/344.6efa4604.js"><link rel="prefetch" href="/docs/assets/js/345.eb25eb47.js"><link rel="prefetch" href="/docs/assets/js/346.7cd67be1.js"><link rel="prefetch" href="/docs/assets/js/347.c89138ea.js"><link rel="prefetch" href="/docs/assets/js/348.7794cd73.js"><link rel="prefetch" href="/docs/assets/js/349.43a34146.js"><link rel="prefetch" href="/docs/assets/js/35.8510e2da.js"><link rel="prefetch" href="/docs/assets/js/350.ec41f96e.js"><link rel="prefetch" href="/docs/assets/js/351.217cb6ff.js"><link rel="prefetch" href="/docs/assets/js/352.8de80f13.js"><link rel="prefetch" href="/docs/assets/js/353.9390dccc.js"><link rel="prefetch" href="/docs/assets/js/354.139d9457.js"><link rel="prefetch" href="/docs/assets/js/355.2bb38968.js"><link rel="prefetch" href="/docs/assets/js/356.b051c8da.js"><link rel="prefetch" href="/docs/assets/js/357.9149d230.js"><link rel="prefetch" href="/docs/assets/js/358.61f2ab7d.js"><link rel="prefetch" href="/docs/assets/js/359.f43074b7.js"><link rel="prefetch" href="/docs/assets/js/36.62b38d06.js"><link rel="prefetch" href="/docs/assets/js/360.f5b8c80e.js"><link rel="prefetch" href="/docs/assets/js/361.c55d82bc.js"><link rel="prefetch" href="/docs/assets/js/362.430f1b01.js"><link rel="prefetch" href="/docs/assets/js/363.04beb33c.js"><link rel="prefetch" href="/docs/assets/js/364.0efaaa29.js"><link rel="prefetch" href="/docs/assets/js/365.6d50d69f.js"><link rel="prefetch" href="/docs/assets/js/366.be07d9bc.js"><link rel="prefetch" href="/docs/assets/js/367.0e95b5d3.js"><link rel="prefetch" href="/docs/assets/js/368.46a53b90.js"><link rel="prefetch" href="/docs/assets/js/369.490041e8.js"><link rel="prefetch" href="/docs/assets/js/37.c8b80ab2.js"><link rel="prefetch" href="/docs/assets/js/370.682c2a36.js"><link rel="prefetch" href="/docs/assets/js/371.ca22f364.js"><link rel="prefetch" href="/docs/assets/js/372.f4b398e0.js"><link rel="prefetch" href="/docs/assets/js/373.58c7f856.js"><link rel="prefetch" href="/docs/assets/js/374.ef1b6ef0.js"><link rel="prefetch" href="/docs/assets/js/375.eb535522.js"><link rel="prefetch" href="/docs/assets/js/376.cb5e3b10.js"><link rel="prefetch" href="/docs/assets/js/377.9eb66743.js"><link rel="prefetch" href="/docs/assets/js/378.97a001f4.js"><link rel="prefetch" href="/docs/assets/js/379.5e12c100.js"><link rel="prefetch" href="/docs/assets/js/38.4bea13ad.js"><link rel="prefetch" href="/docs/assets/js/380.87bebb92.js"><link rel="prefetch" href="/docs/assets/js/381.40379214.js"><link rel="prefetch" href="/docs/assets/js/382.cd17b832.js"><link rel="prefetch" href="/docs/assets/js/383.1cb11e4c.js"><link rel="prefetch" href="/docs/assets/js/384.e398b0bb.js"><link rel="prefetch" href="/docs/assets/js/385.017c75d6.js"><link rel="prefetch" href="/docs/assets/js/386.840aa37c.js"><link rel="prefetch" href="/docs/assets/js/387.e90fb780.js"><link rel="prefetch" href="/docs/assets/js/388.ac6eebbf.js"><link rel="prefetch" href="/docs/assets/js/389.81e1d90b.js"><link rel="prefetch" href="/docs/assets/js/39.82d1b9c2.js"><link rel="prefetch" href="/docs/assets/js/390.63148a2a.js"><link rel="prefetch" href="/docs/assets/js/391.971d96cb.js"><link rel="prefetch" href="/docs/assets/js/392.1d469876.js"><link rel="prefetch" href="/docs/assets/js/393.12537150.js"><link rel="prefetch" href="/docs/assets/js/394.5f76a5e6.js"><link rel="prefetch" href="/docs/assets/js/395.66a32335.js"><link rel="prefetch" href="/docs/assets/js/396.09b837d2.js"><link rel="prefetch" href="/docs/assets/js/397.cded1720.js"><link rel="prefetch" href="/docs/assets/js/398.e8ed0903.js"><link rel="prefetch" href="/docs/assets/js/399.cda7cb34.js"><link rel="prefetch" href="/docs/assets/js/4.3cbfa5c7.js"><link rel="prefetch" href="/docs/assets/js/40.2569ba0b.js"><link rel="prefetch" href="/docs/assets/js/400.6501587e.js"><link rel="prefetch" href="/docs/assets/js/401.6ec5192c.js"><link rel="prefetch" href="/docs/assets/js/402.3d665e11.js"><link rel="prefetch" href="/docs/assets/js/403.cdd8f982.js"><link rel="prefetch" href="/docs/assets/js/404.20ab8803.js"><link rel="prefetch" href="/docs/assets/js/405.4431e639.js"><link rel="prefetch" href="/docs/assets/js/406.ce9ebcb7.js"><link rel="prefetch" href="/docs/assets/js/407.59b73de2.js"><link rel="prefetch" href="/docs/assets/js/408.6acddb26.js"><link rel="prefetch" href="/docs/assets/js/409.7eba8041.js"><link rel="prefetch" href="/docs/assets/js/41.61f0056b.js"><link rel="prefetch" href="/docs/assets/js/410.040da15a.js"><link rel="prefetch" href="/docs/assets/js/411.0eaf5b07.js"><link rel="prefetch" href="/docs/assets/js/412.8c301549.js"><link rel="prefetch" href="/docs/assets/js/413.b5bdd2e3.js"><link rel="prefetch" href="/docs/assets/js/414.8d488c58.js"><link rel="prefetch" href="/docs/assets/js/415.cf33a8e1.js"><link rel="prefetch" href="/docs/assets/js/416.3e9c2c75.js"><link rel="prefetch" href="/docs/assets/js/417.2d5966e0.js"><link rel="prefetch" href="/docs/assets/js/418.203dc0a5.js"><link rel="prefetch" href="/docs/assets/js/419.264d4373.js"><link rel="prefetch" href="/docs/assets/js/42.aec96e15.js"><link rel="prefetch" href="/docs/assets/js/420.c630872f.js"><link rel="prefetch" href="/docs/assets/js/421.3dfe5ddd.js"><link rel="prefetch" href="/docs/assets/js/422.d3424418.js"><link rel="prefetch" href="/docs/assets/js/423.42820523.js"><link rel="prefetch" href="/docs/assets/js/424.e986a86f.js"><link rel="prefetch" href="/docs/assets/js/426.fe160967.js"><link rel="prefetch" href="/docs/assets/js/427.9516b627.js"><link rel="prefetch" href="/docs/assets/js/428.30e81afb.js"><link rel="prefetch" href="/docs/assets/js/429.62ba0e51.js"><link rel="prefetch" href="/docs/assets/js/43.44a80d05.js"><link rel="prefetch" href="/docs/assets/js/430.e583c46e.js"><link rel="prefetch" href="/docs/assets/js/431.bcbbeb0e.js"><link rel="prefetch" href="/docs/assets/js/432.6131d46d.js"><link rel="prefetch" href="/docs/assets/js/433.22b11c14.js"><link rel="prefetch" href="/docs/assets/js/434.baae1083.js"><link rel="prefetch" href="/docs/assets/js/435.009ffcb6.js"><link rel="prefetch" href="/docs/assets/js/436.d048c182.js"><link rel="prefetch" href="/docs/assets/js/437.cdb88918.js"><link rel="prefetch" href="/docs/assets/js/438.29279ecb.js"><link rel="prefetch" href="/docs/assets/js/439.02dc69ce.js"><link rel="prefetch" href="/docs/assets/js/44.8a99e348.js"><link rel="prefetch" href="/docs/assets/js/440.eda3a0cc.js"><link rel="prefetch" href="/docs/assets/js/441.6c90a25d.js"><link rel="prefetch" href="/docs/assets/js/442.dadbab3f.js"><link rel="prefetch" href="/docs/assets/js/443.65896525.js"><link rel="prefetch" href="/docs/assets/js/444.cb1afecb.js"><link rel="prefetch" href="/docs/assets/js/445.1567b729.js"><link rel="prefetch" href="/docs/assets/js/446.64dcb014.js"><link rel="prefetch" href="/docs/assets/js/447.8d0f0937.js"><link rel="prefetch" href="/docs/assets/js/448.96de4780.js"><link rel="prefetch" href="/docs/assets/js/449.28f87c7c.js"><link rel="prefetch" href="/docs/assets/js/45.2e0f9f92.js"><link rel="prefetch" href="/docs/assets/js/450.9ee0c5cc.js"><link rel="prefetch" href="/docs/assets/js/451.e0f8590c.js"><link rel="prefetch" href="/docs/assets/js/452.19734a1d.js"><link rel="prefetch" href="/docs/assets/js/453.0a51079d.js"><link rel="prefetch" href="/docs/assets/js/454.c5984632.js"><link rel="prefetch" href="/docs/assets/js/455.049f8f5a.js"><link rel="prefetch" href="/docs/assets/js/456.8c8da52b.js"><link rel="prefetch" href="/docs/assets/js/457.ee45a7a6.js"><link rel="prefetch" href="/docs/assets/js/458.a5fd67f0.js"><link rel="prefetch" href="/docs/assets/js/459.d2d7fb6e.js"><link rel="prefetch" href="/docs/assets/js/46.361c9dd6.js"><link rel="prefetch" href="/docs/assets/js/460.5a05bf28.js"><link rel="prefetch" href="/docs/assets/js/461.bb1098b1.js"><link rel="prefetch" href="/docs/assets/js/462.3b04b568.js"><link rel="prefetch" href="/docs/assets/js/463.9345bf37.js"><link rel="prefetch" href="/docs/assets/js/464.c7eb2dc1.js"><link rel="prefetch" href="/docs/assets/js/465.f9088619.js"><link rel="prefetch" href="/docs/assets/js/466.d9d07eda.js"><link rel="prefetch" href="/docs/assets/js/467.14ba115d.js"><link rel="prefetch" href="/docs/assets/js/468.ed49a36c.js"><link rel="prefetch" href="/docs/assets/js/469.4b916aa5.js"><link rel="prefetch" href="/docs/assets/js/47.409d83c0.js"><link rel="prefetch" href="/docs/assets/js/470.bad8452b.js"><link rel="prefetch" href="/docs/assets/js/471.6926d528.js"><link rel="prefetch" href="/docs/assets/js/472.79f7a58a.js"><link rel="prefetch" href="/docs/assets/js/473.406c192c.js"><link rel="prefetch" href="/docs/assets/js/474.500230fb.js"><link rel="prefetch" href="/docs/assets/js/475.ac83101e.js"><link rel="prefetch" href="/docs/assets/js/476.80e1e87b.js"><link rel="prefetch" href="/docs/assets/js/477.489b2b35.js"><link rel="prefetch" href="/docs/assets/js/478.077bb4fc.js"><link rel="prefetch" href="/docs/assets/js/479.eed84a4f.js"><link rel="prefetch" href="/docs/assets/js/48.0080608a.js"><link rel="prefetch" href="/docs/assets/js/480.c8080cf6.js"><link rel="prefetch" href="/docs/assets/js/481.79bf12a0.js"><link rel="prefetch" href="/docs/assets/js/482.b3fcac7a.js"><link rel="prefetch" href="/docs/assets/js/483.c3576319.js"><link rel="prefetch" href="/docs/assets/js/484.e5dbd0ec.js"><link rel="prefetch" href="/docs/assets/js/485.9e962252.js"><link rel="prefetch" href="/docs/assets/js/486.8ebaee00.js"><link rel="prefetch" href="/docs/assets/js/487.f1a1695a.js"><link rel="prefetch" href="/docs/assets/js/488.4d7d8a8c.js"><link rel="prefetch" href="/docs/assets/js/489.f1fef496.js"><link rel="prefetch" href="/docs/assets/js/49.55066cfc.js"><link rel="prefetch" href="/docs/assets/js/490.326a8a04.js"><link rel="prefetch" href="/docs/assets/js/491.b62dd965.js"><link rel="prefetch" href="/docs/assets/js/492.4aede1d0.js"><link rel="prefetch" href="/docs/assets/js/493.e3614b5e.js"><link rel="prefetch" href="/docs/assets/js/494.95a35a63.js"><link rel="prefetch" href="/docs/assets/js/495.06e67400.js"><link rel="prefetch" href="/docs/assets/js/496.36c500da.js"><link rel="prefetch" href="/docs/assets/js/497.23490d2f.js"><link rel="prefetch" href="/docs/assets/js/498.d8e8ceb2.js"><link rel="prefetch" href="/docs/assets/js/499.d3fd7c30.js"><link rel="prefetch" href="/docs/assets/js/5.7039a07d.js"><link rel="prefetch" href="/docs/assets/js/50.36f691ad.js"><link rel="prefetch" href="/docs/assets/js/500.59dfbcb9.js"><link rel="prefetch" href="/docs/assets/js/501.cf2a9f80.js"><link rel="prefetch" href="/docs/assets/js/502.17cbad9d.js"><link rel="prefetch" href="/docs/assets/js/503.e85e3a53.js"><link rel="prefetch" href="/docs/assets/js/504.120c01b7.js"><link rel="prefetch" href="/docs/assets/js/505.1efcbd87.js"><link rel="prefetch" href="/docs/assets/js/506.bdc3df97.js"><link rel="prefetch" href="/docs/assets/js/507.d67ea944.js"><link rel="prefetch" href="/docs/assets/js/508.8dfe103f.js"><link rel="prefetch" href="/docs/assets/js/509.4fa8bf99.js"><link rel="prefetch" href="/docs/assets/js/51.bc729280.js"><link rel="prefetch" href="/docs/assets/js/510.390c36aa.js"><link rel="prefetch" href="/docs/assets/js/511.e2639130.js"><link rel="prefetch" href="/docs/assets/js/512.21b3358e.js"><link rel="prefetch" href="/docs/assets/js/513.348e4b85.js"><link rel="prefetch" href="/docs/assets/js/514.06b05982.js"><link rel="prefetch" href="/docs/assets/js/515.98896a81.js"><link rel="prefetch" href="/docs/assets/js/516.d9c01ec9.js"><link rel="prefetch" href="/docs/assets/js/517.eecb3af7.js"><link rel="prefetch" href="/docs/assets/js/518.f935b907.js"><link rel="prefetch" href="/docs/assets/js/519.4f0ae23d.js"><link rel="prefetch" href="/docs/assets/js/52.398f515a.js"><link rel="prefetch" href="/docs/assets/js/520.abef8393.js"><link rel="prefetch" href="/docs/assets/js/521.9ea4d0d1.js"><link rel="prefetch" href="/docs/assets/js/522.78ebe477.js"><link rel="prefetch" href="/docs/assets/js/523.e5cf2c72.js"><link rel="prefetch" href="/docs/assets/js/524.79f4df75.js"><link rel="prefetch" href="/docs/assets/js/525.5302843d.js"><link rel="prefetch" href="/docs/assets/js/526.50279342.js"><link rel="prefetch" href="/docs/assets/js/527.d368e0be.js"><link rel="prefetch" href="/docs/assets/js/528.b4b29ddf.js"><link rel="prefetch" href="/docs/assets/js/529.dc8717c5.js"><link rel="prefetch" href="/docs/assets/js/53.a95bcd81.js"><link rel="prefetch" href="/docs/assets/js/530.b923c923.js"><link rel="prefetch" href="/docs/assets/js/531.360708c7.js"><link rel="prefetch" href="/docs/assets/js/532.c5dd14c0.js"><link rel="prefetch" href="/docs/assets/js/533.b123ce97.js"><link rel="prefetch" href="/docs/assets/js/534.91522425.js"><link rel="prefetch" href="/docs/assets/js/535.034c61c2.js"><link rel="prefetch" href="/docs/assets/js/536.78a4c116.js"><link rel="prefetch" href="/docs/assets/js/537.b044ccfe.js"><link rel="prefetch" href="/docs/assets/js/538.c039b1a0.js"><link rel="prefetch" href="/docs/assets/js/539.86d487e1.js"><link rel="prefetch" href="/docs/assets/js/54.2fe08797.js"><link rel="prefetch" href="/docs/assets/js/540.eab0ed59.js"><link rel="prefetch" href="/docs/assets/js/541.3ea585a1.js"><link rel="prefetch" href="/docs/assets/js/542.f5e1f8b8.js"><link rel="prefetch" href="/docs/assets/js/543.097a13c3.js"><link rel="prefetch" href="/docs/assets/js/544.16300970.js"><link rel="prefetch" href="/docs/assets/js/545.b6377268.js"><link rel="prefetch" href="/docs/assets/js/546.84ae6c11.js"><link rel="prefetch" href="/docs/assets/js/547.9cf5dabc.js"><link rel="prefetch" href="/docs/assets/js/548.621bb124.js"><link rel="prefetch" href="/docs/assets/js/549.cd26b3cb.js"><link rel="prefetch" href="/docs/assets/js/55.a16eff52.js"><link rel="prefetch" href="/docs/assets/js/550.2f866da6.js"><link rel="prefetch" href="/docs/assets/js/551.89c1c1e2.js"><link rel="prefetch" href="/docs/assets/js/56.37338d07.js"><link rel="prefetch" href="/docs/assets/js/57.26a00407.js"><link rel="prefetch" href="/docs/assets/js/58.2f56e8fd.js"><link rel="prefetch" href="/docs/assets/js/59.8f4a96f3.js"><link rel="prefetch" href="/docs/assets/js/6.1e9f5f4c.js"><link rel="prefetch" href="/docs/assets/js/60.1b57fb5a.js"><link rel="prefetch" href="/docs/assets/js/61.13bf7ce9.js"><link rel="prefetch" href="/docs/assets/js/62.114ae3f7.js"><link rel="prefetch" href="/docs/assets/js/63.4e5527db.js"><link rel="prefetch" href="/docs/assets/js/64.72ff5980.js"><link rel="prefetch" href="/docs/assets/js/65.a1ae3262.js"><link rel="prefetch" href="/docs/assets/js/66.214b4bc2.js"><link rel="prefetch" href="/docs/assets/js/67.67657206.js"><link rel="prefetch" href="/docs/assets/js/68.94d55f7c.js"><link rel="prefetch" href="/docs/assets/js/69.1925db57.js"><link rel="prefetch" href="/docs/assets/js/7.5e87d337.js"><link rel="prefetch" href="/docs/assets/js/70.355a7760.js"><link rel="prefetch" href="/docs/assets/js/71.52ed6b75.js"><link rel="prefetch" href="/docs/assets/js/72.34d2fc1a.js"><link rel="prefetch" href="/docs/assets/js/73.b23dfb1c.js"><link rel="prefetch" href="/docs/assets/js/74.0e0d54ea.js"><link rel="prefetch" href="/docs/assets/js/75.0c796480.js"><link rel="prefetch" href="/docs/assets/js/76.e8164ac1.js"><link rel="prefetch" href="/docs/assets/js/77.1ee010d8.js"><link rel="prefetch" href="/docs/assets/js/78.ec1ae879.js"><link rel="prefetch" href="/docs/assets/js/79.731cfed2.js"><link rel="prefetch" href="/docs/assets/js/8.084e11fa.js"><link rel="prefetch" href="/docs/assets/js/80.de091e5c.js"><link rel="prefetch" href="/docs/assets/js/81.ab0a4f59.js"><link rel="prefetch" href="/docs/assets/js/82.8e64d14c.js"><link rel="prefetch" href="/docs/assets/js/83.b9782b6e.js"><link rel="prefetch" href="/docs/assets/js/84.230846c3.js"><link rel="prefetch" href="/docs/assets/js/85.4915f656.js"><link rel="prefetch" href="/docs/assets/js/86.f39995a5.js"><link rel="prefetch" href="/docs/assets/js/87.07e9671d.js"><link rel="prefetch" href="/docs/assets/js/88.c56e7601.js"><link rel="prefetch" href="/docs/assets/js/9.8e31a4ed.js"><link rel="prefetch" href="/docs/assets/js/90.59379451.js"><link rel="prefetch" href="/docs/assets/js/91.1dc12c66.js"><link rel="prefetch" href="/docs/assets/js/92.61efacd9.js"><link rel="prefetch" href="/docs/assets/js/93.78375fd6.js"><link rel="prefetch" href="/docs/assets/js/94.f54f9084.js"><link rel="prefetch" href="/docs/assets/js/95.3d65dc81.js"><link rel="prefetch" href="/docs/assets/js/96.41c44e2b.js"><link rel="prefetch" href="/docs/assets/js/97.b5b8e439.js"><link rel="prefetch" href="/docs/assets/js/98.63e475ee.js"><link rel="prefetch" href="/docs/assets/js/99.7183d97e.js">
    <link rel="stylesheet" href="/docs/assets/css/0.styles.416feb4e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/docs/" class="home-link router-link-active"><!----> <span class="site-name">Nguyễn Khánk's Wiki</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/docs/architect/" class="nav-link">
  Architecture
</a></div><div class="nav-item"><a href="https://nguyenngockhank.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Home
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/docs/architect/" class="nav-link">
  Architecture
</a></div><div class="nav-item"><a href="https://nguyenngockhank.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Home
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>System Design Case Studies</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/kungfu/case-study/notification/" class="sidebar-link">Design a notification system</a></li><li><a href="/docs/kungfu/case-study/metrics/" class="sidebar-link">Metrics Monitoring &amp; Alerting System</a></li><li><a href="/docs/kungfu/case-study/ad-click/" class="sidebar-link">Ad Click Event Aggregation</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Online tools</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Booking System</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Social Network</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Location-based</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Video</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Chat system</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>The Art of Readable Code</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>A Philosophy of Software Design</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Building Microservices</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>97 Things Every Programmer Should Know</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>NoSql Distilled</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Go</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Others</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_14-successive-refinement"><a href="#_14-successive-refinement" class="header-anchor">#</a> 14. Successive Refinement</h1> <p><em>Case Study of a Command-Line Argument Parser</em></p> <p>This chapter is a case study in successive refinement. You will see a module that started well but did not scale. Then you will see how the module was refactored and cleaned.</p> <p>Most of us have had to parse command-line arguments from time to time. If we don’t have a convenient utility, then we simply walk the array of strings that is passed into the mainfunction. There are several good utilities available from various sources, but none of them do exactly what I want. So, of course, I decided to write my own. I call it: <code>Args</code>.</p> <p><code>Args</code> is very simple to use. You simply construct the <code>Args</code> class with the input arguments and a format string, and then query the <code>Args</code> instance for the values of the arguments. Consider the following simple example:</p> <h4 id="listing-14-1"><a href="#listing-14-1" class="header-anchor">#</a> Listing 14-1</h4> <p><strong>Simple use of Args</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">Args</span> arg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Args</span><span class="token punctuation">(</span><span class="token string">&quot;l,p#,d*&quot;</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> logging <span class="token operator">=</span> arg<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token string">'l'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> port <span class="token operator">=</span> arg<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> directory <span class="token operator">=</span> arg<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">'d'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">executeApplication</span><span class="token punctuation">(</span>logging<span class="token punctuation">,</span> port<span class="token punctuation">,</span> directory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArgsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Argument error: %s\n&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">errorMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>You can see how simple this is. We just create an instance of the <code>Args</code> class with two parameters. The first parameter is the format, or <em>schema,</em> string: &quot;<code>l,p#,d*.</code>&quot; It defines three command-line arguments. The first, <code>–l</code>, is a boolean argument. The second, <code>-p</code>, is an integer argument. The third, <code>-d</code>, is a string argument. The second parameter to the <code>Args</code> constructor is simply the array of command-line argument passed into main.</p> <p>If the constructor returns without throwing an ArgsException, then the incoming command-line was parsed, and the <code>Args</code> instance is ready to be queried. Methods like <code>getBoolean</code>,<code>getInteger</code>, and <code>getString</code> allow us to access the values of the arguments by their names.</p> <p>If there is a problem, either in the format string or in the command-line arguments themselves, an <code>ArgsException</code> will be thrown. A convenient description of what went wrong can be retrieved from the <code>errorMessage</code> method of the exception.</p> <h2 id="args-implementation"><a href="#args-implementation" class="header-anchor">#</a> Args Implementation</h2> <p>Listing 14-2 is the implementation of the <code>Args</code> class. Please read it very carefully. I worked hard on the style and structure and hope it is worth emulating.</p> <h4 id="listing-14-2"><a href="#listing-14-2" class="header-anchor">#</a> Listing 14-2</h4> <p><strong>Args.java</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>objectmentor<span class="token punctuation">.</span>utilities<span class="token punctuation">.</span>args</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">com<span class="token punctuation">.</span>objectmentor<span class="token punctuation">.</span>utilities<span class="token punctuation">.</span>args<span class="token punctuation">.</span></span><span class="token class-name">ArgsException</span><span class="token punctuation">.</span><span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>*<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Args</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Character</span><span class="token punctuation">,</span> <span class="token class-name">ArgumentMarshaler</span><span class="token punctuation">&gt;</span></span> marshalers<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Character</span><span class="token punctuation">&gt;</span></span> argsFound<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">ListIterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> currentArgument<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Args</span><span class="token punctuation">(</span><span class="token class-name">String</span> schema<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        marshalers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Character</span><span class="token punctuation">,</span> <span class="token class-name">ArgumentMarshaler</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        argsFound <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Character</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">parseSchema</span><span class="token punctuation">(</span>schema<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">parseArgumentStrings</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseSchema</span><span class="token punctuation">(</span><span class="token class-name">String</span> schema<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> element <span class="token operator">:</span> schema<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token function">parseSchemaElement</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseSchemaElement</span><span class="token punctuation">(</span><span class="token class-name">String</span> element<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        <span class="token keyword">char</span> elementId <span class="token operator">=</span> element<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> elementTail <span class="token operator">=</span> element<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">validateSchemaElementId</span><span class="token punctuation">(</span>elementId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>elementTail<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            marshalers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>elementId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">BooleanArgumentMarshaler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>elementTail<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            marshalers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>elementId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">StringArgumentMarshaler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>elementTail<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;#&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            marshalers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>elementId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">IntegerArgumentMarshaler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>elementTail<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;##&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            marshalers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>elementId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DoubleArgumentMarshaler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>elementTail<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;[*]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            marshalers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>elementId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">StringArrayArgumentMarshaler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span>INVALID_ARGUMENT_FORMAT<span class="token punctuation">,</span> elementId<span class="token punctuation">,</span> elementTail<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">validateSchemaElementId</span><span class="token punctuation">(</span><span class="token keyword">char</span> elementId<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Character</span><span class="token punctuation">.</span><span class="token function">isLetter</span><span class="token punctuation">(</span>elementId<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span>INVALID_ARGUMENT_NAME<span class="token punctuation">,</span> elementId<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseArgumentStrings</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> argsList<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>currentArgument <span class="token operator">=</span> argsList<span class="token punctuation">.</span><span class="token function">listIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> currentArgument<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name">String</span> argString <span class="token operator">=</span> currentArgument<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>argString<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">parseArgumentCharacters</span><span class="token punctuation">(</span>argString<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                currentArgument<span class="token punctuation">.</span><span class="token function">previous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseArgumentCharacters</span><span class="token punctuation">(</span><span class="token class-name">String</span> argChars<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> argChars<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token function">parseArgumentCharacter</span><span class="token punctuation">(</span>argChars<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseArgumentCharacter</span><span class="token punctuation">(</span><span class="token keyword">char</span> argChar<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        <span class="token class-name">ArgumentMarshaler</span> m <span class="token operator">=</span> marshalers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span>UNEXPECTED_ARGUMENT<span class="token punctuation">,</span> argChar<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            argsFound<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                m<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>currentArgument<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArgsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">setErrorArgumentId</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">has</span><span class="token punctuation">(</span><span class="token keyword">char</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> argsFound<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">nextArgument</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> currentArgument<span class="token punctuation">.</span><span class="token function">nextIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token keyword">char</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BooleanArgumentMarshaler</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>marshalers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getString</span><span class="token punctuation">(</span><span class="token keyword">char</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">StringArgumentMarshaler</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>marshalers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getInt</span><span class="token punctuation">(</span><span class="token keyword">char</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">IntegerArgumentMarshaler</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>marshalers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">getDouble</span><span class="token punctuation">(</span><span class="token keyword">char</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">DoubleArgumentMarshaler</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>marshalers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getStringArray</span><span class="token punctuation">(</span><span class="token keyword">char</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">StringArrayArgumentMarshaler</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>marshalers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Notice that you can read this code from the top to the bottom without a lot of jumping around or looking ahead. The one thing you may have had to look ahead for is the definition of <code>ArgumentMarshaler</code>, which I left out intentionally. Having read this code carefully, you should understand what the <code>ArgumentMarshaler</code> interface is and what its derivatives do.
I’ll show a few of them to you now (Listing 14-3 through Listing 14-6).</p> <h4 id="listing-14-3"><a href="#listing-14-3" class="header-anchor">#</a> Listing 14-3</h4> <p><strong>ArgumentMarshaler.java</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">{</span>
<span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> currentArgument<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="listing-14-4"><a href="#listing-14-4" class="header-anchor">#</a> Listing 14-4</h4> <p><strong>BooleanArgumentMarshaler.java</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BooleanArgumentMarshaler</span> <span class="token keyword">implements</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> booleanValue <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> currentArgument<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        booleanValue <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token class-name">ArgumentMarshaler</span> am<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>am <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> am <span class="token keyword">instanceof</span> <span class="token class-name">BooleanArgumentMarshaler</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">BooleanArgumentMarshaler</span><span class="token punctuation">)</span> am<span class="token punctuation">)</span><span class="token punctuation">.</span>booleanValue<span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="listing-14-5"><a href="#listing-14-5" class="header-anchor">#</a> Listing 14-5</h4> <p><strong>StringArgumentMarshaler.java</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">com<span class="token punctuation">.</span>objectmentor<span class="token punctuation">.</span>utilities<span class="token punctuation">.</span>args<span class="token punctuation">.</span></span><span class="token class-name">ArgsException</span><span class="token punctuation">.</span><span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>*<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StringArgumentMarshaler</span> <span class="token keyword">implements</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> stringValue <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> currentArgument<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            stringValue <span class="token operator">=</span> currentArgument<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchElementException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span>MISSING_STRING<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token class-name">ArgumentMarshaler</span> am<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>am <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> am <span class="token keyword">instanceof</span> <span class="token class-name">StringArgumentMarshaler</span><span class="token punctuation">)</span>
            eturn <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">StringArgumentMarshaler</span><span class="token punctuation">)</span> am<span class="token punctuation">)</span><span class="token punctuation">.</span>stringValue<span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="listing-14-6"><a href="#listing-14-6" class="header-anchor">#</a> Listing 14-6</h4> <p><strong>IntegerArgumentMarshaler.java</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">com<span class="token punctuation">.</span>objectmentor<span class="token punctuation">.</span>utilities<span class="token punctuation">.</span>args<span class="token punctuation">.</span></span><span class="token class-name">ArgsException</span><span class="token punctuation">.</span><span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>*<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IntegerArgumentMarshaler</span> <span class="token keyword">implements</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> intValue <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> currentArgument<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> parameter <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            parameter <span class="token operator">=</span> currentArgument<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            intValue <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>parameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchElementException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span>MISSING_INTEGER<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NumberFormatException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span>INVALID_INTEGER<span class="token punctuation">,</span> parameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token class-name">ArgumentMarshaler</span> am<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>am <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> am <span class="token keyword">instanceof</span> <span class="token class-name">IntegerArgumentMarshaler</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">IntegerArgumentMarshaler</span><span class="token punctuation">)</span> am<span class="token punctuation">)</span><span class="token punctuation">.</span>intValue<span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The other <code>ArgumentMarshaler</code> derivatives simply replicate this pattern for <code>doubles</code> and <code>String</code> arrays and would serve to clutter this chapter. I’ll leave them to you as an exercise.</p> <p>One other bit of information might be troubling you: the definition of the error code
constants. They are in the <code>ArgsException</code> class (Listing 14-7).</p> <h4 id="listing-14-7"><a href="#listing-14-7" class="header-anchor">#</a> Listing 14-7</h4> <p><strong>ArgsException.java</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">com<span class="token punctuation">.</span>objectmentor<span class="token punctuation">.</span>utilities<span class="token punctuation">.</span>args<span class="token punctuation">.</span></span><span class="token class-name">ArgsException</span><span class="token punctuation">.</span><span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>*<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ArgsException</span> <span class="token keyword">extends</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">char</span> errorArgumentId <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> errorParameter <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">ErrorCode</span> errorCode <span class="token operator">=</span> OK<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token class-name">ErrorCode</span> errorCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>errorCode <span class="token operator">=</span> errorCode<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token class-name">ErrorCode</span> errorCode<span class="token punctuation">,</span> <span class="token class-name">String</span> errorParameter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>errorCode <span class="token operator">=</span> errorCode<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>errorParameter <span class="token operator">=</span> errorParameter<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token class-name">ErrorCode</span> errorCode<span class="token punctuation">,</span>
        <span class="token keyword">char</span> errorArgumentId<span class="token punctuation">,</span> <span class="token class-name">String</span> errorParameter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>errorCode <span class="token operator">=</span> errorCode<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>errorParameter <span class="token operator">=</span> errorParameter<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>errorArgumentId <span class="token operator">=</span> errorArgumentId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">char</span> <span class="token function">getErrorArgumentId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> errorArgumentId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setErrorArgumentId</span><span class="token punctuation">(</span><span class="token keyword">char</span> errorArgumentId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>errorArgumentId <span class="token operator">=</span> errorArgumentId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getErrorParameter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> errorParameter<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setErrorParameter</span><span class="token punctuation">(</span><span class="token class-name">String</span> errorParameter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>errorParameter <span class="token operator">=</span> errorParameter<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">ErrorCode</span> <span class="token function">getErrorCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> errorCode<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setErrorCode</span><span class="token punctuation">(</span><span class="token class-name">ErrorCode</span> errorCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>errorCode <span class="token operator">=</span> errorCode<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">errorMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>errorCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> OK<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token string">&quot;TILT: Should not get here.&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> UNEXPECTED_ARGUMENT<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Argument -%c unexpected.&quot;</span><span class="token punctuation">,</span> errorArgumentId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> MISSING_STRING<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Could not find string parameter for -%c.&quot;</span><span class="token punctuation">,</span>
                errorArgumentId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> INVALID_INTEGER<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Argument -%c expects an integer but was '%s'.&quot;</span><span class="token punctuation">,</span>
                errorArgumentId<span class="token punctuation">,</span> errorParameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> MISSING_INTEGER<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Could not find integer parameter for -%c.&quot;</span><span class="token punctuation">,</span>
                errorArgumentId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> INVALID_DOUBLE<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Argument -%c expects a double but was '%s'.&quot;</span><span class="token punctuation">,</span>
                errorArgumentId<span class="token punctuation">,</span> errorParameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> MISSING_DOUBLE<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Could not find double parameter for -%c.&quot;</span><span class="token punctuation">,</span>
                errorArgumentId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> INVALID_ARGUMENT_NAME<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;'%c' is not a valid argument name.&quot;</span><span class="token punctuation">,</span>
                errorArgumentId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> INVALID_ARGUMENT_FORMAT<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;'%s' is not a valid argument format.&quot;</span><span class="token punctuation">,</span>
                errorParameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">ErrorCode</span> <span class="token punctuation">{</span>
        OK<span class="token punctuation">,</span>
        INVALID_ARGUMENT_FORMAT<span class="token punctuation">,</span>
        UNEXPECTED_ARGUMENT<span class="token punctuation">,</span>
        INVALID_ARGUMENT_NAME<span class="token punctuation">,</span>
        MISSING_STRING<span class="token punctuation">,</span>
        MISSING_INTEGER<span class="token punctuation">,</span>
        INVALID_INTEGER<span class="token punctuation">,</span>
        MISSING_DOUBLE<span class="token punctuation">,</span>
        INVALID_DOUBLE
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>It’s remarkable how much code is required to flesh out the details of this simple concept. One of the reasons for this is that we are using a particularly wordy language. Java, being a statically typed language, requires a lot of words in order to satisfy the type system. In a language like Ruby, Python, or Smalltalk, this program is much smaller.^1</p> <p>Please read the code over one more time. Pay special attention to the way things are
named, the size of the functions, and the formatting of the code. If you are an experienced
programmer, you may have some quibbles here and there with various parts of the style or
structure. Overall, however, I hope you conclude that this program is nicely written and
has a clean structure.</p> <p>For example, it should be obvious how you would add a new argument type, such as a date argument or a complex number argument, and that such an addition would require a trivial amount of effort. In short, it would simply require a new derivative of <code>ArgumentMarshaler</code>, a new <code>getXXX</code> function, and a new case statement in the <code>parseSchemaElement</code> function. There would also probably be a new <code>ArgsException.ErrorCode</code> and a new error message.</p> <h3 id="how-did-i-do-this"><a href="#how-did-i-do-this" class="header-anchor">#</a> How Did I Do This?</h3> <p>Let me set your mind at rest. I did not simply write this program from beginning to end in its current form. More importantly, I am not expecting you to be able to write clean and elegant programs in one pass. If we have learned anything over the last couple of decades,
it is that programming is a craft more than it is a science. To write clean code, you must
first write dirty code <em>and then clean it</em>.</p> <p>This should not be a surprise to you. We learned this truth in grade school when our teachers tried (usually in vain) to get us to write rough drafts of our compositions. The
process, they told us, was that we should write a rough draft, then a second draft, then several subsequent drafts until we had our final version. Writing clean compositions, they
tried to tell us, is a matter of successive refinement.</p> <p>Most freshman programmers (like most grade-schoolers) don’t follow this advice particularly well. They believe that the primary goal is to get the program working. Once it’s “working,” they move on to the next task, leaving the “working” program in whatever state they finally got it to “work.” Most seasoned programmers know that this is professional suicide.</p> <h2 id="args-the-rough-draft"><a href="#args-the-rough-draft" class="header-anchor">#</a> Args: The Rough Draft</h2> <p>Listing 14-8 shows an earlier version of the Args class. It “works.” And it’s messy.</p> <h4 id="listing-14-8"><a href="#listing-14-8" class="header-anchor">#</a> Listing 14-8</h4> <p><strong>Args.java (first draft)</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>text<span class="token punctuation">.</span></span><span class="token class-name">ParseException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Args</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> schema<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> valid <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Set</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span> <span class="token punctuation">&gt;</span></span> unexpectedArguments <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeSet</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span> <span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span> <span class="token punctuation">&gt;</span></span> booleanArgs <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">HashMap</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span> <span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span><span class="token punctuation">,</span> <span class="token class-name">String</span> <span class="token punctuation">&gt;</span></span> stringArgs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span><span class="token punctuation">,</span> <span class="token class-name">String</span> <span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span> <span class="token punctuation">&gt;</span></span> intArgs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span> <span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Set</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span> <span class="token punctuation">&gt;</span></span> argsFound <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span> <span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> currentArgument<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">char</span> errorArgumentId <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> errorParameter <span class="token operator">=</span> <span class="token string">&quot;TILT&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">ErrorCode</span> errorCode <span class="token operator">=</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>OK<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">enum</span> <span class="token class-name">ErrorCode</span> <span class="token punctuation">{</span>
        OK<span class="token punctuation">,</span>
        MISSING_STRING<span class="token punctuation">,</span>
        MISSING_INTEGER<span class="token punctuation">,</span>
        INVALID_INTEGER<span class="token punctuation">,</span>
        UNEXPECTED_ARGUMENT
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">Args</span><span class="token punctuation">(</span><span class="token class-name">String</span> schema<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ParseException</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>schema <span class="token operator">=</span> schema<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>args <span class="token operator">=</span> args<span class="token punctuation">;</span>
        valid <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ParseException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>schema<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> args<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token function">parseSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">parseArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArgsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword">return</span> valid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">parseSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ParseException</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> element<span class="token operator">:</span> schema<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> trimmedElement <span class="token operator">=</span> element<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">parseSchemaElement</span><span class="token punctuation">(</span>trimmedElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseSchemaElement</span><span class="token punctuation">(</span><span class="token class-name">String</span> element<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ParseException</span> <span class="token punctuation">{</span>
        <span class="token keyword">char</span> elementId <span class="token operator">=</span> element<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> elementTail <span class="token operator">=</span> element<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">validateSchemaElementId</span><span class="token punctuation">(</span>elementId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isBooleanSchemaElement</span><span class="token punctuation">(</span>elementTail<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">parseBooleanSchemaElement</span><span class="token punctuation">(</span>elementId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isStringSchemaElement</span><span class="token punctuation">(</span>elementTail<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">parseStringSchemaElement</span><span class="token punctuation">(</span>elementId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isIntegerSchemaElement</span><span class="token punctuation">(</span>elementTail<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">parseIntegerSchemaElement</span><span class="token punctuation">(</span>elementId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ParseException</span><span class="token punctuation">(</span>
                <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Argument: %c has invalid format: %s.&quot;</span><span class="token punctuation">,</span>
                    elementId<span class="token punctuation">,</span> elementTail<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">validateSchemaElementId</span><span class="token punctuation">(</span><span class="token keyword">char</span> elementId<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ParseException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Character</span><span class="token punctuation">.</span><span class="token function">isLetter</span><span class="token punctuation">(</span>elementId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ParseException</span><span class="token punctuation">(</span>
                <span class="token string">&quot;Bad character:&quot;</span> <span class="token operator">+</span> elementId <span class="token operator">+</span> <span class="token string">&quot;in Args format: &quot;</span> <span class="token operator">+</span> schema<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseBooleanSchemaElement</span><span class="token punctuation">(</span><span class="token keyword">char</span> elementId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        booleanArgs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>elementId<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseIntegerSchemaElement</span><span class="token punctuation">(</span><span class="token keyword">char</span> elementId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        intArgs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>elementId<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseStringSchemaElement</span><span class="token punctuation">(</span><span class="token keyword">char</span> elementId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        stringArgs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>elementId<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isStringSchemaElement</span><span class="token punctuation">(</span><span class="token class-name">String</span> elementTail<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> elementTail<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isBooleanSchemaElement</span><span class="token punctuation">(</span><span class="token class-name">String</span> elementTail<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> elementTail<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isIntegerSchemaElement</span><span class="token punctuation">(</span><span class="token class-name">String</span> elementTail<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> elementTail<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;#&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">parseArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>currentArgument <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> currentArgument <span class="token operator">&lt;</span> args<span class="token punctuation">.</span>length<span class="token punctuation">;</span> currentArgument<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> arg <span class="token operator">=</span> args<span class="token punctuation">[</span>currentArgument<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token function">parseArgument</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseArgument</span><span class="token punctuation">(</span><span class="token class-name">String</span> arg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>arg<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">parseElements</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseElements</span><span class="token punctuation">(</span><span class="token class-name">String</span> arg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arg<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token function">parseElement</span><span class="token punctuation">(</span>arg<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseElement</span><span class="token punctuation">(</span><span class="token keyword">char</span> argChar<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setArgument</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">)</span>
            argsFound<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            unexpectedArguments<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
            errorCode <span class="token operator">=</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>UNEXPECTED_ARGUMENT<span class="token punctuation">;</span>
            valid <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">setArgument</span><span class="token punctuation">(</span><span class="token keyword">char</span> argChar<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isBooleanArg</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">setBooleanArg</span><span class="token punctuation">(</span>argChar<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isStringArg</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">setStringArg</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isIntArg</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">setIntArg</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isIntArg</span><span class="token punctuation">(</span><span class="token keyword">char</span> argChar<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> intArgs<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setIntArg</span><span class="token punctuation">(</span><span class="token keyword">char</span> argChar<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        currentArgument<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> parameter <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            parameter <span class="token operator">=</span> args<span class="token punctuation">[</span>currentArgument<span class="token punctuation">]</span><span class="token punctuation">;</span>
            intArgs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>argChar<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">(</span>parameter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArrayIndexOutOfBoundsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            valid <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            errorArgumentId <span class="token operator">=</span> argChar<span class="token punctuation">;</span>
            errorCode <span class="token operator">=</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>MISSING_INTEGER<span class="token punctuation">;</span>

            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NumberFormatException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            valid <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            errorArgumentId <span class="token operator">=</span> argChar<span class="token punctuation">;</span>
            errorParameter <span class="token operator">=</span> parameter<span class="token punctuation">;</span>
            errorCode <span class="token operator">=</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>INVALID_INTEGER<span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setStringArg</span><span class="token punctuation">(</span><span class="token keyword">char</span> argChar<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        currentArgument<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            stringArgs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>argChar<span class="token punctuation">,</span> args<span class="token punctuation">[</span>currentArgument<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArrayIndexOutOfBoundsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            valid <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            errorArgumentId <span class="token operator">=</span> argChar<span class="token punctuation">;</span>
            errorCode <span class="token operator">=</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>MISSING_STRING<span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isStringArg</span><span class="token punctuation">(</span><span class="token keyword">char</span> argChar<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> stringArgs<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setBooleanArg</span><span class="token punctuation">(</span><span class="token keyword">char</span> argChar<span class="token punctuation">,</span> <span class="token keyword">boolean</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        booleanArgs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>argChar<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isBooleanArg</span><span class="token punctuation">(</span><span class="token keyword">char</span> argChar<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> booleanArgs<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">cardinality</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> argsFound<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">usage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>schema<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token string">&quot;-[&quot;</span> <span class="token operator">+</span> schema <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">errorMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>errorCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> OK<span class="token operator">:</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">&quot;TILT: Should not get here.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> UNEXPECTED_ARGUMENT<span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token function">unexpectedArgumentMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> MISSING_STRING<span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Could not find string parameter for -%c.&quot;</span><span class="token punctuation">,</span>
                    errorArgumentId<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">case</span> INVALID_INTEGER<span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Argument -%c expects an integer but was '%s'.&quot;</span><span class="token punctuation">,</span>
                    errorArgumentId<span class="token punctuation">,</span> errorParameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> MISSING_INTEGER<span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Could not find integer parameter for -%c.&quot;</span><span class="token punctuation">,</span>
                    errorArgumentId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">unexpectedArgumentMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">StringBuffer</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token string">&quot;Argument(s) -&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">char</span> c<span class="token operator">:</span> unexpectedArguments<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            message<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        message<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot; unexpected.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> message<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">falseIfNull</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> b <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> b<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">zeroIfNull</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> i <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> i<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">blankIfNull</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> s <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">&quot;&quot;</span> <span class="token operator">:</span> s<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getString</span><span class="token punctuation">(</span><span class="token keyword">char</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">blankIfNull</span><span class="token punctuation">(</span>stringArgs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getInt</span><span class="token punctuation">(</span><span class="token keyword">char</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">zeroIfNull</span><span class="token punctuation">(</span>intArgs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token keyword">char</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">falseIfNull</span><span class="token punctuation">(</span>booleanArgs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">has</span><span class="token punctuation">(</span><span class="token keyword">char</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> argsFound<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> valid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">ArgsException</span> <span class="token keyword">extends</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>206 <strong>Chapter 14: Successive Refinement</strong></p> <p>I hope your initial reaction to this mass of code is “I’m certainly glad he didn’t leave it
like that!” If you feel like this, then remember that’s how other people are going to feel
about code that you leave in rough-draft form.</p> <p>Actually “rough draft” is probably the kindest thing you can say about this code. It’s
clearly a work in progress. The sheer number of instance variables is daunting. The odd
strings like <code>“TILT</code>,<code>”theHashSetsandTreeSets</code>, and the <code>try-catch-catch</code> blocks all add up to a festering pile.</p> <p>I had not wanted to write a festering pile. Indeed, I was trying to keep things reasonably well organized. You can probably tell that from my choice of function and variable names and the fact that there is a crude structure to the program. But, clearly, I had let the problem get away from me.</p> <p>The mess built gradually. Earlier versions had not been nearly so nasty. For example,
Listing 14-9 shows an earlier version in which only Boolean arguments were working.</p> <h4 id="listing-14-9"><a href="#listing-14-9" class="header-anchor">#</a> Listing 14-9</h4> <p><strong>Args.java (Boolean only)</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>objectmentor<span class="token punctuation">.</span>utilities<span class="token punctuation">.</span>getopts</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Args</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> schema<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> valid<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Set</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span> <span class="token punctuation">&gt;</span></span> unexpectedArguments <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeSet</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span> <span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span> <span class="token punctuation">&gt;</span></span> booleanArgs <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">HashMap</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span> <span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> numberOfArguments <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">Args</span><span class="token punctuation">(</span><span class="token class-name">String</span> schema<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>schema <span class="token operator">=</span> schema<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>args <span class="token operator">=</span> args<span class="token punctuation">;</span>
        valid <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> valid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>schema<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> args<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token function">parseSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">parseArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> unexpectedArguments<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">parseSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> element<span class="token operator">:</span> schema<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">parseSchemaElement</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseSchemaElement</span><span class="token punctuation">(</span><span class="token class-name">String</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">parseBooleanSchemaElement</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseBooleanSchemaElement</span><span class="token punctuation">(</span><span class="token class-name">String</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">char</span> c <span class="token operator">=</span> element<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Character</span><span class="token punctuation">.</span><span class="token function">isLetter</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            booleanArgs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">parseArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> arg<span class="token operator">:</span> args<span class="token punctuation">)</span>
            <span class="token function">parseArgument</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseArgument</span><span class="token punctuation">(</span><span class="token class-name">String</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>arg<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">parseElements</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseElements</span><span class="token punctuation">(</span><span class="token class-name">String</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arg<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token function">parseElement</span><span class="token punctuation">(</span>arg<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseElement</span><span class="token punctuation">(</span><span class="token keyword">char</span> argChar<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isBoolean</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            numberOfArguments<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token function">setBooleanArg</span><span class="token punctuation">(</span>argChar<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span>
            unexpectedArguments<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setBooleanArg</span><span class="token punctuation">(</span><span class="token keyword">char</span> argChar<span class="token punctuation">,</span> <span class="token keyword">boolean</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        booleanArgs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>argChar<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isBoolean</span><span class="token punctuation">(</span><span class="token keyword">char</span> argChar<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> booleanArgs<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">cardinality</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> numberOfArguments<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">usage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>schema<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token string">&quot;-[&quot;</span> <span class="token operator">+</span> schema <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">;</span>

        <span class="token keyword">else</span>
            <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">errorMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>unexpectedArguments<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">unexpectedArgumentMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span>
            <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">unexpectedArgumentMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">StringBuffer</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token string">&quot;Argument(s) -&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">char</span> c<span class="token operator">:</span> unexpectedArguments<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            message<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        message<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot; unexpected.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> message<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token keyword">char</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> booleanArgs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Although you can find plenty to complain about in this code, it’s really not that bad.
It’s compact and simple and easy to understand. However, within this code it is easy to see
the seeds of the later festering pile. It’s quite clear how this grew into the latter mess.</p> <p>Notice that the latter mess has only two more argument types than this: <code>String</code> and <code>integer</code>. The addition of just two more argument types had a massively negative impact on the code. It converted it from something that would have been reasonably maintainable into something that I would expect to become riddled with bugs and warts.</p> <p>I added the two argument types incrementally. First, I added the <code>String</code> argument, which yielded this:</p> <h4 id="listing-14-10"><a href="#listing-14-10" class="header-anchor">#</a> Listing 14-10</h4> <p><strong>Args.java (Boolean and String)</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>objectmentor<span class="token punctuation">.</span>utilities<span class="token punctuation">.</span>getopts</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>text<span class="token punctuation">.</span></span><span class="token class-name">ParseException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Args</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> schema<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> valid <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Set</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span> <span class="token punctuation">&gt;</span></span> unexpectedArguments <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeSet</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span> <span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span> <span class="token punctuation">&gt;</span></span> booleanArgs <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">HashMap</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span> <span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span><span class="token punctuation">,</span> <span class="token class-name">String</span> <span class="token punctuation">&gt;</span></span> stringArgs <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">HashMap</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span><span class="token punctuation">,</span> <span class="token class-name">String</span> <span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Set</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span> <span class="token punctuation">&gt;</span></span> argsFound <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span> <span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> currentArgument<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">char</span> errorArgument <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
    <span class="token keyword">enum</span> <span class="token class-name">ErrorCode</span> <span class="token punctuation">{</span>
        OK<span class="token punctuation">,</span>
        MISSING_STRING
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token class-name">ErrorCode</span> errorCode <span class="token operator">=</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>OK<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">Args</span><span class="token punctuation">(</span><span class="token class-name">String</span> schema<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ParseException</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>schema <span class="token operator">=</span> schema<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>args <span class="token operator">=</span> args<span class="token punctuation">;</span>
        valid <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ParseException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>schema<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> args<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token function">parseSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">parseArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> valid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">parseSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ParseException</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> element<span class="token operator">:</span> schema<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> trimmedElement <span class="token operator">=</span> element<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">parseSchemaElement</span><span class="token punctuation">(</span>trimmedElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseSchemaElement</span><span class="token punctuation">(</span><span class="token class-name">String</span> element<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ParseException</span> <span class="token punctuation">{</span>
        <span class="token keyword">char</span> elementId <span class="token operator">=</span> element<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> elementTail <span class="token operator">=</span> element<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">validateSchemaElementId</span><span class="token punctuation">(</span>elementId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isBooleanSchemaElement</span><span class="token punctuation">(</span>elementTail<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">parseBooleanSchemaElement</span><span class="token punctuation">(</span>elementId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isStringSchemaElement</span><span class="token punctuation">(</span>elementTail<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">parseStringSchemaElement</span><span class="token punctuation">(</span>elementId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">validateSchemaElementId</span><span class="token punctuation">(</span><span class="token keyword">char</span> elementId<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ParseException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Character</span><span class="token punctuation">.</span><span class="token function">isLetter</span><span class="token punctuation">(</span>elementId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ParseException</span><span class="token punctuation">(</span>
                <span class="token string">&quot;Bad character:&quot;</span> <span class="token operator">+</span> elementId <span class="token operator">+</span> <span class="token string">&quot;in Args format: &quot;</span> <span class="token operator">+</span> schema<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseStringSchemaElement</span><span class="token punctuation">(</span><span class="token keyword">char</span> elementId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        stringArgs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>elementId<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isStringSchemaElement</span><span class="token punctuation">(</span><span class="token class-name">String</span> elementTail<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> elementTail<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isBooleanSchemaElement</span><span class="token punctuation">(</span><span class="token class-name">String</span> elementTail<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> elementTail<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseBooleanSchemaElement</span><span class="token punctuation">(</span><span class="token keyword">char</span> elementId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        booleanArgs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>elementId<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">parseArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>currentArgument <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> currentArgument <span class="token operator">&lt;</span> args<span class="token punctuation">.</span>length<span class="token punctuation">;</span> currentArgument<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> arg <span class="token operator">=</span> args<span class="token punctuation">[</span>currentArgument<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token function">parseArgument</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseArgument</span><span class="token punctuation">(</span><span class="token class-name">String</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>arg<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">parseElements</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseElements</span><span class="token punctuation">(</span><span class="token class-name">String</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arg<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token function">parseElement</span><span class="token punctuation">(</span>arg<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseElement</span><span class="token punctuation">(</span><span class="token keyword">char</span> argChar<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setArgument</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">)</span>
            argsFound<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            unexpectedArguments<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
            valid <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">setArgument</span><span class="token punctuation">(</span><span class="token keyword">char</span> argChar<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> set <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isBoolean</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">setBooleanArg</span><span class="token punctuation">(</span>argChar<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">setStringArg</span><span class="token punctuation">(</span>argChar<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            set <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> set<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setStringArg</span><span class="token punctuation">(</span><span class="token keyword">char</span> argChar<span class="token punctuation">,</span> <span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        currentArgument<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            stringArgs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>argChar<span class="token punctuation">,</span> args<span class="token punctuation">[</span>currentArgument<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArrayIndexOutOfBoundsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            valid <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            errorArgument <span class="token operator">=</span> argChar<span class="token punctuation">;</span>
            errorCode <span class="token operator">=</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>MISSING_STRING<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isString</span><span class="token punctuation">(</span><span class="token keyword">char</span> argChar<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> stringArgs<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setBooleanArg</span><span class="token punctuation">(</span><span class="token keyword">char</span> argChar<span class="token punctuation">,</span> <span class="token keyword">boolean</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        booleanArgs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>argChar<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isBoolean</span><span class="token punctuation">(</span><span class="token keyword">char</span> argChar<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> booleanArgs<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">cardinality</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> argsFound<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">usage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>schema<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token string">&quot;-[&quot;</span> <span class="token operator">+</span> schema <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">errorMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>unexpectedArguments<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">unexpectedArgumentMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>errorCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> MISSING_STRING<span class="token operator">:</span>
                    <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Could not find string parameter for -%c.&quot;</span><span class="token punctuation">,</span>
                        errorArgument<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> OK<span class="token operator">:</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">&quot;TILT: Should not get here.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">unexpectedArgumentMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">StringBuffer</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token string">&quot;Argument(s) -&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">char</span> c<span class="token operator">:</span> unexpectedArguments<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            message<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        message<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot; unexpected.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> message<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token keyword">char</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">falseIfNull</span><span class="token punctuation">(</span>booleanArgs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">falseIfNull</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> b <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token boolean">false</span> <span class="token operator">:</span> b<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getString</span><span class="token punctuation">(</span><span class="token keyword">char</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">blankIfNull</span><span class="token punctuation">(</span>stringArgs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">blankIfNull</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> s <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">&quot;&quot;</span> <span class="token operator">:</span> s<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">has</span><span class="token punctuation">(</span><span class="token keyword">char</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> argsFound<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> valid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>You can see that this is starting to get out of hand. It’s still not horrible, but the mess is certainly starting to grow. It’s a pile, but it’s not festering quite yet. It took the addition of the integer argument type to get this pile really fermenting and festering.</p> <h3 id="so-i-stopped"><a href="#so-i-stopped" class="header-anchor">#</a> So I Stopped</h3> <p>I had at least two more argument types to add, and I could tell that they would make things
much worse. If I bulldozed my way forward, I could probably get them to work, but I’d leave behind a mess that was too large to fix. If the structure of this code was ever going to be maintainable, now was the time to fix it.</p> <p>So I stopped adding features and started refactoring. Having just added the <code>String</code> and <code>integer</code> arguments, I knew that each argument type required new code in three major places. First, each argument type required some way to parse its schema element in order to select the <code>HashMap</code> for that type. Next, each argument type needed to be parsed in the command-line strings and converted to its true type. Finally, each argument type needed a <code>getXXX</code> method so that it could be returned to the caller as its true type.</p> <p>Many different types, all with similar methods—that sounds like a class to me. And so
the <code>ArgumentMarshaler</code> concept was born.</p> <h3 id="on-incrementalism"><a href="#on-incrementalism" class="header-anchor">#</a> On Incrementalism</h3> <p>One of the best ways to ruin a program is to make massive changes to its structure in the name of improvement. Some programs never recover from such “improvements.” The problem is that it’s very hard to get the program working the same way it worked before the “improvement.”</p> <p>To avoid this, I use the discipline of Test-Driven Development (TDD). One of the central doctrines of this approach is to keep the system running at all times. In other words, using TDD, I am not allowed to make a change to the system that breaks that system. Every change I make must keep the system working as it worked before.</p> <p>To achieve this, I need a suite of automated tests that I can run on a whim and that verifies that the behavior of the system is unchanged. For the Argsclass I had created a suite of unit and acceptance tests while I was building the festering pile. The unit tests were written in Javaand administered by <code>JUnit</code>. The acceptance tests were written as wiki pages in <code>FitNesse</code>. I could run these tests any time I wanted, and if they passed, I was confident that the system was working as I specified.</p> <p>So I proceeded to make a large number of very tiny changes. Each change moved the structure of the system toward the ArgumentMarshalerconcept. And yet each change kept the system working. The first change I made was to add the skeleton of the ArgumentMarshaller to the end of the festering pile (Listing 14-11).</p> <h4 id="listing-14-11"><a href="#listing-14-11" class="header-anchor">#</a> Listing 14-11</h4> <p><strong>ArgumentMarshaller appended to Args.java</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> booleanValue <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setBoolean</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        booleanValue <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> booleanValue<span class="token punctuation">;</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">BooleanArgumentMarshaler</span> <span class="token keyword">extends</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">StringArgumentMarshaler</span> <span class="token keyword">extends</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">IntegerArgumentMarshaler</span> <span class="token keyword">extends</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Clearly, this wasn’t going to break anything. So then I made the simplest modification I could, one that would break as little as possible. I changed the <code>HashMap</code> for the <code>Boolean</code> arguments to take an <code>ArgumentMarshaler</code>.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Character</span><span class="token punctuation">,</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">&gt;</span></span> booleanArgs <span class="token operator">=</span>
<span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Character</span><span class="token punctuation">,</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>This broke a few statements, which I quickly fixed.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// ...</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseBooleanSchemaElement</span><span class="token punctuation">(</span><span class="token keyword">char</span> elementId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
booleanArgs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>elementId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">BooleanArgumentMarshaler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// ..</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setBooleanArg</span><span class="token punctuation">(</span><span class="token keyword">char</span> argChar<span class="token punctuation">,</span> <span class="token keyword">boolean</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    booleanArgs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setBoolean</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token keyword">char</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">falseIfNull</span><span class="token punctuation">(</span>booleanArgs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">.</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Notice how these changes are in exactly the areas that I mentioned before: the <code>parse</code>,
<code>set</code>, and <code>get</code> for the argument type. Unfortunately, small as this change was, some of the
tests started failing. If you look carefully at <code>getBoolean</code>, you’ll see that if you call it with <code>'y,'</code> but there is no yargument, then <code>booleanArgs.get('y')</code> will return null, and the function will throw a <code>NullPointerException</code>. The <code>falseIfNull</code> function had been used to protect against this, but the change I made caused that function to become irrelevant.</p> <p>Incrementalism demanded that I get this working quickly before making any other
changes. Indeed, the fix was not too difficult. I just had to move the check for null. It was
no longer the <code>boolean</code> being <code>null</code> that I needed to check; it was the <code>ArgumentMarshaller</code>.</p> <p>First, I removed the <code>falseIfNull</code> call in the <code>getBoolean</code> function. It was useless now, so I also eliminated the function itself. The tests still failed in the same way, so I was confident that I hadn’t introduced any new errors.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token keyword">char</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">return</span> booleanArgs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Next, I split the function into two lines and put the <code>ArgumentMarshaller</code> into its own variable named <code>argumentMarshaller</code>. I didn’t care for the long variable name; it was badly redundant and cluttered up the function. So I shortened it to am [N5].</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token keyword">char</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Args</span><span class="token punctuation">.</span><span class="token class-name">ArgumentMarshaler</span> am <span class="token operator">=</span> booleanArgs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> am <span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>And then I put in the null detection logic.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token keyword">char</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Args</span><span class="token punctuation">.</span><span class="token class-name">ArgumentMarshaler</span> am <span class="token operator">=</span> booleanArgs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> am <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> am<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="string-arguments"><a href="#string-arguments" class="header-anchor">#</a> String Arguments</h2> <p><code>AddingString</code> arguments was very similar to adding <code>boolean</code> arguments. I had to change the <code>HashMap</code> and get the <code>parse</code>, <code>set</code>, and <code>get</code> functions working. There shouldn’t be any surprises in what follows except,  perhaps, that I seem to be putting all the marshalling implementation in the <code>ArgumentMarshaller</code> base class instead of distributing it to the derivatives.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Character</span> <span class="token punctuation">,</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">&gt;</span></span> stringArgs <span class="token operator">=</span>
    <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Character</span> <span class="token punctuation">,</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseStringSchemaElement</span><span class="token punctuation">(</span><span class="token keyword">char</span> elementId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    stringArgs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>elementId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">StringArgumentMarshaler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// ...</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setStringArg</span><span class="token punctuation">(</span><span class="token keyword">char</span> argChar<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
    currentArgument<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        stringArgs <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">.</span>get<span class="token operator">*</span><span class="token operator">*</span> <span class="token punctuation">(</span>argChar<span class="token punctuation">)</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">.</span>setString<span class="token operator">*</span><span class="token operator">*</span> <span class="token punctuation">(</span>args<span class="token punctuation">[</span>currentArgument<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArrayIndexOutOfBoundsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        valid <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        errorArgumentId <span class="token operator">=</span> argChar<span class="token punctuation">;</span>
        errorCode <span class="token operator">=</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>MISSING_STRING<span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// ...</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getString</span><span class="token punctuation">(</span><span class="token keyword">char</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Args</span><span class="token punctuation">.</span><span class="token class-name">ArgumentMarshaler</span> am <span class="token operator">=</span> stringArgs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> am <span class="token operator">==</span> <span class="token keyword">null</span><span class="token operator">?</span> <span class="token string">&quot;&quot;</span> <span class="token operator">:</span> am<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// ...</span>
<span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> booleanValue <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> stringValue<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setBoolean</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        booleanValue <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> booleanValue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setString</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    stringValue <span class="token operator">=</span> s<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> stringValue <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">&quot;&quot;</span> <span class="token operator">:</span> stringValue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Again, these changes were made one at a time and in such a way that the tests kept running, if not passing. When a test broke, I made sure to get it passing again before continuing with the next change.</p> <p>By now you should be able to see my intent. Once I get all the current marshalling behavior into the <code>ArgumentMarshaler</code> base class, I’m going to start pushing that behavior down into the derivatives. This will allow me to keep everything running while I gradually change the shape of this program.</p> <p>The obvious next step was to move the <code>int</code> argument functionality into the ArgumentMarshaler`. Again, there weren’t any surprises.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">Map</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span><span class="token punctuation">,</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">&gt;</span></span> intArgs <span class="token operator">=</span>
    <span class="token keyword">new</span> <span class="token class-name">HashMap</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span><span class="token punctuation">,</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseIntegerSchemaElement</span><span class="token punctuation">(</span><span class="token keyword">char</span> elementId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    intArgs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>elementId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">IntegerArgumentMarshaler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// ...</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setIntArg</span><span class="token punctuation">(</span><span class="token keyword">char</span> argChar<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
    currentArgument<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> parameter <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        parameter <span class="token operator">=</span> args<span class="token punctuation">[</span>currentArgument<span class="token punctuation">]</span><span class="token punctuation">;</span>
        intArgs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setInteger</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>parameter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArrayIndexOutOfBoundsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        valid <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        errorArgumentId <span class="token operator">=</span> argChar<span class="token punctuation">;</span>
        errorCode <span class="token operator">=</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>MISSING_INTEGER<span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NumberFormatException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        valid <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        errorArgumentId <span class="token operator">=</span> argChar<span class="token punctuation">;</span>
        errorParameter <span class="token operator">=</span> parameter<span class="token punctuation">;</span>
        errorCode <span class="token operator">=</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>INVALID_INTEGER<span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// ...</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getInt</span><span class="token punctuation">(</span><span class="token keyword">char</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Args</span><span class="token punctuation">.</span><span class="token class-name">ArgumentMarshaler</span> am <span class="token operator">=</span> intArgs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> am <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> am<span class="token punctuation">.</span><span class="token function">getInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// ...</span>
<span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> booleanValue <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> stringValue<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> integerValue<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setBoolean</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        booleanValue <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> booleanValue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setString</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        stringValue <span class="token operator">=</span> s<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> stringValue <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">&quot;&quot;</span> <span class="token operator">:</span> stringValue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setInteger</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        integerValue <span class="token operator">=</span> i<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> integerValue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>With all the marshalling moved to the <code>ArgumentMarshaler</code>, I started pushing functionality into the derivatives. The first step was to move the <code>setBoolean</code> function into the <code>BooleanArgumentMarshaller</code> and make sure it got called correctly. So I created an abstract
set method.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token keyword">boolean</span> booleanValue <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> stringValue<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> integerValue<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setBoolean</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        booleanValue <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> booleanValue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setString</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        stringValue <span class="token operator">=</span> s<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> stringValue <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">&quot;&quot;</span> <span class="token operator">:</span> stringValue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setInteger</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        integerValue <span class="token operator">=</span> i<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> integerValue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Then I implemented the set method in <code>BooleanArgumentMarshaller</code>.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">BooleanArgumentMarshaler</span> <span class="token keyword">extends</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        booleanValue <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>And finally I replaced the call to setBoolean with a call to set.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setBooleanArg</span><span class="token punctuation">(</span><span class="token keyword">char</span> argChar<span class="token punctuation">,</span> <span class="token keyword">boolean</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    booleanArgs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The tests all still passed. Because this change caused setto be deployed to the <code>BooleanArgumentMarshaler</code>, I removed the <code>setBoolean</code> method from the <code>ArgumentMarshaler</code> base class.</p> <p>Notice that the abstract <code>set</code> function takes a <code>String</code> argument, but the implementation in the <code>BooleanArgumentMarshaller</code> does not use it. I put that argument in there because I knew that the <code>StringArgumentMarshaller</code> and <code>IntegerArgumentMarshaller</code> <em>would</em> use it.</p> <p>Next, I wanted to deploy the getmethod into <code>BooleanArgumentMarshaler</code>. Deploying <code>get</code> functions is always ugly because the return type has to be <code>Object</code>, and in this case needs to be cast to a <code>Boolean</code>.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token keyword">char</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Args</span><span class="token punctuation">.</span><span class="token class-name">ArgumentMarshaler</span> am <span class="token operator">=</span> booleanArgs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> am <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">)</span> am<span class="token punctuation">.</span> get <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Just to get this to compile, I added the get function to the <code>ArgumentMarshaler</code>.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This compiled and obviously failed the tests. Getting the tests working again was simply a matter of making get abstract and implementing it in <code>BooleanAgumentMarshaler</code>.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token keyword">boolean</span> booleanValue <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">Object</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">BooleanArgumentMarshaler</span> <span class="token keyword">extends</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        booleanValue <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> booleanValue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Once again the tests passed. So both <code>get</code> and <code>set</code> deploy to the <code>BooleanArgumentMarshaler</code>!
This allowed me to remove the old <code>getBoolean</code> function from <code>ArgumentMarshaler</code>, move the
<code>protected booleanValue</code> variable down to <code>BooleanArgumentMarshaler</code>, and make it <code>private</code>.</p> <p>I did the same pattern of changes for <code>Strings</code>. I deployed both <code>set</code> and <code>get</code>, deleted the
unused functions, and moved the variables.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setStringArg</span><span class="token punctuation">(</span><span class="token keyword">char</span> argChar<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
    currentArgument<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        stringArgs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span>currentArgument<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArrayIndexOutOfBoundsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        valid <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        errorArgumentId <span class="token operator">=</span> argChar<span class="token punctuation">;</span>
        errorCode <span class="token operator">=</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>MISSING_STRING<span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// ...</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getString</span><span class="token punctuation">(</span><span class="token keyword">char</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Args</span><span class="token punctuation">.</span><span class="token class-name">ArgumentMarshaler</span> am <span class="token operator">=</span> stringArgs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> am <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">&quot;&quot;</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> am<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// ...</span>
<span class="token keyword">private</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> integerValue<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setInteger</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        integerValue <span class="token operator">=</span> i<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> integerValue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">Object</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">BooleanArgumentMarshaler</span> <span class="token keyword">extends</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> booleanValue <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        booleanValue <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> booleanValue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">StringArgumentMarshaler</span> <span class="token keyword">extends</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> stringValue <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        stringValue <span class="token operator">=</span> s<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> stringValue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">IntegerArgumentMarshaler</span> <span class="token keyword">extends</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Finally, I repeated the process for <code>integers</code>. This was just a little more complicated because <code>integers</code> needed to be parsed, and the <code>parse</code> operation can throw an exception. But the result is better because the whole concept of <code>NumberFormatException</code> got buried in the <code>IntegerArgumentMarshaler</code>.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isIntArg</span><span class="token punctuation">(</span><span class="token keyword">char</span> argChar<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> intArgs<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setIntArg</span><span class="token punctuation">(</span><span class="token keyword">char</span> argChar<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
    currentArgument<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> parameter <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        parameter <span class="token operator">=</span> args<span class="token punctuation">[</span>currentArgument<span class="token punctuation">]</span><span class="token punctuation">;</span>
        intArgs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>parameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArrayIndexOutOfBoundsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        valid <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        errorArgumentId <span class="token operator">=</span> argChar<span class="token punctuation">;</span>
        errorCode <span class="token operator">=</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>MISSING_INTEGER<span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArgsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        valid <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        errorArgumentId <span class="token operator">=</span> argChar<span class="token punctuation">;</span>
        errorParameter <span class="token operator">=</span> parameter<span class="token punctuation">;</span>
        errorCode <span class="token operator">=</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>INVALID_INTEGER<span class="token punctuation">;</span>
        <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// ...</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setBooleanArg</span><span class="token punctuation">(</span><span class="token keyword">char</span> argChar<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        booleanArgs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArgsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//...</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getInt</span><span class="token punctuation">(</span><span class="token keyword">char</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Args</span><span class="token punctuation">.</span><span class="token class-name">ArgumentMarshaler</span> am <span class="token operator">=</span> intArgs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> am <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">)</span> am<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//...</span>
<span class="token keyword">private</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">Object</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//...</span>
<span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">IntegerArgumentMarshaler</span> <span class="token keyword">extends</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> intValue <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            intValue <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NumberFormatException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> intValue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Of course, the tests continued to pass. Next, I got rid of the three different maps up at the top of the algorithm. This made the whole system much more generic. However, I couldn’t get rid of them just by deleting them because that would break the system.
Instead, I added a new Mapfor the ArgumentMarshalerand then one by one changed the methods to use it instead of the three original maps.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Args</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span><span class="token punctuation">,</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">&gt;</span></span> booleanArgs <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">HashMap</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span><span class="token punctuation">,</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span><span class="token punctuation">,</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">&gt;</span></span> stringArgs <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">HashMap</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span><span class="token punctuation">,</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span><span class="token punctuation">,</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">&gt;</span></span> intArgs <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">HashMap</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span><span class="token punctuation">,</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span><span class="token punctuation">,</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">&gt;</span></span> marshalers <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">HashMap</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span><span class="token punctuation">,</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseBooleanSchemaElement</span><span class="token punctuation">(</span><span class="token keyword">char</span> elementId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ArgumentMarshaler</span> m <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BooleanArgumentMarshaler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        booleanArgs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>elementId<span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">;</span>
        marshalers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>elementId<span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseIntegerSchemaElement</span><span class="token punctuation">(</span><span class="token keyword">char</span> elementId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ArgumentMarshaler</span> m <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntegerArgumentMarshaler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        intArgs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>elementId<span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">;</span>
        marshalers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>elementId<span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseStringSchemaElement</span><span class="token punctuation">(</span><span class="token keyword">char</span> elementId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ArgumentMarshaler</span> m <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringArgumentMarshaler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stringArgs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>elementId<span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">;</span>
        marshalers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>elementId<span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>Of course the tests all still passed. Next, I changed <code>isBooleanArg</code> from this:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isBooleanArg</span><span class="token punctuation">(</span><span class="token keyword">char</span> argChar<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> booleanArgs<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>to this:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isBooleanArg</span><span class="token punctuation">(</span><span class="token keyword">char</span> argChar<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ArgumentMarshaler</span> m <span class="token operator">=</span> marshalers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> m <span class="token keyword">instanceof</span> <span class="token class-name">BooleanArgumentMarshaler</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The tests still passed. So I made the same change to <code>isIntArg</code> and <code>isStringArg</code>.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isIntArg</span><span class="token punctuation">(</span><span class="token keyword">char</span> argChar<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ArgumentMarshaler</span> m <span class="token operator">=</span> marshalers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> m <span class="token keyword">instanceof</span> <span class="token class-name">IntegerArgumentMarshaler</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isStringArg</span><span class="token punctuation">(</span><span class="token keyword">char</span> argChar<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ArgumentMarshaler</span> m <span class="token operator">=</span> marshalers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> m <span class="token keyword">instanceof</span> <span class="token class-name">StringArgumentMarshaler</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The tests still passed. So I eliminated all the duplicate calls to <code>marshalers.get</code> as follows:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">setArgument</span><span class="token punctuation">(</span><span class="token keyword">char</span> argChar<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
    <span class="token class-name">ArgumentMarshaler</span> m <span class="token operator">=</span> marshalers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isBooleanArg</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">setBooleanArg</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isStringArg</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">setStringArg</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isIntArg</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">setIntArg</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isIntArg</span><span class="token punctuation">(</span><span class="token class-name">ArgumentMarshaler</span> m<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> m <span class="token keyword">instanceof</span> <span class="token class-name">IntegerArgumentMarshaler</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isStringArg</span><span class="token punctuation">(</span><span class="token class-name">ArgumentMarshaler</span> m<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> m <span class="token keyword">instanceof</span> <span class="token class-name">StringArgumentMarshaler</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isBooleanArg</span><span class="token punctuation">(</span><span class="token class-name">ArgumentMarshaler</span> m<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> m <span class="token keyword">instanceof</span> <span class="token class-name">BooleanArgumentMarshaler</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This left no good reason for the three <code>isxxxArg</code> methods. So I inlined them:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">setArgument</span><span class="token punctuation">(</span><span class="token keyword">char</span> argChar<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
    <span class="token class-name">ArgumentMarshaler</span> m <span class="token operator">=</span> marshalers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token keyword">instanceof</span> <span class="token class-name">BooleanArgumentMarshaler</span><span class="token punctuation">)</span>
        <span class="token function">setBooleanArg</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token keyword">instanceof</span> <span class="token class-name">StringArgumentMarshaler</span><span class="token punctuation">)</span>
        <span class="token function">setStringArg</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token keyword">instanceof</span> <span class="token class-name">IntegerArgumentMarshaler</span><span class="token punctuation">)</span>
        <span class="token function">setIntArg</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Next, I started using the marshalers map in the set functions, breaking the use of the other
three maps. I started with the booleans.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">setArgument</span><span class="token punctuation">(</span><span class="token keyword">char</span> argChar<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
    <span class="token class-name">ArgumentMarshaler</span> m <span class="token operator">=</span> marshalers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token keyword">instanceof</span> <span class="token class-name">BooleanArgumentMarshaler</span><span class="token punctuation">)</span>
        <span class="token function">setBooleanArg</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token keyword">instanceof</span> <span class="token class-name">StringArgumentMarshaler</span><span class="token punctuation">)</span>
        <span class="token function">setStringArg</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token keyword">instanceof</span> <span class="token class-name">IntegerArgumentMarshaler</span><span class="token punctuation">)</span>
        <span class="token function">setIntArg</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// ...</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setBooleanArg</span><span class="token punctuation">(</span> <span class="token class-name">ArgumentMarshaler</span> m <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        m <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// was: booleanArgs.get(argChar).set(&quot;true&quot;);</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArgsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The tests still passed, so I did the same with <code>Strings</code> and <code>Integers</code>. This allowed me to integrate some of the ugly exception management code into the <code>setArgument</code> function.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">setArgument</span><span class="token punctuation">(</span><span class="token keyword">char</span> argChar<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
    <span class="token class-name">ArgumentMarshaler</span> m <span class="token operator">=</span> marshalers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token keyword">instanceof</span> <span class="token class-name">BooleanArgumentMarshaler</span><span class="token punctuation">)</span>
            <span class="token function">setBooleanArg</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token keyword">instanceof</span> <span class="token class-name">StringArgumentMarshaler</span><span class="token punctuation">)</span>
            <span class="token function">setStringArg</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token keyword">instanceof</span> <span class="token class-name">IntegerArgumentMarshaler</span><span class="token punctuation">)</span>
            <span class="token function">setIntArg</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArgsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        valid <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        errorArgumentId <span class="token operator">=</span> argChar<span class="token punctuation">;</span>
        <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setIntArg</span><span class="token punctuation">(</span><span class="token class-name">ArgumentMarshaler</span> m<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
    currentArgument<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> parameter <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        parameter <span class="token operator">=</span> args<span class="token punctuation">[</span>currentArgument<span class="token punctuation">]</span><span class="token punctuation">;</span>
        m<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>parameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArrayIndexOutOfBoundsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        errorCode <span class="token operator">=</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>MISSING_INTEGER<span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArgsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        errorParameter <span class="token operator">=</span> parameter<span class="token punctuation">;</span>
        errorCode <span class="token operator">=</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>INVALID_INTEGER<span class="token punctuation">;</span>
        <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setStringArg</span><span class="token punctuation">(</span><span class="token class-name">ArgumentMarshaler</span> m<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
    currentArgument<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        m<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span>currentArgument<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArrayIndexOutOfBoundsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        errorCode <span class="token operator">=</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>MISSING_STRING<span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>I was close to being able to remove the three old maps. First, I needed to change the <code>getBoolean</code> function from this:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token keyword">char</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Args</span><span class="token punctuation">.</span><span class="token class-name">ArgumentMarshaler</span> am <span class="token operator">=</span> booleanArgs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> am <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">)</span> am<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>to this:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token keyword">char</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Args</span><span class="token punctuation">.</span><span class="token class-name">ArgumentMarshaler</span> am <span class="token operator">=</span> marshalers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> b <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        b <span class="token operator">=</span> am <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">)</span> am<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassCastException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        b <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This last change might have been a surprise. Why did I suddenly decide to deal with the <code>ClassCastException</code>? The reason is that I have a set of unit tests and a separate set of
acceptance tests written in <code>FitNesse</code>. It turns out that the <code>FitNesse</code> tests made sure that if you called <code>getBoolean</code> on a non <code>boolean</code> argument, you got a <code>false</code>. The unit tests did not.
Up to this point I had only been running the unit tests.^2</p> <p>This last change allowed me to pull out another use of the boolean map:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseBooleanSchemaElement</span><span class="token punctuation">(</span><span class="token keyword">char</span> elementId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ArgumentMarshaler</span> m <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BooleanArgumentMarshaler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// booleanArgs.put(elementId, m);</span>
    marshalers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>elementId<span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>And now we can delete the <code>boolean</code> map.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Args</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// private Map&lt;Character, ArgumentMarshaler&gt; booleanArgs =</span>
    <span class="token comment">// new HashMap&lt;Character, ArgumentMarshaler&gt;();</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Character</span><span class="token punctuation">,</span> <span class="token class-name">ArgumentMarshaler</span><span class="token punctuation">&gt;</span></span> stringArgs <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Character</span><span class="token punctuation">,</span> <span class="token class-name">ArgumentMarshaler</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Character</span><span class="token punctuation">,</span> <span class="token class-name">ArgumentMarshaler</span><span class="token punctuation">&gt;</span></span> intArgs <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Character</span><span class="token punctuation">,</span> <span class="token class-name">ArgumentMarshaler</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Character</span><span class="token punctuation">,</span> <span class="token class-name">ArgumentMarshaler</span><span class="token punctuation">&gt;</span></span> marshalers <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Character</span><span class="token punctuation">,</span> <span class="token class-name">ArgumentMarshaler</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
</code></pre></div><p>Next, I migrated the <code>String</code> and <code>Integer</code> arguments in the same manner and did a little cleanup with the <code>booleans</code>.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseBooleanSchemaElement</span><span class="token punctuation">(</span><span class="token keyword">char</span> elementId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    marshalers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>elementId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">BooleanArgumentMarshaler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseIntegerSchemaElement</span><span class="token punctuation">(</span><span class="token keyword">char</span> elementId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    marshalers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>elementId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">IntegerArgumentMarshaler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseStringSchemaElement</span><span class="token punctuation">(</span><span class="token keyword">char</span> elementId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    marshalers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>elementId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">StringArgumentMarshaler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// ...</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getString</span><span class="token punctuation">(</span><span class="token keyword">char</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Args</span><span class="token punctuation">.</span><span class="token class-name">ArgumentMarshaler</span> am <span class="token operator">=</span> <span class="token operator">*</span><span class="token operator">*</span> marshalers <span class="token operator">*</span><span class="token operator">*</span> <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> am <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">&quot;&quot;</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> am<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassCastException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getInt</span><span class="token punctuation">(</span><span class="token keyword">char</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Args</span><span class="token punctuation">.</span><span class="token class-name">ArgumentMarshaler</span> am <span class="token operator">=</span> <span class="token operator">*</span><span class="token operator">*</span> marshalers <span class="token operator">*</span><span class="token operator">*</span> <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> am <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">)</span> am<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// ...</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Args</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// private Map&lt;Character, ArgumentMarshaler&gt; stringArgs =</span>
    <span class="token comment">//     new HashMap&lt;Character, ArgumentMarshaler&gt;();</span>
    <span class="token comment">// private Map&lt;Character, ArgumentMarshaler&gt; intArgs =</span>
    <span class="token comment">//     new HashMap&lt;Character, ArgumentMarshaler&gt;();</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span><span class="token punctuation">,</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">&gt;</span></span> marshalers <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">HashMap</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span><span class="token punctuation">,</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//...</span>
</code></pre></div><p>Next, I inlined the three <code>parse</code> methods because they didn’t do much anymore:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseSchemaElement</span><span class="token punctuation">(</span><span class="token class-name">String</span> element<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ParseException</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> elementId <span class="token operator">=</span> element<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> elementTail <span class="token operator">=</span> element<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">validateSchemaElementId</span><span class="token punctuation">(</span>elementId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isBooleanSchemaElement</span><span class="token punctuation">(</span>elementTail<span class="token punctuation">)</span><span class="token punctuation">)</span>
        marshalers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>elementId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">BooleanArgumentMarshaler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isStringSchemaElement</span><span class="token punctuation">(</span>elementTail<span class="token punctuation">)</span><span class="token punctuation">)</span>
        marshalers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>elementId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">StringArgumentMarshaler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isIntegerSchemaElement</span><span class="token punctuation">(</span>elementTail<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        marshalers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>elementId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">IntegerArgumentMarshaler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ParseException</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>
            <span class="token string">&quot;Argument: %c has invalid format: %s.&quot;</span><span class="token punctuation">,</span> elementId<span class="token punctuation">,</span> elementTail<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Okay, so now let’s look at the whole picture again. Listing 14-12 shows the current form of the <code>Args</code> class.</p> <h4 id="listing-14-12"><a href="#listing-14-12" class="header-anchor">#</a> Listing 14-12</h4> <p><strong>Args.java (After first refactoring)</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>objectmentor<span class="token punctuation">.</span>utilities<span class="token punctuation">.</span>getopts</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>text<span class="token punctuation">.</span></span><span class="token class-name">ParseException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Args</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> schema<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> valid <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Set</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span> <span class="token punctuation">&gt;</span></span> unexpectedArguments <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeSet</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span> <span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span><span class="token punctuation">,</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">&gt;</span></span> marshalers <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">HashMap</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span><span class="token punctuation">,</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Set</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span> <span class="token punctuation">&gt;</span></span> argsFound <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span> <span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> currentArgument<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">char</span> errorArgumentId <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> errorParameter <span class="token operator">=</span> <span class="token string">&quot;TILT&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">ErrorCode</span> errorCode <span class="token operator">=</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>OK<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">enum</span> <span class="token class-name">ErrorCode</span> <span class="token punctuation">{</span>
        OK<span class="token punctuation">,</span> MISSING_STRING<span class="token punctuation">,</span> MISSING_INTEGER<span class="token punctuation">,</span> INVALID_INTEGER<span class="token punctuation">,</span> UNEXPECTED_ARGUMENT <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Args</span><span class="token punctuation">(</span><span class="token class-name">String</span> schema<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ParseException</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>schema <span class="token operator">=</span> schema<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>args <span class="token operator">=</span> args<span class="token punctuation">;</span>
        valid <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ParseException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>schema<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> args<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token function">parseSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">parseArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArgsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword">return</span> valid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">parseSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ParseException</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> element<span class="token operator">:</span> schema<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> trimmedElement <span class="token operator">=</span> element<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">parseSchemaElement</span><span class="token punctuation">(</span>trimmedElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseSchemaElement</span><span class="token punctuation">(</span><span class="token class-name">String</span> element<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ParseException</span> <span class="token punctuation">{</span>
        <span class="token keyword">char</span> elementId <span class="token operator">=</span> element<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> elementTail <span class="token operator">=</span> element<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">validateSchemaElementId</span><span class="token punctuation">(</span>elementId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isBooleanSchemaElement</span><span class="token punctuation">(</span>elementTail<span class="token punctuation">)</span><span class="token punctuation">)</span>
            marshalers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>elementId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">BooleanArgumentMarshaler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isStringSchemaElement</span><span class="token punctuation">(</span>elementTail<span class="token punctuation">)</span><span class="token punctuation">)</span>
            marshalers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>elementId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">StringArgumentMarshaler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isIntegerSchemaElement</span><span class="token punctuation">(</span>elementTail<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            marshalers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>elementId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">IntegerArgumentMarshaler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ParseException</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>
                <span class="token string">&quot;Argument: %c has invalid format: %s.&quot;</span><span class="token punctuation">,</span> elementId<span class="token punctuation">,</span> elementTail<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">validateSchemaElementId</span><span class="token punctuation">(</span><span class="token keyword">char</span> elementId<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ParseException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Character</span><span class="token punctuation">.</span><span class="token function">isLetter</span><span class="token punctuation">(</span>elementId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ParseException</span><span class="token punctuation">(</span>
                <span class="token string">&quot;Bad character:&quot;</span> <span class="token operator">+</span> elementId <span class="token operator">+</span> <span class="token string">&quot;in Args format: &quot;</span> <span class="token operator">+</span> schema<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isStringSchemaElement</span><span class="token punctuation">(</span><span class="token class-name">String</span> elementTail<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> elementTail<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isBooleanSchemaElement</span><span class="token punctuation">(</span><span class="token class-name">String</span> elementTail<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> elementTail<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isIntegerSchemaElement</span><span class="token punctuation">(</span><span class="token class-name">String</span> elementTail<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> elementTail<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;#&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">parseArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>currentArgument <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> currentArgument <span class="token operator">&lt;</span> args<span class="token punctuation">.</span>length<span class="token punctuation">;</span> currentArgument<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> arg <span class="token operator">=</span> args<span class="token punctuation">[</span>currentArgument<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token function">parseArgument</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseArgument</span><span class="token punctuation">(</span><span class="token class-name">String</span> arg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>arg<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">parseElements</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseElements</span><span class="token punctuation">(</span><span class="token class-name">String</span> arg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arg<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token function">parseElement</span><span class="token punctuation">(</span>arg<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseElement</span><span class="token punctuation">(</span><span class="token keyword">char</span> argChar<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setArgument</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">)</span>
            argsFound<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            unexpectedArguments<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
            errorCode <span class="token operator">=</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>UNEXPECTED_ARGUMENT<span class="token punctuation">;</span>
            valid <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">setArgument</span><span class="token punctuation">(</span><span class="token keyword">char</span> argChar<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        <span class="token class-name">ArgumentMarshaler</span> m <span class="token operator">=</span> marshalers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token keyword">instanceof</span> <span class="token class-name">BooleanArgumentMarshaler</span><span class="token punctuation">)</span>
                <span class="token function">setBooleanArg</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token keyword">instanceof</span> <span class="token class-name">StringArgumentMarshaler</span><span class="token punctuation">)</span>
                <span class="token function">setStringArg</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token keyword">instanceof</span> <span class="token class-name">IntegerArgumentMarshaler</span><span class="token punctuation">)</span>
                <span class="token function">setIntArg</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArgsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            valid <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            errorArgumentId <span class="token operator">=</span> argChar<span class="token punctuation">;</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setIntArg</span><span class="token punctuation">(</span><span class="token class-name">ArgumentMarshaler</span> m<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        currentArgument<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> parameter <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            parameter <span class="token operator">=</span> args<span class="token punctuation">[</span>currentArgument<span class="token punctuation">]</span><span class="token punctuation">;</span>
            m<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>parameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArrayIndexOutOfBoundsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            errorCode <span class="token operator">=</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>MISSING_INTEGER<span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArgsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            errorParameter <span class="token operator">=</span> parameter<span class="token punctuation">;</span>
            errorCode <span class="token operator">=</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>INVALID_INTEGER<span class="token punctuation">;</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setStringArg</span><span class="token punctuation">(</span><span class="token class-name">ArgumentMarshaler</span> m<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        currentArgument<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            m<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span>currentArgument<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArrayIndexOutOfBoundsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            errorCode <span class="token operator">=</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>MISSING_STRING<span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setBooleanArg</span><span class="token punctuation">(</span><span class="token class-name">ArgumentMarshaler</span> m<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            m<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArgsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">cardinality</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> argsFound<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">usage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>schema<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token string">&quot;-[&quot;</span> <span class="token operator">+</span> schema <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">errorMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>errorCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> OK<span class="token operator">:</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">&quot;TILT: Should not get here.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> UNEXPECTED_ARGUMENT<span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token function">unexpectedArgumentMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> MISSING_STRING<span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Could not find string parameter for -%c.&quot;</span><span class="token punctuation">,</span>
                    errorArgumentId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> INVALID_INTEGER<span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Argument -%c expects an integer but was '%s'.&quot;</span><span class="token punctuation">,</span>
                    errorArgumentId<span class="token punctuation">,</span> errorParameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> MISSING_INTEGER<span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Could not find integer parameter for -%c.&quot;</span><span class="token punctuation">,</span>
                    errorArgumentId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">unexpectedArgumentMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">StringBuffer</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token string">&quot;Argument(s) -&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">char</span> c<span class="token operator">:</span> unexpectedArguments<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            message<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        message<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot; unexpected.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> message<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token keyword">char</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Args</span><span class="token punctuation">.</span><span class="token class-name">ArgumentMarshaler</span> am <span class="token operator">=</span> marshalers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> b <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            b <span class="token operator">=</span> am <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">)</span> am<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassCastException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            b <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> b<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getString</span><span class="token punctuation">(</span><span class="token keyword">char</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Args</span><span class="token punctuation">.</span><span class="token class-name">ArgumentMarshaler</span> am <span class="token operator">=</span> marshalers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> am <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">&quot;&quot;</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> am<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassCastException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getInt</span><span class="token punctuation">(</span><span class="token keyword">char</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Args</span><span class="token punctuation">.</span><span class="token class-name">ArgumentMarshaler</span> am <span class="token operator">=</span> marshalers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> am <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">)</span> am<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">has</span><span class="token punctuation">(</span><span class="token keyword">char</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> argsFound<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> valid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">ArgsException</span> <span class="token keyword">extends</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">Object</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">BooleanArgumentMarshaler</span> <span class="token keyword">extends</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">boolean</span> booleanValue <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            booleanValue <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> booleanValue<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">StringArgumentMarshaler</span> <span class="token keyword">extends</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> stringValue <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            stringValue <span class="token operator">=</span> s<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> stringValue<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">IntegerArgumentMarshaler</span> <span class="token keyword">extends</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> intValue <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                intValue <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NumberFormatException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> intValue<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>After all that work, this is a bit disappointing. The structure is a bit better, but we still
have all those variables up at the top; there’s still a horrible type-case in <code>setArgument</code>; and all those <code>set</code> functions are really ugly. Not to mention all the error processing. We still have a lot of work ahead of us.</p> <p>I’d really like to get rid of that type-case up in <code>setArgument</code>[G23]. What I’d like in
<code>setArgument</code> is a single call to <code>ArgumentMarshaler.set</code>. This means I need to push
<code>setIntArg</code>,<code>setStringArg</code>, and setBooleanArgdown into the appropriate <code>ArgumentMarshaler</code>
derivatives. But there is a problem.</p> <p>If you look closely at <code>setIntArg</code>, you’ll notice that it uses two instance variables: <code>args</code>
andc <code>urrentArg</code>. To move <code>setIntArg</code> down into <code>BooleanArgumentMarshaler</code>, I’ll have to pass
both <code>args</code> and <code>currentArgs</code> as function arguments. That’s dirty [F1]. I’d rather pass one argument instead of two. Fortunately, there is a simple solution. We can convert the args array into a <code>list</code> and pass an <code>Iterator</code> down to the <code>set</code> functions. The following took me ten steps, passing all the tests after each. But I’ll just show you the result. You  should be able to figure out what most of the tiny little steps were.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Args</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> schema<span class="token punctuation">;</span>
    <span class="token comment">// private String[] args;</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> valid <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Set</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span> <span class="token punctuation">&gt;</span></span> unexpectedArguments <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeSet</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span> <span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span><span class="token punctuation">,</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">&gt;</span></span> marshalers <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">HashMap</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span><span class="token punctuation">,</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Set</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span> <span class="token punctuation">&gt;</span></span> argsFound <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span> <span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Iterator</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">String</span> <span class="token punctuation">&gt;</span></span> currentArgument<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">char</span> errorArgumentId <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> errorParameter <span class="token operator">=</span> <span class="token string">&quot;TILT&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">ErrorCode</span> errorCode <span class="token operator">=</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>OK<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">String</span> <span class="token punctuation">&gt;</span></span> argsList<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">enum</span> <span class="token class-name">ErrorCode</span> <span class="token punctuation">{</span>
        OK<span class="token punctuation">,</span>
        MISSING_STRING<span class="token punctuation">,</span>
        MISSING_INTEGER<span class="token punctuation">,</span>
        INVALID_INTEGER<span class="token punctuation">,</span>
        UNEXPECTED_ARGUMENT
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">Args</span><span class="token punctuation">(</span><span class="token class-name">String</span> schema<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ParseException</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>schema <span class="token operator">=</span> schema<span class="token punctuation">;</span>
        argsList <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        valid <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ParseException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>schema<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> argsList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token function">parseSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">parseArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArgsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword">return</span> valid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ---</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">parseArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>currentArgument <span class="token operator">=</span> argsList<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> currentArgument<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> arg <span class="token operator">=</span> currentArgument<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">parseArgument</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ---</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setIntArg</span><span class="token punctuation">(</span><span class="token class-name">ArgumentMarshaler</span> m<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> parameter <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            parameter <span class="token operator">=</span> currentArgument<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            m<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>parameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchElementException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            errorCode <span class="token operator">=</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>MISSING_INTEGER<span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArgsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            errorParameter <span class="token operator">=</span> parameter<span class="token punctuation">;</span>
            errorCode <span class="token operator">=</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>INVALID_INTEGER<span class="token punctuation">;</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setStringArg</span><span class="token punctuation">(</span><span class="token class-name">ArgumentMarshaler</span> m<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            m<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>currentArgument<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchElementException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            errorCode <span class="token operator">=</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>MISSING_STRING<span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>These were simple changes that kept all the tests passing. Now we can start moving the <code>set</code> functions down into the appropriate derivatives. First, I need to make the following change <code>insetArgument</code>:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">setArgument</span><span class="token punctuation">(</span><span class="token keyword">char</span> argChar<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
    <span class="token class-name">ArgumentMarshaler</span> m <span class="token operator">=</span> marshalers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token keyword">instanceof</span> <span class="token class-name">BooleanArgumentMarshaler</span><span class="token punctuation">)</span>
            <span class="token function">setBooleanArg</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token keyword">instanceof</span> <span class="token class-name">StringArgumentMarshaler</span><span class="token punctuation">)</span>
            <span class="token function">setStringArg</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token keyword">instanceof</span> <span class="token class-name">IntegerArgumentMarshaler</span><span class="token punctuation">)</span>
            <span class="token function">setIntArg</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// else</span>
        <span class="token comment">// return false;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArgsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        valid <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        errorArgumentId <span class="token operator">=</span> argChar<span class="token punctuation">;</span>
        <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This change is important because we want to completely eliminate the <code>if-else</code> chain.
Therefore, we needed to get the error condition out of it.</p> <p>Now we can start to move the setfunctions. The <code>setBooleanArg</code> function is trivial, so
we’ll prepare that one first. Our goal is to change the <code>setBooleanArg</code> function to simply forward to the <code>BooleanArgumentMarshaler</code>.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">setArgument</span><span class="token punctuation">(</span><span class="token keyword">char</span> argChar<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
    <span class="token class-name">ArgumentMarshaler</span> m <span class="token operator">=</span> marshalers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token keyword">instanceof</span> <span class="token class-name">BooleanArgumentMarshaler</span><span class="token punctuation">)</span>
            <span class="token function">setBooleanArg</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> currentArgument<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token keyword">instanceof</span> <span class="token class-name">StringArgumentMarshaler</span><span class="token punctuation">)</span>
            <span class="token function">setStringArg</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token keyword">instanceof</span> <span class="token class-name">IntegerArgumentMarshaler</span><span class="token punctuation">)</span>
            <span class="token function">setIntArg</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArgsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        valid <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        errorArgumentId <span class="token operator">=</span> argChar<span class="token punctuation">;</span>
        <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// ---</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setBooleanArg</span><span class="token punctuation">(</span><span class="token class-name">ArgumentMarshaler</span> m<span class="token punctuation">,</span> <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> currentArgument<span class="token punctuation">)</span>
<span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
    <span class="token comment">// try {</span>
    m<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// catch (ArgsException e) {</span>
    <span class="token comment">// }</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Didn’t we just put that exception processing in? Putting things in so you can take them out again is pretty common in refactoring. The smallness of the steps and the need to keep the tests running means that you move things around a lot. Refactoring is a lot like solving a Rubik’s cube. There are lots of little steps required to achieve a large goal. Each step enables the next.</p> <p>Why did we pass that <code>iterator</code> when <code>setBooleanArg</code> certainly doesn’t need it? Because <code>setIntArg</code> and <code>setStringArg</code> will! And because I want to deploy all three of these functions through an abstract method in <code>ArgumentMarshaller</code>, I need to pass it to <code>setBooleanArg</code>.</p> <p>So now <code>setBooleanArg</code> is useless. If there were a <code>set</code> function in <code>ArgumentMarshaler</code>, we could call it directly. So it’s time to make that function! The first step is to add the new abstract method to <code>ArgumentMarshaler</code>.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> currentArgument<span class="token punctuation">)</span>
                        <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">Object</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Of course this breaks all the derivatives. So let’s implement the new method in each.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">BooleanArgumentMarshaler</span> <span class="token keyword">extends</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> booleanValue <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">Iterator</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">String</span> <span class="token punctuation">&gt;</span></span> currentArgument<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        <span class="token comment">// booleanValue = true;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        booleanValue <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> booleanValue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">StringArgumentMarshaler</span> <span class="token keyword">extends</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> stringValue <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">Iterator</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">String</span> <span class="token punctuation">&gt;</span></span> currentArgument<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        stringValue <span class="token operator">=</span> s<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> stringValue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">IntegerArgumentMarshaler</span> <span class="token keyword">extends</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> intValue <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">Iterator</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">String</span> <span class="token punctuation">&gt;</span></span> currentArgument<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            intValue <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NumberFormatException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> intValue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>And now we can eliminate <code>setBooleanArg</code>!</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">setArgument</span><span class="token punctuation">(</span><span class="token keyword">char</span> argChar<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
    <span class="token class-name">ArgumentMarshaler</span> m <span class="token operator">=</span> marshalers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token keyword">instanceof</span> <span class="token class-name">BooleanArgumentMarshaler</span><span class="token punctuation">)</span>
            m<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>currentArgument<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token keyword">instanceof</span> <span class="token class-name">StringArgumentMarshaler</span><span class="token punctuation">)</span>
            <span class="token function">setStringArg</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token keyword">instanceof</span> <span class="token class-name">IntegerArgumentMarshaler</span><span class="token punctuation">)</span>
            <span class="token function">setIntArg</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArgsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        valid <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        errorArgumentId <span class="token operator">=</span> argChar<span class="token punctuation">;</span>
        <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The tests all pass, and the set function is deploying to <code>BooleanArgumentMarshaler</code>!</p> <p>Now we can do the same for <code>Strings</code> and <code>Integers</code>.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">setArgument</span><span class="token punctuation">(</span><span class="token keyword">char</span> argChar<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
    <span class="token class-name">ArgumentMarshaler</span> m <span class="token operator">=</span> marshalers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token keyword">instanceof</span> <span class="token class-name">BooleanArgumentMarshaler</span><span class="token punctuation">)</span>
            m<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>currentArgument<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token keyword">instanceof</span> <span class="token class-name">StringArgumentMarshaler</span><span class="token punctuation">)</span>
            m<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>currentArgument<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token keyword">instanceof</span> <span class="token class-name">IntegerArgumentMarshaler</span><span class="token punctuation">)</span>
            m<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>currentArgument<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArgsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        valid <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        errorArgumentId <span class="token operator">=</span> argChar<span class="token punctuation">;</span>
        <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// ---</span>

<span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">StringArgumentMarshaler</span> <span class="token keyword">extends</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> stringValue <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">Iterator</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">String</span> <span class="token punctuation">&gt;</span></span> currentArgument<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            stringValue <span class="token operator">=</span> currentArgument<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchElementException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            errorCode <span class="token operator">=</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>MISSING_STRING<span class="token punctuation">;</span>

            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> stringValue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">IntegerArgumentMarshaler</span> <span class="token keyword">extends</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> intValue <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">Iterator</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">String</span> <span class="token punctuation">&gt;</span></span> currentArgument<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> parameter <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            parameter <span class="token operator">=</span> currentArgument<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">set</span><span class="token punctuation">(</span>parameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchElementException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            errorCode <span class="token operator">=</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>MISSING_INTEGER<span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArgsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            errorParameter <span class="token operator">=</span> parameter<span class="token punctuation">;</span>
            errorCode <span class="token operator">=</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>INVALID_INTEGER<span class="token punctuation">;</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            intValue <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NumberFormatException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> intValue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>And so the <em>coup de grace</em> : The type-case can be removed! Touche!</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">setArgument</span><span class="token punctuation">(</span><span class="token keyword">char</span> argChar<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
    <span class="token class-name">ArgumentMarshaler</span> m <span class="token operator">=</span> marshalers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        m<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>currentArgument<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArgsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        valid <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        errorArgumentId <span class="token operator">=</span> argChar<span class="token punctuation">;</span>
        <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Now we can get rid of some crufty functions in <code>IntegerArgumentMarshaler</code> and clean it up a bit.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">IntegerArgumentMarshaler</span> <span class="token keyword">extends</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> intValue <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">Iterator</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">String</span> <span class="token punctuation">&gt;</span></span> currentArgument<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> parameter <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            parameter <span class="token operator">=</span> currentArgument<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            intValue <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>parameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchElementException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            errorCode <span class="token operator">=</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>MISSING_INTEGER<span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NumberFormatException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            errorParameter <span class="token operator">=</span> parameter<span class="token punctuation">;</span>
            errorCode <span class="token operator">=</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>INVALID_INTEGER<span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> intValue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>We can also turn <strong>ArgumentMarshaler</strong> into an interface.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">interface</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> currentArgument<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span><span class="token punctuation">;</span>
    <span class="token class-name">Object</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>So now let’s see how easy it is to add a new argument type to our structure. It should require very few changes, and those changes should be isolated. First, we begin by adding a new test case to check that the double argument works correctly.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSimpleDoublePresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">Args</span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Args</span><span class="token punctuation">(</span><span class="token string">&quot;x##&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token string">&quot;-x&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;42.3&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assertTrue</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">cardinality</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assertTrue</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">42.3</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">getDouble</span><span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">.001</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Now we clean up the schema parsing code and add the <code>##</code> detection for the <code>double</code> argument type.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseSchemaElement</span><span class="token punctuation">(</span><span class="token class-name">String</span> element<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ParseException</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> elementId <span class="token operator">=</span> element<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> elementTail <span class="token operator">=</span> element<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">validateSchemaElementId</span><span class="token punctuation">(</span>elementId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>elementTail<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        marshalers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>elementId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">BooleanArgumentMarshaler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>elementTail<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        marshalers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>elementId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">StringArgumentMarshaler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>elementTail<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;#&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        marshalers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>elementId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">IntegerArgumentMarshaler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>elementTail<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;##&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        marshalers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>elementId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DoubleArgumentMarshaler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ParseException</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>
            <span class="token string">&quot;Argument: %c has invalid format: %s.&quot;</span><span class="token punctuation">,</span> elementId<span class="token punctuation">,</span> elementTail<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Next, we write the <code>DoubleArgumentMarshaler</code> class.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">DoubleArgumentMarshaler</span> <span class="token keyword">implements</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">double</span> doubleValue <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">Iterator</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">String</span> <span class="token punctuation">&gt;</span></span> currentArgument<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> parameter <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            parameter <span class="token operator">=</span> currentArgument<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            doubleValue <span class="token operator">=</span> <span class="token class-name">Double</span><span class="token punctuation">.</span><span class="token function">parseDouble</span><span class="token punctuation">(</span>parameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchElementException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            errorCode <span class="token operator">=</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>MISSING_DOUBLE<span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NumberFormatException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            errorParameter <span class="token operator">=</span> parameter<span class="token punctuation">;</span>
            errorCode <span class="token operator">=</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>INVALID_DOUBLE<span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> doubleValue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This forces us to add a new <code>ErrorCode</code>.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">enum</span> <span class="token class-name">ErrorCode</span> <span class="token punctuation">{</span>
    OK<span class="token punctuation">,</span> MISSING_STRING<span class="token punctuation">,</span> MISSING_INTEGER<span class="token punctuation">,</span> INVALID_INTEGER<span class="token punctuation">,</span> UNEXPECTED_ARGUMENT<span class="token punctuation">,</span>
    MISSING_DOUBLE<span class="token punctuation">,</span> INVALID_DOUBLE <span class="token punctuation">}</span>
</code></pre></div><p>And we need a <code>getDouble</code> function.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">getDouble</span><span class="token punctuation">(</span><span class="token keyword">char</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Args</span><span class="token punctuation">.</span><span class="token class-name">ArgumentMarshaler</span> am <span class="token operator">=</span> marshalers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> am <span class="token operator">==</span> <span class="token keyword">null</span><span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token class-name">Double</span><span class="token punctuation">)</span> am<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>And all the tests pass! That was pretty painless. So now let’s make sure all the error processing works correctly. The next test case checks that an error is declared if an unparseable string is fed to a <code>##</code> argument.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testInvalidDouble</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">Args</span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Args</span><span class="token punctuation">(</span><span class="token string">&quot;x##&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token string">&quot;-x&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Forty two&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assertFalse</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">cardinality</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assertFalse</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">&quot;Argument -x expects a double but was 'Forty two'.&quot;</span><span class="token punctuation">,</span>
    args<span class="token punctuation">.</span><span class="token function">errorMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// ---</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">errorMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>errorCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> OK<span class="token operator">:</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">&quot;TILT: Should not get here.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> UNEXPECTED_ARGUMENT<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token function">unexpectedArgumentMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> MISSING_STRING<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Could not find string parameter for -%c.&quot;</span><span class="token punctuation">,</span>
                errorArgumentId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> INVALID_INTEGER<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Argument -%c expects an integer but was '%s'.&quot;</span><span class="token punctuation">,</span>
                errorArgumentId<span class="token punctuation">,</span> errorParameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> MISSING_INTEGER<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Could not find integer parameter for -%c.&quot;</span><span class="token punctuation">,</span>
                errorArgumentId<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">*</span><span class="token operator">*</span>
        <span class="token keyword">case</span> INVALID_DOUBLE<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Argument -%c expects a double but was '%s'.&quot;</span><span class="token punctuation">,</span>
                errorArgumentId<span class="token punctuation">,</span> errorParameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> MISSING_DOUBLE<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Could not find double parameter for -%c.&quot;</span><span class="token punctuation">,</span>
                errorArgumentId<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">*</span><span class="token operator">*</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>And the tests pass. The next test makes sure we detect a missing <code>double</code> argument properly.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testMissingDouble</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">Args</span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Args</span><span class="token punctuation">(</span><span class="token string">&quot;x##&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">&quot;-x&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assertFalse</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">cardinality</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assertFalse</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">getDouble</span><span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">&quot;Could not find double parameter for -x.&quot;</span><span class="token punctuation">,</span>
    args<span class="token punctuation">.</span><span class="token function">errorMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This passes as expected. We wrote it simply for completeness.</p> <p>The exception code is pretty ugly and doesn’t really belong in the <code>Args</code> class. We are also throwing out <code>ParseException</code>, which doesn’t really belong to us. So let’s merge all the exceptions into a single <code>ArgsException</code> class and move it into its own module.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ArgsException</span> <span class="token keyword">extends</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">char</span> errorArgumentId <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> errorParameter <span class="token operator">=</span> <span class="token string">&quot;TILT&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">ErrorCode</span> errorCode <span class="token operator">=</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>OK<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">ErrorCode</span> <span class="token punctuation">{</span>
        OK<span class="token punctuation">,</span>
        MISSING_STRING<span class="token punctuation">,</span>
        MISSING_INTEGER<span class="token punctuation">,</span>
        INVALID_INTEGER<span class="token punctuation">,</span>
        UNEXPECTED_ARGUMENT<span class="token punctuation">,</span>
        MISSING_DOUBLE<span class="token punctuation">,</span>
        INVALID_DOUBLE
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// ---</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Args</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">private</span> <span class="token keyword">char</span> errorArgumentId <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> errorParameter <span class="token operator">=</span> <span class="token string">&quot;TILT&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">ArgsException</span><span class="token punctuation">.</span><span class="token class-name">ErrorCode</span> errorCode <span class="token operator">=</span> <span class="token class-name">ArgsException</span><span class="token punctuation">.</span><span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>OK<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">String</span> <span class="token punctuation">&gt;</span></span> argsList<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">Args</span><span class="token punctuation">(</span><span class="token class-name">String</span> schema<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>schema <span class="token operator">=</span> schema<span class="token punctuation">;</span>
        argsList <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        valid <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>schema<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> argsList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token function">parseSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">parseArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArgsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword">return</span> valid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">parseSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseSchemaElement</span><span class="token punctuation">(</span><span class="token class-name">String</span> element<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        <span class="token keyword">else</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span>
                <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Argument: %c has invalid format: %s.&quot;</span><span class="token punctuation">,</span>
                    elementId<span class="token punctuation">,</span> elementTail<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">validateSchemaElementId</span><span class="token punctuation">(</span><span class="token keyword">char</span> elementId<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Character</span><span class="token punctuation">.</span><span class="token function">isLetter</span><span class="token punctuation">(</span>elementId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span>
                <span class="token string">&quot;Bad character:&quot;</span> <span class="token operator">+</span> elementId <span class="token operator">+</span> <span class="token string">&quot;in Args format: &quot;</span> <span class="token operator">+</span> schema<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseElement</span><span class="token punctuation">(</span><span class="token keyword">char</span> argChar<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setArgument</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">)</span>
            argsFound<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            unexpectedArguments<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
            errorCode <span class="token operator">=</span> <span class="token class-name">ArgsException</span><span class="token punctuation">.</span><span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>UNEXPECTED_ARGUMENT<span class="token punctuation">;</span>
            valid <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">StringArgumentMarshaler</span> <span class="token keyword">implements</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> stringValue <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">Iterator</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">String</span> <span class="token punctuation">&gt;</span></span> currentArgument<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                stringValue <span class="token operator">=</span> currentArgument<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchElementException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                errorCode <span class="token operator">=</span> <span class="token class-name">ArgsException</span><span class="token punctuation">.</span><span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>MISSING_STRING<span class="token punctuation">;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> stringValue<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">IntegerArgumentMarshaler</span> <span class="token keyword">implements</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> intValue <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">Iterator</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">String</span> <span class="token punctuation">&gt;</span></span> currentArgument<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> parameter <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                parameter <span class="token operator">=</span> currentArgument<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                intValue <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>parameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchElementException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                errorCode <span class="token operator">=</span> <span class="token class-name">ArgsException</span><span class="token punctuation">.</span><span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>MISSING_INTEGER<span class="token punctuation">;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NumberFormatException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                errorParameter <span class="token operator">=</span> parameter<span class="token punctuation">;</span>
                errorCode <span class="token operator">=</span> <span class="token class-name">ArgsException</span><span class="token punctuation">.</span><span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>INVALID_INTEGER<span class="token punctuation">;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> intValue<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">DoubleArgumentMarshaler</span> <span class="token keyword">implements</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">double</span> doubleValue <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">Iterator</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">String</span> <span class="token punctuation">&gt;</span></span> currentArgument<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> parameter <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                parameter <span class="token operator">=</span> currentArgument<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                doubleValue <span class="token operator">=</span> <span class="token class-name">Double</span><span class="token punctuation">.</span><span class="token function">parseDouble</span><span class="token punctuation">(</span>parameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchElementException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                errorCode <span class="token operator">=</span> <span class="token class-name">ArgsException</span><span class="token punctuation">.</span><span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>MISSING_DOUBLE<span class="token punctuation">;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NumberFormatException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                errorParameter <span class="token operator">=</span> parameter<span class="token punctuation">;</span>
                errorCode <span class="token operator">=</span> <span class="token class-name">ArgsException</span><span class="token punctuation">.</span><span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>INVALID_DOUBLE<span class="token punctuation">;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> doubleValue<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This is nice. Now the only exception thrown by <code>Args</code> is <code>ArgsException</code>. Moving <code>ArgsException</code> into its own module means that we can move a lot of the miscellaneous error support code into that module and out of the Argsmodule. It provides a natural and obvious place to put all that code and will really help us clean up the <code>Args</code> module going forward.</p> <p>So now we have completely separated the exception and error code from the <code>Args</code> module. (See Listing 14-13 through Listing 14-16.) This was achieved through a series of about 30 tiny steps, keeping the tests passing between each step.</p> <h4 id="listing-14-13"><a href="#listing-14-13" class="header-anchor">#</a> Listing 14-13</h4> <p><strong>ArgsTest.java</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>objectmentor<span class="token punctuation">.</span>utilities<span class="token punctuation">.</span>args</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">junit<span class="token punctuation">.</span>framework<span class="token punctuation">.</span></span><span class="token class-name">TestCase</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ArgsTest</span> <span class="token keyword">extends</span> <span class="token class-name">TestCase</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testCreateWithNoSchemaOrArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Args</span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Args</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">cardinality</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testWithNoSchemaButWithOneArgument</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Args</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
                <span class="token string">&quot;-x&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">fail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArgsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token class-name">ArgsException</span><span class="token punctuation">.</span><span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>UNEXPECTED_ARGUMENT<span class="token punctuation">,</span>
                e<span class="token punctuation">.</span><span class="token function">getErrorCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getErrorArgumentId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testWithNoSchemaButWithMultipleArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Args</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
                <span class="token string">&quot;-x&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;-y&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">fail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArgsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token class-name">ArgsException</span><span class="token punctuation">.</span><span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>UNEXPECTED_ARGUMENT<span class="token punctuation">,</span>
                e<span class="token punctuation">.</span><span class="token function">getErrorCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getErrorArgumentId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testNonLetterSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Args</span><span class="token punctuation">(</span><span class="token string">&quot;*&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;Args constructor should have thrown exception&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArgsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">fail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArgsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token class-name">ArgsException</span><span class="token punctuation">.</span><span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>INVALID_ARGUMENT_NAME<span class="token punctuation">,</span>
                e<span class="token punctuation">.</span><span class="token function">getErrorCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getErrorArgumentId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testInvalidArgumentFormat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Args</span><span class="token punctuation">(</span><span class="token string">&quot;f~&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;Args constructor should have throws exception&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArgsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token class-name">ArgsException</span><span class="token punctuation">.</span><span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>INVALID_FORMAT<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getErrorCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">'f'</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getErrorArgumentId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSimpleBooleanPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Args</span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Args</span><span class="token punctuation">(</span><span class="token string">&quot;x&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;-x&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">cardinality</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSimpleStringPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Args</span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Args</span><span class="token punctuation">(</span><span class="token string">&quot;x*&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;-x&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;param&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">cardinality</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertTrue</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">&quot;param&quot;</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testMissingStringArgument</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Args</span><span class="token punctuation">(</span><span class="token string">&quot;x*&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
                <span class="token string">&quot;-x&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">fail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArgsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token class-name">ArgsException</span><span class="token punctuation">.</span><span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>MISSING_STRING<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getErrorCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getErrorArgumentId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSpacesInFormat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Args</span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Args</span><span class="token punctuation">(</span><span class="token string">&quot;x, y&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;-xy&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">cardinality</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertTrue</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertTrue</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token string">'y'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSimpleIntPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Args</span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Args</span><span class="token punctuation">(</span><span class="token string">&quot;x#&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;-x&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;42&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">cardinality</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertTrue</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testInvalidInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Args</span><span class="token punctuation">(</span><span class="token string">&quot;x#&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
                <span class="token string">&quot;-x&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;Forty two&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


            <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token class-name">ArgsException</span><span class="token punctuation">.</span><span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>INVALID_INTEGER<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getErrorCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getErrorArgumentId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">&quot;Forty two&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getErrorParameter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testMissingInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Args</span><span class="token punctuation">(</span><span class="token string">&quot;x#&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
                <span class="token string">&quot;-x&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">fail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArgsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token class-name">ArgsException</span><span class="token punctuation">.</span><span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>MISSING_INTEGER<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getErrorCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getErrorArgumentId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSimpleDoublePresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Args</span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Args</span><span class="token punctuation">(</span><span class="token string">&quot;x##&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;-x&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;42.3&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">cardinality</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertTrue</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">42.3</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">getDouble</span><span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">.001</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testInvalidDouble</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Args</span><span class="token punctuation">(</span><span class="token string">&quot;x##&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
                <span class="token string">&quot;-x&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;Forty two&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">fail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArgsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token class-name">ArgsException</span><span class="token punctuation">.</span><span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>INVALID_DOUBLE<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getErrorCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getErrorArgumentId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">&quot;Forty two&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getErrorParameter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testMissingDouble</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Args</span><span class="token punctuation">(</span><span class="token string">&quot;x##&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
                <span class="token string">&quot;-x&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">fail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArgsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token class-name">ArgsException</span><span class="token punctuation">.</span><span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>MISSING_DOUBLE<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getErrorCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getErrorArgumentId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="listing-14-14"><a href="#listing-14-14" class="header-anchor">#</a> Listing 14-14</h4> <p><strong>ArgsExceptionTest.java</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ArgsExceptionTest</span> <span class="token keyword">extends</span> <span class="token class-name">TestCase</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testUnexpectedMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">ArgsException</span> e <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token class-name">ArgsException</span><span class="token punctuation">.</span><span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>UNEXPECTED_ARGUMENT<span class="token punctuation">,</span>
                <span class="token string">'x'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">&quot;Argument -x unexpected.&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">errorMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testMissingStringMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">ArgsException</span> e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token class-name">ArgsException</span><span class="token punctuation">.</span><span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>MISSING_STRING<span class="token punctuation">,</span>
            <span class="token string">'x'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">&quot;Could not find string parameter for -x.&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">errorMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testInvalidIntegerMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">ArgsException</span> e <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token class-name">ArgsException</span><span class="token punctuation">.</span><span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>INVALID_INTEGER<span class="token punctuation">,</span>
                <span class="token string">'x'</span><span class="token punctuation">,</span> <span class="token string">&quot;Forty two&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">&quot;Argument -x expects an integer but was 'Forty two'.&quot;</span><span class="token punctuation">,</span>
            e<span class="token punctuation">.</span><span class="token function">errorMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testMissingIntegerMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">ArgsException</span> e <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token class-name">ArgsException</span><span class="token punctuation">.</span><span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>MISSING_INTEGER<span class="token punctuation">,</span> <span class="token string">'x'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">&quot;Could not find integer parameter for -x.&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">errorMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testInvalidDoubleMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">ArgsException</span> e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token class-name">ArgsException</span><span class="token punctuation">.</span><span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>INVALID_DOUBLE<span class="token punctuation">,</span>
            <span class="token string">'x'</span><span class="token punctuation">,</span> <span class="token string">&quot;Forty two&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">&quot;Argument -x expects a double but was 'Forty two'.&quot;</span><span class="token punctuation">,</span>
            e<span class="token punctuation">.</span><span class="token function">errorMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testMissingDoubleMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">ArgsException</span> e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token class-name">ArgsException</span><span class="token punctuation">.</span><span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>MISSING_DOUBLE<span class="token punctuation">,</span>
            <span class="token string">'x'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">&quot;Could not find double parameter for -x.&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">errorMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="listing-14-15"><a href="#listing-14-15" class="header-anchor">#</a> Listing 14-15</h4> <p><strong>ArgsException.java</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ArgsException</span> <span class="token keyword">extends</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">char</span> errorArgumentId <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> errorParameter <span class="token operator">=</span> <span class="token string">&quot;TILT&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">ErrorCode</span> errorCode <span class="token operator">=</span> <span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>OK<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token class-name">ErrorCode</span> errorCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>errorCode <span class="token operator">=</span> errorCode<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token class-name">ErrorCode</span> errorCode<span class="token punctuation">,</span> <span class="token class-name">String</span> errorParameter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>errorCode <span class="token operator">=</span> errorCode<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>errorParameter <span class="token operator">=</span> errorParameter<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token class-name">ErrorCode</span> errorCode<span class="token punctuation">,</span> <span class="token keyword">char</span> errorArgumentId<span class="token punctuation">,</span>
        <span class="token class-name">String</span> errorParameter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>errorCode <span class="token operator">=</span> errorCode<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>errorParameter <span class="token operator">=</span> errorParameter<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>errorArgumentId <span class="token operator">=</span> errorArgumentId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">char</span> <span class="token function">getErrorArgumentId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> errorArgumentId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setErrorArgumentId</span><span class="token punctuation">(</span><span class="token keyword">char</span> errorArgumentId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>errorArgumentId <span class="token operator">=</span> errorArgumentId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getErrorParameter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> errorParameter<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setErrorParameter</span><span class="token punctuation">(</span><span class="token class-name">String</span> errorParameter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>errorParameter <span class="token operator">=</span> errorParameter<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">ErrorCode</span> <span class="token function">getErrorCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> errorCode<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setErrorCode</span><span class="token punctuation">(</span><span class="token class-name">ErrorCode</span> errorCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>errorCode <span class="token operator">=</span> errorCode<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">errorMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>errorCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> OK<span class="token operator">:</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">&quot;TILT: Should not get here.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> UNEXPECTED_ARGUMENT<span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Argument -%c unexpected.&quot;</span><span class="token punctuation">,</span> errorArgumentId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> MISSING_STRING<span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Could not find string parameter for -%c.&quot;</span><span class="token punctuation">,</span>
                    errorArgumentId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> INVALID_INTEGER<span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Argument -%c expects an integer but was '%s'.&quot;</span><span class="token punctuation">,</span>
                    errorArgumentId<span class="token punctuation">,</span> errorParameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> MISSING_INTEGER<span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Could not find integer parameter for -%c.&quot;</span><span class="token punctuation">,</span>
                    errorArgumentId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> INVALID_DOUBLE<span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Argument -%c expects a double but was '%s'.&quot;</span><span class="token punctuation">,</span>
                    errorArgumentId<span class="token punctuation">,</span> errorParameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> MISSING_DOUBLE<span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Could not find double parameter for -%c.&quot;</span><span class="token punctuation">,</span>
                    errorArgumentId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">ErrorCode</span> <span class="token punctuation">{</span>
        OK<span class="token punctuation">,</span>
        INVALID_FORMAT<span class="token punctuation">,</span>
        UNEXPECTED_ARGUMENT<span class="token punctuation">,</span>
        INVALID_ARGUMENT_NAME<span class="token punctuation">,</span>
        MISSING_STRING<span class="token punctuation">,</span>
        MISSING_INTEGER<span class="token punctuation">,</span>
        INVALID_INTEGER<span class="token punctuation">,</span>
        MISSING_DOUBLE<span class="token punctuation">,</span>
        INVALID_DOUBLE
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="listing-14-16"><a href="#listing-14-16" class="header-anchor">#</a> Listing 14-16</h4> <p><strong>Args.java</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Args</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> schema<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span><span class="token punctuation">,</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">&gt;</span></span> marshalers <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">HashMap</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span><span class="token punctuation">,</span> <span class="token class-name">ArgumentMarshaler</span> <span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Set</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span> <span class="token punctuation">&gt;</span></span> argsFound <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">Character</span> <span class="token punctuation">&gt;</span></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Iterator</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">String</span> <span class="token punctuation">&gt;</span></span> currentArgument<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">String</span> <span class="token punctuation">&gt;</span></span> argsList<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">Args</span><span class="token punctuation">(</span><span class="token class-name">String</span> schema<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>schema <span class="token operator">=</span> schema<span class="token punctuation">;</span>
        argsList <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        <span class="token function">parseSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">parseArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">parseSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> element<span class="token operator">:</span> schema<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">parseSchemaElement</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseSchemaElement</span><span class="token punctuation">(</span><span class="token class-name">String</span> element<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        <span class="token keyword">char</span> elementId <span class="token operator">=</span> element<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> elementTail <span class="token operator">=</span> element<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">validateSchemaElementId</span><span class="token punctuation">(</span>elementId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>elementTail<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            marshalers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>elementId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">BooleanArgumentMarshaler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>elementTail<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            marshalers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>elementId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">StringArgumentMarshaler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>elementTail<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;#&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            marshalers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>elementId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">IntegerArgumentMarshaler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>elementTail<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;##&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            marshalers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>elementId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DoubleArgumentMarshaler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token class-name">ArgsException</span><span class="token punctuation">.</span><span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>INVALID_FORMAT<span class="token punctuation">,</span>
                elementId<span class="token punctuation">,</span> elementTail<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">validateSchemaElementId</span><span class="token punctuation">(</span><span class="token keyword">char</span> elementId<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Character</span><span class="token punctuation">.</span><span class="token function">isLetter</span><span class="token punctuation">(</span>elementId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token class-name">ArgsException</span><span class="token punctuation">.</span><span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>INVALID_ARGUMENT_NAME<span class="token punctuation">,</span>
                elementId<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>currentArgument <span class="token operator">=</span> argsList<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> currentArgument<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> arg <span class="token operator">=</span> currentArgument<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">parseArgument</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseArgument</span><span class="token punctuation">(</span><span class="token class-name">String</span> arg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>arg<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">parseElements</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseElements</span><span class="token punctuation">(</span><span class="token class-name">String</span> arg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arg<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token function">parseElement</span><span class="token punctuation">(</span>arg<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseElement</span><span class="token punctuation">(</span><span class="token keyword">char</span> argChar<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setArgument</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">)</span>
            argsFound<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgsException</span><span class="token punctuation">(</span><span class="token class-name">ArgsException</span><span class="token punctuation">.</span><span class="token class-name">ErrorCode</span><span class="token punctuation">.</span>UNEXPECTED_ARGUMENT<span class="token punctuation">,</span>
                argChar<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">setArgument</span><span class="token punctuation">(</span><span class="token keyword">char</span> argChar<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ArgsException</span> <span class="token punctuation">{</span>
        <span class="token class-name">ArgumentMarshaler</span> m <span class="token operator">=</span> marshalers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            m<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>currentArgument<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ArgsException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">setErrorArgumentId</span><span class="token punctuation">(</span>argChar<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">cardinality</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> argsFound<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">usage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>schema<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token string">&quot;-[&quot;</span> <span class="token operator">+</span> schema <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token keyword">char</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ArgumentMarshaler</span> am <span class="token operator">=</span> marshalers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> b <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            b <span class="token operator">=</span> am <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">)</span> am<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassCastException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            b <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> b<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getString</span><span class="token punctuation">(</span><span class="token keyword">char</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ArgumentMarshaler</span> am <span class="token operator">=</span> marshalers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> am <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">&quot;&quot;</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> am<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassCastException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getInt</span><span class="token punctuation">(</span><span class="token keyword">char</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ArgumentMarshaler</span> am <span class="token operator">=</span> marshalers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> am <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">)</span> am<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The majority of the changes to the <code>Args</code> class were deletions. A lot of code just got moved out of <code>Args</code> and put into <code>ArgsException</code>. Nice. We also moved all the <code>ArgumentMarshallers</code> into their own files. Nicer!</p> <p>Much of good software design is simply about partitioning—creating appropriate places to put different kinds of code. This separation of concerns makes the code much simpler to understand and maintain.</p> <p>Of special interest is the <code>errorMessage</code> method of <code>ArgsException</code>. Clearly it was a violation of the SRP to put the error message formatting into <code>Args</code>. <code>Args</code> should be about the processing of arguments, not about the format of the error messages. However, does it
really make sense to put the error message formatting code into <code>ArgsException</code>?</p> <p>Frankly, it’s a compromise. Users who don’t like the error messages supplied by <code>ArgsException</code> will have to write their own. But the convenience of having canned error messages already prepared for you is not insignificant.</p> <p>By now it should be clear that we are within striking distance of the final solution that appeared at the start of this chapter. I’ll leave the final transformations to you as an exercise.</p> <h2 id="conclusion"><a href="#conclusion" class="header-anchor">#</a> Conclusion</h2> <p>It is not enough for code to work. Code that works is often badly broken. Programmers who satisfy themselves with merely working code are behaving unprofessionally. They may fear that they don’t have time to improve the structure and design of their code, but I
disagree. Nothing has a more profound and long-term degrading effect upon a development project than bad code. Bad schedules can be redone, bad requirements can be redefined. Bad team dynamics can be repaired. But bad code rots and ferments, becoming an inexorable weight that drags the team down. Time and time again I have seen teams grind to a crawl because, in their haste, they created a malignant morass of code that forever thereafter dominated their destiny.</p> <p>Of course bad code can be cleaned up. But it’s very expensive. As code rots, the modules insinuate themselves into each other, creating lots of hidden and tangled dependencies. Finding and breaking old dependencies is a long and arduous task. On the other hand, keeping code clean is relatively easy. If you made a mess in a module in the morning, it is easy to clean it up in the afternoon. Better yet, if you made a mess five minutes ago, it’s very easy to clean it up right now.</p> <p>So the solution is to continuously keep your code as clean and simple as it can be. Never let the rot get started.</p> <p><em>2. To prevent further surprises of this kind, I added a new unit test that invoked all the FitNesse tests.</em></p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"><!----><!----><!----></div></div>
    <script src="/docs/assets/js/app.13f2dfe1.js" defer></script><script src="/docs/assets/js/2.ca319816.js" defer></script><script src="/docs/assets/js/425.6fba2505.js" defer></script><script src="/docs/assets/js/89.be9ab726.js" defer></script>
  </body>
</html>
